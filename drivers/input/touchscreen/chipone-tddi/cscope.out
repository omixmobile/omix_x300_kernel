cscope 15 /mnt/d/git/tddi/linux_driver/chipone-tddi               0000466983
	@cts_builtin_firmware.h

1 
u8
 
	giúl9911_driv”_butš_fœmw¬e
[] = {

5 cÚ¡ 
ùs_fœmw¬e
 
	gùs_driv”_butš_fœmw¬es
[] = {

7 .
Çme
 = "OEM-Project",

8 .
	ghwid
 = 
CTS_DEV_HWID_ICNL9911
,

9 .
	gfwid
 = 
CTS_DEV_FWID_ICNL9911
,

10 .
	gd©a
 = 
iúl9911_driv”_butš_fœmw¬e
,

11 .
	gsize
 = 
ARRAY_SIZE
(
iúl9911_driv”_butš_fœmw¬e
),

	@cts_charger_detect.c

1 
	#LOG_TAG
 "Ch¬g”"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sysfs.h
"

8 #ifdeà
CONFIG_CTS_CHARGER_DETECT


10 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,6,0)

20 
	$m©ch_¡ršg
(cÚ¡ * cÚ¡ *
¬¿y
, 
size_t
 
n
, cÚ¡ *
¡ršg
)

22 
šdex
;

23 cÚ¡ *
™em
;

25 
šdex
 = 0; index < 
n
; index++) {

26 
™em
 = 
¬¿y
[
šdex
];

27 ià(!
™em
)

29 ià(!
	`¡rcmp
(
™em
, 
¡ršg
))

30  
šdex
;

33  -
EINVAL
;

34 
	}
}

37 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4,1,0)

38 
	#CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


	)

40 
	#CFG_CTS_CHARGER_DETECT_PSY_POLL


	)

42 
	~<lšux/pow”_suµly.h
>

43 
	~<lšux/nÙif›r.h
>

45 
	eùs_ch¬g”_d‘eù_ty³
 {

46 
	mCTS_CHGR_DET_TYPE_NONE
 = 0,

47 
	mCTS_CHGR_DET_TYPE_PSY_NOTIFY
,

48 
	mCTS_CHGR_DET_TYPE_POLL_PSP
,

49 
	mCTS_CHGR_DET_TYPE_MAX


56 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


57 
	#CFG_CTS_DEF_CHGR_DET_TYPE
 
CTS_CHGR_DET_TYPE_PSY_NOTIFY


	)

59 
	#CFG_CTS_DEF_CHGR_DET_TYPE
 
CTS_CHGR_DET_TYPE_POLL_PSP


	)

62 
	#CFG_CTS_DEF_CHGR_DET_PSY_NAME
 "usb"

	)

63 
	#CFG_CTS_DEF_CHGR_DET_PSY_PROP
 
POWER_SUPPLY_PROP_ONLINE


	)

64 
	#CFG_CTS_DEF_CHGR_DET_PSP_POLL_INTERVAL
 2000u

	)

66 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4,1,0)

68 
	#POWER_SUPPLY_GET_PROPERTY
(
psy
, 
p¥
, 
v®
) \

69 
	`pow”_suµly_g‘_´İ”ty
(
psy
, 
p¥
, 
v®
)

	)

70 
	#POWER_SUPPLY_NAME
(
psy
è(Õsy)->
desc
->
Çme
)

	)

72 
	#POWER_SUPPLY_GET_PROPERTY
(
psy
, 
p¥
, 
v®
) \

73 
psy
->
	`g‘_´İ”ty
Õsy, 
p¥
, 
v®
)

	)

74 
	#POWER_SUPPLY_NAME
(
psy
è(Õsy)->
Çme
)

	)

77 
	sùs_ch¬g”_d‘eù_d©a
 {

78 
boŞ
 
	m’abË
;

79 
boŞ
 
	mruÂšg
;

80 
boŞ
 
	m¡©e
;

83 
ùs_ch¬g”_d‘eù_ty³
 
	mty³
;

84 cÚ¡ *
	mpsy_Çme
;

85 
pow”_suµly_´İ”ty
 
	mp¥
;

86 
u32
 
	mp¥_pŞl_š‹rv®
;

89 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


90 
boŞ
 
	mnÙif›r_»gi¡”ed
;

91 
nÙif›r_block
 
	mpsy_nÙif›r
;

94 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_POLL


96 
d–ayed_wÜk
 
	mp¥_pŞl_wÜk
;

99 
wÜk_¡ruù
 
	m£t_ch¬g”_¡©e_wÜk
;

101 #ifdeà
CONFIG_CTS_SYSFS


102 
boŞ
 
	msysfs_©Œ_group_ü—‹d
;

105 
chÚe_ts_d©a
 *
	mùs_d©a
;

109 
	#POWER_SUPPLY_PROP_PREFIX
 "POWER_SUPPLY_PROP_"

	)

110 
	#POWER_SUPPLY_PROP_TOKEN
(
´İ”ty
) \

111 {.
´İ
 = 
POWER_SUPPLY_PROP_
 ##
´İ”ty
, \

112 .
Çme
 = 
POWER_SUPPLY_PROP_PREFIX
 #´İ”ty}

	)

115 
pow”_suµly_´İ”ty
 
	m´İ
;

116 cÚ¡ *
	mÇme
;

117 } 
	gpow”_suµly_´İ_tok’
 [] = {

118 
POWER_SUPPLY_PROP_TOKEN
(
STATUS
),

119 
POWER_SUPPLY_PROP_TOKEN
(
PRESENT
),

120 
POWER_SUPPLY_PROP_TOKEN
(
ONLINE
),

123 cÚ¡ *
	$pow”_suµly_´İ_¡r
(
pow”_suµly_´İ”ty
 
´İ
)

125 
i
;

127 
i
 = 0; i < (
pow”_suµly_´İ_tok’
); i++) {

128 ià(
´İ
 =ğ
pow”_suµly_´İ_tok’
[
i
].prop) {

129  
pow”_suµly_´İ_tok’
[
i
].
Çme
;

134 
	}
}

136 
pow”_suµly_´İ”ty
 
	$pow”_suµly_´İ_äom_Çme
(cÚ¡ *
Çme
)

138 
size_t
 
off£t
 = 
	`¡¾’
(
POWER_SUPPLY_PROP_PREFIX
);

139 
i
;

141 
i
 = 0; i < 
	`ARRAY_SIZE
(
pow”_suµly_´İ_tok’
); i++) {

142 ià(
	`¡rÿ£cmp
(
pow”_suµly_´İ_tok’
[
i
].
Çme
 + 
off£t
,‚ame) == 0 ||

143 
	`¡rÿ£cmp
(
pow”_suµly_´İ_tok’
[
i
].
Çme
,‚ame) == 0) {

144  
pow”_suµly_´İ_tok’
[
i
].
´İ
;

148  -
ENOENT
;

149 
	}
}

151 cÚ¡ *
	gch¬g”_d‘eù_ty³_‹xt
[] = {

155 cÚ¡ *
	$ch¬g”_d‘eù_ty³_¡r
(
ùs_ch¬g”_d‘eù_ty³
 
ty³
)

157  
ty³
 < 
	`ARRAY_SIZE
(
ch¬g”_d‘eù_ty³_‹xt
) ?

158 
ch¬g”_d‘eù_ty³_‹xt
[
ty³
] : "Unknown";

159 
	}
}

161 
	$·r£_ch¬g”_d‘eù_dt
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
,

162 
deviû_node
 *
Å
)

164 cÚ¡ *
psy_Çme
;

165 cÚ¡ *
ty³_¡r
;

166 cÚ¡ *
p¥_¡r
;

167 
»t
;

169 
	`ùs_šfo
("Parse dt");

171 #ifdeà
CFG_CTS_DEF_CHGR_DET_ENABLE


172 
cd_d©a
->
’abË
 = 
Œue
;

174 
cd_d©a
->
’abË
 =

175 
	`of_´İ”ty_»ad_boŞ
(
Å
, "chipone,touch-charger-detect-enable");

178 
cd_d©a
->
ty³
 = 
CFG_CTS_DEF_CHGR_DET_TYPE
;

179 
»t
 = 
	`of_´İ”ty_»ad_¡ršg
(
Å
,

180 "chÚe,touch-ch¬g”-d‘eù-ty³", &
ty³_¡r
);

181 ià(
»t
) {

182 
	`ùs_w¬n
("P¬£ d‘eùy³ faed %d", 
»t
);

184 
ty³
 = 
	`m©ch_¡ršg
(
ch¬g”_d‘eù_ty³_‹xt
,

185 
	`ARRAY_SIZE
(
ch¬g”_d‘eù_ty³_‹xt
), 
ty³_¡r
);

186 ià(
ty³
 < 0) {

187 
	`ùs_”r
("P¬£ d‘eùy³ '%s' inv®id", 
ty³_¡r
);

189 
cd_d©a
->
ty³
 =ype;

193 
»t
 = 
	`of_´İ”ty_»ad_¡ršg
(
Å
,

194 "chÚe,touch-ch¬g”-d‘eù-psy-Çme", &
psy_Çme
);

195 ià(
»t
) {

196 
	`ùs_w¬n
("P¬£ d‘eù…sy‚amçed %d", 
»t
);

197 
psy_Çme
 = 
CFG_CTS_DEF_CHGR_DET_PSY_NAME
;

199 ià(
	`pow”_suµly_g‘_by_Çme
(
psy_Çme
è=ğ
NULL
) {

200 
	`ùs_w¬n
("Pow” suµly '%s'‚Ù found", 
psy_Çme
);

201 
psy_Çme
 = 
CFG_CTS_DEF_CHGR_DET_PSY_NAME
;

204 
cd_d©a
->
psy_Çme
 = 
	`k¡rdup
Õsy_Çme, 
GFP_KERNEL
);

205 ià(
cd_d©a
->
psy_Çme
 =ğ
NULL
) {

206 
	`ùs_”r
("Alloc mem for…sy‚ame failed");

207  -
ENOMEM
;

210 
cd_d©a
->
p¥
 = 
CFG_CTS_DEF_CHGR_DET_PSY_PROP
;

211 
»t
 = 
	`of_´İ”ty_»ad_¡ršg
(
Å
,

212 "chÚe,touch-ch¬g”-d‘eù-p¥", &
p¥_¡r
);

213 ià(
»t
) {

214 
	`ùs_w¬n
("P¬£ d‘eù…¥ faed %d", 
»t
);

216 
pow”_suµly
 *
psy
;

217 
pow”_suµly_´İ”ty
 
p¥
;

218 
pow”_suµly_´İv®
 
v®
;

220 
p¥
 = 
	`pow”_suµly_´İ_äom_Çme
(
p¥_¡r
);

221 ià(
p¥
 < 0) {

222 
	`ùs_w¬n
("Parse detect…sp: '%s' invalid",

223 
p¥_¡r
);

225 
psy
 = 
	`pow”_suµly_g‘_by_Çme
(
cd_d©a
->
psy_Çme
);

226 ià(
psy
 !ğ
NULL
 &&

227 
	`POWER_SUPPLY_GET_PROPERTY
(
psy
, 
p¥
, &
v®
) >=0) {

228 
	`ùs_”r
("Parse detect…sp invalid");

230 
cd_d©a
->
p¥
 =…sp;

235 
cd_d©a
->
p¥_pŞl_š‹rv®
 = 
CFG_CTS_DEF_CHGR_DET_PSP_POLL_INTERVAL
;

236 
»t
 = 
	`of_´İ”ty_»ad_u32
(
Å
,

238 &
cd_d©a
->
p¥_pŞl_š‹rv®
);

239 ià(
»t
) {

240 
	`ùs_w¬n
("P¬£ d‘eù…¥…ŞÈš‹rv® faed %d", 
»t
);

244 
	}
}

246 
	$¡¬t_ch¬g”_d‘eù
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
)

248 ià(!
cd_d©a
->
’abË
) {

249 
	`ùs_w¬n
("Start detect while NOTƒnabled");

250  -
EINVAL
;

253 ià(
cd_d©a
->
ruÂšg
) {

254 
	`ùs_w¬n
("Start detect while‡lready RUNNING");

258 
	`ùs_šfo
("Start detectype: %d(%s)",

259 
cd_d©a
->
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(cd_data->type));

261 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


262 if(
cd_d©a
->
ty³
 =ğ
CTS_CHGR_DET_TYPE_PSY_NOTIFY
) {

263 
»t
 = 
	`pow”_suµly_»g_nÙif›r
(&
cd_d©a
->
psy_nÙif›r
);

264 ià(
»t
) {

265 
	`ùs_”r
("Regi¡”‚Ùif›¸çed: %d", 
»t
);

266  
»t
;

268 
cd_d©a
->
nÙif›r_»gi¡”ed
 = 
Œue
;

270 
cd_d©a
->
ruÂšg
 = 
Œue
;

276 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_POLL


277 if(
cd_d©a
->
ty³
 =ğ
CTS_CHGR_DET_TYPE_POLL_PSP
) {

278 ià(!
	`queue_d–ayed_wÜk
(
cd_d©a
->
ùs_d©a
->
wÜkqueue
,

279 &
cd_d©a
->
p¥_pŞl_wÜk
,

280 
	`m£cs_to_jiff›s
(
cd_d©a
->
p¥_pŞl_š‹rv®
))) {

281 
	`ùs_w¬n
("Queue detect work while‡lready onhe queue");

283 
cd_d©a
->
ruÂšg
 = 
Œue
;

289  -
ENOTSUPP
;

290 
	}
}

292 
	$¡İ_ch¬g”_d‘eù
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
)

294 ià(!
cd_d©a
->
ruÂšg
) {

295 
	`ùs_w¬n
("Stop detect while NOT„unning");

299 
	`ùs_šfo
("Stop detectype: %d(%s)",

300 
cd_d©a
->
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(cd_data->type));

302 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


303 if(
cd_d©a
->
ty³
 =ğ
CTS_CHGR_DET_TYPE_PSY_NOTIFY
) {

304 ià(
cd_d©a
->
nÙif›r_»gi¡”ed
) {

305 
	`pow”_suµly_uÄeg_nÙif›r
(&
cd_d©a
->
psy_nÙif›r
);

306 
cd_d©a
->
nÙif›r_»gi¡”ed
 = 
çl£
;

308 
cd_d©a
->
ruÂšg
 = 
çl£
;

314 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_POLL


315 if(
cd_d©a
->
ty³
 =ğ
CTS_CHGR_DET_TYPE_POLL_PSP
) {

316 ià(!
	`ÿnûl_d–ayed_wÜk_sync
(&
cd_d©a
->
p¥_pŞl_wÜk
)) {

317 
	`ùs_w¬n
("Cancel…oll…sp work while NOT…ending");

319 
cd_d©a
->
ruÂšg
 = 
çl£
;

326 
	}
}

328 
	$g‘_ch¬g”_¡©e
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
)

330 
pow”_suµly
 *
psy
;

331 
pow”_suµly_´İv®
 
´İv®
;

332 
»t
;

334 
	`ùs_dbg
("Get state from…sy: '%s'…rop: %d(%s)",

335 
cd_d©a
->
psy_Çme
, cd_d©a->
p¥
,

336 
	`pow”_suµly_´İ_¡r
(
cd_d©a
->
p¥
));

338 ià(
cd_d©a
->
psy_Çme
 =ğ
NULL
 ||

339 (
psy
 = 
	`pow”_suµly_g‘_by_Çme
(
cd_d©a
->
psy_Çme
)è=ğ
NULL
) {

340 
	`ùs_”r
("Get state from…sy: '%s'‚ot found",

341 
cd_d©a
->
psy_Çme
);

342  -
EINVAL
;

345 
»t
 = 
	`POWER_SUPPLY_GET_PROPERTY
(
psy
, 
cd_d©a
->
p¥
, &
´İv®
);

346 ià(
»t
 < 0) {

347 
	`ùs_”r
("Get state from…sy: '%s'…rop: %d(%s) failed",

348 
cd_d©a
->
psy_Çme
, cd_d©a->
p¥
,

349 
	`pow”_suµly_´İ_¡r
(
cd_d©a
->
p¥
));

350  -
EINVAL
;

354 
cd_d©a
->
¡©e
 = !!
´İv®
.
štv®
;

356 
	`ùs_dbg
("S‹: %s", 
cd_d©a
->
¡©e
 ? "ATTACHED" : "DETACHED");

359 
	}
}

361 
	$£t_dev_ch¬g”_¡©e_wÜk
(
wÜk_¡ruù
 *
wÜk
)

363 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

364 
»t
;

366 
cd_d©a
 = 
	`cÚš”_of
(
wÜk
, 
ùs_ch¬g”_d‘eù_d©a
,

367 
£t_ch¬g”_¡©e_wÜk
);

369 
	`ùs_lock_deviû
(&
cd_d©a
->
ùs_d©a
->
ùs_dev
);

370 
»t
 = 
	`ùs_£t_dev_ch¬g”_©ched
(&
cd_d©a
->
ùs_d©a
->
ùs_dev
,

371 
cd_d©a
->
¡©e
);

372 
	`ùs_uÆock_deviû
(&
cd_d©a
->
ùs_d©a
->
ùs_dev
);

373 ià(
»t
) {

374 
	`ùs_”r
("Set dev charger‡ttachedo %s failed %d",

375 
cd_d©a
->
¡©e
 ? "ATTACHED" : "DETATCHED", 
»t
);

377 
cd_d©a
->
¡©e
 = !cd_data->state;

379 
	}
}

381 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


382 
	$psy_nÙify_ÿÎback
(
nÙif›r_block
 *
nb
,

383 
aùiÚ
, *
d©a
)

385 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

386 
pow”_suµly
 *
psy
;

387 
boŞ
 
´ev_¡©e
;

388 
»t
;

390 ià(
nb
 =ğ
NULL
 || 
d©a
 == NULL) {

391 
	`ùs_”r
("PSY‚otify with‚otifier(%p) or data(%p) = NULL",

392 
nb
, 
d©a
);

393  
NOTIFY_DONE
;

396 ià(
aùiÚ
 !ğ
PSY_EVENT_PROP_CHANGED
) {

397 
	`ùs_dbg
("NÙifyƒv’ˆ%ld‚Ù c¬e", 
aùiÚ
);

398  
NOTIFY_DONE
;

401 
cd_d©a
 =

402 
	`cÚš”_of
(
nb
, 
ùs_ch¬g”_d‘eù_d©a
, 
psy_nÙif›r
);

404 
psy
 = (
pow”_suµly
 *)
d©a
;

405 ià(
	`¡rcmp
(
	`POWER_SUPPLY_NAME
(
psy
), 
cd_d©a
->
psy_Çme
) != 0) {

406 
	`ùs_dbg
("Notify from…ower supply '%s'‚ot care",

407 
	`POWER_SUPPLY_NAME
(
psy
));

408  
NOTIFY_DONE
;

411 
´ev_¡©e
 = 
cd_d©a
->
¡©e
;

413 
»t
 = 
	`g‘_ch¬g”_¡©e
(
cd_d©a
);

414 ià(
»t
 < 0) {

415 
	`ùs_”r
("G‘ s‹ faed %d", 
»t
);

416  
NOTIFY_DONE
;

419 
	`ùs_šfo
("State changed: %s -> %s",

420 
´ev_¡©e
 ? "ATTACHED" : "DETACHED",

421 
cd_d©a
->
¡©e
 ? "ATTACHED" : "DETACHED");

423 ià(!
	`queue_wÜk
(
cd_d©a
->
ùs_d©a
->
wÜkqueue
,

424 &
cd_d©a
->
£t_ch¬g”_¡©e_wÜk
)) {

425 
	`ùs_w¬n
("Set device charger state work is PENDING");

428  
NOTIFY_OK
;

429 
	}
}

432 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_POLL


433 
	$pŞl_p¥_wÜk
(
wÜk_¡ruù
 *
wÜk
)

435 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

436 
boŞ
 
´ev_¡©e
;

437 
»t
;

439 
	`ùs_dbg
("Poll…sp work");

441 
cd_d©a
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

442 
ùs_ch¬g”_d‘eù_d©a
, 
p¥_pŞl_wÜk
);

444 
´ev_¡©e
 = 
cd_d©a
->
¡©e
;

446 
»t
 = 
	`g‘_ch¬g”_¡©e
(
cd_d©a
);

447 ià(
»t
 < 0) {

448 
	`ùs_”r
("G‘ s‹ faed %d", 
»t
);

450 ià(
cd_d©a
->
¡©e
 !ğ
´ev_¡©e
) {

451 
	`ùs_šfo
("State changed: %s -> %s",

452 
´ev_¡©e
 ? "ATTACHED" : "DETACHED",

453 
cd_d©a
->
¡©e
 ? "ATTACHED" : "DETACHED");

455 ià(!
	`queue_wÜk
(
cd_d©a
->
ùs_d©a
->
wÜkqueue
,

456 &
cd_d©a
->
£t_ch¬g”_¡©e_wÜk
)) {

457 
	`ùs_w¬n
("Set device charger state work is PENDING");

462 ià(!
	`queue_d–ayed_wÜk
(
cd_d©a
->
ùs_d©a
->
wÜkqueue
,

463 &
cd_d©a
->
p¥_pŞl_wÜk
,

464 
	`m£cs_to_jiff›s
(
cd_d©a
->
p¥_pŞl_š‹rv®
))) {

465 
	`ùs_w¬n
("Queue detect work while‡lready onhe queue");

467 
	}
}

470 
	$š™_ch¬g”_d‘eù
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
)

472 
»t
;

474 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_NOTIFY


475 
cd_d©a
->
psy_nÙif›r
.
nÙif›r_ÿÎ
 = 
psy_nÙify_ÿÎback
;

478 #ifdeà
CFG_CTS_CHARGER_DETECT_PSY_POLL


479 
	`INIT_DELAYED_WORK
(&
cd_d©a
->
p¥_pŞl_wÜk
, 
pŞl_p¥_wÜk
);

482 
	`INIT_WORK
(&
cd_d©a
->
£t_ch¬g”_¡©e_wÜk
, 
£t_dev_ch¬g”_¡©e_wÜk
);

484 
»t
 = 
	`g‘_ch¬g”_¡©e
(
cd_d©a
);

485 ià(
»t
) {

486 
	`ùs_”r
("G‘ s‹ faed %d", 
»t
);

490 
	}
}

493 #ifdeà
CONFIG_CTS_SYSFS


494 
¬gc
;

495 *
¬gv
[];

496 
·r£_¬g
(cÚ¡ *
buf
, 
size_t
 
couÁ
);

498 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,6,0)

509 
	$k¡¹oboŞ
(cÚ¡ *
s
, 
boŞ
 *
»s
)

511 ià(!
s
)

512  -
EINVAL
;

514 
s
[0]) {

518 *
»s
 = 
Œue
;

523 *
»s
 = 
çl£
;

527 
s
[1]) {

530 *
»s
 = 
Œue
;

534 *
»s
 = 
çl£
;

543  -
EINVAL
;

544 
	}
}

547 
	#CHARGER_DET_SYSFS_GROUP_NAME
 "ch¬g”-d‘"

	)

549 
	$’abË_ch¬g”_d‘eù
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
)

551 
	`ùs_šfo
("Enable detectype: %d(%s)",

552 
cd_d©a
->
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(cd_data->type));

554 
cd_d©a
->
’abË
 = 
Œue
;

557 
	}
}

559 
	$di§bË_ch¬g”_d‘eù
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
)

561 
»t
;

563 
	`ùs_šfo
("Disable detectype: %d(%s)",

564 
cd_d©a
->
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(cd_data->type));

566 
»t
 = 
	`¡İ_ch¬g”_d‘eù
(
cd_d©a
);

567 ià(
»t
) {

568 
	`ùs_”r
("Di§bË d‘eù faed %d", 
»t
);

571 
cd_d©a
->
’abË
 = 
çl£
;

574 
	}
}

576 
ssize_t
 
	$ch¬g”_d‘eù_’abË_show
(
deviû
 *
dev
,

577 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

579 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

580 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

582 
	`ùs_šfo
("R—d sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s'",

583 
©Œ
->©Œ.
Çme
);

585  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

587 
cd_d©a
->
’abË
 ? "ENABLED" : "DISABLED");

588 
	}
}

591 
ssize_t
 
	$ch¬g”_d‘eù_’abË_¡Üe
(
deviû
 *
dev
,

592 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

594 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

595 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

596 
boŞ
 
’abË
;

597 
»t
;

599 
	`ùs_šfo
("Wr™sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

600 
©Œ
->©Œ.
Çme
, 
couÁ
);

602 
	`·r£_¬g
(
buf
, 
couÁ
);

604 ià(
¬gc
 != 1) {

605 
	`ùs_”r
("Invalid‚um of‡rgs");

606  -
EINVAL
;

609 
»t
 = 
	`k¡¹oboŞ
(
¬gv
[0], &
’abË
);

610 ià(
»t
) {

611 
	`ùs_”r
("Invalid…aram ofƒnable");

612  
»t
;

615 ià(
’abË
) {

616 
»t
 = 
	`’abË_ch¬g”_d‘eù
(
cd_d©a
);

618 
»t
 = 
	`di§bË_ch¬g”_d‘eù
(
cd_d©a
);

620 ià(
»t
) {

621 
	`ùs_”r
("%s charger detect failed %d",

622 
’abË
 ? "EÇbË" : "Di§bË", 
»t
);

623  
»t
;

626  
couÁ
;

627 
	}
}

628 
DEVICE_ATTR
(
’abË
, 
S_IWUSR
 | 
S_IRUGO
,

629 
ch¬g”_d‘eù_’abË_show
, 
ch¬g”_d‘eù_’abË_¡Üe
);

631 
ssize_t
 
	$ch¬g”_d‘eù_ruÂšg_show
(
deviû
 *
dev
,

632 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

634 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

635 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

637 
	`ùs_šfo
("R—d sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s'",

638 
©Œ
->©Œ.
Çme
);

640  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

642 
cd_d©a
->
ruÂšg
 ? "" : "Not-");

643 
	}
}

646 
ssize_t
 
	$ch¬g”_d‘eù_ruÂšg_¡Üe
(
deviû
 *
dev
,

647 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

649 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

650 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

651 
boŞ
 
ruÂšg
;

652 
»t
;

654 
	`ùs_šfo
("Wr™sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

655 
©Œ
->©Œ.
Çme
, 
couÁ
);

657 
	`·r£_¬g
(
buf
, 
couÁ
);

659 ià(
¬gc
 != 1) {

660 
	`ùs_”r
("Invalid‚um of‡rgs");

661  -
EINVAL
;

664 
»t
 = 
	`k¡¹oboŞ
(
¬gv
[0], &
ruÂšg
);

665 ià(
»t
) {

666 
	`ùs_”r
("Invalid…aram of„unning");

667  
»t
;

670 ià(
ruÂšg
) {

671 
»t
 = 
	`¡¬t_ch¬g”_d‘eù
(
cd_d©a
);

673 
»t
 = 
	`¡İ_ch¬g”_d‘eù
(
cd_d©a
);

675 ià(
»t
) {

676 
	`ùs_”r
("%s charger detect failed %d",

677 
ruÂšg
 ? "S¹" : "Stİ", 
»t
);

678  
»t
;

681  
couÁ
;

682 
	}
}

683 
DEVICE_ATTR
(
ruÂšg
, 
S_IWUSR
 | 
S_IRUGO
,

684 
ch¬g”_d‘eù_ruÂšg_show
, 
ch¬g”_d‘eù_ruÂšg_¡Üe
);

686 
	$sw™ch_ch¬g”_d‘eù_ty³
(
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
,

687 
ùs_ch¬g”_d‘eù_ty³
 
ty³
)

689 
boŞ
 
ruÂšg
;

691 
	`ùs_šfo
("Switch detectypeo %d(%s)",

692 
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(type));

694 ià(
ty³
 >ğ
CTS_CHGR_DET_TYPE_MAX
) {

695 
	`ùs_”r
("Sw™ch d‘eùy³ %d inv®id", 
ty³
);

696  -
EINVAL
;

699 ià(
cd_d©a
->
ty³
 ==ype) {

700 
	`ùs_w¬n
("Switch detectypeƒqual");

704 
ruÂšg
 = 
cd_d©a
->running;

706 ià(
ruÂšg
) {

707 
»t
 = 
	`¡İ_ch¬g”_d‘eù
(
cd_d©a
);

708 ià(
»t
) {

709 
	`ùs_”r
("Stİ d‘eù faed %d", 
»t
);

710  
»t
;

714 
cd_d©a
->
ty³
 =ype;

716 ià(
ruÂšg
) {

717 
»t
 = 
	`¡¬t_ch¬g”_d‘eù
(
cd_d©a
);

718 ià(
»t
) {

719 
	`ùs_”r
("S¹ d‘eù faed %d", 
»t
);

720 
cd_d©a
->
ty³
 = 
CTS_CHGR_DET_TYPE_NONE
;

721  
»t
;

726 
	}
}

728 
ssize_t
 
	$ch¬g”_d‘eù_ty³_show
(
deviû
 *
dev
,

729 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

731 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

732 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

734 
	`ùs_šfo
("R—d sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s'",

735 
©Œ
->©Œ.
Çme
);

737  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

739 
cd_d©a
->
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(cd_data->type));

740 
	}
}

743 
ssize_t
 
	$ch¬g”_d‘eù_ty³_¡Üe
(
deviû
 *
dev
,

744 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

746 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

747 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

748 
ty³
, 
»t
;

750 
	`ùs_šfo
("Wr™sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

751 
©Œ
->©Œ.
Çme
, 
couÁ
);

753 
	`·r£_¬g
(
buf
, 
couÁ
);

755 ià(
¬gc
 != 1) {

756 
	`ùs_”r
("");

757  -
EINVAL
;

760 
ty³
 = 
	`m©ch_¡ršg
(
ch¬g”_d‘eù_ty³_‹xt
,

761 
	`ARRAY_SIZE
(
ch¬g”_d‘eù_ty³_‹xt
), 
¬gv
[0]);

762 ià(
ty³
 < 0) {

763 
	`ùs_”r
("Inv®id ch¬g” d‘eùy³: '%s'", 
¬gv
[0]);

764  -
EINVAL
;

767 
»t
 = 
	`sw™ch_ch¬g”_d‘eù_ty³
(
cd_d©a
, 
ty³
);

768 ià(
»t
) {

769 
	`ùs_”r
("Sw™ch ch¬g” d‘eùy³ faed %d", 
»t
);

770  
»t
;

773  
couÁ
;

774 
	}
}

775 
DEVICE_ATTR
(
ty³
, 
S_IWUSR
 | 
S_IRUGO
,

776 
ch¬g”_d‘eù_ty³_show
, 
ch¬g”_d‘eù_ty³_¡Üe
);

778 
ssize_t
 
	$ch¬g”_¡©e_show
(
deviû
 *
dev
,

779 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

781 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

782 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

783 
»t
;

785 
	`ùs_šfo
("R—d sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s'",

786 
©Œ
->©Œ.
Çme
);

788 
»t
 = 
	`g‘_ch¬g”_¡©e
(
cd_d©a
);

789 ià(
»t
) {

790  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

791 "G‘ ch¬g¡©çed %d\n", 
»t
);

794  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

796 
cd_d©a
->
¡©e
 ? "ATTACHED" : "DETACHED");

797 
	}
}

798 
DEVICE_ATTR
(
¡©e
, 
S_IRUGO
, 
ch¬g”_¡©e_show
, 
NULL
);

800 
ssize_t
 
	$ch¬g”_d‘eù_·¿m_show
(
deviû
 *
dev
,

801 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

803 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

804 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

805 
pow”_suµly
 *
psy
;

807 
	`ùs_šfo
("R—d sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s'",

808 
©Œ
->©Œ.
Çme
);

810 
psy
 = 
	`pow”_suµly_g‘_by_Çme
(
cd_d©a
->
psy_Çme
);

812  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

816 
cd_d©a
->
psy_Çme
, 
psy
 =ğ
NULL
 ? "Non-" : "",

817 
cd_d©a
->
p¥
, 
	`pow”_suµly_´İ_¡r
(cd_data->psp),

818 
cd_d©a
->
p¥_pŞl_š‹rv®
);

819 
	}
}

822 
ssize_t
 
	$ch¬g”_d‘eù_·¿m_¡Üe
(
deviû
 *
dev
,

823 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

825 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

826 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

827 
pow”_suµly
 *
psy
;

828 
pow”_suµly_´İv®
 
´İv®
;

829 
pow”_suµly_´İ”ty
 
p¥
;

830 
u32
 
š‹rv®
;

831 
»t
;

833 
	`ùs_šfo
("Wr™sysf '"
CHARGER_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

834 
©Œ
->©Œ.
Çme
, 
couÁ
);

836 
	`·r£_¬g
(
buf
, 
couÁ
);

838 ià(
¬gc
 < 2 ||‡rgc > 3) {

839 
	`ùs_”r
("Invalid‚um of‡rgs");

840  -
EINVAL
;

843 ià((
psy
 = 
	`pow”_suµly_g‘_by_Çme
(
¬gv
[0])è=ğ
NULL
) {

844 
	`ùs_”r
("Pow” suµly '%s'‚Ù found", 
¬gv
[0]);

845  -
EINVAL
;

848 
p¥
 = 
	`pow”_suµly_´İ_äom_Çme
(
¬gv
[1]);

849 ià(
p¥
 < 0 ||

850 
	`POWER_SUPPLY_GET_PROPERTY
(
psy
, 
p¥
, &
´İv®
) < 0) {

851 
	`ùs_”r
("Power supply '%s'…roperty '%s'‚ot valid",

852 
¬gv
[0], 
	`pow”_suµly_´İ_¡r
(
p¥
));

853  -
EINVAL
;

856 
š‹rv®
 = 
cd_d©a
->
p¥_pŞl_š‹rv®
;

857 ià(
¬gc
 > 2) {

858 
»t
 = 
	`k¡¹ou32
(
¬gv
[2], 0, &
š‹rv®
);

859 ià(
»t
) {

860 
	`ùs_”r
("Arg interval is invalid");

861  -
EINVAL
;

865 ià(
cd_d©a
->
psy_Çme
) {

866 
	`kä“
(
cd_d©a
->
psy_Çme
);

868 
cd_d©a
->
psy_Çme
 = 
	`k¡rdup
(
¬gv
[0], 
GFP_KERNEL
);

869 ià(
cd_d©a
->
psy_Çme
 =ğ
NULL
) {

870 
	`ùs_”r
("Dup…ower supply‚ame failed");

871  -
ENOMEM
;

874 
cd_d©a
->
p¥
 =…sp;

875 
cd_d©a
->
p¥_pŞl_š‹rv®
 = 
š‹rv®
;

877  
couÁ
;

878 
	}
}

879 
DEVICE_ATTR
(
·¿m
, 
S_IWUSR
 | 
S_IRUGO
,

880 
ch¬g”_d‘eù_·¿m_show
, 
ch¬g”_d‘eù_·¿m_¡Üe
);

882 
©Œibu‹
 *
	gch¬g”_d‘eù_©Œs
[] = {

883 &
dev_©Œ_’abË
.
©Œ
,

884 &
dev_©Œ_ruÂšg
.
©Œ
,

885 &
dev_©Œ_ty³
.
©Œ
,

886 &
dev_©Œ_¡©e
.
©Œ
,

887 &
dev_©Œ_·¿m
.
©Œ
,

888 
NULL


891 cÚ¡ 
©Œibu‹_group
 
	gch¬g”_d‘eù_©Œ_group
 = {

892 .
Çme
 = 
CHARGER_DET_SYSFS_GROUP_NAME
,

893 .
	g©Œs
 = 
ch¬g”_d‘eù_©Œs
,

897 
	$ùs_š™_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

899 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

900 
»t
 = 0;

902 
	`ùs_šfo
("Init detect");

904 ià(
ùs_d©a
 =ğ
NULL
) {

905 
	`ùs_”r
("Init detect with cts_data = NULL");

906  -
EFAULT
;

909 
cd_d©a
 = 
	`kz®loc
((*cd_d©a), 
GFP_KERNEL
);

910 ià(
cd_d©a
 =ğ
NULL
) {

911 
	`ùs_”r
("Alloc charger detect data failed");

912  -
ENOMEM
;

915 #ifdeà
CONFIG_CTS_OF


916 
»t
 = 
	`·r£_ch¬g”_d‘eù_dt
(
cd_d©a
, 
ùs_d©a
->
deviû
->
of_node
);

918 #ifdeà
CFG_CTS_DEF_CHGR_DET_ENABLE


919 
cd_d©a
->
’abË
 = 
Œue
;

921 
cd_d©a
->
’abË
 = 
çl£
;

924 
cd_d©a
->
ty³
 = 
CFG_CTS_DEF_CHGR_DET_TYPE
;

925 
cd_d©a
->
p¥
 = 
CFG_CTS_DEF_CHGR_DET_PSY_PROP
;

926 
cd_d©a
->
p¥_pŞl_š‹rv®
 = 
CFG_CTS_DEF_CHGR_DET_PSP_POLL_INTERVAL
;

927 
cd_d©a
->
psy_Çme
 = 
	`k¡rdup
(
CFG_CTS_DEF_CHGR_DET_PSY_NAME
, 
GFP_KERNEL
);

928 ià(
cd_d©a
->
psy_Çme
 =ğ
NULL
) {

929 
	`ùs_”r
("Dup…ower supply‚ame failed");

930 
»t
 = -
ENOMEM
;

933 ià(
»t
) {

934 
	`ùs_”r
("G‘ d‘eù…¬am faed %d", 
»t
);

935 
ä“_cd_d©a
;

938 
	`ùs_šfo
("D‘eù: %sABLED", 
cd_d©a
->
’abË
 ? "EN" : "DIS");

939 
	`ùs_šfo
(" Ty³ : %s", 
	`ch¬g”_d‘eù_ty³_¡r
(
cd_d©a
->
ty³
));

940 
	`ùs_šfo
(" PSY Name: %s,…rİ: %d(%s)", 
cd_d©a
->
psy_Çme
,

941 
cd_d©a
->
p¥
, 
	`pow”_suµly_´İ_¡r
(cd_data->psp));

942 
	`ùs_šfo
(" PŞÈIÁ: %dms", 
cd_d©a
->
p¥_pŞl_š‹rv®
);

944 
»t
 = 
	`š™_ch¬g”_d‘eù
(
cd_d©a
);

945 ià(
»t
) {

946 
	`ùs_”r
("In™ d‘eù faed %d", 
»t
);

947 
ä“_psy_Çme
;

950 #ifdeà
CONFIG_CTS_SYSFS


951 
	`ùs_šfo
("C»©sysf ©Œ grou°'%s'", 
CHARGER_DET_SYSFS_GROUP_NAME
);

952 
»t
 = 
	`sysfs_ü—‹_group
(&
ùs_d©a
->
deviû
->
kobj
,

953 &
ch¬g”_d‘eù_©Œ_group
);

954 ià(
»t
) {

955 
	`ùs_w¬n
("C»©sysf ©Œ grou°çed %d", 
»t
);

957 
cd_d©a
->
sysfs_©Œ_group_ü—‹d
 = 
Œue
;

961 
ùs_d©a
->
ch¬g”_d‘eù_d©a
 = 
cd_d©a
;

962 
cd_d©a
->
ùs_d©a
 = cts_data;

966 
ä“_psy_Çme
:

967 
	`kä“
(
cd_d©a
->
psy_Çme
);

968 
ä“_cd_d©a
:

969 
	`kä“
(
cd_d©a
);

971  
»t
;

972 
	}
}

974 
	$ùs_deš™_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

976 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

977 
»t
;

979 
	`ùs_šfo
("Deinit detect");

981 ià(
ùs_d©a
 =ğ
NULL
) {

982 
	`ùs_”r
("Deinit detect with cts_data = NULL");

983  -
EFAULT
;

986 
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

987 ià(
cd_d©a
 =ğ
NULL
) {

988 
	`ùs_w¬n
("Deinit detect with charger_detect_data = NULL");

992 ià(
cd_d©a
->
ruÂšg
) {

993 
»t
 = 
	`¡İ_ch¬g”_d‘eù
(
cd_d©a
);

994 ià(
»t
) {

995 
	`ùs_”r
("Stİ d‘eù faed %d", 
»t
);

999 #ifdeà
CONFIG_CTS_SYSFS


1000 ià(
cd_d©a
->
sysfs_©Œ_group_ü—‹d
) {

1001 
	`ùs_šfo
("Remove sysfs‡ttr group '%s'",

1002 
CHARGER_DET_SYSFS_GROUP_NAME
);

1003 
	`sysfs_»move_group
(&
ùs_d©a
->
deviû
->
kobj
,

1004 &
ch¬g”_d‘eù_©Œ_group
);

1005 
cd_d©a
->
sysfs_©Œ_group_ü—‹d
 = 
çl£
;

1009 ià(
cd_d©a
->
psy_Çme
) {

1010 
	`ùs_šfo
("Kfree…ower supply‚ame");

1011 
	`kä“
(
cd_d©a
->
psy_Çme
);

1012 
cd_d©a
->
psy_Çme
 = 
NULL
;

1015 
	`kä“
(
cd_d©a
);

1016 
ùs_d©a
->
ch¬g”_d‘eù_d©a
 = 
NULL
;

1019 
	}
}

1021 
	$ùs_is_ch¬g”_©ched
(
chÚe_ts_d©a
 *
ùs_d©a
, 
boŞ
 *
©ched
)

1023 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

1024 
»t
;

1026 ià(
ùs_d©a
 =ğ
NULL
) {

1027 
	`ùs_”r
("Get state with cts_data = NULL");

1028  -
EFAULT
;

1031 
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

1032 ià(
cd_d©a
 =ğ
NULL
) {

1033 
	`ùs_”r
("Get state with charger_detect_data = NULL");

1034  -
ENODEV
;

1037 
	`ùs_šfo
("Get state usingype %d(%s)…aram",

1038 
cd_d©a
->
ty³
, 
	`ch¬g”_d‘eù_ty³_¡r
(cd_data->type));

1040 
»t
 = 
	`g‘_ch¬g”_¡©e
(
cd_d©a
);

1041 ià(
»t
) {

1042 
	`ùs_”r
("G‘ s‹ faed %d", 
»t
);

1043  
»t
;

1046 *
©ched
 = 
cd_d©a
->
¡©e
;

1049 
	}
}

1051 
	$ùs_¡¬t_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

1053 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

1055 ià(
ùs_d©a
 =ğ
NULL
) {

1056 
	`ùs_”r
("Start detect with cts_data = NULL");

1057  -
EFAULT
;

1060 
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

1061 ià(
cd_d©a
 =ğ
NULL
) {

1062 
	`ùs_”r
("Start detect with charger_detect_data = NULL");

1063  -
ENODEV
;

1066  
	`¡¬t_ch¬g”_d‘eù
(
cd_d©a
);

1067 
	}
}

1069 
	$ùs_¡İ_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

1071 
ùs_ch¬g”_d‘eù_d©a
 *
cd_d©a
;

1073 ià(
ùs_d©a
 =ğ
NULL
) {

1074 
	`ùs_”r
("Stop detect with cts_data = NULL");

1075  -
EFAULT
;

1078 
cd_d©a
 = 
ùs_d©a
->
ch¬g”_d‘eù_d©a
;

1079 ià(
cd_d©a
 =ğ
NULL
) {

1080 
	`ùs_”r
("Stop detect with charger_detect_data = NULL");

1081  -
ENODEV
;

1084  
	`¡İ_ch¬g”_d‘eù
(
cd_d©a
);

1085 
	}
}

	@cts_charger_detect.h

1 #iâdeà
CTS_CHARGER_DETECT_H


2 
	#CTS_CHARGER_DETECT_H


	)

4 
	~"ùs_cÚfig.h
"

6 
	gchÚe_ts_d©a
;

8 #ifdeà
CONFIG_CTS_CHARGER_DETECT


9 
ùs_š™_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

10 
ùs_deš™_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

11 
ùs_¡¬t_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

12 
ùs_¡İ_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

13 
ùs_is_ch¬g”_©ched
(
chÚe_ts_d©a
 *
ùs_d©a
,

14 
boŞ
 *
©ched
);

16 
šlše
 
	$ùs_ch¬g”_d‘eù_š™
(
chÚe_ts_d©a
 *
ùs_d©a
)

18  -
ENOTSUPP
;

19 
	}
}

20 
šlše
 
	$ùs_ch¬g”_d‘eù_deš™
(
chÚe_ts_d©a
 *
ùs_d©a
)

22  -
ENOTSUPP
;

23 
	}
}

24 
šlše
 
	$ùs_¡¬t_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

26  -
ENODEV
;

27 
	}
}

28 
šlše
 
	$ùs_¡İ_ch¬g”_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

30  -
ENODEV
;

31 
	}
}

32 
šlše
 
	$ùs_is_ch¬g”_©ched
(
chÚe_ts_d©a
 *
ùs_d©a
,

33 
boŞ
 *
©ched
)

35  -
ENODEV
;

36 
	}
}

	@cts_config.h

1 #iâdeà
CTS_CONFIG_H


2 
	#CTS_CONFIG_H


	)

5 
	#CFG_CTS_DRIVER_MAJOR_VERSION
 1

	)

6 
	#CFG_CTS_DRIVER_MINOR_VERSION
 3

	)

7 
	#CFG_CTS_DRIVER_PATCH_VERSION
 1

	)

9 
	#CFG_CTS_DRIVER_VERSION
 "v1.3.1"

	)

12 
	#CFG_CTS_HAS_RESET_PIN


	)

15 #iâdeà
CONFIG_CTS_I2C_HOST


17 #iâdeà
CFG_CTS_HAS_RESET_PIN


18 
	#CFG_CTS_HAS_RESET_PIN


	)

21 
	#CFG_CTS_SPI_SPEED_KHZ
 4000

	)

25 
	#CFG_CTS_FORCE_UP


	)

33 
	#CFG_CTS_DRIVER_BUILTIN_FIRMWARE


	)

34 
	#CFG_CTS_FIRMWARE_IN_FS


	)

35 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


36 
	#CFG_CTS_FIRMWARE_FILENAME
 "ICNL9911.bš"

	)

37 
	#CFG_CTS_FIRMWARE_FILEPATH
 "/‘c/fœmw¬e/ICNL9911.bš"

	)

40 #ifdeà
CONFIG_PROC_FS


42 
	#CONFIG_CTS_LEGACY_TOOL


	)

45 #ifdeà
CONFIG_SYSFS


47 
	#CONFIG_CTS_SYSFS


	)

50 
	#CFG_CTS_MAX_TOUCH_NUM
 (10)

	)

54 #ifdeà
CONFIG_CTS_VIRTUALKEY


55 
	#CFG_CTS_MAX_VKEY_NUM
 (4)

	)

56 
	#CFG_CTS_NUM_VKEY
 (3)

	)

57 
	#CFG_CTS_VKEY_KEYCODES
 {
KEY_BACK
, 
KEY_HOME
, 
KEY_MENU
}

	)

62 #ifdeà
CFG_CTS_GESTURE


63 
	#GESTURE_UP
 0x11

	)

64 
	#GESTURE_C
 0x12

	)

65 
	#GESTURE_O
 0x13

	)

66 
	#GESTURE_M
 0x14

	)

67 
	#GESTURE_W
 0x15

	)

68 
	#GESTURE_E
 0x16

	)

69 
	#GESTURE_S
 0x17

	)

70 
	#GESTURE_Z
 0x1d

	)

71 
	#GESTURE_V
 0x1e

	)

72 
	#GESTURE_D_TAP
 0x50

	)

73 
	#GESTURE_DOWN
 0x22

	)

74 
	#GESTURE_LEFT
 0x23

	)

75 
	#GESTURE_RIGHT
 0x24

	)

77 
	#CFG_CTS_NUM_GESTURE
 (13u)

	)

78 
	#CFG_CTS_GESTURE_REPORT_KEY


	)

79 
	#CFG_CTS_GESTURE_KEYMAP
 \

80 {{
GESTURE_C
, 
KEY_C
,}, \

81 {
GESTURE_W
, 
KEY_W
,}, \

82 {
GESTURE_V
, 
KEY_V
,}, \

83 {
GESTURE_D_TAP
, 
KEY_F1
,}, \

84 {
GESTURE_Z
, 
KEY_Z
,}, \

85 {
GESTURE_M
, 
KEY_M
,}, \

86 {
GESTURE_O
, 
KEY_O
,}, \

87 {
GESTURE_E
, 
KEY_E
,}, \

88 {
GESTURE_S
, 
KEY_S
,}, \

89 {
GESTURE_UP
, 
KEY_UP
,}, \

90 {
GESTURE_DOWN
, 
KEY_DOWN
,}, \

91 {
GESTURE_LEFT
, 
KEY_LEFT
,}, \

92 {
GESTURE_RIGHT
, 
KEY_RIGHT
,}, \

93 }

	)

94 
	#CFG_CTS_GESTURE_REPORT_TRACE
 0

	)

99 
	#CONFIG_CTS_CHARGER_DETECT


	)

101 
	#CONFIG_CTS_EARJACK_DETECT


	)

106 #ifdeà
CONFIG_CTS_ESD_PROTECTION


107 
	#CFG_CTS_ESD_PROTECTION_CHECK_PERIOD
 (2 * 
HZ
)

	)

108 
	#CFG_CTS_ESD_FAILED_CONFIRM_CNT
 3

	)

112 
	#CONFIG_CTS_SLOTPROTOCOL


	)

114 #ifdeà
CONFIG_CTS_LEGACY_TOOL


115 
	#CFG_CTS_TOOL_PROC_FILENAME
 "iú85xx_toŞ"

	)

118 
	#CFG_CTS_UPDATE_CRCCHECK


	)

123 
	~"ùs_¶©_qcom_cÚfig.h
"

	@cts_core.c

1 
	#LOG_TAG
 "CÜe"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sfù¾.h
"

7 
	~"ùs_¥i_æash.h
"

8 
	~"ùs_fœmw¬e.h
"

9 
	~"ùs_ch¬g”_d‘eù.h
"

10 
	~"ùs_—rjack_d‘eù.h
"

12 #ifdeà
CONFIG_CTS_I2C_HOST


13 
	$ùs_i2c_wr™eb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

14 
u32
 
addr
, 
u8
 
b
, 
»Œy
, 
d–ay
)

16 
u8
 
buff
[8];

18 
	`ùs_dbg
("Writeo slave_addr: 0x%02x„eg: 0x%0*x val: 0x%02x",

19 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
, 
b
);

21 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

22 
	`put_uÇligÃd_be16
(
addr
, 
buff
);

23 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

24 
	`put_uÇligÃd_be24
(
addr
, 
buff
);

26 
	`ùs_”r
("Writeb invalid‡ddress width %u",

27 
ùs_dev
->
¹d©a
.
addr_width
);

28  -
EINVAL
;

30 
buff
[
ùs_dev
->
¹d©a
.
addr_width
] = 
b
;

32  
	`ùs_¶©_i2c_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

33 
buff
, 
ùs_dev
->
¹d©a
.
addr_width
 + 1, 
»Œy
 ,
d–ay
);

34 
	}
}

36 
	$ùs_i2c_wr™ew
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

37 
u32
 
addr
, 
u16
 
w
, 
»Œy
, 
d–ay
)

39 
u8
 
buff
[8];

41 
	`ùs_dbg
("Writeo slave_addr: 0x%02x„eg: 0x%0*x val: 0x%04x",

42 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
, 
w
);

44 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

45 
	`put_uÇligÃd_be16
(
addr
, 
buff
);

46 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

47 
	`put_uÇligÃd_be24
(
addr
, 
buff
);

49 
	`ùs_”r
("Writew invalid‡ddress width %u",

50 
ùs_dev
->
¹d©a
.
addr_width
);

51  -
EINVAL
;

54 
	`put_uÇligÃd_Ë16
(
w
, 
buff
 + 
ùs_dev
->
¹d©a
.
addr_width
);

56  
	`ùs_¶©_i2c_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

57 
buff
, 
ùs_dev
->
¹d©a
.
addr_width
 + 2, 
»Œy
, 
d–ay
);

58 
	}
}

60 
	$ùs_i2c_wr™–
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

61 
u32
 
addr
, u32 
l
, 
»Œy
, 
d–ay
)

63 
u8
 
buff
[8];

65 
	`ùs_dbg
("Writeo slave_addr: 0x%02x„eg: 0x%0*x val: 0x%08x",

66 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
, 
l
);

68 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

69 
	`put_uÇligÃd_be16
(
addr
, 
buff
);

70 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

71 
	`put_uÇligÃd_be24
(
addr
, 
buff
);

73 
	`ùs_”r
("Writel invalid‡ddress width %u",

74 
ùs_dev
->
¹d©a
.
addr_width
);

75  -
EINVAL
;

78 
	`put_uÇligÃd_Ë32
(
l
, 
buff
 + 
ùs_dev
->
¹d©a
.
addr_width
);

80  
	`ùs_¶©_i2c_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

81 
buff
, 
ùs_dev
->
¹d©a
.
addr_width
 + 4, 
»Œy
, 
d–ay
);

82 
	}
}

84 
	$ùs_i2c_wr™esb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
,

85 cÚ¡ 
u8
 *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

87 
»t
;

88 
u8
 *
d©a
;

89 
size_t
 
max_xãr_size
;

90 
size_t
 
·ylßd_Ën
;

91 
size_t
 
xãr_Ën
;

93 
	`ùs_dbg
("Writeo slave_addr: 0x%02x„eg: 0x%0*x†en: %zu",

94 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
, 
Ën
);

96 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_i2c_xãr_size
(
ùs_dev
->
pd©a
);

97 
d©a
 = 
	`ùs_¶©_g‘_i2c_xãr_buf
(
ùs_dev
->
pd©a
, 
Ën
);

98 
Ën
) {

99 
·ylßd_Ën
 =

100 
	`mš
((
size_t
)(
max_xãr_size
 - 
ùs_dev
->
¹d©a
.
addr_width
), 
Ën
);

101 
xãr_Ën
 = 
·ylßd_Ën
 + 
ùs_dev
->
¹d©a
.
addr_width
;

103 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

104 
	`put_uÇligÃd_be16
(
addr
, 
d©a
);

105 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

106 
	`put_uÇligÃd_be24
(
addr
, 
d©a
);

108 
	`ùs_”r
("Writesb invalid‡ddress width %u",

109 
ùs_dev
->
¹d©a
.
addr_width
);

110  -
EINVAL
;

113 
	`memıy
(
d©a
 + 
ùs_dev
->
¹d©a
.
addr_width
, 
¤c
, 
·ylßd_Ën
);

115 
»t
 = 
	`ùs_¶©_i2c_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

116 
d©a
, 
xãr_Ën
, 
»Œy
, 
d–ay
);

117 ià(
»t
) {

118 
	`ùs_”r
("PÏtfÜm i2øwr™çed %d", 
»t
);

119  
»t
;

122 
¤c
 +ğ
·ylßd_Ën
;

123 
Ën
 -ğ
·ylßd_Ën
;

124 
addr
 +ğ
·ylßd_Ën
;

128 
	}
}

130 
	$ùs_i2c_»adb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

131 
u32
 
addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
)

133 
u8
 
addr_buf
[4];

135 
	`ùs_dbg
("Readb from slave_addr: 0x%02x„eg: 0x%0*x",

136 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
);

138 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

139 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

140 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

141 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

143 
	`ùs_”r
("Readb invalid‡ddress width %u",

144 
ùs_dev
->
¹d©a
.
addr_width
);

145  -
EINVAL
;

148  
	`ùs_¶©_i2c_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

149 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
b
, 1, 
»Œy
, 
d–ay
);

150 
	}
}

152 
	$ùs_i2c_»adw
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

153 
u32
 
addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
)

155 
»t
;

156 
u8
 
addr_buf
[4];

157 
u8
 
buff
[2];

159 
	`ùs_dbg
("Readw from slave_addr: 0x%02x„eg: 0x%0*x",

160 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
);

162 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

163 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

164 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

165 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

167 
	`ùs_”r
("Readw invalid‡ddress width %u",

168 
ùs_dev
->
¹d©a
.
addr_width
);

169  -
EINVAL
;

172 
»t
 = 
	`ùs_¶©_i2c_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

173 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
buff
, 2, 
»Œy
, 
d–ay
);

174 ià(
»t
 == 0) {

175 *
w
 = 
	`g‘_uÇligÃd_Ë16
(
buff
);

178  
»t
;

179 
	}
}

181 
	$ùs_i2c_»adl
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

182 
u32
 
addr
, u32 *
l
, 
»Œy
, 
d–ay
)

184 
»t
;

185 
u8
 
addr_buf
[4];

186 
u8
 
buff
[4];

188 
	`ùs_dbg
("Readl from slave_addr: 0x%02x„eg: 0x%0*x",

189 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
);

191 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

192 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

193 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

194 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

196 
	`ùs_”r
("Readl invalid‡ddress width %u",

197 
ùs_dev
->
¹d©a
.
addr_width
);

198  -
EINVAL
;

201 
»t
 = 
	`ùs_¶©_i2c_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

202 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
buff
, 4, 
»Œy
, 
d–ay
);

203 ià(
»t
 == 0) {

204 *
l
 = 
	`g‘_uÇligÃd_Ë32
(
buff
);

207  
»t
;

208 
	}
}

210 
	$ùs_i2c_»adsb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

211 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

213 
»t
;

214 
u8
 
addr_buf
[4];

215 
size_t
 
max_xãr_size
, 
xãr_Ën
;

217 
	`ùs_dbg
("Readsb from slave_addr: 0x%02x„eg: 0x%0*x†en: %zu",

218 
ùs_dev
->
¹d©a
.
¦ave_addr
, cts_dev->¹d©a.
addr_width
 * 2, 
addr
, 
Ën
);

220 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_i2c_xãr_size
(
ùs_dev
->
pd©a
);

221 
Ën
) {

222 
xãr_Ën
 = 
	`mš
(
max_xãr_size
, 
Ën
);

224 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

225 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

226 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

227 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

229 
	`ùs_”r
("Readsb invalid‡ddress width %u",

230 
ùs_dev
->
¹d©a
.
addr_width
);

231  -
EINVAL
;

234 
»t
 = 
	`ùs_¶©_i2c_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

235 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
d¡
, 
xãr_Ën
, 
»Œy
, 
d–ay
);

236 ià(
»t
) {

237 
	`ùs_”r
("PÏtfÜm i2ø»ad faed %d", 
»t
);

238  
»t
;

241 
d¡
 +ğ
xãr_Ën
;

242 
Ën
 -ğ
xãr_Ën
;

243 
addr
 +ğ
xãr_Ën
;

247 
	}
}

249 
	$ùs_¥i_wr™eb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

250 
u32
 
addr
, 
u8
 
b
, 
»Œy
, 
d–ay
)

252 
u8
 
buff
[8];

257 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

258 
	`put_uÇligÃd_be16
(
addr
, 
buff
);

259 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

260 
	`put_uÇligÃd_be24
(
addr
, 
buff
);

262 
	`ùs_”r
("Writeb invalid‡ddress width %u",

263 
ùs_dev
->
¹d©a
.
addr_width
);

264  -
EINVAL
;

266 
buff
[
ùs_dev
->
¹d©a
.
addr_width
] = 
b
;

268  
	`ùs_¶©_¥i_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
, 
buff
,

269 
ùs_dev
->
¹d©a
.
addr_width
 + 1, 
»Œy
 ,
d–ay
);

271 
	}
}

273 
	$ùs_¥i_wr™ew
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

274 
u32
 
addr
, 
u16
 
w
, 
»Œy
, 
d–ay
)

276 
u8
 
buff
[8];

281 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

282 
	`put_uÇligÃd_be16
(
addr
, 
buff
);

283 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

284 
	`put_uÇligÃd_be24
(
addr
, 
buff
);

286 
	`ùs_”r
("Writew invalid‡ddress width %u",

287 
ùs_dev
->
¹d©a
.
addr_width
);

288  -
EINVAL
;

291 
	`put_uÇligÃd_Ë16
(
w
, 
buff
 + 
ùs_dev
->
¹d©a
.
addr_width
);

293  
	`ùs_¶©_¥i_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

294 
buff
, 
ùs_dev
->
¹d©a
.
addr_width
 + 2, 
»Œy
, 
d–ay
);

296 
	}
}

298 
	$ùs_¥i_wr™–
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

299 
u32
 
addr
, u32 
l
, 
»Œy
, 
d–ay
)

301 
u8
 
buff
[8];

306 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

307 
	`put_uÇligÃd_be16
(
addr
, 
buff
);

308 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

309 
	`put_uÇligÃd_be24
(
addr
, 
buff
);

311 
	`ùs_”r
("Writel invalid‡ddress width %u",

312 
ùs_dev
->
¹d©a
.
addr_width
);

313  -
EINVAL
;

316 
	`put_uÇligÃd_Ë32
(
l
, 
buff
 + 
ùs_dev
->
¹d©a
.
addr_width
);

318  
	`ùs_¶©_¥i_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

319 
buff
, 
ùs_dev
->
¹d©a
.
addr_width
 + 4, 
»Œy
, 
d–ay
);

321 
	}
}

323 
	$ùs_¥i_wr™esb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
,

324 cÚ¡ 
u8
 *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

327 
»t
;

328 
u8
 *
d©a
;

329 
size_t
 
max_xãr_size
;

330 
size_t
 
·ylßd_Ën
;

331 
size_t
 
xãr_Ën
;

336 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_¥i_xãr_size
(
ùs_dev
->
pd©a
);

337 
d©a
 = 
	`ùs_¶©_g‘_¥i_xãr_buf
(
ùs_dev
->
pd©a
, 
Ën
);

338 
Ën
) {

339 
·ylßd_Ën
 =

340 
	`mš
((
size_t
)(
max_xãr_size
 - 
ùs_dev
->
¹d©a
.
addr_width
), 
Ën
);

341 
xãr_Ën
 = 
·ylßd_Ën
 + 
ùs_dev
->
¹d©a
.
addr_width
;

343 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

344 
	`put_uÇligÃd_be16
(
addr
, 
d©a
);

345 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

346 
	`put_uÇligÃd_be24
(
addr
, 
d©a
);

348 
	`ùs_”r
("Writesb invalid‡ddress width %u",

349 
ùs_dev
->
¹d©a
.
addr_width
);

350  -
EINVAL
;

353 
	`memıy
(
d©a
 + 
ùs_dev
->
¹d©a
.
addr_width
, 
¤c
, 
·ylßd_Ën
);

355 
»t
 = 
	`ùs_¶©_¥i_wr™e
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

356 
d©a
, 
xãr_Ën
, 
»Œy
, 
d–ay
);

357 ià(
»t
) {

358 
	`ùs_”r
("PÏtfÜm i2øwr™çed %d", 
»t
);

359  
»t
;

362 
¤c
 +ğ
·ylßd_Ën
;

363 
Ën
 -ğ
·ylßd_Ën
;

364 
addr
 +ğ
·ylßd_Ën
;

368 
	}
}

370 
	$ùs_¥i_»adb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

371 
u32
 
addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
)

373 
u8
 
addr_buf
[4];

378 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

379 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

380 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

381 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

383 
	`ùs_”r
("Readb invalid‡ddress width %u",

384 
ùs_dev
->
¹d©a
.
addr_width
);

385  -
EINVAL
;

388  
	`ùs_¶©_¥i_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

389 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
b
, 1, 
»Œy
, 
d–ay
);

390 
	}
}

392 
	$ùs_¥i_»adw
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

393 
u32
 
addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
)

395 
»t
;

396 
u8
 
addr_buf
[4];

397 
u8
 
buff
[2];

402 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

403 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

404 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

405 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

407 
	`ùs_”r
("Readw invalid‡ddress width %u",

408 
ùs_dev
->
¹d©a
.
addr_width
);

409  -
EINVAL
;

412 
»t
 = 
	`ùs_¶©_¥i_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

413 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
buff
, 2, 
»Œy
, 
d–ay
);

414 ià(
»t
 == 0) {

415 *
w
 = 
	`g‘_uÇligÃd_Ë16
(
buff
);

418  
»t
;

419 
	}
}

421 
	$ùs_¥i_»adl
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

422 
u32
 
addr
, u32 *
l
, 
»Œy
, 
d–ay
)

424 
»t
;

425 
u8
 
addr_buf
[4];

426 
u8
 
buff
[4];

431 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

432 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

433 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

434 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

436 
	`ùs_”r
("Readl invalid‡ddress width %u",

437 
ùs_dev
->
¹d©a
.
addr_width
);

438  -
EINVAL
;

441 
»t
 = 
	`ùs_¶©_¥i_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

442 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
buff
, 4, 
»Œy
, 
d–ay
);

443 ià(
»t
 == 0) {

444 *
l
 = 
	`g‘_uÇligÃd_Ë32
(
buff
);

447  
»t
;

449 
	}
}

451 
	$ùs_¥i_»adsb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

452 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

454 
»t
;

455 
u8
 
addr_buf
[4];

456 
size_t
 
max_xãr_size
, 
xãr_Ën
;

461 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_¥i_xãr_size
(
ùs_dev
->
pd©a
);

462 
Ën
) {

463 
xãr_Ën
 = 
	`mš
(
max_xãr_size
, 
Ën
);

465 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

466 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

467 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

468 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

470 
	`ùs_”r
("Readsb invalid‡ddress width %u",

471 
ùs_dev
->
¹d©a
.
addr_width
);

472  -
EINVAL
;

475 
»t
 = 
	`ùs_¶©_¥i_»ad
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

476 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
d¡
, 
xãr_Ën
, 
»Œy
, 
d–ay
);

477 ià(
»t
) {

478 
	`ùs_”r
("PÏtfÜm i2ø»ad faed %d", 
»t
);

479  
»t
;

482 
d¡
 +ğ
xãr_Ën
;

483 
Ën
 -ğ
xãr_Ën
;

484 
addr
 +ğ
xãr_Ën
;

487 
	}
}

489 
	$ùs_¥i_»adsb_d–ay_idË
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

490 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
, 
idË
)

492 
»t
;

493 
u8
 
addr_buf
[4];

494 
size_t
 
max_xãr_size
, 
xãr_Ën
;

499 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_¥i_xãr_size
(
ùs_dev
->
pd©a
);

500 
Ën
) {

501 
xãr_Ën
 = 
	`mš
(
max_xãr_size
, 
Ën
);

503 ià(
ùs_dev
->
¹d©a
.
addr_width
 == 2) {

504 
	`put_uÇligÃd_be16
(
addr
, 
addr_buf
);

505 } ià(
ùs_dev
->
¹d©a
.
addr_width
 == 3) {

506 
	`put_uÇligÃd_be24
(
addr
, 
addr_buf
);

508 
	`ùs_”r
("Readsb invalid‡ddress width %u",

509 
ùs_dev
->
¹d©a
.
addr_width
);

510  -
EINVAL
;

513 
»t
 = 
	`ùs_¶©_¥i_»ad_d–ay_idË
(
ùs_dev
->
pd©a
, cts_dev->
¹d©a
.
¦ave_addr
,

514 
addr_buf
, 
ùs_dev
->
¹d©a
.
addr_width
, 
d¡
, 
xãr_Ën
, 
»Œy
, 
d–ay
, 
idË
);

515 ià(
»t
) {

516 
	`ùs_”r
("PÏtfÜm i2ø»ad faed %d", 
»t
);

517  
»t
;

520 
d¡
 +ğ
xãr_Ën
;

521 
Ën
 -ğ
xãr_Ën
;

522 
addr
 +ğ
xãr_Ën
;

525 
	}
}

529 
šlše
 
	$ùs_dev_wr™eb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

530 
u32
 
addr
, 
u8
 
b
, 
»Œy
, 
d–ay
)

532 #ifdeà
CONFIG_CTS_I2C_HOST


533  
	`ùs_i2c_wr™eb
(
ùs_dev
, 
addr
, 
b
, 
»Œy
, 
d–ay
);

535  
	`ùs_¥i_wr™eb
(
ùs_dev
, 
addr
, 
b
, 
»Œy
, 
d–ay
);

537 
	}
}

539 
šlše
 
	$ùs_dev_wr™ew
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

540 
u32
 
addr
, 
u16
 
w
, 
»Œy
, 
d–ay
)

542 #ifdeà
CONFIG_CTS_I2C_HOST


543  
	`ùs_i2c_wr™ew
(
ùs_dev
, 
addr
, 
w
, 
»Œy
, 
d–ay
);

545  
	`ùs_¥i_wr™ew
(
ùs_dev
, 
addr
, 
w
, 
»Œy
, 
d–ay
);

547 
	}
}

549 
šlše
 
	$ùs_dev_wr™–
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

550 
u32
 
addr
, u32 
l
, 
»Œy
, 
d–ay
)

552 #ifdeà
CONFIG_CTS_I2C_HOST


553  
	`ùs_i2c_wr™–
(
ùs_dev
, 
addr
, 
l
, 
»Œy
, 
d–ay
);

555  
	`ùs_¥i_wr™–
(
ùs_dev
, 
addr
, 
l
, 
»Œy
, 
d–ay
);

557 
	}
}

559 
šlše
 
	$ùs_dev_wr™esb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
,

560 cÚ¡ 
u8
 *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

562 #ifdeà
CONFIG_CTS_I2C_HOST


563  
	`ùs_i2c_wr™esb
(
ùs_dev
, 
addr
, 
¤c
, 
Ën
, 
»Œy
, 
d–ay
);

565  
	`ùs_¥i_wr™esb
(
ùs_dev
, 
addr
, 
¤c
, 
Ën
, 
»Œy
, 
d–ay
);

567 
	}
}

569 
šlše
 
	$ùs_dev_»adb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

570 
u32
 
addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
)

572 #ifdeà
CONFIG_CTS_I2C_HOST


573  
	`ùs_i2c_»adb
(
ùs_dev
, 
addr
, 
b
, 
»Œy
, 
d–ay
);

575  
	`ùs_¥i_»adb
(
ùs_dev
, 
addr
, 
b
, 
»Œy
, 
d–ay
);

577 
	}
}

579 
šlše
 
	$ùs_dev_»adw
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

580 
u32
 
addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
)

582 #ifdeà
CONFIG_CTS_I2C_HOST


583  
	`ùs_i2c_»adw
(
ùs_dev
, 
addr
, 
w
, 
»Œy
, 
d–ay
);

585  
	`ùs_¥i_»adw
(
ùs_dev
, 
addr
, 
w
, 
»Œy
, 
d–ay
);;

587 
	}
}

589 
šlše
 
	$ùs_dev_»adl
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

590 
u32
 
addr
, u32 *
l
, 
»Œy
, 
d–ay
)

592 #ifdeà
CONFIG_CTS_I2C_HOST


593  
	`ùs_i2c_»adl
(
ùs_dev
, 
addr
, 
l
, 
»Œy
, 
d–ay
);

595  
	`ùs_¥i_»adl
(
ùs_dev
, 
addr
, 
l
, 
»Œy
, 
d–ay
);

597 
	}
}

599 
šlše
 
	$ùs_dev_»adsb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

600 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

602 #ifdeà
CONFIG_CTS_I2C_HOST


603  
	`ùs_i2c_»adsb
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

605  
	`ùs_¥i_»adsb
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

607 
	}
}

609 
šlše
 
	$ùs_dev_»adsb_d–ay_idË
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

610 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
, 
idË
)

612 #ifdeà
CONFIG_CTS_I2C_HOST


613  
	`ùs_i2c_»adsb
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

615  
	`ùs_¥i_»adsb_d–ay_idË
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
, 
idË
);

617 
	}
}

620 #ifdeà
CFG_CTS_UPDATE_CRCCHECK


621 
	$ùs_¤am_wr™esb_boÙ_üc_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

622 
size_t
 
Ën
, 
u32
 
üc
, 
»Œy
)

624 
»t
 = 0, 
»Œ›s
;

626 
»Œ›s
 = 0;

628 ià((
»t
 = 
	`ùs_dev_wr™–
(
ùs_dev
, 0x015ff0, 0xCC33555A, 3, 1)) != 0) {

629 
	`ùs_”r
("SRAM wr™esb faed %d", 
»t
);

633 ià((
»t
 = 
	`ùs_dev_wr™–
(
ùs_dev
, 0x08fffc, 
üc
, 3, 1)) != 0) {

634 
	`ùs_”r
("SRAM wr™esb faed %d", 
»t
);

638 ià((
»t
 = 
	`ùs_dev_wr™–
(
ùs_dev
, 0x08fff8, 
Ën
, 3, 1)) != 0) {

639 
	`ùs_”r
("SRAM wr™esb faed %d", 
»t
);

644 }
»Œ›s
++ < 
»Œy
);

646  
»t
;

647 
	}
}

650 
	$ùs_wr™e_¤am_nÜm®_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

651 
u32
 
addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

653 
i
, 
»t
;

654 
u8
 
buff
[5];

656 
i
 = 0; i < 
Ën
; i++) {

657 
	`put_uÇligÃd_Ë32
(
addr
, 
buff
);

658 
buff
[4] = *(
u8
 *)
¤c
;

660 
addr
++;

661 
¤c
++;

663 
»t
 = 
	`ùs_dev_wr™esb
(
ùs_dev
,

664 
CTS_DEVICE_FW_REG_DEBUG_INTF
, 
buff
, 5, 
»Œy
, 
d–ay
);

665 ià(
»t
) {

666 
	`ùs_”r
("Write„DEBUG_INTF†en=5B failed %d",

667 
»t
);

668  
»t
;

673 
	}
}

675 
	$ùs_¤am_wr™eb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

676 
u32
 
addr
, 
u8
 
b
, 
»Œy
, 
d–ay
)

678 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

679  
	`ùs_dev_wr™eb
(
ùs_dev
, 
addr
, 
b
, 
»Œy
, 
d–ay
);

681  
	`ùs_wr™e_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, &
b
, 1, 
»Œy
, 
d–ay
);

683 
	}
}

685 
	$ùs_¤am_wr™ew_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

686 
u32
 
addr
, 
u16
 
w
, 
»Œy
, 
d–ay
)

688 
u8
 
buff
[2];

690 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

691  
	`ùs_dev_wr™ew
(
ùs_dev
, 
addr
, 
w
, 
»Œy
, 
d–ay
);

693 
	`put_uÇligÃd_Ë16
(
w
, 
buff
);

695  
	`ùs_wr™e_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
buff
, 2, 
»Œy
, 
d–ay
);

697 
	}
}

699 
	$ùs_¤am_wr™–_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

700 
u32
 
addr
, u32 
l
, 
»Œy
, 
d–ay
)

702 
u8
 
buff
[4];

704 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

705  
	`ùs_dev_wr™–
(
ùs_dev
, 
addr
, 
l
, 
»Œy
, 
d–ay
);

707 
	`put_uÇligÃd_Ë32
(
l
, 
buff
);

709  
	`ùs_wr™e_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
buff
, 4, 
»Œy
, 
d–ay
);

711 
	}
}

713 
	$ùs_¤am_wr™esb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

714 
u32
 
addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

716 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

717  
	`ùs_dev_wr™esb
(
ùs_dev
, 
addr
, 
¤c
, 
Ën
, 
»Œy
, 
d–ay
);

719  
	`ùs_wr™e_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
¤c
, 
Ën
, 
»Œy
, 
d–ay
);

721 
	}
}

723 
	$ùs_ÿlc_¤am_üc
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

724 
u32
 
¤am_addr
, 
size_t
 
size
, u32 *
üc
)

726 
	`ùs_šfo
("C®øüøäom s¿m 0x%06x siz%zu", 
¤am_addr
, 
size
);

728  
ùs_dev
->
hwd©a
->
sfù¾
->
İs
->
	`ÿlc_¤am_üc
(cts_dev,

729 
¤am_addr
, 
size
, 
üc
);

730 
	}
}

732 
	$ùs_¤am_wr™esb_check_üc_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

733 
u32
 
addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, u32 
üc
, 
»Œy
)

735 
»t
, 
»Œ›s
;

737 
»Œ›s
 = 0;

739 
u32
 
üc_¤am
;

741 
»Œ›s
++;

743 ià((
»t
 = 
	`ùs_¤am_wr™esb
(
ùs_dev
, 0, 
¤c
, 
Ën
)) != 0) {

744 
	`ùs_”r
("SRAM wr™esb faed %d", 
»t
);

748 ià((
»t
 = 
	`ùs_ÿlc_¤am_üc
(
ùs_dev
, 0, 
Ën
, &
üc_¤am
)) != 0) {

749 
	`ùs_”r
("Get CRC for sram writesb failed %d„etries %d",

750 
»t
, 
»Œ›s
);

754 ià(
üc
 =ğ
üc_¤am
) {

758 
	`ùs_”r
("Check CRC for sram writesb mismatch %x != %x„etries %d",

759 
üc
, 
üc_¤am
, 
»Œ›s
);

760 
»t
 = -
EFAULT
;

761 }
»Œ›s
 < 
»Œy
);

763  
»t
;

764 
	}
}

766 
	$ùs_»ad_¤am_nÜm®_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

767 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

769 
i
, 
»t
;

771 
i
 = 0; i < 
Ën
; i++) {

772 
»t
 = 
	`ùs_dev_wr™–
(
ùs_dev
,

773 
CTS_DEVICE_FW_REG_DEBUG_INTF
, 
addr
, 
»Œy
, 
d–ay
);

774 ià(
»t
) {

775 
	`ùs_”r
("Wr™add¸tØrDEBUG_INTF faed %d", 
»t
);

776  
»t
;

779 
»t
 = 
	`ùs_dev_»adb
(
ùs_dev
,

780 
CTS_DEVICE_FW_REG_DEBUG_INTF
 + 4, (
u8
 *)
d¡
, 
»Œy
, 
d–ay
);

781 ià(
»t
) {

782 
	`ùs_”r
("Read value from„DEBUG_INTF + 4 failed %d",

783 
»t
);

784  
»t
;

787 
addr
++;

788 
d¡
++;

792 
	}
}

794 
	$ùs_¤am_»adb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

795 
u32
 
addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
)

797 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

798  
	`ùs_dev_»adb
(
ùs_dev
, 
addr
, 
b
, 
»Œy
, 
d–ay
);

800  
	`ùs_»ad_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
b
, 1, 
»Œy
, 
d–ay
);

802 
	}
}

804 
	$ùs_¤am_»adw_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

805 
u32
 
addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
)

807 
»t
;

808 
u8
 
buff
[2];

810 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

811  
	`ùs_dev_»adw
(
ùs_dev
, 
addr
, 
w
, 
»Œy
, 
d–ay
);

813 
»t
 = 
	`ùs_»ad_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
buff
, 2, 
»Œy
, 
d–ay
);

814 ià(
»t
) {

815 
	`ùs_”r
("SRAM„—dw iÀnÜm® modçed %d", 
»t
);

816  
»t
;

819 *
w
 = 
	`g‘_uÇligÃd_Ë16
(
buff
);

823 
	}
}

825 
	$ùs_¤am_»adl_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

826 
u32
 
addr
, u32 *
l
, 
»Œy
, 
d–ay
)

828 
»t
;

829 
u8
 
buff
[4];

831 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

832  
	`ùs_dev_»adl
(
ùs_dev
, 
addr
, 
l
, 
»Œy
, 
d–ay
);

834 
»t
 = 
	`ùs_»ad_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
buff
, 4, 
»Œy
, 
d–ay
);

835 ià(
»t
) {

836 
	`ùs_”r
("SRAM„—dÈš‚Üm® modçed %d", 
»t
);

837  
»t
;

840 *
l
 = 
	`g‘_uÇligÃd_Ë32
(
buff
);

844 
	}
}

846 
	$ùs_¤am_»adsb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

847 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

849 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

850  
	`ùs_dev_»adsb
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

852  
	`ùs_»ad_¤am_nÜm®_mode
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

854 
	}
}

856 
	$ùs_fw_»g_wr™eb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

857 
u32
 
»g_addr
, 
u8
 
b
, 
»Œy
, 
d–ay
)

859 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

860 
	`ùs_”r
("Wr™ebØfw„eg 0x%04x und”…rog¿m mode", 
»g_addr
);

861  -
ENODEV
;

864  
	`ùs_dev_wr™eb
(
ùs_dev
, 
»g_addr
, 
b
, 
»Œy
, 
d–ay
);

865 
	}
}

867 
	$ùs_fw_»g_wr™ew_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

868 
u32
 
»g_addr
, 
u16
 
w
, 
»Œy
, 
d–ay
)

870 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

871 
	`ùs_”r
("Wr™ewØfw„eg 0x%04x und”…rog¿m mode", 
»g_addr
);

872  -
ENODEV
;

875  
	`ùs_dev_wr™ew
(
ùs_dev
, 
»g_addr
, 
w
, 
»Œy
, 
d–ay
);

876 
	}
}

878 
	$ùs_fw_»g_wr™–_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

879 
u32
 
»g_addr
, u32 
l
, 
»Œy
, 
d–ay
)

881 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

882 
	`ùs_”r
("Wr™–Øfw„eg 0x%04x und”…rog¿m mode", 
»g_addr
);

883  -
ENODEV
;

886  
	`ùs_dev_wr™–
(
ùs_dev
, 
»g_addr
, 
l
, 
»Œy
, 
d–ay
);

887 
	}
}

889 
	$ùs_fw_»g_wr™esb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

890 
u32
 
»g_addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

892 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

893 
	`ùs_”r
("Wr™esbØfw„eg 0x%04x und”…rog¿m mode", 
»g_addr
);

894  -
ENODEV
;

897  
	`ùs_dev_wr™esb
(
ùs_dev
, 
»g_addr
, 
¤c
, 
Ën
, 
»Œy
, 
d–ay
);

898 
	}
}

900 
	$ùs_fw_»g_»adb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

901 
u32
 
»g_addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
)

903 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

904 
	`ùs_”r
("Readb from fw„eg under…rogram mode");

905  -
ENODEV
;

908  
	`ùs_dev_»adb
(
ùs_dev
, 
»g_addr
, 
b
, 
»Œy
, 
d–ay
);

909 
	}
}

911 
	$ùs_fw_»g_»adw_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

912 
u32
 
»g_addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
)

914 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

915 
	`ùs_”r
("Readw from fw„eg under…rogram mode");

916  -
ENODEV
;

919  
	`ùs_dev_»adw
(
ùs_dev
, 
»g_addr
, 
w
, 
»Œy
, 
d–ay
);

920 
	}
}

922 
	$ùs_fw_»g_»adl_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

923 
u32
 
»g_addr
, u32 *
l
, 
»Œy
, 
d–ay
)

925 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

926 
	`ùs_”r
("Readl from fw„eg under…rogram mode");

927  -
ENODEV
;

930  
	`ùs_dev_»adl
(
ùs_dev
, 
»g_addr
, 
l
, 
»Œy
, 
d–ay
);

931 
	}
}

933 
	$ùs_fw_»g_»adsb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

934 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

936 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

937 
	`ùs_”r
("Readsb from fw„eg under…rogram mode");

938  -
ENODEV
;

941  
	`ùs_dev_»adsb
(
ùs_dev
, 
»g_addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

942 
	}
}

943 
	$ùs_fw_»g_»adsb_»Œy_d–ay_idË
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

944 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
, 
idË
)

946 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

947 
	`ùs_”r
("Readsb from fw„eg under…rogram mode");

948  -
ENODEV
;

951  
	`ùs_dev_»adsb_d–ay_idË
(
ùs_dev
, 
»g_addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
, 
idË
);

952 
	}
}

955 
	$ùs_hw_»g_wr™eb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

956 
u32
 
»g_addr
, 
u8
 
b
, 
»Œy
, 
d–ay
)

958  
	`ùs_¤am_wr™eb_»Œy
(
ùs_dev
, 
»g_addr
, 
b
, 
»Œy
, 
d–ay
);

959 
	}
}

961 
	$ùs_hw_»g_wr™ew_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

962 
u32
 
»g_addr
, 
u16
 
w
, 
»Œy
, 
d–ay
)

964  
	`ùs_¤am_wr™ew_»Œy
(
ùs_dev
, 
»g_addr
, 
w
, 
»Œy
, 
d–ay
);

965 
	}
}

967 
	$ùs_hw_»g_wr™–_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

968 
u32
 
»g_addr
, u32 
l
, 
»Œy
, 
d–ay
)

970  
	`ùs_¤am_wr™–_»Œy
(
ùs_dev
, 
»g_addr
, 
l
, 
»Œy
, 
d–ay
);

971 
	}
}

973 
	$ùs_hw_»g_wr™esb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

974 
u32
 
»g_addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

976  
	`ùs_¤am_wr™esb_»Œy
(
ùs_dev
, 
»g_addr
, 
¤c
, 
Ën
, 
»Œy
, 
d–ay
);

977 
	}
}

979 
	$ùs_hw_»g_»adb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

980 
u32
 
»g_addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
)

982  
	`ùs_¤am_»adb_»Œy
(
ùs_dev
, 
»g_addr
, 
b
, 
»Œy
, 
d–ay
);

983 
	}
}

985 
	$ùs_hw_»g_»adw_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

986 
u32
 
»g_addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
)

988  
	`ùs_¤am_»adw_»Œy
(
ùs_dev
, 
»g_addr
, 
w
, 
»Œy
, 
d–ay
);

989 
	}
}

991 
	$ùs_hw_»g_»adl_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

992 
u32
 
»g_addr
, u32 *
l
, 
»Œy
, 
d–ay
)

994  
	`ùs_¤am_»adl_»Œy
(
ùs_dev
, 
»g_addr
, 
l
, 
»Œy
, 
d–ay
);

995 
	}
}

997 
	$ùs_hw_»g_»adsb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

998 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

1000  
	`ùs_¤am_»adsb_»Œy
(
ùs_dev
, 
»g_addr
, 
d¡
, 
Ën
, 
»Œy
, 
d–ay
);

1001 
	}
}

1003 cÚ¡ 
ùs_sfù¾
 
	giúl9911_sfù¾
 = {

1004 .
»g_ba£
 = 0x34000,

1005 .
	gxchg_¤am_ba£
 = (80 - 1) * 1024,

1006 .
	gxchg_¤am_size
 = 1024,

1007 .
	gİs
 = &
ùs_sfù¾v2_İs


1010 cÚ¡ 
ùs_sfù¾
 
	giúl9911s_sfù¾
 = {

1011 .
»g_ba£
 = 0x34000,

1012 .
	gxchg_¤am_ba£
 = (64 - 1) * 1024,

1013 .
	gxchg_¤am_size
 = 1024,

1014 .
	gİs
 = &
ùs_sfù¾v2_İs


1017 cÚ¡ 
ùs_sfù¾
 
	giúl9911c_sfù¾
 = {

1018 .
»g_ba£
 = 0x34000,

1019 .
	gxchg_¤am_ba£
 = (64 - 1) * 1024,

1020 .
	gxchg_¤am_size
 = 1024,

1021 .
	gİs
 = &
ùs_sfù¾v2_İs


1024 
	#CTS_DEV_HW_REG_DDI_REG_CTRL
 (0x3002Cu)

	)

1026 
	$iúl9911_£t_acûss_ddi_»g
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
’abË
)

1028 
»t
;

1029 
u8
 
acûss_æag
;

1031 
	`ùs_šfo
("ICNL9911 % acûs dd˜»g", 
’abË
 ? "enable" : "disable");

1033 
»t
 = 
	`ùs_hw_»g_»adb
(
ùs_dev
, 
CTS_DEV_HW_REG_DDI_REG_CTRL
, &
acûss_æag
);

1034 ià(
»t
) {

1035 
	`ùs_”r
("R—d HW_REG_DDI_REG_CTRL faed %d", 
»t
);

1036  
»t
;

1039 
acûss_æag
 = 
’abË
 ? (access_flag | 0x01) : (access_flag & (~0x01));

1040 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 
CTS_DEV_HW_REG_DDI_REG_CTRL
, 
acûss_æag
);

1041 ià(
»t
) {

1042 
	`ùs_”r
("Wr™HW_REG_DDI_REG_CTRL %02x faed %d", 
acûss_æag
, 
»t
);

1043  
»t
;

1046 
»t
 = 
	`ùs_hw_»g_wr™ew
(
ùs_dev
, 0x3DFF0, 
’abË
 ? 0x4BB4 : 0xB44B);

1047 ià(
»t
) {

1048 
	`ùs_”r
("Write…assword failed %d");

1049 
di§bË_acûss_ddi_»g
;

1054 
di§bË_acûss_ddi_»g
: {

1055 
r
;

1057 
acûss_æag
 = 
’abË
 ? (access_flag & (~0x01)) : (access_flag | 0x01);

1058 
r
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 
CTS_DEV_HW_REG_DDI_REG_CTRL
, 
acûss_æag
);

1059 ià(
r
) {

1060 
	`ùs_”r
("");

1064  
»t
;

1065 
	}
}

1067 
	$iúl9911s_£t_acûss_ddi_»g
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
’abË
)

1069 
»t
;

1070 
u8
 
acûss_æag
;

1072 
	`ùs_šfo
("ICNL9911S % acûs dd˜»g", 
’abË
 ? "enable" : "disable");

1074 
»t
 = 
	`ùs_hw_»g_»adb
(
ùs_dev
, 
CTS_DEV_HW_REG_DDI_REG_CTRL
, &
acûss_æag
);

1075 ià(
»t
) {

1076 
	`ùs_”r
("R—d HW_REG_DDI_REG_CTRL faed %d", 
»t
);

1077  
»t
;

1080 
acûss_æag
 = 
’abË
 ? (access_flag | 0x01) : (access_flag & (~0x01));

1081 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 
CTS_DEV_HW_REG_DDI_REG_CTRL
, 
acûss_æag
);

1082 ià(
»t
) {

1083 
	`ùs_”r
("Wr™HW_REG_DDI_REG_CTRL %02x faed %d", 
acûss_æag
, 
»t
);

1084  
»t
;

1087 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x30074, 
’abË
 ? 1 : 0);

1088 ià(
»t
) {

1089 
	`ùs_”r
("Wr™0x30074 faed %d", 
acûss_æag
, 
»t
);

1090  
»t
;

1093 
»t
 = 
	`ùs_hw_»g_wr™ew
(
ùs_dev
, 0x3DFF0, 
’abË
 ? 0x595A : 0x5A5A);

1094 ià(
»t
) {

1095 
	`ùs_”r
("Write…asswordo F0 failed %d");

1096  
»t
;

1098 
»t
 = 
	`ùs_hw_»g_wr™ew
(
ùs_dev
, 0x3DFF4, 
’abË
 ? 0xA6A5 : 0x5A5A);

1099 ià(
»t
) {

1100 
	`ùs_”r
("Write…asswordo F1 failed %d");

1101  
»t
;

1105 
	}
}

1107 cÚ¡ 
ùs_deviû_hwd©a
 
	gùs_deviû_hwd©as
[] = {

1109 .
Çme
 = "ICNL9911",

1110 .
	ghwid
 = 
CTS_DEV_HWID_ICNL9911
,

1111 .
	gfwid
 = 
CTS_DEV_FWID_ICNL9911
,

1112 .
	gnum_row
 = 32,

1113 .
	gnum_cŞ
 = 18,

1114 .
	g¤am_size
 = 80 * 1024,

1116 .
	g´og¿m_addr_width
 = 3,

1118 .
	gsfù¾
 = &
iúl9911_sfù¾
,

1119 .
	g’abË_acûss_ddi_»g
 = 
iúl9911_£t_acûss_ddi_»g
,

1122 .
	gÇme
 = "ICNL9911S",

1123 .
	ghwid
 = 
CTS_DEV_HWID_ICNL9911S
,

1124 .
	gfwid
 = 
CTS_DEV_FWID_ICNL9911S
,

1125 .
	gnum_row
 = 32,

1126 .
	gnum_cŞ
 = 18,

1127 .
	g¤am_size
 = 64 * 1024,

1129 .
	g´og¿m_addr_width
 = 3,

1131 .
	gsfù¾
 = &
iúl9911s_sfù¾
,

1132 .
	g’abË_acûss_ddi_»g
 = 
iúl9911s_£t_acûss_ddi_»g
,

1135 .
	gÇme
 = "ICNL9911C",

1136 .
	ghwid
 = 
CTS_DEV_HWID_ICNL9911C
,

1137 .
	gfwid
 = 
CTS_DEV_FWID_ICNL9911C
,

1138 .
	gnum_row
 = 32,

1139 .
	gnum_cŞ
 = 18,

1140 .
	g¤am_size
 = 64 * 1024,

1142 .
	g´og¿m_addr_width
 = 3,

1144 .
	gsfù¾
 = &
iúl9911c_sfù¾
,

1145 .
	g’abË_acûss_ddi_»g
 = 
iúl9911s_£t_acûss_ddi_»g
,

1149 
	$ùs_š™_deviû_hwd©a
(
ùs_deviû
 *
ùs_dev
,

1150 
u32
 
hwid
, 
u16
 
fwid
)

1152 
i
;

1154 
	`ùs_šfo
("In™ h¬dw¬d©¨hwid: %06x fwid: %04x", 
hwid
, 
fwid
);

1156 
i
 = 0; i < 
	`ARRAY_SIZE
(
ùs_deviû_hwd©as
); i++) {

1157 ià(
hwid
 =ğ
ùs_deviû_hwd©as
[
i
].hwid ||

1158 
fwid
 =ğ
ùs_deviû_hwd©as
[
i
].fwid) {

1159 
ùs_dev
->
hwd©a
 = &
ùs_deviû_hwd©as
[
i
];

1164  -
EINVAL
;

1165 
	}
}

1167 
	$ùs_lock_deviû
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1169 
	`ùs_dbg
("*** Lock ***");

1171 
	`¹_mu‹x_lock
(&
ùs_dev
->
pd©a
->
dev_lock
);

1172 
	}
}

1174 
	$ùs_uÆock_deviû
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1176 
	`ùs_dbg
("### Un-Lock ###");

1178 
	`¹_mu‹x_uÆock
(&
ùs_dev
->
pd©a
->
dev_lock
);

1179 
	}
}

1181 
	$ùs_£t_wÜk_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 
mode
)

1183 
	`ùs_šfo
("S‘ wÜk modtØ%u", 
mode
);

1185  
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_WORK_MODE
, 
mode
);

1186 
	}
}

1188 
	$ùs_g‘_wÜk_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
mode
)

1190  
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_WORK_MODE
, 
mode
);

1191 
	}
}

1193 
	$ùs_g‘_fœmw¬e_v”siÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
v”siÚ
)

1195 
»t
 = 
	`ùs_fw_»g_»adw
(
ùs_dev
, 
CTS_DEVICE_FW_REG_VERSION
, 
v”siÚ
);

1197 ià(
»t
) {

1198 *
v”siÚ
 = 0;

1200 *
v”siÚ
 = 
	`be16_to_ıup
(version);

1203  
»t
;

1204 
	}
}

1206 
	$ùs_g‘_ddi_v”siÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
v”siÚ
)

1208 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_DDI_VERSION
, 
v”siÚ
);

1210 ià(
»t
) {

1211 *
v”siÚ
 = 0;

1213  
»t
;

1214 
	}
}

1216 
	$ùs_g‘_lib_v”siÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
lib_v”siÚ
)

1218 
u8
 
maš_v”siÚ
, 
sub_v”siÚ
;

1219 
»t
;

1221 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_FW_LIB_MAIN_VERSION
, &
maš_v”siÚ
);

1222 ià(
»t
) {

1223 
	`ùs_”r
("G‘ fw†ib maš v”siÚ faed %d", 
»t
);

1224  
»t
;

1227 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_FW_LIB_SUB_VERSION
, &
sub_v”siÚ
);

1228 ià(
»t
) {

1229 
	`ùs_”r
("G‘ fw†ib sub v”siÚ faed %d", 
»t
);

1230  
»t
;

1233 *
lib_v”siÚ
 = (
maš_v”siÚ
 << 8è+ 
sub_v”siÚ
;

1235 
	}
}

1238 
	$ùs_g‘_d©a_»ady_æag
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
æag
)

1240  
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_DATA_READY
, 
æag
);

1241 
	}
}

1243 
	$ùs_şr_d©a_»ady_æag
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1245  
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_DATA_READY
, 0);

1246 
	}
}

1248 
	$ùs_£nd_commªd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 
cmd
)

1250 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1251 
	`ùs_w¬n
("S’d commªd %u whch iÀ´og¿m mode", 
cmd
);

1252  -
ENODEV
;

1255  
	`ùs_fw_»g_wr™eb_»Œy
(
ùs_dev
, 
CTS_DEVICE_FW_REG_CMD
, 
cmd
, 3, 0);

1256 
	}
}

1258 
	$ùs_g‘_touchšfo
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

1259 
ùs_deviû_touch_šfo
 *
touch_šfo
)

1261 
	`ùs_dbg
("Getouch info");

1263 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1264 
	`ùs_w¬n
("Getouch info in…rogram mode");

1265  -
ENODEV
;

1268 ià(
ùs_dev
->
¹d©a
.
su¥’ded
) {

1269 
	`ùs_w¬n
("Getouch info while is suspended");

1270  -
ENODEV
;

1273  
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_TOUCH_INFO
,

1274 
touch_šfo
, (*touch_info));

1275 
	}
}

1277 
	$ùs_g‘_·Ãl_·¿m
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

1278 *
·¿m
, 
size_t
 
size
)

1280 
	`ùs_šfo
("Get…anel…arameter");

1282 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1283 
	`ùs_w¬n
("Get…anel…arameter in…rogram mode");

1284  -
ENODEV
;

1287  
	`ùs_fw_»g_»adsb
(
ùs_dev
,

1288 
CTS_DEVICE_FW_REG_PANEL_PARAM
, 
·¿m
, 
size
);

1289 
	}
}

1291 
	$ùs_£t_·Ãl_·¿m
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

1292 cÚ¡ *
·¿m
, 
size_t
 
size
)

1294 
	`ùs_šfo
("Set…anel…arameter");

1296 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1297 
	`ùs_w¬n
("Set…anel…arameter in…rogram mode");

1298  -
ENODEV
;

1300  
	`ùs_fw_»g_wr™esb
(
ùs_dev
,

1301 
CTS_DEVICE_FW_REG_PANEL_PARAM
, 
·¿m
, 
size
);

1302 
	}
}

1304 
	$ùs_g‘_x_»sŞutiÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
»sŞutiÚ
)

1306  
	`ùs_fw_»g_»adw
(
ùs_dev
, 
CTS_DEVICE_FW_REG_X_RESOLUTION
, 
»sŞutiÚ
);

1307 
	}
}

1309 
	$ùs_g‘_y_»sŞutiÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
»sŞutiÚ
)

1311  
	`ùs_fw_»g_»adw
(
ùs_dev
, 
CTS_DEVICE_FW_REG_Y_RESOLUTION
, 
»sŞutiÚ
);

1312 
	}
}

1314 
	$ùs_g‘_num_rows
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
num_rows
)

1316  
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_NUM_TX
, 
num_rows
);

1317 
	}
}

1319 
	$ùs_g‘_num_cŞs
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
num_cŞs
)

1321  
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_NUM_RX
, 
num_cŞs
);

1322 
	}
}

1324 
	#CTS_DEV_FW_ESD_PROTECTION_ON
 (3)

	)

1325 
	#CTS_DEV_FW_ESD_PROTECTION_OFF
 (1)

	)

1327 
	$ùs_g‘_dev_esd_´ÙeùiÚ
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 *
’abË
)

1329 
»t
;

1330 
u8
 
v®
;

1332 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_ESD_PROTECTION
, &
v®
);

1333 ià(
»t
 == 0) {

1334 *
’abË
 = (
v®
 =ğ
CTS_DEV_FW_ESD_PROTECTION_ON
);

1337  
»t
;

1338 
	}
}

1340 
	$ùs_£t_dev_esd_´ÙeùiÚ
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
’abË
)

1342 
	`ùs_šfo
("% ESD…rÙeùiÚ", 
’abË
 ? "Enable" : "Disable");

1344  
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_ESD_PROTECTION
,

1345 
’abË
 ? 
CTS_DEV_FW_ESD_PROTECTION_ON
 : 
CTS_DEV_FW_ESD_PROTECTION_OFF
);

1346 
	}
}

1348 #ifdeà
CONFIG_CTS_LEGACY_TOOL


1349 
	$ùs_’abË_g‘_¿wd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1351 
	`ùs_šfo
("Enable get„aw/diff data");

1352  
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_ENABLE_READ_RAWDATA
);

1353 
	}
}

1355 
	$ùs_di§bË_g‘_¿wd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1357 
	`ùs_šfo
("Disable get„aw/diff data");

1358  
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_DISABLE_READ_RAWDATA
);

1359 
	}
}

1361 
	$tsd©a_æ_x
(*
tsd©a
, 
u8
 
fw_rows
, u8 
fw_cŞs
)

1363 
u8
 
r
, 
c
;

1364 
u16
 *
d©a
;

1366 
d©a
 = (
u16
 *)
tsd©a
;

1367 
r
 = 0;„ < 
fw_rows
;„++) {

1368 
c
 = 0; c < 
fw_cŞs
 / 2; c++) {

1369 
	`sw­
(
d©a
[
r
 * 
fw_cŞs
 + 
c
],

1370 
d©a
[
r
 * 
fw_cŞs
 + 
	`w¿p
(fw_cŞs, 
c
)]);

1373 
	}
}

1375 
	$tsd©a_æ_y
(*
tsd©a
, 
u8
 
fw_rows
, u8 
fw_cŞs
)

1377 
u8
 
r
, 
c
;

1378 
u16
 *
d©a
;

1380 
d©a
 = (
u16
 *)
tsd©a
;

1381 
r
 = 0;„ < 
fw_rows
 / 2;„++) {

1382 
c
 = 0; c < 
fw_cŞs
; c++) {

1383 
	`sw­
(
d©a
[
r
 * 
fw_cŞs
 + 
c
],

1384 
d©a
[
	`w¿p
(
fw_rows
, 
r
è* 
fw_cŞs
 + 
c
]);

1387 
	}
}

1389 
	$ùs_g‘_¿wd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, *
buf
)

1391 
i
, 
»t
;

1392 
u8
 
»ady
;

1393 
u8
 
»Œ›s
 = 5;

1395 
	`ùs_šfo
("Get„awdata");

1397 
i
 = 0; i < 1000; i++) {

1398 
	`md–ay
(1);

1399 
»t
 = 
	`ùs_g‘_d©a_»ady_æag
(
ùs_dev
, &
»ady
);

1400 ià(
»t
) {

1401 
	`ùs_”r
("G‘ d©¨»ady fÏg faed %d", 
»t
);

1402 
g‘_¿w_ex™
;

1404 ià(
»ady
) {

1408 ià(
i
 == 1000) {

1409 
»t
 = -
ENODEV
;

1410 
g‘_¿w_ex™
;

1413 
»t
 = 
	`ùs_fw_»g_»adsb_d–ay_idË
(
ùs_dev
, 
CTS_DEVICE_FW_REG_RAW_DATA
,

1414 
buf
,
ùs_dev
->
fwd©a
.
rows
*ùs_dev->fwd©a.
cŞs
*2, 500);

1415 ià(
»t
) {

1416 
	`ùs_”r
("R—d„awd©¨çed %d", 
»t
);

1418 } --
»Œ›s
 > 0 && 
»t
 != 0);

1420 ià(
ùs_dev
->
fwd©a
.
æ_x
) {

1421 
	`tsd©a_æ_x
(
buf
, 
ùs_dev
->
fwd©a
.
rows
, cts_dev->fwd©a.
cŞs
);

1423 ià(
ùs_dev
->
fwd©a
.
æ_y
) {

1424 
	`tsd©a_æ_y
(
buf
, 
ùs_dev
->
fwd©a
.
rows
, cts_dev->fwd©a.
cŞs
);

1427 ià(
	`ùs_şr_d©a_»ady_æag
(
ùs_dev
)) {

1428 
	`ùs_”r
("Clear data„eady flag failed");

1429 
»t
 = -
ENODEV
;

1431 
g‘_¿w_ex™
:

1432  
»t
;

1433 
	}
}

1435 
	$ùs_g‘_diffd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, *
buf
)

1437 
i
, 
j
, 
»t
;

1438 
u8
 
»ady
;

1439 
u8
 
»Œ›s
 = 5;

1440 
u8
 *
ÿche_buf
;

1442 
	`ùs_šfo
("Get diffdata");

1443 
ÿche_buf
 = 
	`kz®loc
(

1444 (
ùs_dev
->
fwd©a
.
rows
 + 2è* (ùs_dev->fwd©a.
cŞs
 + 2è* 2, 
GFP_KERNEL
);

1445 ià(
ÿche_buf
 =ğ
NULL
) {

1446 
	`ùs_”r
("Get diffdata: mallocƒrror");

1447 
»t
 = -
ENOMEM
;

1448 
g‘_diff_ex™
;

1451 
i
 = 0; i < 1000; i++) {

1452 
	`md–ay
(1);

1453 
»t
 = 
	`ùs_g‘_d©a_»ady_æag
(
ùs_dev
, &
»ady
);

1454 ià(
»t
) {

1455 
	`ùs_”r
("G‘ d©¨»ady fÏg faed %d", 
»t
);

1456 
g‘_diff_ä“_buf
;

1458 ià(
»ady
) {

1462 ià(
i
 == 1000) {

1463 
»t
 = -
ENODEV
;

1464 
g‘_diff_ä“_buf
;

1467 
»t
 = 
	`ùs_fw_»g_»adsb_d–ay_idË
(
ùs_dev
, 
CTS_DEVICE_FW_REG_DIFF_DATA
,

1468 
ÿche_buf
,(
ùs_dev
->
fwd©a
.
rows
+2)*(ùs_dev->fwd©a.
cŞs
+2)*2, 500);

1469 ià(
»t
) {

1470 
	`ùs_”r
("R—d diffd©¨çed %d", 
»t
);

1472 } --
»Œ›s
 > 0 && 
»t
 != 0);

1474 
i
 = 0; i < 
ùs_dev
->
fwd©a
.
rows
; i++) {

1475 
j
 = 0; j < 
ùs_dev
->
fwd©a
.
cŞs
; j++) {

1476 ((
u8
 *)
buf
)[2 * (
i
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
j
)] =

1477 
ÿche_buf
[2 * ((
i
+1)*(
ùs_dev
->
fwd©a
.
cŞs
+2)+
j
+1)];

1478 ((
u8
 *)
buf
)[2*(
i
*
ùs_dev
->
fwd©a
.
cŞs
 + 
j
)+1] =

1479 
ÿche_buf
[2*((
i
+1)*(
ùs_dev
->
fwd©a
.
cŞs
+2)+
j
+1)+1];

1483 ià(
ùs_dev
->
fwd©a
.
æ_x
) {

1484 
	`tsd©a_æ_x
(
buf
, 
ùs_dev
->
fwd©a
.
rows
, cts_dev->fwd©a.
cŞs
);

1486 ià(
ùs_dev
->
fwd©a
.
æ_y
) {

1487 
	`tsd©a_æ_y
(
buf
, 
ùs_dev
->
fwd©a
.
rows
, cts_dev->fwd©a.
cŞs
);

1490 ià(
	`ùs_şr_d©a_»ady_æag
(
ùs_dev
)) {

1491 
	`ùs_”r
("Clear data„eady flag failed");

1492 
»t
 = -
ENODEV
;

1494 
g‘_diff_ä“_buf
:

1495 
	`kä“
(
ÿche_buf
);

1496 
g‘_diff_ex™
:

1497  
»t
;

1498 
	}
}

1501 
	$ùs_g‘_dev_boÙ_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

1502 
u8
 *
boÙ_mode
)

1504 
»t
;

1506 
»t
 = 
	`ùs_hw_»g_»adb_»Œy
(
ùs_dev
,

1507 
CTS_DEV_HW_REG_CURRENT_MODE
, 
boÙ_mode
, 5, 10);

1508 ià(
»t
) {

1509 
	`ùs_”r
("R—d boÙ modçed %d", 
»t
);

1510  
»t
;

1513 *
boÙ_mode
 &ğ
CTS_DEV_BOOT_MODE_MASK
;

1515 
	`ùs_šfo
("Cu¼ dev boÙ mode: %u(%s)", *
boÙ_mode
,

1516 
	`ùs_dev_boÙ_mode2¡r
(*
boÙ_mode
));

1518 
	}
}

1520 
	$ùs_£t_dev_boÙ_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

1521 
u8
 
boÙ_mode
)

1523 
»t
;

1525 
	`ùs_šfo
("S‘ dev boÙ modtØ%u(%s)", 
boÙ_mode
,

1526 
	`ùs_dev_boÙ_mode2¡r
(
boÙ_mode
));

1528 
»t
 = 
	`ùs_hw_»g_wr™eb_»Œy
(
ùs_dev
, 
CTS_DEV_HW_REG_BOOT_MODE
,

1529 
boÙ_mode
, 5, 5);

1530 ià(
»t
) {

1531 
	`ùs_”r
("Wr™hw„egi¡” BOOT_MODE faed %d", 
»t
);

1532  
»t
;

1536 
	}
}

1538 
	$ùs_š™_fwd©a
(
ùs_deviû
 *
ùs_dev
)

1540 
ùs_deviû_fwd©a
 *
fwd©a
 = &
ùs_dev
->fwdata;

1541 
u8
 
v®
;

1542 
»t
;

1544 
	`ùs_šfo
("Init firmware data");

1546 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1547 
	`ùs_”r
("Init firmware data while in…rogram mode");

1548  -
EINVAL
;

1551 
»t
 = 
	`ùs_g‘_fœmw¬e_v”siÚ
(
ùs_dev
, &
fwd©a
->
v”siÚ
);

1552 ià(
»t
) {

1553 
	`ùs_”r
("R—d fœmw¬v”siÚ faed %d", 
»t
);

1554  
»t
;

1556 
	`ùs_šfo
(" %-24s: %04x", "Fœmw¬v”siÚ", 
fwd©a
->
v”siÚ
);

1558 
»t
 = 
	`ùs_g‘_lib_v”siÚ
(
ùs_dev
, &
fwd©a
->
lib_v”siÚ
);

1559 ià(
»t
) {

1560 
	`ùs_”r
("R—d fœmw¬Lib v”siÚ faed %d", 
»t
);

1562 
	`ùs_šfo
(" %-24s: v%x.%x", "Fimrware†ib verion",

1563 (
u8
)(
fwd©a
->
lib_v”siÚ
 >> 8),

1564 (
u8
)(
fwd©a
->
lib_v”siÚ
));

1566 
»t
 = 
	`ùs_g‘_ddi_v”siÚ
(
ùs_dev
, &
fwd©a
->
ddi_v”siÚ
);

1567 ià(
»t
) {

1568 
	`ùs_”r
("R—d dd˜v”siÚ faed %d", 
»t
);

1569  
»t
;

1571 
	`ùs_šfo
(" %-24s: %02x", "DDI in™ codv”iÚ", 
fwd©a
->
ddi_v”siÚ
);

1573 
»t
 = 
	`ùs_g‘_x_»sŞutiÚ
(
ùs_dev
, &
fwd©a
->
»s_x
);

1574 ià(
»t
) {

1575 
	`ùs_”r
("R—d fœmw¬X„esŞtiÚ faed %d", 
»t
);

1576  
»t
;

1578 
	`ùs_šfo
(" %-24s: %u", "X„esŞutiÚ", 
fwd©a
->
»s_x
);

1580 
»t
 = 
	`ùs_g‘_y_»sŞutiÚ
(
ùs_dev
, &
fwd©a
->
»s_y
);

1581 ià(
»t
) {

1582 
	`ùs_”r
("R—d fœmw¬Y„esŞutiÚ faed %d", 
»t
);

1583  
»t
;

1585 
	`ùs_šfo
(" %-24s: %u", "Y„esŞutiÚ", 
fwd©a
->
»s_y
);

1587 
»t
 = 
	`ùs_g‘_num_rows
(
ùs_dev
, &
fwd©a
->
rows
);

1588 ià(
»t
) {

1589 
	`ùs_”r
("R—d fœmw¬num TX faed %d", 
»t
);

1590  
»t
;

1592 
	`ùs_šfo
(" %-24s: %u", "Num„ows", 
fwd©a
->
rows
);

1594 
»t
 = 
	`ùs_g‘_num_cŞs
(
ùs_dev
, &
fwd©a
->
cŞs
);

1595 ià(
»t
) {

1596 
	`ùs_”r
("R—d fœmw¬num RX faed %d", 
»t
);

1597  
»t
;

1599 
	`ùs_šfo
(" %-24s: %u", "Num cŞs", 
fwd©a
->
cŞs
);

1601 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_FLAG_BITS
, &
v®
);

1602 ià(
»t
) {

1603 
	`ùs_”r
("R—d FW_REG_FLIP_X/Y faed %d", 
»t
);

1604  
»t
;

1606 
ùs_dev
->
fwd©a
.
æ_x
 = !!(
v®
 & 
	`BIT
(2));

1607 
ùs_dev
->
fwd©a
.
æ_y
 = !!(
v®
 & 
	`BIT
(3));

1608 
	`ùs_šfo
(" %-24s: %s", "Flip X",

1609 
ùs_dev
->
fwd©a
.
æ_x
 ? "True" : "Flase");

1610 
	`ùs_šfo
(" %-24s: %s", "Flip Y",

1611 
ùs_dev
->
fwd©a
.
æ_y
 ? "True" : "Flase");

1613 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_SWAP_AXES
, &
v®
);

1614 ià(
»t
) {

1615 
	`ùs_”r
("R—d FW_REG_SWAP_AXES faed %d", 
»t
);

1616  
»t
;

1618 
	`ùs_šfo
(" %-24s: %s", "Swap‡xes",

1619 
ùs_dev
->
fwd©a
.
sw­_axes
 ? "True" : "Flase");

1621 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

1622 
CTS_DEVICE_FW_REG_INT_MODE
, &
fwd©a
->
št_mode
);

1623 ià(
»t
) {

1624 
	`ùs_”r
("R—d fœmw¬IÁ modçed %d", 
»t
);

1625  
»t
;

1627 
	`ùs_šfo
(" %-24s: %s", "Int…olarity",

1628 (
fwd©a
->
št_mode
 == 0) ? "LOW" : "HIGH");

1630 
»t
 = 
	`ùs_fw_»g_»adw
(
ùs_dev
,

1631 
CTS_DEVICE_FW_REG_INT_KEEP_TIME
, &
fwd©a
->
št_k“p_time
);

1632 ià(
»t
) {

1633 
	`ùs_”r
("R—d fœmw¬IÁ k“°timçed %d", 
»t
);

1634  
»t
;

1636 
	`ùs_šfo
(" %-24s: %d", "IÁ k“°time", 
fwd©a
->
št_k“p_time
);

1638 
»t
 = 
	`ùs_fw_»g_»adw
(
ùs_dev
,

1639 
CTS_DEVICE_FW_REG_RAWDATA_TARGET
, &
fwd©a
->
¿wd©a_rg‘
);

1640 ià(
»t
) {

1641 
	`ùs_”r
("R—d fœmw¬Raw de¡ v®uçed %d", 
»t
);

1642  
»t
;

1644 
	`ùs_šfo
(" %-24s: %d", "Raw¬g‘ v®ue", 
fwd©a
->
¿wd©a_rg‘
);

1647 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

1648 
CTS_DEVICE_FW_REG_ESD_PROTECTION
, &
fwd©a
->
esd_m‘hod
);

1649 ià(
»t
) {

1650 
	`ùs_”r
("R—d fœmw¬Esd m‘hod faed %d", 
»t
);

1651  
»t
;

1653 
	`ùs_šfo
(" %-24s: %d", "Esd m‘hod", 
fwd©a
->
esd_m‘hod
);

1655 #ifdeà
CONFIG_CTS_EARJACK_DETECT


1656 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

1657 
CTS_DEVICE_FW_REG_EARJACK_DETECT_SUPP
, &
v®
);

1658 ià(
»t
) {

1659 
	`ùs_”r
("R—d fœmw¬—rjack d‘eù suµÜˆçed %d", 
»t
);

1660  
»t
;

1662 
fwd©a
->
suµ_h—dphÚe_ÿbË_»jeù
 = !!(
v®
 & 
	`BIT
(0));

1663 
	`ùs_šfo
(" %-24s: %s", "Headphone cable„eject",

1664 
fwd©a
->
suµ_h—dphÚe_ÿbË_»jeù
 ? "True" : "False");

1668 
	}
}

1670 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


1671 
	$ùs_show_fw_log
(
ùs_deviû
 *
ùs_dev
)

1673 
u8
 
Ën
, 
max_Ën
;

1674 
»t
;

1675 
u8
 *
d©a
;

1677 
max_Ën
 = 
	`ùs_¶©_g‘_max_fw_log_size
(
ùs_dev
->
pd©a
);

1678 
d©a
 = 
	`ùs_¶©_g‘_fw_log_buf
(
ùs_dev
->
pd©a
, 
max_Ën
);

1679 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_TOUCH_INFO
+1, &
Ën
, 1);

1680 ià(
»t
) {

1681 
	`ùs_”r
("Get i2c…rint buf†enƒrror");

1684 ià(
Ën
 >ğ
max_Ën
) {

1685 
Ën
 = 
max_Ën
 - 1;

1687 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_TOUCH_INFO
+2, 
d©a
, 
Ën
);

1688 ià(
»t
) {

1689 
	`ùs_”r
("Get i2c…rint bufƒrror");

1692 
d©a
[
Ën
] = '\0';

1693 
	`´štk
("CTS-FW_LOG %s", 
d©a
);

1694 
	`ùs_fw_log_show_fšish
(
ùs_dev
);

1695 
	}
}

1698 
	$ùs_œq_hªdËr
(
ùs_deviû
 *
ùs_dev
)

1700 
»t
;

1702 
	`ùs_dbg
("Enter IRQ handler");

1704 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1705 
	`ùs_”r
("IRQriggered in…rogram mode");

1706  -
EINVAL
;

1709 ià(
	`uÆik–y
(
ùs_dev
->
¹d©a
.
su¥’ded
)) {

1710 #ifdeà
CFG_CTS_GESTURE


1711 ià(
ùs_dev
->
¹d©a
.
ge¡u»_wakeup_’abËd
) {

1712 
ùs_deviû_ge¡u»_šfo
 
ge¡u»_šfo
;

1714 
	`ùs_šfo
("Get gesture info");

1715 
»t
 = 
	`ùs_g‘_ge¡u»_šfo
(
ùs_dev
,

1716 &
ge¡u»_šfo
, 
CFG_CTS_GESTURE_REPORT_TRACE
);

1717 ià(
»t
) {

1718 
	`ùs_w¬n
("G‘ ge¡u» infØçed %d", 
»t
);

1725 
	`ùs_šfo
("Set deviceƒnter gesture mode");

1726 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_SUSPEND_WITH_GESTURE
);

1728 
»t
 = 
	`ùs_¶©_´oûss_ge¡u»_šfo
(
ùs_dev
->
pd©a
, &
ge¡u»_šfo
);

1729 ià(
»t
) {

1730 
	`ùs_”r
("Proûs ge¡u» infØçed %d", 
»t
);

1731  
»t
;

1734 
	`ùs_w¬n
("IRQriggered while device suspended "

1739 
ùs_deviû_touch_šfo
 *
touch_šfo
;

1741 
touch_šfo
 = &
ùs_dev
->
pd©a
->touch_info;

1742 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


1743 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_TOUCH_INFO
, 
touch_šfo
, 1);

1744 ià(
»t
) {

1745 
	`ùs_”r
("G‘ vkey_¡©çed %d", 
»t
);

1746  
»t
;

1749 ià(
touch_šfo
->
vkey_¡©e
 =ğ
CTS_FW_LOG_REDIRECT_SIGN
) {

1750 ià(
	`ùs_is_fw_log_»dœeù
(
ùs_dev
)) {

1751 
	`ùs_show_fw_log
(
ùs_dev
);

1756 
»t
 = 
	`ùs_g‘_touchšfo
(
ùs_dev
, 
touch_šfo
);

1757 ià(
»t
) {

1758 
	`ùs_”r
("G‘ouch infØçed %d", 
»t
);

1759  
»t
;

1762 
	`ùs_dbg
("Touch info: vkey_state %x,‚um_msg %u",

1763 
touch_šfo
->
vkey_¡©e
,ouch_šfo->
num_msg
);

1765 
»t
 = 
	`ùs_¶©_´oûss_touch_msg
(
ùs_dev
->
pd©a
,

1766 
touch_šfo
->
msgs
,ouch_šfo->
num_msg
);

1767 ià(
»t
) {

1768 
	`ùs_”r
("Proûs touch msg faed %d", 
»t
);

1769  
»t
;

1772 #ifdeà
CONFIG_CTS_VIRTUALKEY


1773 
»t
 = 
	`ùs_¶©_´oûss_vkey
(
ùs_dev
->
pd©a
, 
touch_šfo
->
vkey_¡©e
);

1774 ià(
»t
) {

1775 
	`ùs_”r
("Proûs vkey faed %d", 
»t
);

1776  
»t
;

1782 
	}
}

1784 
boŞ
 
	$ùs_is_deviû_su¥’ded
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1786  
ùs_dev
->
¹d©a
.
su¥’ded
;

1787 
	}
}

1789 
	$ùs_su¥’d_deviû
(
ùs_deviû
 *
ùs_dev
)

1791 
»t
;

1793 
	`ùs_šfo
("Suspend device");

1795 ià(
ùs_dev
->
¹d©a
.
su¥’ded
) {

1796 
	`ùs_w¬n
("Suspend device while‡lready suspended");

1799 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1800 
	`ùs_šfo
("Quit…rogramming mode before suspend");

1801 
»t
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

1802 ià(
»t
) {

1803 
	`ùs_”r
("FaedØex™…rog¿m modbefÜsu¥’d:%d", 
»t
);

1804  
»t
;

1807 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
,

1808 
ùs_dev
->
¹d©a
.
ge¡u»_wakeup_’abËd
 ?

1809 
CTS_CMD_SUSPEND_WITH_GESTURE
 : 
CTS_CMD_SUSPEND
);

1811 ià(
»t
){

1812 
	`ùs_”r
("Su¥’d deviû faed %d", 
»t
);

1814  
»t
;

1817 
	`ùs_šfo
("Device suspended ...");

1818 
ùs_dev
->
¹d©a
.
su¥’ded
 = 
Œue
;

1821 
	}
}

1823 
	$ùs_»sume_deviû
(
ùs_deviû
 *
ùs_dev
)

1825 
»t
 = 0;

1826 
»Œ›s
 = 3;

1828 
	`ùs_šfo
("Resume device");

1831 --
»Œ›s
 >= 0) {

1832 #ifdeà
CFG_CTS_HAS_RESET_PIN


1833 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

1835 
	`ùs_£t_nÜm®_addr
(
ùs_dev
);

1836 #ifdeà
CONFIG_CTS_I2C_HOST


1837 ià(
	`ùs_¶©_is_i2c_Úlše
(
ùs_dev
->
pd©a
, 
CTS_DEV_NORMAL_MODE_I2CADDR
))

1839 ià(
	`ùs_¶©_is_nÜm®_mode
(
ùs_dev
->
pd©a
))

1846 ià(
»Œ›s
 < 0) {

1847 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

1849 
	`ùs_šfo
("Need update firmware when„esume");

1850 
fœmw¬e
 = 
	`ùs_»que¡_fœmw¬e
(
ùs_dev
->
hwd©a
->
hwid
,

1851 
ùs_dev
->
hwd©a
->
fwid
, 0);

1852 ià(
fœmw¬e
) {

1853 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, 
fœmw¬e
, 
Œue
);

1854 
	`ùs_»Ëa£_fœmw¬e
(
fœmw¬e
);

1856 ià(
»t
) {

1857 
	`ùs_”r
("Upd©deçuÉ fœmw¬çed %d", 
»t
);

1858 
”r_£t_´og¿m_mode
;

1861 
	`ùs_”r
("Request default firmware failed %d, "

1862 "¶—£ upd©mªu®ly!!", 
»t
);

1864 
”r_£t_´og¿m_mode
;

1868 #ifdeà
CONFIG_CTS_CHARGER_DETECT


1869 ià(
	`ùs_is_ch¬g”_exi¡
(
ùs_dev
)) {

1870 
r
 = 
	`ùs_£t_dev_ch¬g”_©ched
(
ùs_dev
, 
Œue
);

1871 ià(
r
) {

1872 
	`ùs_”r
("S‘ dev ch¬g”‡‰ached faed %d", 
r
);

1877 #ifdeà
CONFIG_CTS_EARJACK_DETECT


1878 ià(
ùs_dev
->
fwd©a
.
suµ_h—dphÚe_ÿbË_»jeù
 &&

1879 
	`ùs_is_—rjack_exi¡
(
ùs_dev
)) {

1880 
r
 = 
	`ùs_£t_dev_—rjack_©ched
(
ùs_dev
, 
Œue
);

1881 ià(
r
) {

1882 
	`ùs_”r
("S‘ devƒ¬jack‡‰ached faed %d", 
r
);

1887 #ifdeà
CONFIG_CTS_GLOVE


1888 ià(
	`ùs_is_glove_’abËd
(
ùs_dev
)) {

1889 
	`ùs_’‹r_glove_mode
(
ùs_dev
);

1893 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


1894 ià(
	`ùs_is_fw_log_»dœeù
(
ùs_dev
)) {

1895 
	`ùs_’abË_fw_log_»dœeù
(
ùs_dev
);

1899 
ùs_dev
->
¹d©a
.
su¥’ded
 = 
çl£
;

1902 
”r_£t_´og¿m_mode
:

1903 
ùs_dev
->
¹d©a
.
´og¿m_mode
 = 
Œue
;

1904 
ùs_dev
->
¹d©a
.
¦ave_addr
 = 
CTS_DEV_PROGRAM_MODE_I2CADDR
;

1905 
ùs_dev
->
¹d©a
.
addr_width
 = 
CTS_DEV_PROGRAM_MODE_ADDR_WIDTH
;

1907  
»t
;

1908 
	}
}

1910 
boŞ
 
	$ùs_is_deviû_´og¿m_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

1912  
ùs_dev
->
¹d©a
.
´og¿m_mode
;

1913 
	}
}

1915 
šlše
 
	$ùs_š™_¹d©a_w™h_nÜm®_mode
(
ùs_deviû
 *
ùs_dev
)

1917 
	`mem£t
(&
ùs_dev
->
¹d©a
, 0, (cts_dev->rtdata));

1919 
	`ùs_£t_nÜm®_addr
(
ùs_dev
);

1920 
ùs_dev
->
¹d©a
.
su¥’ded
 = 
çl£
;

1921 
ùs_dev
->
¹d©a
.
upd©šg
 = 
çl£
;

1922 
ùs_dev
->
¹d©a
.
‹¡šg
 = 
çl£
;

1923 
ùs_dev
->
¹d©a
.
fw_log_»dœeù_’abËd
 = 
çl£
;

1924 
ùs_dev
->
¹d©a
.
glove_mode_’abËd
 = 
çl£
;

1925 
	}
}

1927 
	$ùs_’‹r_´og¿m_mode
(
ùs_deviû
 *
ùs_dev
)

1929 cÚ¡ 
u8
 
magic_num
[] = {0xCC, 0x33, 0x55, 0x5A};

1930 
u8
 
boÙ_mode
;

1931 
»t
;

1933 
	`ùs_šfo
("Enter…rogram mode");

1935 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1936 
	`ùs_w¬n
("Enter…rogram mode while‡lredy in");

1940 #ifdeà
CONFIG_CTS_I2C_HOST


1941 
»t
 = 
	`ùs_¶©_i2c_wr™e
(
ùs_dev
->
pd©a
,

1942 
CTS_DEV_PROGRAM_MODE_I2CADDR
, 
magic_num
, 4, 5, 10);

1943 ià(
»t
) {

1944 
	`ùs_”r
("Write magic‚umbero i2c_dev: 0x%02x failed %d",

1945 
CTS_DEV_PROGRAM_MODE_I2CADDR
, 
»t
);

1946  
»t
;

1949 
	`ùs_£t_´og¿m_addr
(
ùs_dev
);

1951 
»t
 = 
	`ùs_hw_»g_wr™eb_»Œy
(
ùs_dev
, 0x37001, 0x0F, 5, 1);

1952 ià(
»t
) {

1953 
	`ùs_”r
("Write i2c deglitch„egister failed\n");

1957 
	`ùs_£t_´og¿m_addr
(
ùs_dev
);

1958 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

1959 
»t
 = 
	`ùs_¶©_¥i_wr™e
(
ùs_dev
->
pd©a
,

1960 0xcc, &
magic_num
[1], 3, 5, 10);

1961 ià(
»t
) {

1962 
	`ùs_”r
("Write magic‚umbero i2c_dev: 0x%02x failed %d",

1963 
CTS_DEV_PROGRAM_MODE_SPIADDR
, 
»t
);

1964  
»t
;

1967 
»t
 = 
	`ùs_g‘_dev_boÙ_mode
(
ùs_dev
, &
boÙ_mode
);

1968 ià(
»t
) {

1969 
	`ùs_”r
("R—d BOOT_MODE faed %d", 
»t
);

1970  
»t
;

1973 #ifdeà
CONFIG_CTS_I2C_HOST


1974 ià(
boÙ_mode
 !ğ
CTS_DEV_BOOT_MODE_I2C_PROGRAM
)

1976 ià(
boÙ_mode
 !ğ
CTS_DEV_BOOT_MODE_SPI_PROGRAM
)

1979 
	`ùs_”r
("BOOT_MODE„—dback %u !ğI2C/SPI PROMGRAM mode", 
boÙ_mode
);

1980  -
EFAULT
;

1984 
	}
}

1986 cÚ¡ *
	$ùs_dev_boÙ_mode2¡r
(
u8
 
boÙ_mode
)

1988 
	#ÿ£_boÙ_mode
(
mode
) \

1989 
CTS_DEV_BOOT_MODE_
 ## 
mode
:  #mod"-BOOT"

	)

1991 
boÙ_mode
) {

1992 
	`ÿ£_boÙ_mode
(
FLASH
);

1993 
	`ÿ£_boÙ_mode
(
I2C_PROGRAM
);

1994 
	`ÿ£_boÙ_mode
(
SRAM
);

1995 
	`ÿ£_boÙ_mode
(
SPI_PROGRAM
);

1999 #undeà
ÿ£_boÙ_mode


2000 
	}
}

2002 
	$ùs_’‹r_nÜm®_mode
(
ùs_deviû
 *
ùs_dev
)

2004 
»t
 = 0;

2005 
u8
 
boÙ_mode
;

2006 
»Œ›s
;

2007 
u16
 
fwid
 = 
CTS_DEV_FWID_INVALID
;

2008 
u8
 
auto_boÙ
 = 0;

2009 
u8
 
fœ¡_boÙ
 = 1;

2011 
	`ùs_šfo
("Enter‚ormal mode");

2013 ià(!
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

2014 
	`ùs_w¬n
("Enter‚ormal mode while‡lready in");

2018 ià(
ùs_dev
->
¹d©a
.
has_æash
) {

2019 
auto_boÙ
 = 1;

2021 #ifdeà
CFG_CTS_UPDATE_CRCCHECK


2022 ià(
ùs_dev
->
hwd©a
->
hwid
 =ğ
CTS_DEV_HWID_ICNL9911S
) {

2023 
auto_boÙ
 = 1;

2026 
»Œ›s
 = 5;„etries >= 0;„etries--) {

2027 ià(
fœ¡_boÙ
 =ğ1 || 
auto_boÙ
 == 0) {

2028 
	`ùs_£t_´og¿m_addr
(
ùs_dev
);

2029 
»t
 = 
	`ùs_£t_dev_boÙ_mode
(
ùs_dev
, 
CTS_DEV_BOOT_MODE_SRAM
);

2030 ià(
»t
) {

2031 
	`ùs_”r
("S‘ BOOT_MODEØSRAM faed %d,ryØ»£ˆdeviû", 
»t
);

2033 
	`md–ay
(30);

2035 
fœ¡_boÙ
 = 0;

2036 #ifdeà
CONFIG_CTS_I2C_HOST


2037 ià(
	`ùs_¶©_is_i2c_Úlše
(
ùs_dev
->
pd©a
, 
CTS_DEV_NORMAL_MODE_I2CADDR
)) {

2038 
	`ùs_£t_nÜm®_addr
(
ùs_dev
);

2041 
	`ùs_£t_nÜm®_addr
(
ùs_dev
);

2043 
»t
 = 
	`ùs_g‘_dev_boÙ_mode
(
ùs_dev
, &
boÙ_mode
);

2044 ià(
»t
) {

2045 
	`ùs_”r
("G‘ BOOT_MODE faed %d", 
»t
);

2047 ià(
boÙ_mode
 !ğ
CTS_DEV_BOOT_MODE_SRAM
) {

2048 
	`ùs_”r
("Curr boot mode %u(%s) != SRAM_BOOT",

2049 
boÙ_mode
, 
	`ùs_dev_boÙ_mode2¡r
(boot_mode));

2054 
»t
 = 
	`ùs_g‘_fwid
(
ùs_dev
, &
fwid
);

2055 ià(
»t
) {

2056 
	`ùs_”r
("G‘ fœmw¬id faed %d,„‘r› %d", 
»t
, 
»Œ›s
);

2058 ià(
fwid
 =ğ
CTS_DEV_FWID_ICNL9911
 || fwid =ğ
CTS_DEV_FWID_ICNL9911S
)

2060 
	`ùs_šfo
("G‘ fœmw¬id sucûssfuÈ0x%02x", 
fwid
);

2064 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

2066 ià(
»Œ›s
 >= 0) {

2067 
»t
 = 
	`ùs_š™_fwd©a
(
ùs_dev
);

2068 ià(
»t
) {

2069 
	`ùs_”r
("Deviû in™ fœmw¬d©¨çed %d", 
»t
);

2070  
»t
;

2074 
	`ùs_£t_´og¿m_addr
(
ùs_dev
);

2075  
»t
;

2076 
	}
}

2078 
boŞ
 
	$ùs_is_deviû_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

2080  
ùs_dev
->
’abËd
;

2081 
	}
}

2083 
	$ùs_¡¬t_deviû
(
ùs_deviû
 *
ùs_dev
)

2085 #ià
	`defšed
(
CONFIG_CTS_ESD_PROTECTION
è|| defšed(
CONFIG_CTS_CHARGER_DETECT
è|| defšed(
CONFIG_CTS_EARJACK_DETECT
)

2086 
chÚe_ts_d©a
 *
ùs_d©a
 =

2087 
	`cÚš”_of
(
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

2089 
»t
;

2091 
	`ùs_šfo
("Start device...");

2093 ià(
	`ùs_is_deviû_’abËd
(
ùs_dev
)) {

2094 
	`ùs_w¬n
("Start device while‡lready started");

2098 #ifdeà
CONFIG_CTS_ESD_PROTECTION


2099 
	`ùs_’abË_esd_´ÙeùiÚ
(
ùs_d©a
);

2102 #ifdeà
CONFIG_CTS_CHARGER_DETECT


2103 
	`ùs_¡¬t_ch¬g”_d‘eù
(
ùs_d©a
);

2106 #ifdeà
CONFIG_CTS_EARJACK_DETECT


2107 ià(
ùs_dev
->
fwd©a
.
suµ_h—dphÚe_ÿbË_»jeù
) {

2108 
	`ùs_¡¬t_—rjack_d‘eù
(
ùs_d©a
);

2112 ià((
»t
 = 
	`ùs_¶©_’abË_œq
(
ùs_dev
->
pd©a
)) < 0) {

2113 
	`ùs_”r
("EÇbË IRQ faed %d", 
»t
);

2114  
»t
;

2117 
ùs_dev
->
’abËd
 = 
Œue
;

2119 
	`ùs_šfo
("Start device successfully");

2122 
	}
}

2124 
	$ùs_¡İ_deviû
(
ùs_deviû
 *
ùs_dev
)

2126 
chÚe_ts_d©a
 *
ùs_d©a
 =

2127 
	`cÚš”_of
(
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

2128 
»t
;

2130 
	`ùs_šfo
("Stop device...");

2132 ià(!
	`ùs_is_deviû_’abËd
(
ùs_dev
)) {

2133 
	`ùs_w¬n
("Stop device while halted");

2137 ià(
	`ùs_is_fœmw¬e_upd©šg
(
ùs_dev
)) {

2138 
	`ùs_w¬n
("Stop device while firmware updating,…leasery‡gain");

2139  -
EAGAIN
;

2142 ià((
»t
 = 
	`ùs_¶©_di§bË_œq
(
ùs_dev
->
pd©a
)) < 0) {

2143 
	`ùs_”r
("Di§bË IRQ faed %d", 
»t
);

2144  
»t
;

2147 
ùs_dev
->
’abËd
 = 
çl£
;

2149 #ifdeà
CONFIG_CTS_ESD_PROTECTION


2150 
	`ùs_di§bË_esd_´ÙeùiÚ
(
ùs_d©a
);

2153 #ifdeà
CONFIG_CTS_CHARGER_DETECT


2154 
	`ùs_¡İ_ch¬g”_d‘eù
(
ùs_d©a
);

2157 #ifdeà
CONFIG_CTS_EARJACK_DETECT


2158 ià(
ùs_dev
->
fwd©a
.
suµ_h—dphÚe_ÿbË_»jeù
) {

2159 
	`ùs_¡İ_—rjack_d‘eù
(
ùs_d©a
);

2163 
	`æush_wÜkqueue
(
ùs_d©a
->
wÜkqueue
);

2165 
»t
 = 
	`ùs_¶©_»Ëa£_®l_touch
(
ùs_dev
->
pd©a
);

2166 ià(
»t
) {

2167 
	`ùs_”r
("R–—£‡Îouch faed %d", 
»t
);

2168  
»t
;

2171 #ifdeà
CONFIG_CTS_VIRTUALKEY


2172 
»t
 = 
	`ùs_¶©_»Ëa£_®l_vkey
(
ùs_dev
->
pd©a
);

2173 ià(
»t
) {

2174 
	`ùs_”r
("R–—£‡Î vkey faed %d", 
»t
);

2175  
»t
;

2180 
	}
}

2182 #ifdeà
CONFIG_CTS_ESD_PROTECTION


2183 
	$ùs_¡¬t_deviû_esd»cov”
(
ùs_deviû
 *
ùs_dev
)

2185 
»t
;

2187 
	`ùs_šfo
("Start device...");

2189 ià(
	`ùs_is_deviû_’abËd
(
ùs_dev
)) {

2190 
	`ùs_w¬n
("Start device while‡lready started");

2194 ià((
»t
 = 
	`ùs_¶©_’abË_œq
(
ùs_dev
->
pd©a
)) < 0) {

2195 
	`ùs_”r
("EÇbË IRQ faed %d", 
»t
);

2196  
»t
;

2199 
ùs_dev
->
’abËd
 = 
Œue
;

2201 
	`ùs_šfo
("Start device successfully");

2204 
	}
}

2206 
	$ùs_¡İ_deviû_esd»cov”
(
ùs_deviû
 *
ùs_dev
)

2208 
chÚe_ts_d©a
 *
ùs_d©a
 =

2209 
	`cÚš”_of
(
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

2210 
»t
;

2212 
	`ùs_šfo
("Stop device...");

2214 ià(!
	`ùs_is_deviû_’abËd
(
ùs_dev
)) {

2215 
	`ùs_w¬n
("Stop device while halted");

2219 ià(
	`ùs_is_fœmw¬e_upd©šg
(
ùs_dev
)) {

2220 
	`ùs_w¬n
("Stop device while firmware updating,…leasery‡gain");

2221  -
EAGAIN
;

2224 ià((
»t
 = 
	`ùs_¶©_di§bË_œq
(
ùs_dev
->
pd©a
)) < 0) {

2225 
	`ùs_”r
("Di§bË IRQ faed %d", 
»t
);

2226  
»t
;

2229 
ùs_dev
->
’abËd
 = 
çl£
;

2231 
	`æush_wÜkqueue
(
ùs_d©a
->
wÜkqueue
);

2233 
»t
 = 
	`ùs_¶©_»Ëa£_®l_touch
(
ùs_dev
->
pd©a
);

2234 ià(
»t
) {

2235 
	`ùs_”r
("R–—£‡Îouch faed %d", 
»t
);

2236  
»t
;

2239 #ifdeà
CONFIG_CTS_VIRTUALKEY


2240 
»t
 = 
	`ùs_¶©_»Ëa£_®l_vkey
(
ùs_dev
->
pd©a
);

2241 ià(
»t
) {

2242 
	`ùs_”r
("R–—£‡Î vkey faed %d", 
»t
);

2243  
»t
;

2248 
	}
}

2251 
boŞ
 
	$ùs_is_fwid_v®id
(
u16
 
fwid
)

2253 
i
;

2255 
i
 = 0; i < 
	`ARRAY_SIZE
(
ùs_deviû_hwd©as
); i++) {

2256 ià(
ùs_deviû_hwd©as
[
i
].
fwid
 == fwid) {

2257  
Œue
;

2261  
çl£
;

2262 
	}
}

2264 
boŞ
 
	$ùs_is_hwid_v®id
(
u32
 
hwid
)

2266 
i
;

2268 
i
 = 0; i < 
	`ARRAY_SIZE
(
ùs_deviû_hwd©as
); i++) {

2269 ià(
ùs_deviû_hwd©as
[
i
].
hwid
 == hwid) {

2270  
Œue
;

2274  
çl£
;

2275 
	}
}

2277 
	$ùs_g‘_fwid
(
ùs_deviû
 *
ùs_dev
, 
u16
 *
fwid
)

2279 
»t
;

2281 
	`ùs_šfo
("Get device firmware id");

2283 ià(
ùs_dev
->
hwd©a
) {

2284 *
fwid
 = 
ùs_dev
->
hwd©a
->fwid;

2288 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

2289 
	`ùs_”r
("Get device firmware id while in…rogram mode");

2290 
»t
 = -
ENODEV
;

2291 
”r_out
;

2294 
»t
 = 
	`ùs_fw_»g_»adw_»Œy
(
ùs_dev
,

2295 
CTS_DEVICE_FW_REG_CHIP_TYPE
, 
fwid
, 5, 1);

2296 ià(
»t
) {

2297 
”r_out
;

2300 *
fwid
 = 
	`be16_to_ıu
(*fwid);

2302 
	`ùs_šfo
("Deviû fœmw¬id: %04x", *
fwid
);

2304 ià(!
	`ùs_is_fwid_v®id
(*
fwid
)) {

2305 
	`ùs_w¬n
("G‘ inv®id fœmw¬id %04x", *
fwid
);

2306 
»t
 = -
EINVAL
;

2307 
”r_out
;

2312 
”r_out
:

2313 *
fwid
 = 
CTS_DEV_FWID_INVALID
;

2314  
»t
;

2315 
	}
}

2317 
	$ùs_g‘_hwid
(
ùs_deviû
 *
ùs_dev
, 
u32
 *
hwid
)

2319 
»t
;

2321 
	`ùs_šfo
("Get device hardware id");

2323 ià(
ùs_dev
->
hwd©a
) {

2324 *
hwid
 = 
ùs_dev
->
hwd©a
->hwid;

2328 
	`ùs_šfo
("Device hardware data‚ot initialized,ryo„ead from„egister");

2330 ià(!
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

2331 
»t
 = 
	`ùs_’‹r_´og¿m_mode
(
ùs_dev
);

2332 ià(
»t
) {

2333 
	`ùs_”r
("EÁ”…rog¿m modçed %d", 
»t
);

2334 
”r_out
;

2338 
»t
 = 
	`ùs_hw_»g_»adl_»Œy
(
ùs_dev
, 
CTS_DEV_HW_REG_HARDWARE_ID
, 
hwid
, 5, 0);

2339 ià(
»t
) {

2340 
”r_out
;

2343 *
hwid
 = 
	`Ë32_to_ıu
(*hwid);

2344 *
hwid
 &= 0XFFFFFFF0;

2345 
	`ùs_šfo
("Deviû h¬dw¬id: %04x", *
hwid
);

2347 ià(!
	`ùs_is_hwid_v®id
(*
hwid
)) {

2348 
	`ùs_w¬n
("Deviû h¬dw¬id %04x inv®id", *
hwid
);

2349 
»t
 = -
EINVAL
;

2350 
”r_out
;

2355 
”r_out
:

2356 *
hwid
 = 
CTS_DEV_HWID_INVALID
;

2357  
»t
;

2358 
	}
}

2360 
	$ùs_´obe_deviû
(
ùs_deviû
 *
ùs_dev
)

2362 
»t
, 
»Œ›s
 = 0;

2363 
u16
 
fwid
 = 
CTS_DEV_FWID_INVALID
;

2364 
u32
 
hwid
 = 
CTS_DEV_HWID_INVALID
;

2365 
u16
 
deviû_fw_v”
 = 0;

2366 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
 = 
NULL
;

2368 
	`ùs_šfo
("Probe device");

2370 
»ad_fwid
:

2371 #ifdeà
CONFIG_CTS_I2C_HOST


2372 ià(!
	`ùs_¶©_is_i2c_Úlše
(
ùs_dev
->
pd©a
, 
CTS_DEV_NORMAL_MODE_I2CADDR
)) {

2373 
	`ùs_w¬n
("Normal mode i2c‡ddr is offline");

2376 ià(!
	`ùs_¶©_is_nÜm®_mode
(
ùs_dev
->
pd©a
)) {

2377 
	`ùs_w¬n
("Normal mode spi‡ddr is offline");

2381 
	`ùs_š™_¹d©a_w™h_nÜm®_mode
(
ùs_dev
);

2382 
»t
 = 
	`ùs_g‘_fwid
(
ùs_dev
, &
fwid
);

2383 ià(
»t
) {

2384 
	`ùs_”r
("G‘ fœmw¬id faed %d,„‘r› %d", 
»t
, 
»Œ›s
);

2386 
»t
 = 
	`ùs_fw_»g_»adw_»Œy
(
ùs_dev
,

2387 
CTS_DEVICE_FW_REG_VERSION
, &
deviû_fw_v”
, 5, 0);

2388 ià(
»t
) {

2389 
	`ùs_”r
("R—d fœmw¬v”siÚ faed %d", 
»t
);

2390 
deviû_fw_v”
 = 0;

2393 
deviû_fw_v”
 = 
	`be16_to_ıu
(device_fw_ver);

2394 
	`ùs_šfo
("Deviû fœmw¬v”siÚ: %04x", 
deviû_fw_v”
);

2396 
š™_hwd©a
;

2402 
»t
 = 
	`ùs_g‘_hwid
(
ùs_dev
, &
hwid
);

2403 ià(
»t
 || 
hwid
 =ğ
CTS_DEV_HWID_INVALID
) {

2404 
»Œ›s
++;

2406 
	`ùs_”r
("G‘ h¬dw¬id faed %d„‘r› %d", 
»t
, 
»Œ›s
);

2408 ià(
»Œ›s
 < 3) {

2409 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

2410 
»ad_fwid
;

2412  -
ENODEV
;

2416 
š™_hwd©a
:

2417 
»t
 = 
	`ùs_š™_deviû_hwd©a
(
ùs_dev
, 
hwid
, 
fwid
);

2418 ià(
»t
) {

2419 
	`ùs_”r
("Deviû hwid: %06x fwid: %04x‚Ù found", 
hwid
, 
fwid
);

2420  -
ENODEV
;

2423 #ifdeà
CFG_CTS_FIRMWARE_FORCE_UPDATE


2424 
	`ùs_w¬n
("Force update firmware");

2425 
fœmw¬e
 = 
	`ùs_»que¡_fœmw¬e
(
CTS_DEV_HWID_ANY
, 
CTS_DEV_FWID_ANY
, 0);

2427 
fœmw¬e
 = 
	`ùs_»que¡_fœmw¬e
(
hwid
, 
fwid
, 
deviû_fw_v”
);

2431 
»Œ›s
 = 0;

2432 
upd©e_fœmw¬e
:

2433 ià(
fœmw¬e
) {

2434 ++
»Œ›s
;

2435 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, 
fœmw¬e
, 
Œue
);

2436 ià(
»t
) {

2437 
	`ùs_”r
("Upd©fœmw¬çed %d„‘r› %d", 
»t
, 
»Œ›s
);

2439 ià(
»Œ›s
 < 3) {

2440 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

2441 
upd©e_fœmw¬e
;

2443 
	`ùs_»Ëa£_fœmw¬e
(
fœmw¬e
);

2444  
»t
;

2447 
	`ùs_»Ëa£_fœmw¬e
(
fœmw¬e
);

2450 ià(
fwid
 =ğ
CTS_DEV_FWID_INVALID
) {

2452  -
ENODEV
;

2454 
»t
 = 
	`ùs_š™_fwd©a
(
ùs_dev
);

2455 ià(
»t
) {

2456 
	`ùs_”r
("Deviû in™ fœmw¬d©¨çed %d", 
»t
);

2457  
»t
;

2463 
	}
}

2465 #ifdeà
CFG_CTS_GESTURE


2466 
	$ùs_’abË_ge¡u»_wakeup
(
ùs_deviû
 *
ùs_dev
)

2468 
	`ùs_šfo
("Enable gesture wakeup");

2469 
ùs_dev
->
¹d©a
.
ge¡u»_wakeup_’abËd
 = 
Œue
;

2470 
	}
}

2472 
	$ùs_di§bË_ge¡u»_wakeup
(
ùs_deviû
 *
ùs_dev
)

2474 
	`ùs_šfo
("Disable gesture wakeup");

2475 
ùs_dev
->
¹d©a
.
ge¡u»_wakeup_’abËd
 = 
çl£
;

2476 
	}
}

2478 
boŞ
 
	$ùs_is_ge¡u»_wakeup_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

2480  
ùs_dev
->
¹d©a
.
ge¡u»_wakeup_’abËd
;

2481 
	}
}

2483 
	$ùs_g‘_ge¡u»_šfo
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

2484 *
ge¡u»_šfo
, 
boŞ
 
Œaû_pošt
)

2486 
»t
;

2488 
	`ùs_šfo
("Get gesture info");

2490 ià(
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

2491 
	`ùs_w¬n
("Get gesture info in…rogram mode");

2492  -
ENODEV
;

2495 ià(!
ùs_dev
->
¹d©a
.
su¥’ded
) {

2496 
	`ùs_w¬n
("Get gesture info while‚ot suspended");

2497  -
ENODEV
;

2500 ià(!
ùs_dev
->
¹d©a
.
ge¡u»_wakeup_’abËd
) {

2501 
	`ùs_w¬n
("Get gesture info while gesture wakeup‚otƒnabled");

2502  -
ENODEV
;

2505 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
,

2506 
CTS_DEVICE_FW_REG_GESTURE_INFO
, 
ge¡u»_šfo
, 2);

2507 if(
»t
) {

2508 
	`ùs_”r
("R—d ge¡u» infØh—d” faed %d", 
»t
);

2509  
»t
;

2512 ià(
Œaû_pošt
) {

2513 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_GESTURE_INFO
 + 2,

2514 
ge¡u»_šfo
 + 2,

2515 (((
u8
 *)
ge¡u»_šfo
))[1] * (
ùs_deviû_ge¡u»_pošt
));

2516 if(
»t
) {

2517 
	`ùs_”r
("R—d ge¡u»¿û…ošt çed %d", 
»t
);

2518  
»t
;

2523 
	}
}

2526 #ifdeà
CONFIG_CTS_ESD_PROTECTION


2527 
	$ùs_esd_´ÙeùiÚ_wÜk
(
wÜk_¡ruù
 *
wÜk
)

2529 
chÚe_ts_d©a
 *
ùs_d©a
;

2530 
»t
;

2532 
	`ùs_šfo
("ESD…rotection work");

2533 
ùs_d©a
 = 
	`cÚš”_of
(
wÜk
, 
chÚe_ts_d©a
, 
esd_wÜk
.work);

2534 
	`ùs_lock_deviû
(&
ùs_d©a
->
ùs_dev
);

2535 #ifdeà
CONFIG_CTS_I2C_HOST


2536 ià(!
	`ùs_¶©_is_i2c_Úlše
(
ùs_d©a
->
pd©a
, 
CTS_DEV_NORMAL_MODE_I2CADDR
))

2538 ià(!
	`ùs_¶©_is_nÜm®_mode
(
ùs_d©a
->
pd©a
))

2541 
ùs_d©a
->
esd_check_ç_út
++;

2543 ià((
ùs_d©a
->
esd_check_ç_út
 % 2) == 0) {

2544 
	`ùs_”r
("ESD…rotection„ead‚ormal mode failed,„eset chip!");

2545 
»t
 = 
	`ùs_¶©_»£t_deviû
(
ùs_d©a
->
pd©a
);

2546 ià(
»t
) {

2547 
	`ùs_”r
("ESD…rÙeùiÚ„e£ˆch faed %d", 
»t
);

2551 
ùs_d©a
->
esd_check_ç_út
 = 0;

2554 ià(
ùs_d©a
->
esd_check_ç_út
 >ğ
CFG_CTS_ESD_FAILED_CONFIRM_CNT
) {

2555 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

2557 
	`ùs_w¬n
("ESD…rotection check failed, update firmware!!!");

2558 
	`ùs_¡İ_deviû_esd»cov”
(&
ùs_d©a
->
ùs_dev
);

2559 
fœmw¬e
 = 
	`ùs_»que¡_fœmw¬e
(
ùs_d©a
->
ùs_dev
.
hwd©a
->
hwid
,

2560 
ùs_d©a
->
ùs_dev
.
hwd©a
->
fwid
, 0);

2561 ià(
fœmw¬e
) {

2562 
»t
 = 
	`ùs_upd©e_fœmw¬e
(&
ùs_d©a
->
ùs_dev
, 
fœmw¬e
, 
Œue
);

2563 
	`ùs_»Ëa£_fœmw¬e
(
fœmw¬e
);

2565 ià(
»t
) {

2566 
	`ùs_”r
("Upd©deçuÉ fœmw¬çed %d", 
»t
);

2569 
	`ùs_”r
("Request default firmware failed %d, "

2570 "¶—£ upd©mªu®ly!!", 
»t
);

2572 
	`ùs_¡¬t_deviû_esd»cov”
(&
ùs_d©a
->
ùs_dev
);

2573 
ùs_d©a
->
esd_check_ç_út
 = 0;

2575 
	`queue_d–ayed_wÜk
(
ùs_d©a
->
esd_wÜkqueue
,

2576 &
ùs_d©a
->
esd_wÜk
, 
CFG_CTS_ESD_PROTECTION_CHECK_PERIOD
);

2578 
	`ùs_uÆock_deviû
(&
ùs_d©a
->
ùs_dev
);

2579 
	}
}

2581 
	$ùs_’abË_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
)

2583 ià(
ùs_d©a
->
esd_wÜkqueue
 && !ùs_d©a->
esd_’abËd
) {

2584 
	`ùs_šfo
("ESD…rotectionƒnable");

2586 
ùs_d©a
->
esd_’abËd
 = 
Œue
;

2587 
ùs_d©a
->
esd_check_ç_út
 = 0;

2588 
	`queue_d–ayed_wÜk
(
ùs_d©a
->
esd_wÜkqueue
,

2589 &
ùs_d©a
->
esd_wÜk
, 
CFG_CTS_ESD_PROTECTION_CHECK_PERIOD
);

2591 
	}
}

2593 
	$ùs_di§bË_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
)

2595 ià(
ùs_d©a
->
esd_wÜkqueue
 && cts_d©a->
esd_’abËd
) {

2596 
	`ùs_šfo
("ESD…rotection disable");

2598 
ùs_d©a
->
esd_’abËd
 = 
çl£
;

2599 
	`ÿnûl_d–ayed_wÜk
(&
ùs_d©a
->
esd_wÜk
);

2600 
	`æush_wÜkqueue
(
ùs_d©a
->
esd_wÜkqueue
);

2602 
	}
}

2604 
	$ùs_š™_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
)

2606 
	`ùs_šfo
("Init ESD…rotection");

2608 
	`INIT_DELAYED_WORK
(&
ùs_d©a
->
esd_wÜk
, 
ùs_esd_´ÙeùiÚ_wÜk
);

2610 
ùs_d©a
->
esd_’abËd
 = 
çl£
;

2611 
ùs_d©a
->
esd_check_ç_út
 = 0;

2612 
	}
}

2614 
	$ùs_deš™_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
)

2616 
	`ùs_šfo
("De-Init ESD…rotection");

2618 ià(
ùs_d©a
->
esd_wÜkqueue
 && cts_d©a->
esd_’abËd
) {

2619 
ùs_d©a
->
esd_’abËd
 = 
çl£
;

2620 
	`ÿnûl_d–ayed_wÜk
(&
ùs_d©a
->
esd_wÜk
);

2622 
	}
}

2625 #ifdeà
CONFIG_CTS_GLOVE


2626 
	$ùs_’‹r_glove_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

2628 
	`ùs_šfo
("Enter glove mode");

2630 
»t
 = 
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_GLOVE_MODE
, 1);

2631 ià(
»t
) {

2632 
	`ùs_”r
("Enable Glove modeƒrr");

2635 
ùs_dev
->
¹d©a
.
glove_mode_’abËd
 = 
Œue
;

2637  
»t
;

2638 
	}
}

2640 
	$ùs_ex™_glove_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

2642 
	`ùs_šfo
("Exit glove mode");

2644 
»t
 = 
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_GLOVE_MODE
, 0);

2645 ià(
»t
) {

2646 
	`ùs_”r
("Exit Glove modeƒrr");

2649 
ùs_dev
->
¹d©a
.
glove_mode_’abËd
 = 
çl£
;

2651  
»t
;

2652 
	}
}

2654 
	$ùs_is_glove_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

2656  
ùs_dev
->
¹d©a
.
glove_mode_’abËd
;

2657 
	}
}

2661 #ifdeà
CONFIG_CTS_CHARGER_DETECT


2662 
boŞ
 
	$ùs_is_ch¬g”_exi¡
(
ùs_deviû
 *
ùs_dev
)

2664 
chÚe_ts_d©a
 *
ùs_d©a
;

2665 
boŞ
 
©ched
 = 
çl£
;

2666 
»t
;

2668 
ùs_d©a
 = 
	`cÚš”_of
(
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

2670 
»t
 = 
	`ùs_is_ch¬g”_©ched
(
ùs_d©a
, &
©ched
);

2671 ià(
»t
) {

2672 
	`ùs_”r
("G‘ ch¬g” s‹ faed %d", 
»t
);

2675 
ùs_dev
->
¹d©a
.
ch¬g”_exi¡
 = 
©ched
;

2677  
©ched
;

2678 
	}
}

2680 
	$ùs_£t_dev_ch¬g”_©ched
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
©ched
)

2682 
»t
;

2684 
	`ùs_šfo
("S‘ dev ch¬g” %s", 
©ched
 ? "ATTACHED" : "DETATCHED");

2685 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
,

2686 
©ched
 ? 
CTS_CMD_CHARGER_ATTACHED
 : 
CTS_CMD_CHARGER_DETACHED
);

2687 ià(
»t
) {

2688 ià(
»t
) {

2689 
	`ùs_”r
("Send CMD_CHARGER_%s failed %d",

2690 
©ched
 ? "ATTACHED" : "DETACHED", 
»t
);

2694  
»t
;

2695 
	}
}

2698 #ifdeà
CONFIG_CTS_EARJACK_DETECT


2699 
boŞ
 
	$ùs_is_—rjack_exi¡
(
ùs_deviû
 *
ùs_dev
)

2701 
chÚe_ts_d©a
 *
ùs_d©a
;

2702 
boŞ
 
©ched
 = 
çl£
;

2703 
»t
;

2705 
ùs_d©a
 = 
	`cÚš”_of
(
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

2707 
»t
 = 
	`ùs_is_—rjack_©ched
(
ùs_d©a
, &
©ched
);

2708 ià(
»t
) {

2709 
	`ùs_”r
("G‘ƒ¬jack s‹ faed %d", 
»t
);

2712  
©ched
;

2713 
	}
}

2715 
	$ùs_£t_dev_—rjack_©ched
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
©ched
)

2717 
»t
;

2719 
	`ùs_šfo
("S‘ devƒ¬jack %s", 
©ched
 ? "ATTACHED" : "DETATCHED");

2720 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
,

2721 
©ched
 ? 
CTS_CMD_EARJACK_ATTACHED
 : 
CTS_CMD_EARJACK_DETACHED
);

2722 ià(
»t
) {

2723 
	`ùs_”r
("Send CMD_EARJACK_%s failed %d",

2724 
©ched
 ? "ATTACHED" : "DETACHED", 
»t
);

2727  
»t
;

2728 
	}
}

2731 
	$ùs_’abË_fw_log_»dœeù
(
ùs_deviû
 *
ùs_dev
)

2733 
»t
;

2735 
	`ùs_šfo
("Fw†og„edirectƒnable");

2736 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_ENABLE_FW_LOG_REDIRECT
);

2737 ià(
»t
) {

2738 
	`ùs_”r
("S’d CTS_CMD_ENABLE_FW_LOG_REDIRECT faed %d", 
»t
);

2740 
ùs_dev
->
¹d©a
.
fw_log_»dœeù_’abËd
 = 
Œue
;

2742  
»t
;

2743 
	}
}

2745 
	$ùs_di§bË_fw_log_»dœeù
(
ùs_deviû
 *
ùs_dev
)

2747 
»t
;

2749 
	`ùs_šfo
("Fw†og„edirect disable");

2750 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_DISABLE_FW_LOG_REDIRECT
);

2751 ià(
»t
) {

2752 
	`ùs_”r
("S’d CTS_CMD_DISABLE_FW_LOG_REDIRECT faed %d", 
»t
);

2754 
ùs_dev
->
¹d©a
.
fw_log_»dœeù_’abËd
 = 
çl£
;

2756  
»t
;

2757 
	}
}

2759 
boŞ
 
	$ùs_is_fw_log_»dœeù
(
ùs_deviû
 *
ùs_dev
)

2761  
ùs_dev
->
¹d©a
.
fw_log_»dœeù_’abËd
;

2762 
	}
}

2764 
	$ùs_fw_log_show_fšish
(
ùs_deviû
 *
ùs_dev
)

2766 
»t
;

2768 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_FW_LOG_SHOW_FINISH
);

2769 ià(
»t
) {

2770 
	`ùs_”r
("S’d CTS_CMD_FW_LOG_SHOW_FINISH faed %d", 
»t
);

2773  
»t
;

2774 
	}
}

2776 
	$ùs_g‘_com³n§‹_ÿp
(
ùs_deviû
 *
ùs_dev
, 
u8
 *
ÿp
)

2778 
i
, 
»t
;

2779 
u8
 
auto_ÿlib_comp_ÿp_’abËd
;

2781 ià(
ùs_dev
 =ğ
NULL
 || 
ÿp
 == NULL) {

2782 
	`ùs_”r
("Get compensate cap with cts_dev(%p) or cap(%p) = NULL",

2783 
ùs_dev
, 
ÿp
);

2784  -
EINVAL
;

2787 ià(
ùs_dev
->
hwd©a
->
hwid
 =ğ
CTS_DEV_HWID_ICNL9911
 &&

2788 
ùs_dev
->
fwd©a
.
lib_v”siÚ
 < 0x0500) {

2789 
	`ùs_”r
("ICNL9911†ib version 0x%04x < v5.0 "

2791 
ùs_dev
->
fwd©a
.
lib_v”siÚ
);

2792  -
ENOTSUPP
;

2795 
	`ùs_šfo
("Get compensate cap");

2798 
	`ùs_šfo
(" - Get‡uto calib comp capƒnable");

2799 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

2800 
CTS_DEVICE_FW_REG_AUTO_CALIB_COMP_CAP_ENABLE
,

2801 &
auto_ÿlib_comp_ÿp_’abËd
);

2802 ià(
»t
) {

2803 
	`ùs_”r
("G‘‡utØÿlib com°ÿ°’abË faed %d", 
»t
);

2804  
»t
;

2808 ià(
auto_ÿlib_comp_ÿp_’abËd
) {

2809 
u8
 
auto_ÿlib_comp_ÿp_dÚe
;

2811 
	`ùs_šfo
(" - Wait‡uto calib comp cap done...");

2813 
i
 = 0;

2815 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

2816 
CTS_DEVICE_FW_REG_AUTO_CALIB_COMP_CAP_DONE
,

2817 &
auto_ÿlib_comp_ÿp_dÚe
);

2818 ià(
»t
) {

2819 
	`ùs_”r
("G‘‡utØÿlib com°ÿ°dÚçed %d", 
»t
);

2821 ià(
auto_ÿlib_comp_ÿp_dÚe
) {

2822 
’abË_»ad_com³n§‹_ÿp
;

2826 
	`md–ay
(5);

2827 } ++
i
 < 100);

2829 
	`ùs_”r
("Wait‡uto calib comp cap doneimeout");

2830  -
ETIMEDOUT
;

2833 
’abË_»ad_com³n§‹_ÿp
:

2834 
	`ùs_šfo
(" - Enable„ead comp cap");

2835 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_ENABLE_READ_CNEG
);

2836 ià(
»t
) {

2837 
	`ùs_”r
("EÇbË„—d com°ÿ°çed %d",
»t
);

2838  
»t
;

2842 
	`ùs_šfo
(" - Wait comp cap„eady...");

2843 
i
 = 0;

2845 
u8
 
»ady
;

2847 
	`md–ay
(5);

2849 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

2850 
CTS_DEVICE_FW_REG_COMPENSATE_CAP_READY
, &
»ady
);

2851 ià(
»t
) {

2852 
	`ùs_”r
("R—d com°ÿ°»ady faed %d", 
»t
);

2854 ià(
»ady
) {

2855 
»ad_com³n§‹_ÿp
;

2858 } ++
i
 < 100);

2860 
	`ùs_”r
("Wait comp cap„eadyimeout");

2861  -
ETIMEDOUT
;

2863 
»ad_com³n§‹_ÿp
:

2865 
	`ùs_šfo
(" - Read comp cap");

2866 
»t
 = 
	`ùs_fw_»g_»adsb_d–ay_idË
(
ùs_dev
,

2867 
CTS_DEVICE_FW_REG_COMPENSATE_CAP
, 
ÿp
,

2868 
ùs_dev
->
hwd©a
->
num_row
 * cts_dev->hwd©a->
num_cŞ
,

2870 ià(
»t
) {

2871 
	`ùs_”r
("R—d com°ÿ°çed %d",
»t
);

2875 
	`ùs_šfo
(" - Clear comp cap„eady");

2876 
i
 = 0;

2878 
r
;

2879 
u8
 
»ady
;

2881 
r
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_DISABLE_READ_CNEG
);

2882 ià(
r
) {

2883 
	`ùs_”r
("S’d cmd DISABLE_READ_CNEG faed %d", 
r
);

2887 
	`md–ay
(5);

2888 
r
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

2889 
CTS_DEVICE_FW_REG_COMPENSATE_CAP_READY
, &
»ady
);

2890 ià(
r
) {

2891 
	`ùs_”r
("Re-Check com°ÿ°»ady faed %d", 
r
);

2895 ià(
»ady
) {

2896 
	`ùs_w¬n
("Comp cap„eady is still set");

2899  
»t
;

2901 }++
i
 < 100);

2903 
	`ùs_w¬n
("Clr comp cap„eady failed,ryo do„eset!");

2906 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

2908 #ifdeà
CONFIG_CTS_CHARGER_DETECT


2909 ià(
	`ùs_is_ch¬g”_exi¡
(
ùs_dev
)) {

2910 
r
 = 
	`ùs_£t_dev_ch¬g”_©ched
(
ùs_dev
, 
Œue
);

2911 ià(
r
) {

2912 
	`ùs_”r
("S‘ dev ch¬g”‡‰ached faed %d", 
r
);

2917 #ifdeà
CONFIG_CTS_EARJACK_DETECT


2918 ià(
ùs_dev
->
fwd©a
.
suµ_h—dphÚe_ÿbË_»jeù
 &&

2919 
	`ùs_is_—rjack_exi¡
(
ùs_dev
)) {

2920 
r
 = 
	`ùs_£t_dev_—rjack_©ched
(
ùs_dev
, 
Œue
);

2921 ià(
r
) {

2922 
	`ùs_”r
("S‘ devƒ¬jack‡‰ached faed %d", 
r
);

2927 #ifdeà
CONFIG_CTS_GLOVE


2928 ià(
	`ùs_is_glove_’abËd
(
ùs_dev
)) {

2929 
r
 = 
	`ùs_’‹r_glove_mode
(
ùs_dev
);

2930 ià(
r
) {

2931 
	`ùs_”r
("EÁ” dev glovmodçed %d", 
r
);

2936 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


2937 ià(
	`ùs_is_fw_log_»dœeù
(
ùs_dev
)) {

2938 
r
 = 
	`ùs_’abË_fw_log_»dœeù
(
ùs_dev
);

2939 ià(
r
) {

2940 
	`ùs_”r
("EÇbË fw†og„edœeù faed %d", 
r
);

2945  
»t
;

2946 
	}
}

2948 
fe
 *
	gùs_log_fp
 = 
NULL
;

2949 
	gùs_log_to_fe_Ëv–
 = 0;

2950 
ùs_wr™e_fe
(
fe
 *
fp
, cÚ¡ *
d©a
, 
size_t
 
size
);

2952 *
	gùs_log_bufãr
 = 
NULL
;

2953 
	gùs_log_buf_size
 = 0;

2954 
	gùs_log_buf_wr_size
 = 0;

2956 
boŞ
 
	gùs_log_»dœeù
 = 
çl£
;

2958 
	$ùs_¡¬t_driv”_log_»dœeù
(cÚ¡ *
f•©h
, 
boŞ
 
­³nd_to_fe
,

2959 *
log_bufãr
, 
log_buf_size
, 
log_Ëv–
)

2961 
	#START_BANNER
 \

2962 ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n"

	)

2964 
»t
 = 0;

2966 
	`ùs_šfo
("Start driver†og„edirect");

2968 
ùs_log_to_fe_Ëv–
 = 
log_Ëv–
;

2970 ià(
log_bufãr
 && 
log_buf_size
) {

2971 
	`ùs_šfo
(" - Start driver†ogo buffer: %p size: %d†evel: %d",

2972 
log_bufãr
, 
log_buf_size
, 
log_Ëv–
);

2973 
ùs_log_bufãr
 = 
log_bufãr
;

2974 
ùs_log_buf_size
 = 
log_buf_size
;

2975 
ùs_log_buf_wr_size
 = 0;

2978 ià(
f•©h
 && filepath[0]) {

2979 
	`ùs_šfo
(" - Start driver†ogo file : '%s'†evel: %d",

2980 
f•©h
, 
log_Ëv–
);

2981 
ùs_log_fp
 = 
	`fp_İ’
(
f•©h
,

2982 
O_WRONLY
 | 
O_CREAT
 | (
­³nd_to_fe
 ? 
O_APPEND
 : 
O_TRUNC
),

2983 
S_IRUGO
 | 
S_IWUGO
);

2984 ià(
	`IS_ERR
(
ùs_log_fp
)) {

2985 
»t
 = 
	`PTR_ERR
(
ùs_log_fp
);

2986 
ùs_log_fp
 = 
NULL
;

2987 
	`ùs_”r
("Open file '%s' for driver†og failed %d",

2988 
f•©h
, 
»t
);

2990 
	`ùs_wr™e_fe
(
ùs_log_fp
, 
START_BANNER
, 
	`¡¾’
(START_BANNER));

2994 
ùs_log_»dœeù
 = 
Œue
;

2996  
»t
;

2997 #undeà
START_BANNER


2998 
	}
}

3000 
	$ùs_¡İ_driv”_log_»dœeù
()

3002 
	#END_BANNER
 \

3003 "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\n"

	)

3005 
ùs_log_»dœeù
 = 
çl£
;

3007 
	`ùs_šfo
("Stop driver†og„edirect");

3009 ià(
ùs_log_fp
) {

3010 
»t
;

3012 
	`ùs_šfo
(" - Stop driver†ogo file");

3014 
	`ùs_wr™e_fe
(
ùs_log_fp
, 
END_BANNER
, 
	`¡¾’
(END_BANNER));

3015 
»t
 = 
	`fp_şo£
(
ùs_log_fp
, 
NULL
);

3016 ià(
»t
) {

3017 
	`ùs_”r
("Clo£ driv”†og fçed %d", 
»t
);

3019 
ùs_log_fp
 = 
NULL
;

3022 ià(
ùs_log_bufãr
) {

3023 
	`ùs_šfo
(" - Stop driver†ogo buffer");

3025 
ùs_log_bufãr
 = 
NULL
;

3026 
ùs_log_buf_size
 = 0;

3027 
ùs_log_buf_wr_size
 = 0;

3030 #undeà
END_BANNER


3031 
	}
}

3033 
	$ùs_g‘_driv”_log_»dœeù_size
()

3035 ià(
ùs_log_»dœeù
 && 
ùs_log_bufãr
 && 
ùs_log_buf_wr_size
) {

3036  
ùs_log_buf_wr_size
;

3040 
	}
}

3042 
	$ùs_log
(
Ëv–
, cÚ¡ *
fmt
, ...)

3044 
va_li¡
 
¬gs
;

3046 
	`va_¡¬t
(
¬gs
, 
fmt
);

3048 ià(
ùs_log_»dœeù
) {

3049 ià(
ùs_log_bufãr
 &&

3050 
ùs_log_buf_wr_size
 < 
ùs_log_buf_size
 &&

3051 
Ëv–
 <ğ
ùs_log_to_fe_Ëv–
)

3053 
ùs_log_buf_wr_size
 +ğ
	`vsú´štf
(
ùs_log_bufãr
 + cts_log_buf_wr_size,

3054 
ùs_log_buf_size
 - 
ùs_log_buf_wr_size
, 
fmt
, 
¬gs
);

3057 ià(
ùs_log_fp
 !ğ
NULL
 && 
Ëv–
 <ğ
ùs_log_to_fe_Ëv–
) {

3058 
buf
[512];

3059 
couÁ
 = 
	`vsú´štf
(
buf
, (buf), 
fmt
, 
¬gs
);

3061 
	`ùs_wr™e_fe
(
ùs_log_fp
, 
buf
, 
couÁ
);

3065 ià(
Ëv–
 < 
CTS_DRIVER_LOG_DEBUG
 || 
ùs_show_debug_log
) {

3066 
	`v´štk
(
fmt
, 
¬gs
);

3069 
	`va_’d
(
¬gs
);

3070 
	}
}

	@cts_core.h

1 #iâdeà
CTS_CORE_H


2 
	#CTS_CORE_H


	)

4 
	~"ùs_cÚfig.h
"

6 
	eùs_dev_hw_»g
 {

7 
	mCTS_DEV_HW_REG_HARDWARE_ID
 = 0x30000u,

8 
	mCTS_DEV_HW_REG_CLOCK_GATING
 = 0x30004u,

9 
	mCTS_DEV_HW_REG_RESET_CONFIG
 = 0x30008u,

10 
	mCTS_DEV_HW_REG_BOOT_MODE
 = 0x30010u,

11 
	mCTS_DEV_HW_REG_CURRENT_MODE
 = 0x30011u,

14 
	eùs_dev_boÙ_mode
 {

15 
	mCTS_DEV_BOOT_MODE_FLASH
 = 1,

16 
	mCTS_DEV_BOOT_MODE_I2C_PROGRAM
 = 2,

17 
	mCTS_DEV_BOOT_MODE_SRAM
 = 3,

18 
	mCTS_DEV_BOOT_MODE_SPI_PROGRAM
 = 5,

19 
	mCTS_DEV_BOOT_MODE_MASK
 = 7,

23 
	#CTS_DEV_NORMAL_MODE_I2CADDR
 (0x48)

	)

24 
	#CTS_DEV_PROGRAM_MODE_I2CADDR
 (0x30)

	)

25 
	#CTS_DEV_NORMAL_MODE_ADDR_WIDTH
 (2)

	)

26 
	#CTS_DEV_PROGRAM_MODE_ADDR_WIDTH
 (3)

	)

27 
	#CTS_DEV_NORMAL_MODE_SPIADDR
 (0xF0)

	)

28 
	#CTS_DEV_PROGRAM_MODE_SPIADDR
 (0x60)

	)

31 
	eùs_deviû_fw_»g
 {

32 
	mCTS_DEVICE_FW_REG_WORK_MODE
 = 0x0000,

33 
	mCTS_DEVICE_FW_REG_SYS_BUSY
 = 0x0001,

34 
	mCTS_DEVICE_FW_REG_DATA_READY
 = 0x0002,

35 
	mCTS_DEVICE_FW_REG_CMD
 = 0x0004,

36 
	mCTS_DEVICE_FW_REG_POWER_MODE
 = 0x0005,

37 
	mCTS_DEVICE_FW_REG_FW_LIB_MAIN_VERSION
 = 0x0009,

38 
	mCTS_DEVICE_FW_REG_CHIP_TYPE
 = 0x000A,

39 
	mCTS_DEVICE_FW_REG_VERSION
 = 0x000C,

40 
	mCTS_DEVICE_FW_REG_DDI_VERSION
 = 0x0010,

41 
	mCTS_DEVICE_FW_REG_GET_WORK_MODE
 = 0x003F,

42 
	mCTS_DEVICE_FW_REG_AUTO_CALIB_COMP_CAP_DONE
 = 0x0046,

43 
	mCTS_DEVICE_FW_REG_FW_LIB_SUB_VERSION
 = 0x0047,

44 
	mCTS_DEVICE_FW_REG_COMPENSATE_CAP_READY
 = 0x004E,

46 
	mCTS_DEVICE_FW_REG_TOUCH_INFO
 = 0x1000,

47 
	mCTS_DEVICE_FW_REG_RAW_DATA
 = 0x2000,

48 
	mCTS_DEVICE_FW_REG_DIFF_DATA
 = 0x3000,

49 
	mCTS_DEVICE_FW_REG_GESTURE_INFO
 = 0x7000,

51 
	mCTS_DEVICE_FW_REG_PANEL_PARAM
 = 0x8000,

52 
	mCTS_DEVICE_FW_REG_NUM_TX
 = 0x8007,

53 
	mCTS_DEVICE_FW_REG_NUM_RX
 = 0x8008,

54 
	mCTS_DEVICE_FW_REG_INT_KEEP_TIME
 = 0x8047,

55 
	mCTS_DEVICE_FW_REG_RAWDATA_TARGET
 = 0x8049,

56 
	mCTS_DEVICE_FW_REG_X_RESOLUTION
 = 0x8090,

57 
	mCTS_DEVICE_FW_REG_Y_RESOLUTION
 = 0x8092,

58 
	mCTS_DEVICE_FW_REG_SWAP_AXES
 = 0x8094,

59 
	mCTS_DEVICE_FW_REG_GLOVE_MODE
 = 0x8095,

60 
	mCTS_DEVICE_FW_REG_TEST_WITH_DISPLAY_ON
 = 0x80A3,

61 
	mCTS_DEVICE_FW_REG_INT_MODE
 = 0x80D8,

62 
	mCTS_DEVICE_FW_REG_EARJACK_DETECT_SUPP
 = 0x8113,

63 
	mCTS_DEVICE_FW_REG_AUTO_CALIB_COMP_CAP_ENABLE
 = 0x8114,

64 
	mCTS_DEVICE_FW_REG_ESD_PROTECTION
 = 0x8156,

65 
	mCTS_DEVICE_FW_REG_FLAG_BITS
 = 0x8158,

67 
	mCTS_DEVICE_FW_REG_COMPENSATE_CAP
 = 0xA000,

68 
	mCTS_DEVICE_FW_REG_DEBUG_INTF
 = 0xF000,

72 
	eùs_dev_hwid
 {

73 
	mCTS_DEV_HWID_ICNL9911
 = 0x990100u,

74 
	mCTS_DEV_HWID_ICNL9911S
 = 0x990110u,

75 
	mCTS_DEV_HWID_ICNL9911C
 = 0x991110u,

77 
	mCTS_DEV_HWID_ANY
 = 0,

78 
	mCTS_DEV_HWID_INVALID
 = 0xFFFFFFFFu,

83 
	eùs_dev_fwid
 {

84 
	mCTS_DEV_FWID_ICNL9911
 = 0x9911u,

85 
	mCTS_DEV_FWID_ICNL9911S
 = 0x9964u,

86 
	mCTS_DEV_FWID_ICNL9911C
 = 0x9954u,

88 
	mCTS_DEV_FWID_ANY
 = 0u,

89 
	mCTS_DEV_FWID_INVALID
 = 0xFFFFu

93 
	eùs_fœmw¬e_cmd
 {

94 
	mCTS_CMD_RESET
 = 1,

95 
	mCTS_CMD_SUSPEND
 = 2,

96 
	mCTS_CMD_ENTER_WRITE_PARA_TO_FLASH_MODE
 = 3,

97 
	mCTS_CMD_WRITE_PARA_TO_FLASH
 = 4,

98 
	mCTS_CMD_WRTITE_INT_HIGH
 = 5,

99 
	mCTS_CMD_WRTITE_INT_LOW
 = 6,

100 
	mCTS_CMD_RELASE_INT_TEST
 = 7,

101 
	mCTS_CMD_RECOVERY_TX_VOL
 = 0x10,

102 
	mCTS_CMD_DEC_TX_VOL_1
 = 0x11,

103 
	mCTS_CMD_DEC_TX_VOL_2
 = 0x12,

104 
	mCTS_CMD_DEC_TX_VOL_3
 = 0x13,

105 
	mCTS_CMD_DEC_TX_VOL_4
 = 0x14,

106 
	mCTS_CMD_DEC_TX_VOL_5
 = 0x15,

107 
	mCTS_CMD_DEC_TX_VOL_6
 = 0x16,

108 
	mCTS_CMD_ENABLE_READ_RAWDATA
 = 0x20,

109 
	mCTS_CMD_DISABLE_READ_RAWDATA
 = 0x21,

110 
	mCTS_CMD_SUSPEND_WITH_GESTURE
 = 0x40,

111 
	mCTS_CMD_QUIT_GESTURE_MONITOR
 = 0x41,

112 
	mCTS_CMD_CHARGER_ATTACHED
 = 0x55,

113 
	mCTS_CMD_EARJACK_ATTACHED
 = 0x57,

114 
	mCTS_CMD_EARJACK_DETACHED
 = 0x58,

115 
	mCTS_CMD_CHARGER_DETACHED
 = 0x66,

116 
	mCTS_CMD_ENABLE_FW_LOG_REDIRECT
 = 0x86,

117 
	mCTS_CMD_DISABLE_FW_LOG_REDIRECT
 = 0x87,

118 
	mCTS_CMD_ENABLE_READ_CNEG
 = 0x88,

119 
	mCTS_CMD_DISABLE_READ_CNEG
 = 0x89,

120 
	mCTS_CMD_FW_LOG_SHOW_FINISH
 = 0xE0,

124 #´agm¨
·ck
(1)

126 
	sùs_deviû_touch_msg
 {

127 
u8
 
	mid
;

128 
__Ë16
 
	mx
;

129 
__Ë16
 
	my
;

130 
u8
 
	m´essu»
;

131 
u8
 
	mev’t
;

133 
	#CTS_DEVICE_TOUCH_EVENT_NONE
 (0)

	)

134 
	#CTS_DEVICE_TOUCH_EVENT_DOWN
 (1)

	)

135 
	#CTS_DEVICE_TOUCH_EVENT_MOVE
 (2)

	)

136 
	#CTS_DEVICE_TOUCH_EVENT_STAY
 (3)

	)

137 
	#CTS_DEVICE_TOUCH_EVENT_UP
 (4)

	)

142 
	sùs_deviû_touch_šfo
 {

143 
u8
 
	mvkey_¡©e
;

144 
u8
 
	mnum_msg
;

146 
ùs_deviû_touch_msg
 
	mmsgs
[
CFG_CTS_MAX_TOUCH_NUM
];

150 
	sùs_deviû_ge¡u»_pošt
 {

151 
__Ë16
 
	mx
;

152 
__Ë16
 
	my
;

153 
u8
 
	m´essu»
;

154 
u8
 
	mev’t
;

158 
	sùs_deviû_ge¡u»_šfo
 {

159 
u8
 
	mge¡u»_id
;

160 
	#CTS_GESTURE_UP
 (0x11)

	)

161 
	#CTS_GESTURE_C
 (0x12)

	)

162 
	#CTS_GESTURE_O
 (0x13)

	)

163 
	#CTS_GESTURE_M
 (0x14)

	)

164 
	#CTS_GESTURE_W
 (0x15)

	)

165 
	#CTS_GESTURE_E
 (0x16)

	)

166 
	#CTS_GESTURE_S
 (0x17)

	)

167 
	#CTS_GESTURE_B
 (0x18)

	)

168 
	#CTS_GESTURE_T
 (0x19)

	)

169 
	#CTS_GESTURE_H
 (0x1A)

	)

170 
	#CTS_GESTURE_F
 (0x1B)

	)

171 
	#CTS_GESTURE_X
 (0x1C)

	)

172 
	#CTS_GESTURE_Z
 (0x1D)

	)

173 
	#CTS_GESTURE_V
 (0x1E)

	)

174 
	#CTS_GESTURE_D_TAP
 (0x50)

	)

176 
u8
 
	mnum_pošts
;

178 
	#CTS_CHIP_MAX_GESTURE_TRACE_POINT
 (64u)

	)

179 
ùs_deviû_ge¡u»_pošt
 
	mpošts
[
CTS_CHIP_MAX_GESTURE_TRACE_POINT
];

182 #´agm¨
·ck
()

185 
	gùs_deviû
;

187 
	eùs_üc_ty³
 {

188 
	mCTS_CRC16
 = 1,

189 
	mCTS_CRC32
 = 2,

193 
	sùs_deviû_hwd©a
 {

194 cÚ¡ *
	mÇme
;

195 
u32
 
	mhwid
;

196 
u16
 
	mfwid
;

197 
u8
 
	mnum_row
;

198 
u8
 
	mnum_cŞ
;

199 
u32
 
	m¤am_size
;

202 
u8
 
	m´og¿m_addr_width
;

204 cÚ¡ 
ùs_sfù¾
 *
	msfù¾
;

206 (*
	m’abË_acûss_ddi_»g
)(
ùs_deviû
 *
	mùs_dev
, 
boŞ
 
	m’abË
);

210 
	sùs_deviû_fwd©a
 {

211 
u16
 
	mv”siÚ
;

212 
u16
 
	m»s_x
;

213 
u16
 
	m»s_y
;

214 
u8
 
	mrows
;

215 
u8
 
	mcŞs
;

216 
boŞ
 
	mæ_x
;

217 
boŞ
 
	mæ_y
;

218 
boŞ
 
	msw­_axes
;

219 
u8
 
	mddi_v”siÚ
;

220 
u8
 
	mšt_mode
;

221 
u8
 
	mesd_m‘hod
;

222 
u16
 
	mlib_v”siÚ
;

223 
u16
 
	mšt_k“p_time
;

224 
u16
 
	m¿wd©a_rg‘
;

225 #ifdeà
CONFIG_CTS_EARJACK_DETECT


226 
boŞ
 
	msuµ_h—dphÚe_ÿbË_»jeù
;

231 
	sùs_deviû_¹d©a
 {

232 
u8
 
	m¦ave_addr
;

233 
	maddr_width
;

234 
boŞ
 
	m´og¿m_mode
;

235 
boŞ
 
	mhas_æash
;

237 
boŞ
 
	msu¥’ded
;

238 
boŞ
 
	mupd©šg
;

239 
boŞ
 
	m‹¡šg
;

241 
boŞ
 
	mge¡u»_wakeup_’abËd
;

242 
boŞ
 
	mch¬g”_exi¡
;

243 
boŞ
 
	mfw_log_»dœeù_’abËd
;

244 
boŞ
 
	mglove_mode_’abËd
;

247 
	sùs_deviû
 {

248 
ùs_¶©fÜm_d©a
 *
	mpd©a
;

250 cÚ¡ 
ùs_deviû_hwd©a
 *
	mhwd©a
;

251 
ùs_deviû_fwd©a
 
	mfwd©a
;

252 
ùs_deviû_¹d©a
 
	m¹d©a
;

253 cÚ¡ 
ùs_æash
 *
	mæash
;

254 
boŞ
 
	m’abËd
;

258 
	gùs_¶©fÜm_d©a
;

260 
	schÚe_ts_d©a
 {

261 #ifdeà
CONFIG_CTS_I2C_HOST


262 
i2c_ş›Á
 *
	mi2c_ş›Á
;

264 
¥i_deviû
 *
	m¥i_ş›Á
;

267 
deviû
 *
	mdeviû
;

269 
ùs_deviû
 
	mùs_dev
;

271 
ùs_¶©fÜm_d©a
 *
	mpd©a
;

273 
wÜkqueue_¡ruù
 *
	mwÜkqueue
;

275 #ifdeà
CONFIG_CTS_ESD_PROTECTION


276 
wÜkqueue_¡ruù
 *
	mesd_wÜkqueue
;

277 
d–ayed_wÜk
 
	mesd_wÜk
;

278 
boŞ
 
	mesd_’abËd
;

279 
	mesd_check_ç_út
;

282 #ifdeà
CONFIG_CTS_CHARGER_DETECT


283 *
	mch¬g”_d‘eù_d©a
;

286 #ifdeà
CONFIG_CTS_EARJACK_DETECT


287 *
	m—rjack_d‘eù_d©a
;

290 #ifdeà
CONFIG_CTS_LEGACY_TOOL


291 
´oc_dœ_’Œy
 *
	m´ocfs_’Œy
;

296 
šlše
 
u32
 
	$g‘_uÇligÃd_Ë24
(cÚ¡ *
p
)

298 cÚ¡ 
u8
 *
puc
 = (cÚ¡ u8 *)
p
;

299  (
puc
[0] | (puc[1] << 8) | (puc[2] << 16));

300 
	}
}

302 
šlše
 
u32
 
	$g‘_uÇligÃd_be24
(cÚ¡ *
p
)

304 cÚ¡ 
u8
 *
puc
 = (cÚ¡ u8 *)
p
;

305  (
puc
[2] | (puc[1] << 8) | (puc[0] << 16));

306 
	}
}

308 
šlše
 
	$put_uÇligÃd_be24
(
u32
 
v
, *
p
)

310 
u8
 *
puc
 = (u8 *)
p
;

312 
puc
[0] = (
v
 >> 16) & 0xFF;

313 
puc
[1] = (
v
 >> 8 ) & 0xFF;

314 
puc
[2] = (
v
 >> 0 ) & 0xFF;

315 
	}
}

317 
	#w¿p
(
max
,
x
è((maxè- 1 - (x))

	)

319 
ùs_lock_deviû
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

320 
ùs_uÆock_deviû
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

322 
ùs_¤am_wr™eb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

323 
u32
 
addr
, 
u8
 
b
, 
»Œy
, 
d–ay
);

324 
ùs_¤am_wr™ew_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

325 
u32
 
addr
, 
u16
 
w
, 
»Œy
, 
d–ay
);

326 
ùs_¤am_wr™–_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

327 
u32
 
addr
, u32 
l
, 
»Œy
, 
d–ay
);

328 
ùs_¤am_wr™esb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

329 
u32
 
addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

330 
ùs_¤am_wr™esb_check_üc_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

331 
u32
 
addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, u32 
üc
, 
»Œy
);

333 
ùs_¤am_»adb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

334 
u32
 
addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
);

335 
ùs_¤am_»adw_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

336 
u32
 
addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
);

337 
ùs_¤am_»adl_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

338 
u32
 
addr
, u32 *
l
, 
»Œy
, 
d–ay
);

339 
ùs_¤am_»adsb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

340 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

342 
ùs_fw_»g_wr™eb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

343 
u32
 
»g_addr
, 
u8
 
b
, 
»Œy
, 
d–ay
);

344 
ùs_fw_»g_wr™ew_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

345 
u32
 
»g_addr
, 
u16
 
w
, 
»Œy
, 
d–ay
);

346 
ùs_fw_»g_wr™–_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

347 
u32
 
»g_addr
, u32 
l
, 
»Œy
, 
d–ay
);

348 
ùs_fw_»g_wr™esb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

349 
u32
 
»g_addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

351 
ùs_fw_»g_»adb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

352 
u32
 
»g_addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
);

353 
ùs_fw_»g_»adw_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

354 
u32
 
»g_addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
);

355 
ùs_fw_»g_»adl_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

356 
u32
 
»g_addr
, u32 *
l
, 
»Œy
, 
d–ay
);

357 
ùs_fw_»g_»adsb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

358 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

359 
ùs_fw_»g_»adsb_»Œy_d–ay_idË
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

360 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
, 
idË
);

362 
ùs_hw_»g_wr™eb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

363 
u32
 
»g_addr
, 
u8
 
b
, 
»Œy
, 
d–ay
);

364 
ùs_hw_»g_wr™ew_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

365 
u32
 
»g_addr
, 
u16
 
w
, 
»Œy
, 
d–ay
);

366 
ùs_hw_»g_wr™–_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

367 
u32
 
»g_addr
, u32 
l
, 
»Œy
, 
d–ay
);

368 
ùs_hw_»g_wr™esb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

369 
u32
 
»g_addr
, cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

371 
ùs_hw_»g_»adb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

372 
u32
 
»g_addr
, 
u8
 *
b
, 
»Œy
, 
d–ay
);

373 
ùs_hw_»g_»adw_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

374 
u32
 
»g_addr
, 
u16
 *
w
, 
»Œy
, 
d–ay
);

375 
ùs_hw_»g_»adl_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

376 
u32
 
»g_addr
, u32 *
l
, 
»Œy
, 
d–ay
);

377 
ùs_hw_»g_»adsb_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

378 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

380 
šlše
 
	$ùs_fw_»g_wr™eb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u8
 
b
)

382  
	`ùs_fw_»g_wr™eb_»Œy
(
ùs_dev
, 
»g_addr
, 
b
, 1, 0);

383 
	}
}

385 
šlše
 
	$ùs_fw_»g_wr™ew
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u16
 
w
)

387  
	`ùs_fw_»g_wr™ew_»Œy
(
ùs_dev
, 
»g_addr
, 
w
, 1, 0);

388 
	}
}

390 
šlše
 
	$ùs_fw_»g_wr™–
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, u32 
l
)

392  
	`ùs_fw_»g_wr™–_»Œy
(
ùs_dev
, 
»g_addr
, 
l
, 1, 0);

393 
	}
}

395 
šlše
 
	$ùs_fw_»g_wr™esb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
,

396 cÚ¡ *
¤c
, 
size_t
 
Ën
)

398  
	`ùs_fw_»g_wr™esb_»Œy
(
ùs_dev
, 
»g_addr
, 
¤c
, 
Ën
, 1, 0);

399 
	}
}

401 
šlše
 
	$ùs_fw_»g_»adb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u8
 *
b
)

403  
	`ùs_fw_»g_»adb_»Œy
(
ùs_dev
, 
»g_addr
, 
b
, 1, 0);

404 
	}
}

406 
šlše
 
	$ùs_fw_»g_»adw
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u16
 *
w
)

408  
	`ùs_fw_»g_»adw_»Œy
(
ùs_dev
, 
»g_addr
, 
w
, 1, 0);

409 
	}
}

411 
šlše
 
	$ùs_fw_»g_»adl
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, u32 *
l
)

413  
	`ùs_fw_»g_»adl_»Œy
(
ùs_dev
, 
»g_addr
, 
l
, 1, 0);

414 
	}
}

416 
šlše
 
	$ùs_fw_»g_»adsb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

417 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
)

419  
	`ùs_fw_»g_»adsb_»Œy
(
ùs_dev
, 
»g_addr
, 
d¡
, 
Ën
, 1, 0);

420 
	}
}

422 
šlše
 
	$ùs_fw_»g_»adsb_d–ay_idË
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

423 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
, 
idË
)

425  
	`ùs_fw_»g_»adsb_»Œy_d–ay_idË
(
ùs_dev
, 
»g_addr
, 
d¡
, 
Ën
, 1, 0, 
idË
);

426 
	}
}

428 
šlše
 
	$ùs_hw_»g_wr™eb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u8
 
b
)

430  
	`ùs_hw_»g_wr™eb_»Œy
(
ùs_dev
, 
»g_addr
, 
b
, 1, 0);

431 
	}
}

433 
šlše
 
	$ùs_hw_»g_wr™ew
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u16
 
w
)

435  
	`ùs_hw_»g_wr™ew_»Œy
(
ùs_dev
, 
»g_addr
, 
w
, 1, 0);

436 
	}
}

438 
šlše
 
	$ùs_hw_»g_wr™–
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, u32 
l
)

440  
	`ùs_hw_»g_wr™–_»Œy
(
ùs_dev
, 
»g_addr
, 
l
, 1, 0);

441 
	}
}

443 
šlše
 
	$ùs_hw_»g_wr™esb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
,

444 cÚ¡ *
¤c
, 
size_t
 
Ën
)

446  
	`ùs_hw_»g_wr™esb_»Œy
(
ùs_dev
, 
»g_addr
, 
¤c
, 
Ën
, 1, 0);

447 
	}
}

449 
šlše
 
	$ùs_hw_»g_»adb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u8
 *
b
)

451  
	`ùs_hw_»g_»adb_»Œy
(
ùs_dev
, 
»g_addr
, 
b
, 1, 0);

452 
	}
}

454 
šlše
 
	$ùs_hw_»g_»adw
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, 
u16
 *
w
)

456  
	`ùs_hw_»g_»adw_»Œy
(
ùs_dev
, 
»g_addr
, 
w
, 1, 0);

457 
	}
}

459 
šlše
 
	$ùs_hw_»g_»adl
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
»g_addr
, u32 *
l
)

461  
	`ùs_hw_»g_»adl_»Œy
(
ùs_dev
, 
»g_addr
, 
l
, 1, 0);

462 
	}
}

464 
šlše
 
	$ùs_hw_»g_»adsb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

465 
u32
 
»g_addr
, *
d¡
, 
size_t
 
Ën
)

467  
	`ùs_hw_»g_»adsb_»Œy
(
ùs_dev
, 
»g_addr
, 
d¡
, 
Ën
, 1, 0);

468 
	}
}

470 
šlše
 
	$ùs_¤am_wr™eb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, 
u8
 
b
)

472  
	`ùs_¤am_wr™eb_»Œy
(
ùs_dev
, 
addr
, 
b
, 1, 0);

473 
	}
}

475 
šlše
 
	$ùs_¤am_wr™ew
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, 
u16
 
w
)

477  
	`ùs_¤am_wr™ew_»Œy
(
ùs_dev
, 
addr
, 
w
, 1, 0);

478 
	}
}

480 
šlše
 
	$ùs_¤am_wr™–
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, u32 
l
)

482  
	`ùs_¤am_wr™–_»Œy
(
ùs_dev
, 
addr
, 
l
, 1, 0);

483 
	}
}

485 
šlše
 
	$ùs_¤am_wr™esb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
,

486 cÚ¡ *
¤c
, 
size_t
 
Ën
)

488  
	`ùs_¤am_wr™esb_»Œy
(
ùs_dev
, 
addr
, 
¤c
, 
Ën
, 1, 0);

489 
	}
}

491 
šlše
 
	$ùs_¤am_»adb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, 
u8
 *
b
)

493  
	`ùs_¤am_»adb_»Œy
(
ùs_dev
, 
addr
, 
b
, 1, 0);

494 
	}
}

496 
šlše
 
	$ùs_¤am_»adw
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, 
u16
 *
w
)

498  
	`ùs_¤am_»adw_»Œy
(
ùs_dev
, 
addr
, 
w
, 1, 0);

499 
	}
}

501 
šlše
 
	$ùs_¤am_»adl
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, u32 *
l
)

503  
	`ùs_¤am_»adl_»Œy
(
ùs_dev
, 
addr
, 
l
, 1, 0);

504 
	}
}

506 
šlše
 
	$ùs_¤am_»adsb
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

507 
u32
 
addr
, *
d¡
, 
size_t
 
Ën
)

509  
	`ùs_¤am_»adsb_»Œy
(
ùs_dev
, 
addr
, 
d¡
, 
Ën
, 1, 0);

510 
	}
}

512 #ifdeà
CONFIG_CTS_I2C_HOST


513 
šlše
 
	$ùs_£t_´og¿m_addr
(
ùs_deviû
 *
ùs_dev
)

515 
ùs_dev
->
¹d©a
.
¦ave_addr
 = 
CTS_DEV_PROGRAM_MODE_I2CADDR
;

516 
ùs_dev
->
¹d©a
.
´og¿m_mode
 = 
Œue
;

517 
ùs_dev
->
¹d©a
.
addr_width
 = 
CTS_DEV_PROGRAM_MODE_ADDR_WIDTH
;

518 
	}
}

520 
šlše
 
	$ùs_£t_nÜm®_addr
(
ùs_deviû
 *
ùs_dev
)

522 
ùs_dev
->
¹d©a
.
¦ave_addr
 = 
CTS_DEV_NORMAL_MODE_I2CADDR
;

523 
ùs_dev
->
¹d©a
.
´og¿m_mode
 = 
çl£
;

524 
ùs_dev
->
¹d©a
.
addr_width
 = 
CTS_DEV_NORMAL_MODE_ADDR_WIDTH
;

525 
	}
}

527 
šlše
 
	$ùs_£t_´og¿m_addr
(
ùs_deviû
 *
ùs_dev
)

529 
ùs_dev
->
¹d©a
.
¦ave_addr
 = 
CTS_DEV_PROGRAM_MODE_SPIADDR
;

530 
ùs_dev
->
¹d©a
.
´og¿m_mode
 = 
Œue
;

531 
ùs_dev
->
¹d©a
.
addr_width
 = 
CTS_DEV_PROGRAM_MODE_ADDR_WIDTH
;

532 
	}
}

534 
šlše
 
	$ùs_£t_nÜm®_addr
(
ùs_deviû
 *
ùs_dev
)

536 
ùs_dev
->
¹d©a
.
¦ave_addr
 = 
CTS_DEV_NORMAL_MODE_SPIADDR
;

537 
ùs_dev
->
¹d©a
.
´og¿m_mode
 = 
çl£
;

538 
ùs_dev
->
¹d©a
.
addr_width
 = 
CTS_DEV_NORMAL_MODE_ADDR_WIDTH
;

539 
	}
}

542 
ùs_œq_hªdËr
(
ùs_deviû
 *
ùs_dev
);

544 
boŞ
 
ùs_is_deviû_su¥’ded
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

545 
ùs_su¥’d_deviû
(
ùs_deviû
 *
ùs_dev
);

546 
ùs_»sume_deviû
(
ùs_deviû
 *
ùs_dev
);

548 
boŞ
 
ùs_is_deviû_´og¿m_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

549 
ùs_’‹r_´og¿m_mode
(
ùs_deviû
 *
ùs_dev
);

550 
ùs_’‹r_nÜm®_mode
(
ùs_deviû
 *
ùs_dev
);

552 
ùs_´obe_deviû
(
ùs_deviû
 *
ùs_dev
);

553 
ùs_£t_wÜk_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 
mode
);

554 
ùs_g‘_wÜk_mode
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
mode
);

555 
ùs_g‘_fœmw¬e_v”siÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
v”siÚ
);

556 
ùs_g‘_ddi_v”siÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
v”siÚ
);

557 
ùs_g‘_lib_v”siÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
lib_v”siÚ
);

558 
ùs_g‘_d©a_»ady_æag
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
æag
);

559 
ùs_şr_d©a_»ady_æag
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

560 
ùs_£nd_commªd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 
cmd
);

561 
ùs_g‘_·Ãl_·¿m
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

562 *
·¿m
, 
size_t
 
size
);

563 
ùs_£t_·Ãl_·¿m
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

564 cÚ¡ *
·¿m
, 
size_t
 
size
);

565 
ùs_g‘_x_»sŞutiÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
»sŞutiÚ
);

566 
ùs_g‘_y_»sŞutiÚ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u16
 *
»sŞutiÚ
);

567 
ùs_g‘_num_rows
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
num_rows
);

568 
ùs_g‘_num_cŞs
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
num_cŞs
);

569 
ùs_g‘_dev_esd_´ÙeùiÚ
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 *
’abË
);

570 
ùs_£t_dev_esd_´ÙeùiÚ
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
’abË
);

571 
ùs_’abË_g‘_¿wd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

572 
ùs_di§bË_g‘_¿wd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

573 
ùs_g‘_¿wd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, *
buf
);

574 
ùs_g‘_diffd©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, *
buf
);

575 
ùs_g‘_com³n§‹_ÿp
(
ùs_deviû
 *
ùs_dev
, 
u8
 *
ÿp
);

576 
ùs_g‘_fwid
(
ùs_deviû
 *
ùs_dev
, 
u16
 *
fwid
);

577 
ùs_g‘_hwid
(
ùs_deviû
 *
ùs_dev
, 
u32
 *
hwid
);

579 #ifdeà
CFG_CTS_GESTURE


580 
ùs_’abË_ge¡u»_wakeup
(
ùs_deviû
 *
ùs_dev
);

581 
ùs_di§bË_ge¡u»_wakeup
(
ùs_deviû
 *
ùs_dev
);

582 
boŞ
 
ùs_is_ge¡u»_wakeup_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

583 
ùs_g‘_ge¡u»_šfo
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

584 *
ge¡u»_šfo
, 
boŞ
 
Œaû_pošt
);

587 #ifdeà
CONFIG_CTS_ESD_PROTECTION


588 
ùs_š™_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
);

589 
ùs_’abË_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
);

590 
ùs_di§bË_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
);

591 
ùs_deš™_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
);

593 
šlše
 
	$ùs_š™_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
è{
	}
}

594 
šlše
 
	$ùs_’abË_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
è{
	}
}

595 
šlše
 
	$ùs_di§bË_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
è{
	}
}

596 
šlše
 
	$ùs_deš™_esd_´ÙeùiÚ
(
chÚe_ts_d©a
 *
ùs_d©a
è{
	}
}

599 #ifdeà
CONFIG_CTS_GLOVE


600 
ùs_’‹r_glove_mode
(
ùs_deviû
 *
ùs_dev
);

601 
ùs_ex™_glove_mode
(
ùs_deviû
 *
ùs_dev
);

602 
ùs_is_glove_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

604 
šlše
 
	$ùs_’‹r_glove_mode
(
ùs_deviû
 *
ùs_dev
è{ 0;
	}
}

605 
šlše
 
	$ùs_ex™_glove_mode
(
ùs_deviû
 *
ùs_dev
è{ 0;
	}
}

606 
šlše
 
	$ùs_is_glove_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
è{ 0;
	}
}

609 #ifdeà
CONFIG_CTS_CHARGER_DETECT


610 
boŞ
 
ùs_is_ch¬g”_exi¡
(
ùs_deviû
 *
ùs_dev
);

611 
ùs_£t_dev_ch¬g”_©ched
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
©ched
);

613 
šlše
 
boŞ
 
	$ùs_is_ch¬g”_exi¡
(
ùs_deviû
 *
ùs_dev
è{ 
çl£
;
	}
}

614 
šlše
 
	$ùs_dev_ch¬g”_©ched
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
©ched
è{ 0;
	}
}

617 #ifdeà
CONFIG_CTS_EARJACK_DETECT


618 
boŞ
 
ùs_is_—rjack_exi¡
(
ùs_deviû
 *
ùs_dev
);

619 
ùs_£t_dev_—rjack_©ched
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
©ched
);

621 
šlše
 
boŞ
 
	$ùs_is_—rjack_exi¡
(
ùs_deviû
 *
ùs_dev
è{ 
çl£
;
	}
}

622 
šlše
 
	$ùs_£t_dev_—rjack_©ched
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
©ched
è{ 0;
	}
}

625 #ifdeà
CONFIG_CTS_LEGACY_TOOL


626 
ùs_toŞ_š™
(
chÚe_ts_d©a
 *
ùs_d©a
);

627 
ùs_toŞ_deš™
(
chÚe_ts_d©a
 *
d©a
);

629 
šlše
 
	$ùs_toŞ_š™
(
chÚe_ts_d©a
 *
ùs_d©a
è{ 0;
	}
}

630 
šlše
 
	$ùs_toŞ_deš™
(
chÚe_ts_d©a
 *
d©a
è{
	}
}

633 
boŞ
 
ùs_is_deviû_’abËd
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

634 
ùs_¡¬t_deviû
(
ùs_deviû
 *
ùs_dev
);

635 
ùs_¡İ_deviû
(
ùs_deviû
 *
ùs_dev
);

637 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


638 
ùs_’abË_fw_log_»dœeù
(
ùs_deviû
 *
ùs_dev
);

639 
ùs_di§bË_fw_log_»dœeù
(
ùs_deviû
 *
ùs_dev
);

640 
boŞ
 
ùs_is_fw_log_»dœeù
(
ùs_deviû
 *
ùs_dev
);

641 
ùs_fw_log_show_fšish
(
ùs_deviû
 *
ùs_dev
);

644 #ifdeà
CFG_CTS_UPDATE_CRCCHECK


645 
ùs_¤am_wr™esb_boÙ_üc_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

646 
size_t
 
Ën
, 
u32
 
üc
, 
»Œy
);

649 cÚ¡ *
ùs_dev_boÙ_mode2¡r
(
u8
 
boÙ_mode
);

650 
boŞ
 
ùs_is_fwid_v®id
(
u16
 
fwid
);

	@cts_earjack_detect.c

1 
	#LOG_TAG
 "E¬jack"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sysfs.h
"

8 #ifdeà
CONFIG_CTS_EARJACK_DETECT


9 
	sùs_—rjack_d‘eù_d©a
 {

10 
boŞ
 
	m’abË
;

11 
boŞ
 
	mruÂšg
;

12 
boŞ
 
	m¡©e
;

14 cÚ¡ *
	m—rjack_¡©e_f•©h
;

15 
d–ayed_wÜk
 
	mpŞl_wÜk
;

16 
u32
 
	mpŞl_š‹rv®
;

18 #ifdeà
CONFIG_CTS_SYSFS


19 
boŞ
 
	msysfs_©Œ_group_ü—‹d
;

22 
chÚe_ts_d©a
 *
	mùs_d©a
;

28 
	#CFG_CTS_DEF_EARJACK_POLL_INTERVAL
 2000u

	)

29 #ià
defšed
(
CONFIG_MTK_PLATFORM
)

30 
	#CFG_CTS_DEF_EARJACK_STATE_FILEPATH
 \

31 "/sys/bus/¶©fÜm/driv”s/Accd‘_Driv”/¡©e"

	)

32 #–ià
defšed
(
CONFIG_ARCH_SPREADRUM
)

33 
	#CFG_CTS_DEF_EARJACK_STATE_FILEPATH
 \

34 "/sys/k”Ãl/h—d£t/¡©e"

	)

37 
	#CFG_CTS_DEF_EARJACK_STATE_FILEPATH
 ""

	)

40 
	$·r£_—rjack_d‘eù_dt
(
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
,

41 
deviû_node
 *
Å
)

43 cÚ¡ *
f•©h
;

44 
»t
;

46 
	`ùs_šfo
("Parse dt");

48 #ifdeà
CFG_CTS_DEF_EARJACK_DET_ENABLE


49 
ed_d©a
->
’abË
 = 
Œue
;

51 
ed_d©a
->
’abË
 =

52 
	`of_´İ”ty_»ad_boŞ
(
Å
, "chipone,touch-earjack-detect-enable");

55 
»t
 = 
	`of_´İ”ty_»ad_¡ršg
(
Å
,

56 "chÚe,touch-—rjack-¡©e-f•©h", &
f•©h
);

57 ià(
»t
) {

58 
	`ùs_w¬n
("P¬£ s‹ f•©h faed %d", 
»t
);

59 
f•©h
 = 
CFG_CTS_DEF_EARJACK_STATE_FILEPATH
;

61 
ed_d©a
->
—rjack_¡©e_f•©h
 = 
	`k¡rdup
(
f•©h
, 
GFP_KERNEL
);

62 ià(
ed_d©a
->
—rjack_¡©e_f•©h
 =ğ
NULL
) {

63 
	`ùs_”r
("Dupƒarjack state filepath failed");

64  -
ENOMEM
;

67 
ed_d©a
->
pŞl_š‹rv®
 = 
CFG_CTS_DEF_EARJACK_POLL_INTERVAL
;

68 
»t
 = 
	`of_´İ”ty_»ad_u32
(
Å
,

69 "chÚe,touch-—rjack-pŞl-š‹rv®", &
ed_d©a
->
pŞl_š‹rv®
);

70 ià(
»t
) {

71 
	`ùs_w¬n
("P¬£…ŞÈš‹rv® faed %d", 
»t
);

75 
	}
}

77 
	$¡¬t_—rjack_d‘eù
(
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
)

79 ià(!
ed_d©a
->
’abË
) {

80 
	`ùs_w¬n
("Start detect while NOTƒnabled");

81  -
EINVAL
;

84 ià(
ed_d©a
->
ruÂšg
) {

85 
	`ùs_w¬n
("Start detect while‡lready RUNNING");

89 ià(
ed_d©a
->
—rjack_¡©e_f•©h
 =ğ
NULL
 ||

90 
ed_d©a
->
—rjack_¡©e_f•©h
[0] == '\n') {

91 
	`ùs_w¬n
("Start detect with filepath = NULL/NUL");

92  -
EINVAL
;

95 
	`ùs_šfo
("Start detect check file: '%s'",

96 
ed_d©a
->
—rjack_¡©e_f•©h
);

98 ià(!
	`queue_d–ayed_wÜk
(
ed_d©a
->
ùs_d©a
->
wÜkqueue
,

99 &
ed_d©a
->
pŞl_wÜk
,

100 
	`m£cs_to_jiff›s
(
ed_d©a
->
pŞl_š‹rv®
))) {

101 
	`ùs_w¬n
("Queue detect work while‡lready onhe queue");

104 
ed_d©a
->
ruÂšg
 = 
Œue
;

107 
	}
}

109 
	$¡İ_—rjack_d‘eù
(
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
)

111 ià(!
ed_d©a
->
ruÂšg
) {

112 
	`ùs_w¬n
("Stop detect while NOT„unning");

116 
	`ùs_šfo
("Stop detect");

118 ià(!
	`ÿnûl_d–ayed_wÜk_sync
(&
ed_d©a
->
pŞl_wÜk
)) {

119 
	`ùs_w¬n
("Cancel…oll work while NOT…ending");

121 
ed_d©a
->
ruÂšg
 = 
çl£
;

124 
	}
}

126 
	$g‘_—rjack_¡©e
(
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
)

128 
fe
 *fğ
NULL
;

129 
loff_t
 
pos
 = 0;

130 
»t
, 
»ad_size
;

131 
buff
[10];

132 
u32
 
¡©e
;

134 
	`ùs_dbg
("Get state from file '%s'",

135 
ed_d©a
->
—rjack_¡©e_f•©h
);

137 
fe
 = 
	`fp_İ’
(
ed_d©a
->
—rjack_¡©e_f•©h
, 
O_RDONLY
, 0);

138 ià(
	`IS_ERR
(
fe
)) {

139 
	`ùs_”r
("Open file '%s' failed %ld",

140 
ed_d©a
->
—rjack_¡©e_f•©h
, 
	`PTR_ERR
(
fe
));

141  
	`PTR_ERR
(
fe
);

144 
	`mem£t
(
buff
, 0, (buff));

145 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

146 
»ad_size
 = 
	`k”Ãl_»ad
(
fe
, 
buff
, (buff), &
pos
);

148 
»ad_size
 = 
	`k”Ãl_»ad
(
fe
, 
pos
, 
buff
, (buff));

150 ià(
»ad_size
 < 0) {

151 
	`ùs_”r
("Read state file '%s' failed %d",

152 
ed_d©a
->
—rjack_¡©e_f•©h
, 
»ad_size
);

153 
	`fp_şo£
(
fe
, 
NULL
);

154  
»ad_size
;

157 
	`ùs_dbg
("R—d s‹ fcÚ‹Á: '%s'", 
buff
);

159 
»t
 = 
	`fp_şo£
(
fe
, 
NULL
);

160 ià(
»t
) {

161 
	`ùs_w¬n
("Close file '%s' failed %d",

162 
ed_d©a
->
—rjack_¡©e_f•©h
, 
»t
);

165 
»t
 = 
	`k¡¹ou32
(
buff
, 0, &
¡©e
);

166 ià(
»t
) {

167 
	`ùs_”r
("Inv®id sŒšg from s‹ fe: '%s'", 
buff
);

168  
»t
;

172 
ed_d©a
->
¡©e
 = !!state;

174 
	`ùs_dbg
("S‹: %s", 
ed_d©a
->
¡©e
 ? "ATTACHED" : "DETACHED");

177 
	}
}

180 #ifdeà
CONFIG_CTS_SYSFS


181 
¬gc
;

182 *
¬gv
[];

183 
·r£_¬g
(cÚ¡ *
buf
, 
size_t
 
couÁ
);

184 
k¡¹oboŞ
(cÚ¡ *
s
, 
boŞ
 *
»s
);

186 
	#EARJACK_DET_SYSFS_GROUP_NAME
 "—rjack-d‘"

	)

188 
	$’abË_—rjack_d‘eù
(
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
)

190 
	`ùs_šfo
("Enable detect");

192 
ed_d©a
->
’abË
 = 
Œue
;

195 
	}
}

197 
	$di§bË_—rjack_d‘eù
(
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
)

199 
»t
;

201 
	`ùs_šfo
("Disable detect");

203 
»t
 = 
	`¡İ_—rjack_d‘eù
(
ed_d©a
);

204 ià(
»t
) {

205 
	`ùs_”r
("Stİ d‘eù faed %d", 
»t
);

208 
ed_d©a
->
’abË
 = 
çl£
;

211 
	}
}

213 
ssize_t
 
	$—rjack_d‘eù_’abË_show
(
deviû
 *
dev
,

214 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

216 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

217 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

219 
	`ùs_šfo
("R—d sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s'",

220 
©Œ
->©Œ.
Çme
);

222  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

224 
ed_d©a
->
’abË
 ? "ENABLED" : "DISABLED");

225 
	}
}

228 
ssize_t
 
	$—rjack_d‘eù_’abË_¡Üe
(
deviû
 *
dev
,

229 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

231 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

232 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

233 
boŞ
 
’abË
;

234 
»t
;

236 
	`ùs_šfo
("Wr™sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

237 
©Œ
->©Œ.
Çme
, 
couÁ
);

239 
	`·r£_¬g
(
buf
, 
couÁ
);

241 ià(
¬gc
 != 1) {

242 
	`ùs_”r
("Invalid‚um of‡rgs");

243  -
EINVAL
;

246 
»t
 = 
	`k¡¹oboŞ
(
¬gv
[0], &
’abË
);

247 ià(
»t
) {

248 
	`ùs_”r
("Invalid…aram ofƒnable");

249  
»t
;

252 ià(
’abË
) {

253 
»t
 = 
	`’abË_—rjack_d‘eù
(
ed_d©a
);

255 
»t
 = 
	`di§bË_—rjack_d‘eù
(
ed_d©a
);

257 ià(
»t
) {

258 
	`ùs_”r
("%sƒarjack detect failed",

259 
’abË
 ? "EÇbË" : "Di§bË", 
»t
);

260  
»t
;

263  
couÁ
;

264 
	}
}

265 
DEVICE_ATTR
(
’abË
, 
S_IWUSR
 | 
S_IRUGO
,

266 
—rjack_d‘eù_’abË_show
, 
—rjack_d‘eù_’abË_¡Üe
);

268 
ssize_t
 
	$—rjack_d‘eù_ruÂšg_show
(
deviû
 *
dev
,

269 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

271 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

272 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

274 
	`ùs_šfo
("R—d sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s'",

275 
©Œ
->©Œ.
Çme
);

277  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

279 
ed_d©a
->
ruÂšg
 ? "" : "Not-");

280 
	}
}

283 
ssize_t
 
	$—rjack_d‘eù_ruÂšg_¡Üe
(
deviû
 *
dev
,

284 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

286 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

287 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

288 
boŞ
 
ruÂšg
;

289 
»t
;

291 
	`ùs_šfo
("Wr™sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

292 
©Œ
->©Œ.
Çme
, 
couÁ
);

294 
	`·r£_¬g
(
buf
, 
couÁ
);

296 ià(
¬gc
 != 1) {

297 
	`ùs_”r
("Invalid‚um of‡rgs");

298  -
EINVAL
;

301 
»t
 = 
	`k¡¹oboŞ
(
¬gv
[0], &
ruÂšg
);

302 ià(
»t
) {

303 
	`ùs_”r
("Invalid…aram of„unning");

304  
»t
;

307 ià(
ruÂšg
) {

308 
»t
 = 
	`¡¬t_—rjack_d‘eù
(
ed_d©a
);

310 
»t
 = 
	`¡İ_—rjack_d‘eù
(
ed_d©a
);

312 ià(
»t
) {

313 
	`ùs_”r
("%sƒarjack detect failed %d",

314 
ruÂšg
 ? "S¹" : "Stİ", 
»t
);

315  
»t
;

318  
couÁ
;

319 
	}
}

320 
DEVICE_ATTR
(
ruÂšg
, 
S_IWUSR
 | 
S_IRUGO
,

321 
—rjack_d‘eù_ruÂšg_show
, 
—rjack_d‘eù_ruÂšg_¡Üe
);

323 
ssize_t
 
	$—rjack_¡©e_show
(
deviû
 *
dev
,

324 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

326 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

327 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

328 
»t
;

330 
	`ùs_šfo
("R—d sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s'",

331 
©Œ
->©Œ.
Çme
);

333 
»t
 = 
	`g‘_—rjack_¡©e
(
ed_d©a
);

334 ià(
»t
) {

335  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

336 "G‘ƒ¬jack s‹ faed %d\n", 
»t
);

339  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

341 
ed_d©a
->
¡©e
 ? "ATTACHED" : "DETACHED");

342 
	}
}

343 
DEVICE_ATTR
(
¡©e
, 
S_IRUGO
, 
—rjack_¡©e_show
, 
NULL
);

345 
ssize_t
 
	$—rjack_d‘eù_·¿m_show
(
deviû
 *
dev
,

346 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

348 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

349 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

351 
	`ùs_šfo
("R—d sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s'",

352 
©Œ
->©Œ.
Çme
);

354  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

357 
ed_d©a
->
—rjack_¡©e_f•©h
,ƒd_d©a->
pŞl_š‹rv®
);

358 
	}
}

361 
ssize_t
 
	$—rjack_d‘eù_·¿m_¡Üe
(
deviû
 *
dev
,

362 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

364 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

365 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

366 
u32
 
š‹rv®
;

367 
»t
;

369 
	`ùs_šfo
("Wr™sysf '"
EARJACK_DET_SYSFS_GROUP_NAME
"/%s' size %zu",

370 
©Œ
->©Œ.
Çme
, 
couÁ
);

372 
	`·r£_¬g
(
buf
, 
couÁ
);

374 ià(
¬gc
 < 1 ||‡rgc > 2) {

375 
	`ùs_”r
("Invalid‚um of‡rgs");

376  -
EINVAL
;

379 
š‹rv®
 = 
ed_d©a
->
pŞl_š‹rv®
;

380 ià(
¬gc
 > 1) {

381 
»t
 = 
	`k¡¹ou32
(
¬gv
[1], 0, &
š‹rv®
);

382 ià(
»t
) {

383 
	`ùs_”r
("Arg interval is invalid");

384  -
EINVAL
;

388 ià(
ed_d©a
->
—rjack_¡©e_f•©h
) {

389 
	`kä“
(
ed_d©a
->
—rjack_¡©e_f•©h
);

391 
ed_d©a
->
—rjack_¡©e_f•©h
 = 
	`k¡rdup
(
¬gv
[0], 
GFP_KERNEL
);

392 ià(
ed_d©a
->
—rjack_¡©e_f•©h
 =ğ
NULL
) {

393 
	`ùs_”r
("Dupƒarjack state filepath failed");

394  -
ENOMEM
;

396 
ed_d©a
->
pŞl_š‹rv®
 = 
š‹rv®
;

398  
couÁ
;

399 
	}
}

400 
DEVICE_ATTR
(
·¿m
, 
S_IWUSR
 | 
S_IRUGO
,

401 
—rjack_d‘eù_·¿m_show
, 
—rjack_d‘eù_·¿m_¡Üe
);

403 
©Œibu‹
 *
	g—rjack_d‘eù_©Œs
[] = {

404 &
dev_©Œ_’abË
.
©Œ
,

405 &
dev_©Œ_ruÂšg
.
©Œ
,

406 &
dev_©Œ_¡©e
.
©Œ
,

407 &
dev_©Œ_·¿m
.
©Œ
,

408 
NULL


411 cÚ¡ 
©Œibu‹_group
 
	g—rjack_d‘eù_©Œ_group
 = {

412 .
Çme
 = 
EARJACK_DET_SYSFS_GROUP_NAME
,

413 .
	g©Œs
 = 
—rjack_d‘eù_©Œs
,

417 
	$pŞl_—rjack_¡©e_wÜk
(
wÜk_¡ruù
 *
wÜk
)

419 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
;

420 
boŞ
 
´ev_¡©e
 = 
çl£
;

421 
»t
;

423 
	`ùs_dbg
("Pollƒarjack state work");

425 
ed_d©a
 = 
	`cÚš”_of
(
	`to_d–ayed_wÜk
(
wÜk
),

426 
ùs_—rjack_d‘eù_d©a
, 
pŞl_wÜk
);

428 
´ev_¡©e
 = 
ed_d©a
->
¡©e
;

430 
»t
 = 
	`g‘_—rjack_¡©e
(
ed_d©a
);

431 ià(
»t
) {

432 
	`ùs_”r
("G‘ s‹ faed %d", 
»t
);

434 ià(
ed_d©a
->
¡©e
 !ğ
´ev_¡©e
) {

435 
	`ùs_šfo
("State changed: %s -> %s",

436 
´ev_¡©e
 ? "ATTACHED" : "DETATCHED",

437 
ed_d©a
->
¡©e
 ? "ATTACHED" : "DETATCHED");

439 
	`ùs_lock_deviû
(&
ed_d©a
->
ùs_d©a
->
ùs_dev
);

440 
»t
 = 
	`ùs_£t_dev_—rjack_©ched
(

441 &
ed_d©a
->
ùs_d©a
->
ùs_dev
,ƒd_d©a->
¡©e
);

442 
	`ùs_uÆock_deviû
(&
ed_d©a
->
ùs_d©a
->
ùs_dev
);

443 ià(
»t
) {

444 
	`ùs_”r
("Set devƒarjack‡ttachedo %s failed %d",

445 
ed_d©a
->
¡©e
 ? "ATTACHED" : "DETATCHED", 
»t
);

447 
ed_d©a
->
¡©e
 = 
´ev_¡©e
;

452 ià(!
	`queue_d–ayed_wÜk
(
ed_d©a
->
ùs_d©a
->
wÜkqueue
,

453 &
ed_d©a
->
pŞl_wÜk
,

454 
	`m£cs_to_jiff›s
(
ed_d©a
->
pŞl_š‹rv®
))) {

455 
	`ùs_w¬n
("Queue detect work while‡lready onhe queue");

457 
	}
}

459 
	$ùs_š™_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

461 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
;

462 
»t
 = 0;

464 
	`ùs_šfo
("Init detect");

466 ià(
ùs_d©a
 =ğ
NULL
) {

467 
	`ùs_”r
("Init detect with cts_data = NULL");

468  -
EFAULT
;

471 
ed_d©a
 = 
	`kz®loc
((*ed_d©a), 
GFP_KERNEL
);

472 ià(
ed_d©a
 =ğ
NULL
) {

473 
	`ùs_”r
("Allocƒarjack detect data failed");

474  -
ENOMEM
;

477 #ifdeà
CONFIG_CTS_OF


478 
»t
 = 
	`·r£_—rjack_d‘eù_dt
(
ed_d©a
, 
ùs_d©a
->
deviû
->
of_node
);

480 #ifdeà
CFG_CTS_DEF_EARJACK_DET_ENABLE


481 
ed_d©a
->
’abË
 = 
Œue
;

483 
ed_d©a
->
’abË
 = 
çl£
;

485 
ed_d©a
->
pŞl_š‹rv®
 = 
CFG_CTS_DEF_EARJACK_POLL_INTERVAL
;

486 
ed_d©a
->
—rjack_¡©e_f•©h
 = 
	`k¡rdup
(

487 
CFG_CTS_DEF_EARJACK_STATE_FILEPATH
, 
GFP_KERNEL
);

488 ià(
ed_d©a
->
—rjack_¡©e_f•©h
 =ğ
NULL
) {

489 
	`ùs_”r
("Dupƒarjack state filepath failed");

490 
»t
 = -
ENOMEM
;

493 ià(
»t
) {

494 
	`ùs_”r
("G‘ d‘eù…¬am faed %d", 
»t
);

495 
ä“_ed_d©a
;

498 
	`ùs_šfo
("D‘eù: %sABLED", 
ed_d©a
->
’abË
 ? "EN" : "DIS");

499 
	`ùs_šfo
(" F•©h: '%s'", 
ed_d©a
->
—rjack_¡©e_f•©h
);

500 
	`ùs_šfo
(" PŞÈIÁ: %dms", 
ed_d©a
->
pŞl_š‹rv®
);

502 
	`INIT_DELAYED_WORK
(&
ed_d©a
->
pŞl_wÜk
, 
pŞl_—rjack_¡©e_wÜk
);

504 #ifdeà
CONFIG_CTS_SYSFS


505 
	`ùs_šfo
("C»©sysf ©Œ grou°'%s'", 
EARJACK_DET_SYSFS_GROUP_NAME
);

506 
»t
 = 
	`sysfs_ü—‹_group
(&
ùs_d©a
->
deviû
->
kobj
,

507 &
—rjack_d‘eù_©Œ_group
);

508 ià(
»t
) {

509 
	`ùs_w¬n
("C»©sysf ©Œ grou°çed %d", 
»t
);

511 
ed_d©a
->
sysfs_©Œ_group_ü—‹d
 = 
Œue
;

515 
ùs_d©a
->
—rjack_d‘eù_d©a
 = 
ed_d©a
;

516 
ed_d©a
->
ùs_d©a
 = cts_data;

520 
ä“_ed_d©a
:

521 
	`kä“
(
ed_d©a
);

523  
»t
;

524 
	}
}

526 
	$ùs_deš™_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

528 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
;

529 
»t
;

531 
	`ùs_šfo
("Deinit detect");

533 ià(
ùs_d©a
 =ğ
NULL
) {

534 
	`ùs_”r
("Deinit detect with cts_data = NULL");

535  -
EFAULT
;

538 
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

539 ià(
ed_d©a
 =ğ
NULL
) {

540 
	`ùs_w¬n
("Deinit detect withƒarjack_detect_data = NULL");

544 ià(
ed_d©a
->
ruÂšg
) {

545 
»t
 = 
	`¡İ_—rjack_d‘eù
(
ed_d©a
);

546 ià(
»t
) {

547 
	`ùs_”r
("Stİ d‘eù faed %d", 
»t
);

551 #ifdeà
CONFIG_CTS_SYSFS


552 ià(
ed_d©a
->
sysfs_©Œ_group_ü—‹d
) {

553 
	`ùs_šfo
("Remove sysfs‡ttr group '%s'",

554 
EARJACK_DET_SYSFS_GROUP_NAME
);

555 
	`sysfs_»move_group
(&
ùs_d©a
->
deviû
->
kobj
,

556 &
—rjack_d‘eù_©Œ_group
);

557 
ed_d©a
->
sysfs_©Œ_group_ü—‹d
 = 
çl£
;

561 if(
ed_d©a
->
—rjack_¡©e_f•©h
) {

562 
	`ùs_šfo
("Kfreeƒarjack state filepath");

563 
	`kä“
(
ed_d©a
->
—rjack_¡©e_f•©h
);

564 
ed_d©a
->
—rjack_¡©e_f•©h
 = 
NULL
;

567 
	`kä“
(
ed_d©a
);

568 
ùs_d©a
->
—rjack_d‘eù_d©a
 = 
NULL
;

571 
	}
}

573 
	$ùs_is_—rjack_©ched
(
chÚe_ts_d©a
 *
ùs_d©a
, 
boŞ
 *
©ched
)

575 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
;

576 
»t
;

578 ià(
ùs_d©a
 =ğ
NULL
) {

579 
	`ùs_”r
("Get state with cts_data = NULL");

580  -
EFAULT
;

583 
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

584 ià(
ed_d©a
 =ğ
NULL
) {

585 
	`ùs_”r
("Get state withƒarjack_detect_data = NULL");

586  -
ENODEV
;

589 
»t
 = 
	`g‘_—rjack_¡©e
(
ed_d©a
);

590 ià(
»t
) {

591 
	`ùs_”r
("G‘ s‹ faed %d", 
»t
);

592  
»t
;

595 *
©ched
 = 
ed_d©a
->
¡©e
;

598 
	}
}

600 
	$ùs_¡¬t_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

602 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
;

604 ià(
ùs_d©a
 =ğ
NULL
) {

605 
	`ùs_”r
("Start detect with cts_data = NULL");

606  -
EFAULT
;

609 
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

610 ià(
ed_d©a
 =ğ
NULL
) {

611 
	`ùs_”r
("Start detect withƒarjack_detect_data = NULL");

612  -
ENODEV
;

615  
	`¡¬t_—rjack_d‘eù
(
ed_d©a
);

616 
	}
}

618 
	$ùs_¡İ_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

620 
ùs_—rjack_d‘eù_d©a
 *
ed_d©a
;

622 ià(
ùs_d©a
 =ğ
NULL
) {

623 
	`ùs_”r
("Stop detect with cts_data = NULL");

624  -
EFAULT
;

627 
ed_d©a
 = 
ùs_d©a
->
—rjack_d‘eù_d©a
;

628 ià(
ed_d©a
 =ğ
NULL
) {

629 
	`ùs_”r
("Stop detect withƒarjack_detect_data = NULL");

630  -
ENODEV
;

633  
	`¡İ_—rjack_d‘eù
(
ed_d©a
);

634 
	}
}

	@cts_earjack_detect.h

1 #iâdeà
CTS_EARJACK_DETECT_H


2 
	#CTS_EARJACK_DETECT_H


	)

4 
	~"ùs_cÚfig.h
"

6 
	gchÚe_ts_d©a
;

8 #ifdeà
CONFIG_CTS_EARJACK_DETECT


9 
ùs_š™_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

10 
ùs_deš™_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

11 
ùs_¡¬t_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

12 
ùs_¡İ_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
);

13 
ùs_is_—rjack_©ched
(
chÚe_ts_d©a
 *
ùs_d©a
,

14 
boŞ
 *
©ched
);

16 
šlše
 
	$ùs_š™_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

18  -
ENOTSUPP
;

19 
	}
}

20 
šlše
 
	$ùs_deš™_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

22  -
ENOTSUPP
;

23 
	}
}

24 
šlše
 
	$ùs_¡¬t_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

26  -
ENODEV
;

27 
	}
}

28 
šlše
 
	$ùs_¡İ_—rjack_d‘eù
(
chÚe_ts_d©a
 *
ùs_d©a
)

30  -
ENODEV
;

31 
	}
}

32 
šlše
 
	$ùs_is_—rjack_©ched
(
chÚe_ts_d©a
 *
ùs_d©a
,

33 
boŞ
 *
©ched
)

35  -
ENODEV
;

36 
	}
}

	@cts_firmware.c

1 
	#LOG_TAG
 "Fœmw¬e"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sfù¾.h
"

7 
	~"ùs_¥i_æash.h
"

8 
	~"ùs_fœmw¬e.h
"

9 
	~<lšux/·th.h
>

10 
	~<lšux/mouÁ.h
>

11 
	~<lšux/Çmei.h
>

12 
	~<lšux/vm®loc.h
>

14 
u32
 
	$üc32
(cÚ¡ 
u8
 *
d©a
, 
size_t
 
Ën
)

16 cÚ¡ 
u32
 
üc32_bË
[] = {

62 
u32
 
üc
 = 0;

63 
Ën
) {

64 
üc
 = (üø<< 8è^ 
üc32_bË
[((üø>> 24è^ *
d©a
) & 0xFF];

66 
d©a
++;

67 
Ën
--;

70  
üc
;

71 
	}
}

73 #ià
defšed
(
CFG_CTS_DRIVER_BUILTIN_FIRMWARE
è|| defšed(
CFG_CTS_FIRMWARE_IN_FS
)

75 #ifdeà
CFG_CTS_DRIVER_BUILTIN_FIRMWARE


76 
	~"ùs_butš_fœmw¬e.h
"

77 
	#NUM_DRIVER_BUILTIN_FIRMWARE
 
	`ARRAY_SIZE
(
ùs_driv”_butš_fœmw¬es
)

	)

80 
	#CTS_FIRMWARE_MULTI_SECTION_FILE_SIZE
 (0x20000)

	)

81 
	#CTS_SECTION_ENABLE_FLAG
 (0x0000C35A)

	)

83 
	eùs_fœmw¬e_£ùiÚ_off£t
 {

84 
	mCTS_FIRMWARE_SECTION_OFFSET
 = 0x00000000,

85 
	mCTS_FIRMWARE_CRC_SECTION_OFFSET
 = 0x17000,

86 
	mCTS_DDIPARAM_SECTION_OFFSET
 = 0x00019000,

87 
	mCTS_DDIPARAM_CRC_SECTION_OFFSET
 = 0x1B000,

91 
	sùs_fœmw¬e_£ù_šfo
 {

92 cÚ¡ 
u8
 *
	mfœmw¬e_£ù
;

93 
size_t
 
	mfœmw¬e_£ù_size
;

94 cÚ¡ 
u8
 *
	mfœmw¬e_üc_£ù
;

95 
size_t
 
	mfœmw¬e_üc_£ù_size
;

96 
u32
 
	mfœmw¬e_£ù_üc
;

98 cÚ¡ 
u8
 *
	mdd¬am_£ù
;

99 
size_t
 
	mdd¬am_£ù_size
;

100 cÚ¡ 
u8
 *
	mdd¬am_üc_£ù
;

101 
size_t
 
	mdd¬am_üc_£ù_size
;

102 
u32
 
	mdd¬am_£ù_üc
;

106 
	#FIRMWARE_SECTION
(
fœmw¬e
) \

107 ((
fœmw¬e
)->
d©a
)

	)

108 
	#FIRMWARE_CRC_SECTION
(
fœmw¬e
) \

109 ((
fœmw¬e
)->
d©a
 + 
CTS_FIRMWARE_CRC_SECTION_OFFSET
)

	)

110 
	#DDIPARAM_SECTION
(
fœmw¬e
) \

111 ((
fœmw¬e
)->
d©a
 + 
CTS_DDIPARAM_SECTION_OFFSET
)

	)

112 
	#DDIPARAM_CRC_SECTION
(
fœmw¬e
) \

113 ((
fœmw¬e
)->
d©a
 + 
CTS_DDIPARAM_CRC_SECTION_OFFSET
)

	)

115 
	#FIRMWARE_SECTION_CRC
(
fœmw¬e
) \

116 (
	`g‘_uÇligÃd_Ë32
(
	`FIRMWARE_CRC_SECTION
(
fœmw¬e
)))

	)

117 
	#FIRMWARE_SECTION_SIZE
(
fœmw¬e
) \

118 (
	`g‘_uÇligÃd_Ë32
(
	`FIRMWARE_CRC_SECTION
(
fœmw¬e
è+ 4))

	)

119 
	#FIRMWARE_SECTION_CRC_ENABLE
(
fœmw¬e
) \

120 (
	`g‘_uÇligÃd_Ë32
(
	`FIRMWARE_CRC_SECTION
(
fœmw¬e
è+ 8))

	)

121 
	#FIRMWARE_CRC_SECTION_SIZE
 (12)

	)

123 
	#DDIPARAM_SECTION_ENABLE
(
fœmw¬e
) \

124 (
	`g‘_uÇligÃd_Ë32
(
	`DDIPARAM_CRC_SECTION
(
fœmw¬e
)))

	)

125 
	#DDIPARAM_SECTION_CRC_ENABLE
(
fœmw¬e
) \

126 (
	`g‘_uÇligÃd_Ë32
(
	`DDIPARAM_CRC_SECTION
(
fœmw¬e
è+ 4))

	)

127 
	#DDIPARAM_SECTION_CRC
(
fœmw¬e
) \

128 (
	`g‘_uÇligÃd_Ë32
(
	`DDIPARAM_CRC_SECTION
(
fœmw¬e
è+ 8))

	)

129 
	#DDIPARAM_SECTION_SIZE
(
fœmw¬e
) \

130 (
	`g‘_uÇligÃd_Ë32
(
	`DDIPARAM_CRC_SECTION
(
fœmw¬e
è+ 12))

	)

131 
	#DDIPARAM_CRC_SECTION_SIZE
 (17)

	)

134 
	$ÿlc_üc_š_æash
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

135 
u32
 
æash_addr
, 
size_t
 
size
, u32 *
üc
)

137  
ùs_dev
->
hwd©a
->
sfù¾
->
İs
->
	`ÿlc_æash_üc
(cts_dev,

138 
æash_addr
, 
size
, 
üc
);

139 
	}
}

141 
boŞ
 
	$is_muÉi_£ùiÚ_fœmw¬e
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
)

143  (
fœmw¬e
->
size
 =ğ
CTS_FIRMWARE_MULTI_SECTION_FILE_SIZE
);

144 
	}
}

146 
boŞ
 
	$is_sšgË_£ùiÚ_fœmw¬e
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
)

148  !(
	`is_muÉi_£ùiÚ_fœmw¬e
(
fœmw¬e
));

149 
	}
}

151 
boŞ
 
	$is_fœmw¬e_size_v®id
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
)

153  (
fœmw¬e
->
size
 > 0x102 &&

154 
fœmw¬e
->
size
 <ğ
CTS_FIRMWARE_MULTI_SECTION_FILE_SIZE
);

155 
	}
}

157 
boŞ
 
	$is_muÉi_£ùiÚ_fœmw¬e_v®id
(

158 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
)

160 
u32
 
üc
;

162 
üc
 = 
	`üc32
(
	`FIRMWARE_SECTION
(
fœmw¬e
), 
	`FIRMWARE_SECTION_SIZE
(firmware));

163 ià(
üc
 !ğ
	`FIRMWARE_SECTION_CRC
(
fœmw¬e
)) {

164 
	`ùs_”r
("Firmware-section crc mismatch crc-section %08x != %08x"

166 
üc
, 
	`FIRMWARE_SECTION_CRC
(
fœmw¬e
));

167  
çl£
;

170 ià(
	`DDIPARAM_SECTION_ENABLE
(
fœmw¬e
è=ğ
CTS_SECTION_ENABLE_FLAG
) {

171 
üc
 = 
	`üc32
(
	`DDIPARAM_SECTION
(
fœmw¬e
), 
	`DDIPARAM_SECTION_SIZE
(firmware));

172 ià(
üc
 !ğ
	`DDIPARAM_SECTION_CRC
(
fœmw¬e
)) {

173 
	`ùs_”r
("DDIParam-section crc mismatch crc-section %08x != %08x"

175 
üc
, 
	`DDIPARAM_SECTION_CRC
(
fœmw¬e
));

176  
çl£
;

179 
	`ùs_šfo
("DDIParam-section is NOTƒnabled");

182  
Œue
;

183 
	}
}

185 
boŞ
 
	$is_fœmw¬e_v®id
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
)

187 ià(
fœmw¬e
 && fœmw¬e->
d©a
 && 
	`is_fœmw¬e_size_v®id
(firmware)) {

188 ià(
	`is_sšgË_£ùiÚ_fœmw¬e
(
fœmw¬e
) ||

189 
	`is_muÉi_£ùiÚ_fœmw¬e_v®id
(
fœmw¬e
)) {

190  
Œue
;

194  
çl£
;

195 
	}
}

197 
	$·r£_sšgË_£ùiÚ_fœmw¬e
(

198 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
,

199 
ùs_fœmw¬e_£ù_šfo
 *
šfo
)

201 
u8
 
üc_£ù
[12];

203 
šfo
->
fœmw¬e_£ù
 = 
fœmw¬e
->
d©a
;

204 
šfo
->
fœmw¬e_£ù_size
 = 
fœmw¬e
->
size
;

205 
šfo
->
fœmw¬e_£ù_üc
 = 
	`üc32
(
fœmw¬e
->
d©a
, fœmw¬e->
size
);

207 
	`put_uÇligÃd_Ë32
(
šfo
->
fœmw¬e_£ù_üc
, 
üc_£ù
);

208 
	`put_uÇligÃd_Ë32
(
šfo
->
fœmw¬e_£ù_size
, 
üc_£ù
 + 4);

209 
	`put_uÇligÃd_Ë32
(~0x0000C35A, 
üc_£ù
 + 8);

210 
šfo
->
fœmw¬e_üc_£ù
 = 
üc_£ù
;

211 
šfo
->
fœmw¬e_üc_£ù_size
 = (
üc_£ù
);

212 
	}
}

214 
	$·r£_muÉi_£ùiÚ_fœmw¬e
(

215 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
,

216 
ùs_fœmw¬e_£ù_šfo
 *
šfo
)

218 
šfo
->
fœmw¬e_£ù
 = 
	`FIRMWARE_SECTION
(
fœmw¬e
);

219 
šfo
->
fœmw¬e_£ù_size
 = 
	`FIRMWARE_SECTION_SIZE
(
fœmw¬e
);

220 
šfo
->
fœmw¬e_üc_£ù
 = 
	`FIRMWARE_CRC_SECTION
(
fœmw¬e
);

221 
šfo
->
fœmw¬e_üc_£ù_size
 = 
FIRMWARE_CRC_SECTION_SIZE
;

222 
šfo
->
fœmw¬e_£ù_üc
 = 
	`FIRMWARE_SECTION_CRC
(
fœmw¬e
);

224 ià(
	`DDIPARAM_SECTION_ENABLE
(
fœmw¬e
è=ğ
CTS_SECTION_ENABLE_FLAG
) {

225 
šfo
->
dd¬am_£ù
 = 
	`DDIPARAM_SECTION
(
fœmw¬e
);

226 
šfo
->
dd¬am_£ù_size
 = 
	`DDIPARAM_SECTION_SIZE
(
fœmw¬e
);

227 
šfo
->
dd¬am_üc_£ù
 = 
	`DDIPARAM_CRC_SECTION
(
fœmw¬e
);

228 
šfo
->
dd¬am_üc_£ù_size
 = 
DDIPARAM_CRC_SECTION_SIZE
;

229 
šfo
->
dd¬am_£ù_üc
 = 
	`DDIPARAM_SECTION_CRC
(
fœmw¬e
);

231 
	}
}

233 
	$·r£_fœmw¬e
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
,

234 
ùs_fœmw¬e_£ù_šfo
 *
šfo
)

236 
	`mem£t
(
šfo
, 0, (*info));

238 ià(
	`is_muÉi_£ùiÚ_fœmw¬e
(
fœmw¬e
)) {

239 
	`·r£_muÉi_£ùiÚ_fœmw¬e
(
fœmw¬e
, 
šfo
);

241 
	`·r£_sšgË_£ùiÚ_fœmw¬e
(
fœmw¬e
, 
šfo
);

244 
	`ùs_šfo
(" Fœmw¬£ùiÚ size: %zu", 
šfo
->
fœmw¬e_£ù_size
);

245 ià(
šfo
->
dd¬am_üc_£ù
) {

246 
	`ùs_šfo
(" DDIP¬am seùiÚ size: %zu", 
šfo
->
dd¬am_£ù_size
);

250 
	}
}

252 #ifdeà
CFG_CTS_DRIVER_BUILTIN_FIRMWARE


253 #ifdeà
CONFIG_CTS_SYSFS


254 
	$ùs_g‘_num_driv”_butš_fœmw¬e
()

256  
NUM_DRIVER_BUILTIN_FIRMWARE
;

257 
	}
}

259 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_driv”_butš_fœmw¬e_by_Çme
(cÚ¡ *
Çme
)

261 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

262 
i
;

264 
	`ùs_šfo
("Reque¡ driv” butš by‚am'%s'", 
Çme
);

266 
fœmw¬e
 = 
ùs_driv”_butš_fœmw¬es
;

267 
i
 = 0; i < 
NUM_DRIVER_BUILTIN_FIRMWARE
; i++, 
fœmw¬e
++) {

268 ià(
	`¡rcmp
(
fœmw¬e
->
Çme
,‚ame) == 0) {

269 ià(
	`is_fœmw¬e_v®id
(
fœmw¬e
)) {

270 
	`ùs_šfo
("Found driver builtin '%s' "

272 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->
fwid
,

273 
fœmw¬e
->
size
, 
	`FIRMWARE_VERSION
(firmware));

274  
fœmw¬e
;

277 
	`ùs_w¬n
("Found driver builtin '%s' "

279 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->hwid, fœmw¬e->
size
);

283  
NULL
;

284 
	}
}

286 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_driv”_butš_fœmw¬e_by_šdex
(
u32
 
šdex
)

288 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

290 
	`ùs_šfo
("Reque¡ driv” butš by index %u", 
šdex
);

292 ià(
šdex
 < 
NUM_DRIVER_BUILTIN_FIRMWARE
) {

293 
fœmw¬e
 = 
ùs_driv”_butš_fœmw¬es
 + 
šdex
;

294 ià(
	`is_fœmw¬e_v®id
(
fœmw¬e
)) {

295 
	`ùs_šfo
("Found driver builtin '%s' "

297 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->
fwid
,

298 
fœmw¬e
->
size
, 
	`FIRMWARE_VERSION
(firmware));

299  
fœmw¬e
;

301 
	`ùs_w¬n
("Found driver builtin '%s' "

303 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->hwid, fœmw¬e->
size
);

305 
	`ùs_w¬n
("Request driver builtin by index %uoo†arge >= %zu",

306 
šdex
, 
NUM_DRIVER_BUILTIN_FIRMWARE
);

309  
NULL
;

310 
	}
}

313 cÚ¡ 
ùs_fœmw¬e
 * 
	$ùs_»que¡_Ãw”_driv”_butš_fœmw¬e
(

314 
u32
 
hwid
, 
u16
 
fwid
, u16 
deviû_fw_v”
)

316 
	#MATCH_HWID
(
fœmw¬e
, 
hwid
) \

317 ((
hwid
è=ğ
CTS_DEV_HWID_ANY
 || (
fœmw¬e
)->hwid =ğ(hwid))

	)

318 
	#MATCH_FWID
(
fœmw¬e
, 
fwid
) \

319 ((
fwid
è=ğ
CTS_DEV_FWID_ANY
 || (
fœmw¬e
)->fwid =ğ(fwid))

	)

321 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
 = 
NULL
;

322 
i
;

324 
	`ùs_šfo
("Request driver builtin if match hwid: %06x fwid: %04x && ver > %04x",

325 
hwid
, 
fwid
, 
deviû_fw_v”
);

327 
fœmw¬e
 = 
ùs_driv”_butš_fœmw¬es
;

328 
i
 = 0; i < 
	`ARRAY_SIZE
(
ùs_driv”_butš_fœmw¬es
); i++, 
fœmw¬e
++) {

329 ià(
	`MATCH_HWID
(
fœmw¬e
, 
hwid
è&& 
	`MATCH_FWID
(fœmw¬e, 
fwid
)) {

330 ià(!
	`is_fœmw¬e_v®id
(
fœmw¬e
)) {

331 
	`ùs_”r
("Found driver builtin '%s' "

333 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->
fwid
,

334 
fœmw¬e
->
d©a
, fœmw¬e->
size
);

338 
	`ùs_šfo
("Found matched driver builtin '%s' "

340 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->
fwid
,

341 
fœmw¬e
->
size
, 
	`FIRMWARE_VERSION
(firmware));

343 if(
	`FIRMWARE_VERSION
(
fœmw¬e
è> 
deviû_fw_v”
) {

344 
	`ùs_šfo
("Found‚ewer driver builtin '%s' "

346 
fœmw¬e
->
Çme
, fœmw¬e->
hwid
, fœmw¬e->
fwid
,

347 
fœmw¬e
->
size
, 
	`FIRMWARE_VERSION
(fœmw¬e), 
deviû_fw_v”
);

348  
fœmw¬e
;

353 
	`ùs_šfo
("No‚ewer driver builtin found");

355  
NULL
;

357 #undeà
MATCH_HWID


358 #undeà
MATCH_FWID


359 
	}
}

362 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


363 
boŞ
 
	$is_fesy¡em_mouÁed
(cÚ¡ *
f•©h
)

365 
·th
 
roÙ_·th
;

366 
·th
…ath;

367 
»t
;

369 
»t
 = 
	`k”n_·th
("/", 
LOOKUP_FOLLOW
, &
roÙ_·th
);

370 ià(
»t
) {

371  
çl£
;

374 
»t
 = 
	`k”n_·th
(
f•©h
, 
LOOKUP_FOLLOW
, &
·th
);

375 ià(
»t
) {

376 
”r_put_roÙ_·th
;

379 ià(
·th
.
mÁ
->
mÁ_sb
 =ğ
roÙ_·th
.mnt->mnt_sb) {

381 
»t
 = 
çl£
;

383 
»t
 = 
Œue
;

386 
	`·th_put
(&
·th
);

387 
”r_put_roÙ_·th
:

388 
	`·th_put
(&
roÙ_·th
);

390  !!
»t
;

391 
	}
}

393 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_Ãw”_fœmw¬e_äom_fs
(

394 cÚ¡ *
f•©h
, 
u16
 
cu¼_v”siÚ
)

396 
ùs_fœmw¬e
 *
fœmw¬e
;

397 
fe
 *file;

398 
»t
, 
»ad_size
;

399 
u8
 
buff
[2];

400 
u16
 
v”siÚ
;

401 
loff_t
 
pos
 = 0;

403 
	`ùs_šfo
("Request from file '%s' if version > %04x",

404 
f•©h
, 
cu¼_v”siÚ
);

406 
fœmw¬e
 = (
ùs_fœmw¬e
 *)
	`kz®loc
((*fœmw¬e), 
GFP_KERNEL
);

407 ià(
fœmw¬e
 =ğ
NULL
) {

408 
	`ùs_”r
("Request from file‡lloc struct firmware failed");

409  
NULL
;

412 
fe
 = 
	`fp_İ’
(
f•©h
, 
O_RDONLY
, 0);

413 ià(
	`IS_ERR
(
fe
)) {

414 
	`ùs_”r
("O³Àf'%s' faed %ld", 
f•©h
, 
	`PTR_ERR
(
fe
));

415 
”r_ä“_fœmw¬e
;

418 
fœmw¬e
->
size
 = 
	`fe_šode
(
fe
)->
i_size
;

419 ià(!
	`is_fœmw¬e_size_v®id
(
fœmw¬e
)) {

420 
	`ùs_šfo
("F'%s' size: %zu inv®id", 
f•©h
, 
fœmw¬e
->
size
);

421 
”r_şo£_fe
;

424 
pos
 = 
FIRMWARE_VERSION_OFFSET
;

425 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

426 
»ad_size
 = 
	`k”Ãl_»ad
(
fe
, 
buff
, 2, &
pos
);

428 
»ad_size
 = 
	`k”Ãl_»ad
(
fe
, 
pos
, 
buff
, 2);

430 ià(
»ad_size
 < 0) {

431 
	`ùs_”r
("Read version from offset 0x100 failed");

432 
”r_şo£_fe
;

434 
v”siÚ
 = 
	`g‘_uÇligÃd_Ë16
(
buff
);

436 ià(
v”siÚ
 <ğ
cu¼_v”siÚ
) {

437 
	`ùs_šfo
("File '%s' size: %zu version: %04x <= %04x",

438 
f•©h
, 
fœmw¬e
->
size
, 
v”siÚ
, 
cu¼_v”siÚ
);

439 
”r_şo£_fe
;

442 
	`ùs_šfo
("File '%s' size: %zu version: %04x",

443 
f•©h
, 
fœmw¬e
->
size
, 
v”siÚ
);

445 
fœmw¬e
->
d©a
 = (
u8
 *)
	`vm®loc
(fœmw¬e->
size
);

446 ià(
fœmw¬e
->
d©a
 =ğ
NULL
) {

447 
	`ùs_”r
("Request form fs‡lloc firmware data failed");

448 
”r_şo£_fe
;

451 
pos
 = 0;

452 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

453 
»ad_size
 = 
	`k”Ãl_»ad
(
fe
, 
fœmw¬e
->
d©a
, fœmw¬e->
size
, &
pos
);

455 
»ad_size
 = 
	`k”Ãl_»ad
(
fe
, 
pos
, 
fœmw¬e
->
d©a
, fœmw¬e->
size
);

457 ià(
»ad_size
 < 0 ||„—d_siz!ğ
fœmw¬e
->
size
) {

458 
	`ùs_”r
("Reque¡ from f »ad whŞfçed %d", 
»ad_size
);

459 
”r_ä“_fœmw¬e_d©a
;

462 
»t
 = 
	`fp_şo£
(
fe
, 
NULL
);

463 ià(
»t
) {

464 
	`ùs_w¬n
("Clo£ f'%s' faed %d", 
f•©h
, 
»t
);

467 ià(!
	`is_fœmw¬e_v®id
(
fœmw¬e
)) {

468 
	`ùs_”r
("Firmware is invalid");

469 
	`vä“
(
fœmw¬e
->
d©a
);

470 
”r_ä“_fœmw¬e
;

473  
fœmw¬e
;

475 
”r_ä“_fœmw¬e_d©a
:

476 
	`vä“
(
fœmw¬e
->
d©a
);

477 
”r_şo£_fe
:

478 
	`fp_şo£
(
fe
, 
NULL
);

479 
”r_ä“_fœmw¬e
:

480 
	`kä“
(
fœmw¬e
);

481 
fœmw¬e
 = 
NULL
;

483  
NULL
;

484 
	}
}

486 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_fœmw¬e_äom_fs
(cÚ¡ *
f•©h
)

488 
	`ùs_šfo
("Reque¡ from f'%s'", 
f•©h
);

490  
	`ùs_»que¡_Ãw”_fœmw¬e_äom_fs
(
f•©h
, 0);

491 
	}
}

493 
	$ùs_upd©e_fœmw¬e_äom_fe
(
ùs_deviû
 *
ùs_dev
,

494 cÚ¡ *
f•©h
, 
boŞ
 
to_æash
)

496 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

497 
»t
;

499 
	`ùs_šfo
("Upd©äom f'%s'Ø%s", 
f•©h
,

500 
to_æash
 ? "flash" : "sram");

502 
fœmw¬e
 = 
	`ùs_»que¡_fœmw¬e_äom_fs
(
f•©h
);

503 if(
fœmw¬e
 =ğ
NULL
) {

504 
	`ùs_”r
("Reque¡ from f'%s' faed", 
f•©h
);

505  -
EFAULT
;

508 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, 
fœmw¬e
, 
to_æash
);

509 ià(
»t
) {

510 
	`ùs_”r
("Updateo %s from file failed %d",

511 
to_æash
 ? "æash" : "¤am", 
»t
);

512 
”r_»Ëa£_fœmw¬e
;

515 
	`ùs_šfo
("Update from file success");

517 
”r_»Ëa£_fœmw¬e
:

518 
	`ùs_»Ëa£_fœmw¬e
(
fœmw¬e
);

520  
»t
;

521 
	}
}

524 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_fœmw¬e
(

525 
u32
 
hwid
, 
u16
 
fwid
, u16 
cu¼_fœmw¬e_v”
)

527 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e_butš
 = 
NULL
;

528 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e_äom_fe
 = 
NULL
;

530 ià(
hwid
 =ğ
CTS_DEV_HWID_INVALID
) {

531 
hwid
 = 
CTS_DEV_HWID_ANY
;

533 ià(
fwid
 =ğ
CTS_DEV_FWID_INVALID
) {

534 
fwid
 = 
CTS_DEV_FWID_ANY
;

537 
	`ùs_šfo
("Request‚ewer if match hwid: %06x fwid: %04x && ver > %04x",

538 
hwid
, 
fwid
, 
cu¼_fœmw¬e_v”
);

540 #ifdeà
CFG_CTS_DRIVER_BUILTIN_FIRMWARE


541 
fœmw¬e_butš
 = 
	`ùs_»que¡_Ãw”_driv”_butš_fœmw¬e
(

542 
hwid
, 
fwid
, 
cu¼_fœmw¬e_v”
);

545 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


547 ià(
	`is_fesy¡em_mouÁed
(
CFG_CTS_FIRMWARE_FILEPATH
)) {

548 
fœmw¬e_äom_fe
 = 
	`ùs_»que¡_Ãw”_fœmw¬e_äom_fs
(

549 
CFG_CTS_FIRMWARE_FILEPATH
,

550 
fœmw¬e_butš
 ? 
	`FIRMWARE_VERSION
(firmware_builtin) :

551 
cu¼_fœmw¬e_v”
);

555  
fœmw¬e_äom_fe
 ? fœmw¬e_äom_f: 
fœmw¬e_butš
;

556 
	}
}

558 
	$ùs_»Ëa£_fœmw¬e
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
)

560 
	`ùs_šfo
("Release firmware");

563 ià(
fœmw¬e
 && fœmw¬e->
Çme
 =ğ
NULL
) {

564 
	`vä“
(
fœmw¬e
->
d©a
);

565 
	`kä“
(
fœmw¬e
);

567 
	}
}

569 
	$v®id©e_æash_d©a
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

570 
u32
 
æash_addr
, cÚ¡ 
u8
 *
d©a
, 
size_t
 
size
,

571 
u8
 *
buf
, 
boŞ
 
ÿlc_üc
, 
u32
 
üc
)

573 
»t
, 
i
;

574 
boŞ
 
ä“_d©a
 = 
çl£
;

575 
u32
 
üc_æash
;

577 
	`ùs_šfo
("Validate flash data from 0x%06x size %zu by %s",

578 
æash_addr
, 
size
, 
ÿlc_üc
 ? "check-crc" : "direct-readback");

580 ià(
ÿlc_üc
) {

581 
»t
 = 
	`ÿlc_üc_š_æash
(
ùs_dev
, 
æash_addr
, 
size
, &
üc_æash
);

582 ià(
»t
) {

583 
	`ùs_”r
("Calc data in flash from 0x%06x size %zu crc failed %d, "

585 
æash_addr
, 
size
, 
»t
);

588 ià(
üc_æash
 !ğ
üc
) {

589 
	`ùs_”r
("Crc in flash from 0x%06x size %zu mismatch 0x%08x != 0x%08x",

590 
æash_addr
, 
size
, 
üc_æash
, 
üc
);

593 
	`ùs_šfo
("Flash data crc correct");

599 ià(
buf
 =ğ
NULL
) {

600 
buf
 = (
u8
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

601 ià(
buf
 =ğ
NULL
) {

602 
	`ùs_”r
("Validate flash data‡llocate mem failed");

603  -
ENOMEM
;

606 
ä“_d©a
 = 
Œue
;

609 
»t
 = 
	`ùs_»ad_æash
(
ùs_dev
, 
æash_addr
, 
buf
, 
size
);

610 ià(
»t
) {

611 
	`ùs_”r
("Read flash from 0x%06x size %zu failed %d",

612 
æash_addr
, 
size
, 
»t
);

613 
”r_ä“_buf
;

616 
i
 = 0; i < 
size
; i++) {

617 ià(
buf
[
i
] !ğ
d©a
[i]) {

618 ià(
»t
 == 0) {

619 
	`ùs_”r
("Flash data from 0x%06x size %zu first bytes diff:\n",

620 
æash_addr
, 
size
);

623 ià(
»t
 < 100) {

624 
	`ùs_”r
(" 0x%06x: %02x %02x", 
i
, 
buf
[i], 
d©a
[i]);

625 } ià(
»t
 == 100) {

626 
	`ùs_”r
(" ...");

628 
»t
++;

632 
”r_ä“_buf
:

633 ià(
ä“_d©a
) {

634 
	`kä“
(
buf
);

637  
»t
;

638 
	}
}

640 
	$ùs_´og¿m_fœmw¬e
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

641 cÚ¡ 
ùs_fœmw¬e_£ù_šfo
 *
fœmw¬e_šfo
)

643 
»t
;

644 
u8
 
üc_£ù_buf
[
FIRMWARE_CRC_SECTION_SIZE
];

646 
	`ùs_šfo
("Prog¿m fœmw¬siz%zu", 
fœmw¬e_šfo
->
fœmw¬e_£ù_size
);

649 
	`ùs_šfo
("Write firmware sectiono sram");

650 
»t
 = 
	`ùs_¤am_wr™esb_check_üc_»Œy
(
ùs_dev
,

651 0, 
fœmw¬e_šfo
->
fœmw¬e_£ù
, fœmw¬e_šfo->
fœmw¬e_£ù_size
,

652 
fœmw¬e_šfo
->
fœmw¬e_£ù_üc
, 3);

653 ià(
»t
) {

654 
	`ùs_”r
("Wr™fœmw¬£ùiÚØ¤am faed %d", 
»t
);

655  
»t
;

658 
»t
 = 
	`ùs_´og¿m_æash_äom_¤am
(
ùs_dev
,

659 4, 4, 
fœmw¬e_šfo
->
fœmw¬e_£ù_size
 - 4);

660 ià(
»t
) {

661 
	`ùs_”r
("Prog¿m fœmw¬£ùiÚ from s¿m faed %d", 
»t
);

662  
»t
;

665 
»t
 = 
	`ùs_´og¿m_æash
(
ùs_dev
,

666 
CTS_FIRMWARE_CRC_SECTION_OFFSET
,

667 
fœmw¬e_šfo
->
fœmw¬e_üc_£ù
,

668 
fœmw¬e_šfo
->
fœmw¬e_üc_£ù_size
);

669 ià(
»t
) {

670 
	`ùs_”r
("Prog¿m fœmw¬üø£ùiÚ faed %d", 
»t
);

671  
»t
;

674 
»t
 = 
	`v®id©e_æash_d©a
(
ùs_dev
,

675 
CTS_FIRMWARE_CRC_SECTION_OFFSET
, 
fœmw¬e_šfo
->
fœmw¬e_üc_£ù
,

676 
fœmw¬e_šfo
->
fœmw¬e_üc_£ù_size
, 
üc_£ù_buf
, 
çl£
, 0);

677 ià(
»t
) {

678 
	`ùs_”r
("V®id©Fœmw¬e-CRC seùiÚ faed %d", 
»t
);

679  
»t
;

682 
»t
 = 
	`ùs_´og¿m_æash
(
ùs_dev
, 0, 
fœmw¬e_šfo
->
fœmw¬e_£ù
, 4);

683 ià(
»t
) {

684 
	`ùs_”r
("Prog¿m fœmw¬£ùiÚ fi¡ 4by‹ çed %d", 
»t
);

685  
»t
;

688 
»t
 = 
	`v®id©e_æash_d©a
(
ùs_dev
,

689 
CTS_FIRMWARE_SECTION_OFFSET
, 
fœmw¬e_šfo
->
fœmw¬e_£ù
,

690 
fœmw¬e_šfo
->
fœmw¬e_£ù_size
, 
NULL
,

691 
Œue
, 
fœmw¬e_šfo
->
fœmw¬e_£ù_üc
);

692 ià(
»t
) {

693 
	`ùs_”r
("V®id©fœmw¬£ùiÚ faed %d", 
»t
);

694  
»t
;

698 
	}
}

700 
	$ùs_´og¿m_dd¬am
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

701 cÚ¡ 
ùs_fœmw¬e_£ù_šfo
 *
fœmw¬e_šfo
)

703 
»t
;

704 
u8
 
üc_£ù_buf
[
DDIPARAM_CRC_SECTION_SIZE
];

706 
	`ùs_šfo
("Prog¿m DDIP¬am size: %zu", 
fœmw¬e_šfo
->
dd¬am_£ù_size
);

708 
»t
 = 
	`ùs_´og¿m_æash
(
ùs_dev
, 
CTS_DDIPARAM_SECTION_OFFSET
,

709 
fœmw¬e_šfo
->
dd¬am_£ù
, fœmw¬e_šfo->
dd¬am_£ù_size
);

710 ià(
»t
) {

711 
	`ùs_”r
("Prog¿m DDIP¬am seùiÚ faed %d", 
»t
);

712  
»t
;

715 
»t
 = 
	`v®id©e_æash_d©a
(
ùs_dev
,

716 
CTS_DDIPARAM_SECTION_OFFSET
, 
fœmw¬e_šfo
->
dd¬am_£ù
,

717 
fœmw¬e_šfo
->
dd¬am_£ù_size
, 
NULL
,

718 
Œue
, 
fœmw¬e_šfo
->
dd¬am_£ù_üc
);

719 ià(
»t
) {

720 
	`ùs_”r
("V®id©DDIP¬am seùiÚ faed %d", 
»t
);

721  
»t
;

724 
»t
 = 
	`ùs_´og¿m_æash
(
ùs_dev
, 
CTS_DDIPARAM_CRC_SECTION_OFFSET
,

725 
fœmw¬e_šfo
->
dd¬am_üc_£ù
,

726 
fœmw¬e_šfo
->
dd¬am_üc_£ù_size
);

727 ià(
»t
) {

728 
	`ùs_”r
("Prog¿m DDIP¬am-CRC seùiÚ faed %d", 
»t
);

729  
»t
;

732 
»t
 = 
	`v®id©e_æash_d©a
(
ùs_dev
,

733 
CTS_DDIPARAM_CRC_SECTION_OFFSET
, 
fœmw¬e_šfo
->
dd¬am_üc_£ù
,

734 
fœmw¬e_šfo
->
dd¬am_üc_£ù_size
, 
üc_£ù_buf
, 
çl£
, 0);

735 ià(
»t
) {

736 
	`ùs_”r
("V®id©DDIP¬am-CRC seùiÚ faed %d", 
»t
);

737  
»t
;

741 
	}
}

744 
	$ùs_upd©e_fœmw¬e
(
ùs_deviû
 *
ùs_dev
,

745 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
, 
boŞ
 
to_æash
)

747 
ùs_fœmw¬e_£ù_šfo
 
fœmw¬e_šfo
;

748 
»t
, 
»Œ›s
;

750 
	`ùs_šfo
("Update firmwareo %s ver: %04x size: %zu",

751 
to_æash
 ? "flash" : "sram",

752 
	`FIRMWARE_VERSION
(
fœmw¬e
), fœmw¬e->
size
);

754 ià(
	`·r£_fœmw¬e
(
fœmw¬e
, &
fœmw¬e_šfo
)) {

755 
	`ùs_”r
("Parse firmware failed");

756  -
EINVAL
;

759 
ùs_dev
->
¹d©a
.
upd©šg
 = 
Œue
;

761 
»t
 = 
	`ùs_’‹r_´og¿m_mode
(
ùs_dev
);

762 ià(
»t
) {

763 
	`ùs_”r
("DeviûƒÁ”…rog¿m modçed %d", 
»t
);

764 
out
;

767 
»t
 = 
	`ùs_´•¬e_æash_İ”©iÚ
(
ùs_dev
);

768 ià(
»t
) {

769 
	`ùs_w¬n
("P»·» fÏsh o³¿tiÚ faed %d", 
»t
);

773 ià(!
to_æash
 || !
ùs_dev
->
¹d©a
.
has_æash
) {

774 
	`ùs_šfo
("Write firmware sectiono sram size %zu",

775 
fœmw¬e_šfo
.
fœmw¬e_£ù_size
);

776 
»t
 = 
	`ùs_¤am_wr™esb_check_üc_»Œy
(
ùs_dev
,

777 0, 
fœmw¬e_šfo
.
fœmw¬e_£ù
, fœmw¬e_šfo.
fœmw¬e_£ù_size
,

778 
fœmw¬e_šfo
.
fœmw¬e_£ù_üc
, 3);

779 ià(
»t
) {

780 
	`ùs_”r
("Wr™fœmw¬£ùiÚØ¤am faed %d", 
»t
);

782 #ifdeà
CFG_CTS_UPDATE_CRCCHECK


783 ià(
ùs_dev
->
hwd©a
->
hwid
 =ğ
CTS_DEV_HWID_ICNL9911S


784 
ùs_dev
->
hwd©a
->
hwid
 =ğ
CTS_DEV_HWID_ICNL9911C
) {

785 
	`ùs_¤am_wr™esb_boÙ_üc_»Œy
(
ùs_dev
,

786 
fœmw¬e_šfo
.
fœmw¬e_£ù_size
,

787 
fœmw¬e_šfo
.
fœmw¬e_£ù_üc
,

791 
out
;

794 
»Œ›s
 = 0;

796 
»Œ›s
++;

798 
»t
 = 
	`ùs_”a£_æash
(
ùs_dev
, 
CTS_FIRMWARE_CRC_SECTION_OFFSET
,

799 
fœmw¬e_šfo
.
fœmw¬e_üc_£ù_size
);

800 ià(
»t
) {

801 
	`ùs_”r
("Erase firmware crc section failed %d„etries %d",

802 
»t
, 
»Œ›s
);

806 
»t
 = 
	`ùs_”a£_æash
(
ùs_dev
, 0, 
fœmw¬e_šfo
.
fœmw¬e_£ù_size
);

807 ià(
»t
) {

808 
	`ùs_”r
("Erase firmware section failed %d„etries %d",

809 
»t
, 
»Œ›s
);

813 
»t
 = 
	`ùs_´og¿m_fœmw¬e
(
ùs_dev
, &
fœmw¬e_šfo
);

814 ià(
»t
) {

815 
	`ùs_”r
("Program firmware & crc section failed %d„etries %d",

816 
»t
, 
»Œ›s
);

818 } 
»t
 && 
»Œ›s
 < 3);

820 ià(
»t
 =ğ0 && 
fœmw¬e_šfo
.
dd¬am_£ù_size
 != 0) {

821 
»Œ›s
 = 0;

823 
»Œ›s
++;

825 
»t
 = 
	`ùs_”a£_æash
(
ùs_dev
, 
CTS_DDIPARAM_CRC_SECTION_OFFSET
,

826 
fœmw¬e_šfo
.
dd¬am_üc_£ù_size
);

827 ià(
»t
) {

828 
	`ùs_”r
("Erase DDIParam crc secction failed %d,„etries %d",

829 
»t
, 
»Œ›s
);

833 
»t
 = 
	`ùs_”a£_æash
(
ùs_dev
, 
CTS_DDIPARAM_SECTION_OFFSET
,

834 
fœmw¬e_šfo
.
dd¬am_£ù_size
);

835 ià(
»t
) {

836 
	`ùs_”r
("Erase DDIParam section failed %d,„etries %d",

837 
»t
, 
»Œ›s
);

841 
»t
 = 
	`ùs_´og¿m_dd¬am
(
ùs_dev
, &
fœmw¬e_šfo
);

842 ià(
»t
) {

843 
	`ùs_”r
("Program DDIParam & crc section failed %d„etries %d",

844 
»t
, 
»Œ›s
);

846 } 
»t
 && 
»Œ›s
 < 3);

849 
	`ùs_po¡_æash_İ”©iÚ
(
ùs_dev
);

851 
out
:

852 
ùs_dev
->
¹d©a
.
upd©šg
 = 
çl£
;

854 ià(
»t
 == 0) {

855 ià(
fœmw¬e_šfo
.
fœmw¬e_£ù_size
 <=

856 
ùs_dev
->
hwd©a
->
sfù¾
->
xchg_¤am_ba£
) {

857 
»t
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

858 ià(
»t
) {

859 
	`ùs_”r
("EÁ”‚Üm® modçed %d", 
»t
);

865 #ifdeà
CONFIG_CTS_CHARGER_DETECT


866 ià(
	`ùs_is_ch¬g”_exi¡
(
ùs_dev
)) {

867 
r
 = 
	`ùs_£t_dev_ch¬g”_©ched
(
ùs_dev
, 
Œue
);

868 ià(
r
) {

869 
	`ùs_”r
("S‘ dev ch¬g”‡‰ached faed %d", 
r
);

874 #ifdeà
CONFIG_CTS_EARJACK_DETECT


875 ià(
ùs_dev
->
fwd©a
.
suµ_h—dphÚe_ÿbË_»jeù
 &&

876 
	`ùs_is_—rjack_exi¡
(
ùs_dev
)) {

877 
r
 = 
	`ùs_£t_dev_—rjack_©ched
(
ùs_dev
, 
Œue
);

878 ià(
r
) {

879 
	`ùs_”r
("S‘ devƒ¬jack‡‰ached faed %d", 
r
);

884 #ifdeà
CONFIG_CTS_GLOVE


885 ià(
	`ùs_is_glove_’abËd
(
ùs_dev
)) {

886 
	`ùs_’‹r_glove_mode
(
ùs_dev
);

890 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


891 ià(
	`ùs_is_fw_log_»dœeù
(
ùs_dev
)) {

892 
	`ùs_’abË_fw_log_»dœeù
(
ùs_dev
);

896  
»t
;

897 
	}
}

899 
boŞ
 
	$ùs_is_fœmw¬e_upd©šg
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

901  
ùs_dev
->
¹d©a
.
upd©šg
;

902 
	}
}

	@cts_firmware.h

1 #iâdeà
CTS_FIRMWARE_H


2 
	#CTS_FIRMWARE_H


	)

4 
	~"ùs_cÚfig.h
"

6 
	sùs_fœmw¬e
 {

7 cÚ¡ *
	mÇme
;

8 
u32
 
	mhwid
;

9 
u16
 
	mfwid
;

11 
u8
 *
	md©a
;

12 
size_t
 
	msize
;

16 
	#FIRMWARE_VERSION_OFFSET
 0x100

	)

17 
	#FIRMWARE_VERSION
(
fœmw¬e
) \

18 
	`g‘_uÇligÃd_Ë16
((
fœmw¬e
)->
d©a
 + 
FIRMWARE_VERSION_OFFSET
)

	)

20 
	gùs_deviû
;

22 
u32
 
üc32
(cÚ¡ 
u8
 *
d©a
, 
size_t
 
Ën
);

24 #ià
defšed
(
CFG_CTS_DRIVER_BUILTIN_FIRMWARE
è|| defšed(
CFG_CTS_FIRMWARE_IN_FS
)

25 cÚ¡ 
ùs_fœmw¬e
 *
ùs_»que¡_fœmw¬e
(

26 
u32
 
hwid
, 
u16
 
fwid
, u16 
deviû_fw_v”
);

27 
ùs_»Ëa£_fœmw¬e
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
);

29 
ùs_upd©e_fœmw¬e
(
ùs_deviû
 *
ùs_dev
,

30 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
, 
boŞ
 
to_æash
);

31 
boŞ
 
ùs_is_fœmw¬e_upd©šg
(cÚ¡ 
ùs_deviû
 *
ùs_dev
);

33 
šlše
 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_fœmw¬e
(

34 
u32
 
hwid
, 
u16
 
fwid
, u16 
deviû_fw_v”
è{ 
NULL
;
	}
}

35 
šlše
 
	$ùs_»Ëa£_fœmw¬e
(cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
){
	}
}

37 
šlše
 
	$ùs_upd©e_fœmw¬e
(
ùs_deviû
 *
ùs_dev
,

38 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
, 
boŞ
 
to_æash
è{ -
ENOTSUPP
;
	}
}

39 
šlše
 
boŞ
 
	$ùs_is_fœmw¬e_upd©šg
(cÚ¡ 
ùs_deviû
 *
ùs_dev
è{ 
çl£
;
	}
}

42 #ifdeà
CFG_CTS_DRIVER_BUILTIN_FIRMWARE


43 
ùs_g‘_num_driv”_butš_fœmw¬e
();

44 cÚ¡ 
ùs_fœmw¬e
 *
ùs_»que¡_driv”_butš_fœmw¬e_by_Çme
(cÚ¡ *
Çme
);

45 cÚ¡ 
ùs_fœmw¬e
 *
ùs_»que¡_driv”_butš_fœmw¬e_by_šdex
(
u32
 
šdex
);

47 
šlše
 
	$ùs_g‘_num_driv”_butš_fœmw¬e
(è{ 0;
	}
}

48 
šlše
 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_driv”_butš_fœmw¬e_by_Çme
(cÚ¡ *
Çme
è{ 
NULL
;
	}
}

49 
šlše
 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_driv”_butš_fœmw¬e_by_šdex
(
u32
 
šdex
è{ 
NULL
;
	}
}

52 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


53 cÚ¡ 
ùs_fœmw¬e
 *
ùs_»que¡_fœmw¬e_äom_fs
(cÚ¡ *
f•©h
);

54 
ùs_upd©e_fœmw¬e_äom_fe
(

55 
ùs_deviû
 *
ùs_dev
, cÚ¡ *
f•©h
, 
boŞ
 
to_æash
);

57 
šlše
 cÚ¡ 
ùs_fœmw¬e
 *
	$ùs_»que¡_fœmw¬e_äom_fs
(cÚ¡ *
f•©h
è{ 
NULL
;
	}
}

58 
šlše
 
	$ùs_upd©e_fœmw¬e_äom_fe
(

59 
ùs_deviû
 *
ùs_dev
, cÚ¡ *
f•©h
, 
boŞ
 
to_æash
è{ -
ENOTSUPP
;
	}
}

	@cts_i2c_driver.c

1 
	#LOG_TAG
 "I2CDrv"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sysfs.h
"

7 
	~"ùs_ch¬g”_d‘eù.h
"

8 
	~"ùs_—rjack_d‘eù.h
"

9 
	~"ùs_¡»¼Ü.h
"

11 
boŞ
 
	gùs_show_debug_log
 = 
çl£
;

12 
moduË_·¿m_Çmed
(
debug_log
, 
ùs_show_debug_log
, 
boŞ
, 0660);

13 
MODULE_PARM_DESC
(
debug_log
, "Show debug†og control");

15 
	$ùs_su¥’d
(
chÚe_ts_d©a
 *
ùs_d©a
)

17 
»t
;

19 
	`ùs_šfo
("Suspend");

21 
	`ùs_lock_deviû
(&
ùs_d©a
->
ùs_dev
);

22 
»t
 = 
	`ùs_su¥’d_deviû
(&
ùs_d©a
->
ùs_dev
);

23 
	`ùs_uÆock_deviû
(&
ùs_d©a
->
ùs_dev
);

25 ià(
»t
) {

26 
	`ùs_”r
("Su¥’d deviû faed %d", 
»t
);

31 
»t
 = 
	`ùs_¡İ_deviû
(&
ùs_d©a
->
ùs_dev
);

32 ià(
»t
) {

33 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

34  
»t
;

37 #ifdeà
CFG_CTS_GESTURE


39 ià(
	`ùs_is_ge¡u»_wakeup_’abËd
(&
ùs_d©a
->
ùs_dev
)) {

40 
»t
 = 
	`ùs_¶©_’abË_œq_wake
(
ùs_d©a
->
pd©a
);

41 ià(
»t
) {

42 
	`ùs_”r
("EÇbË IRQ wakçed %d", 
»t
);

43  
»t
;

45 
»t
 = 
	`ùs_¶©_’abË_œq
(
ùs_d©a
->
pd©a
);

46 ià(
»t
){

47 
	`ùs_”r
("EÇbË IRQ faed %d",
»t
);

48  
»t
;

55 
	`m¦“p
(20);

58 
	}
}

60 
	$ùs_»sume
(
chÚe_ts_d©a
 *
ùs_d©a
)

62 
»t
;

64 
	`ùs_šfo
("Resume");

66 #ifdeà
CFG_CTS_GESTURE


67 ià(
	`ùs_is_ge¡u»_wakeup_’abËd
(&
ùs_d©a
->
ùs_dev
)) {

68 
»t
 = 
	`ùs_¶©_di§bË_œq_wake
(
ùs_d©a
->
pd©a
);

69 ià(
»t
) {

70 
	`ùs_w¬n
("Di§bË IRQ wakçed %d", 
»t
);

73 ià((
»t
 = 
	`ùs_¶©_di§bË_œq
(
ùs_d©a
->
pd©a
)) < 0) {

74 
	`ùs_”r
("Di§bË IRQ faed %d", 
»t
);

80 
	`ùs_lock_deviû
(&
ùs_d©a
->
ùs_dev
);

81 
»t
 = 
	`ùs_»sume_deviû
(&
ùs_d©a
->
ùs_dev
);

82 
	`ùs_uÆock_deviû
(&
ùs_d©a
->
ùs_dev
);

83 if(
»t
) {

84 
	`ùs_w¬n
("Resumdeviû faed %d", 
»t
);

85  
»t
;

88 
»t
 = 
	`ùs_¡¬t_deviû
(&
ùs_d©a
->
ùs_dev
);

89 ià(
»t
) {

90 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

91  
»t
;

95 
	}
}

97 #ifdeà
CONFIG_CTS_PM_FB_NOTIFIER


98 #ifdeà
CFG_CTS_DRM_NOTIFIER


99 
	$fb_nÙif›r_ÿÎback
(
nÙif›r_block
 *
nb
,

100 
aùiÚ
, *
d©a
)

102 vŞ©
bÏnk
;

103 cÚ¡ 
ùs_¶©fÜm_d©a
 *
pd©a
 =

104 
	`cÚš”_of
(
nb
, 
ùs_¶©fÜm_d©a
, 
fb_nÙif›r
);

105 
chÚe_ts_d©a
 *
ùs_d©a
 =

106 
	`cÚš”_of
(
pd©a
->
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

107 
fb_ev’t
 *
evd©a
 = 
d©a
;

109 
	`ùs_šfo
("FB‚otifier callback");

111 ià(
evd©a
 &&ƒvd©a->
d©a
) {

112 ià(
aùiÚ
 =ğ
MSM_DRM_EVENT_BLANK
) {

113 
bÏnk
 = *(*)
evd©a
->
d©a
;

114 ià(
bÏnk
 =ğ
MSM_DRM_BLANK_UNBLANK
) {

115 
	`ùs_»sume
(
ùs_d©a
);

116  
NOTIFY_OK
;

118 } ià(
aùiÚ
 =ğ
MSM_DRM_EARLY_EVENT_BLANK
) {

119 
bÏnk
 = *(*)
evd©a
->
d©a
;

120 ià(
bÏnk
 =ğ
MSM_DRM_BLANK_POWERDOWN
) {

121 
	`ùs_su¥’d
(
ùs_d©a
);

122  
NOTIFY_OK
;

127  
NOTIFY_DONE
;

128 
	}
}

130 
	$fb_nÙif›r_ÿÎback
(
nÙif›r_block
 *
nb
,

131 
aùiÚ
, *
d©a
)

133 vŞ©
bÏnk
;

134 cÚ¡ 
ùs_¶©fÜm_d©a
 *
pd©a
 =

135 
	`cÚš”_of
(
nb
, 
ùs_¶©fÜm_d©a
, 
fb_nÙif›r
);

136 
chÚe_ts_d©a
 *
ùs_d©a
 =

137 
	`cÚš”_of
(
pd©a
->
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

138 
fb_ev’t
 *
evd©a
 = 
d©a
;

140 
	`ùs_šfo
("FB‚otifier callback");

142 ià(
evd©a
 &&ƒvd©a->
d©a
) {

143 ià(
aùiÚ
 =ğ
FB_EVENT_BLANK
) {

144 
bÏnk
 = *(*)
evd©a
->
d©a
;

145 ià(
bÏnk
 =ğ
FB_BLANK_UNBLANK
) {

146 
	`ùs_»sume
(
ùs_d©a
);

147  
NOTIFY_OK
;

149 } ià(
aùiÚ
 =ğ
FB_EARLY_EVENT_BLANK
) {

150 
bÏnk
 = *(*)
evd©a
->
d©a
;

151 ià(
bÏnk
 =ğ
FB_BLANK_POWERDOWN
) {

152 
	`ùs_su¥’d
(
ùs_d©a
);

153  
NOTIFY_OK
;

158  
NOTIFY_DONE
;

159 
	}
}

162 
	$ùs_š™_pm_fb_nÙif›r
(
chÚe_ts_d©a
 * 
ùs_d©a
)

164 
	`ùs_šfo
("Init FB‚otifier");

166 
ùs_d©a
->
pd©a
->
fb_nÙif›r
.
nÙif›r_ÿÎ
 = 
fb_nÙif›r_ÿÎback
;

168 #ifdeà
CFG_CTS_DRM_NOTIFIER


169  
	`msm_drm_»gi¡”_ş›Á
(&
ùs_d©a
->
pd©a
->
fb_nÙif›r
);

171  
	`fb_»gi¡”_ş›Á
(&
ùs_d©a
->
pd©a
->
fb_nÙif›r
);

173 
	}
}

175 
	$ùs_deš™_pm_fb_nÙif›r
(
chÚe_ts_d©a
 * 
ùs_d©a
)

177 
	`ùs_šfo
("Deinit FB‚otifier");

178 #ifdeà
CFG_CTS_DRM_NOTIFIER


179  
	`msm_drm_uÄegi¡”_ş›Á
(&
ùs_d©a
->
pd©a
->
fb_nÙif›r
)

181  
	`fb_uÄegi¡”_ş›Á
(&
ùs_d©a
->
pd©a
->
fb_nÙif›r
);

183 
	}
}

186 #ifdeà
CONFIG_CTS_I2C_HOST


187 
	$ùs_driv”_´obe
(
i2c_ş›Á
 *
ş›Á
,

188 cÚ¡ 
i2c_deviû_id
 *
id
)

190 
	$ùs_driv”_´obe
(
¥i_deviû
 *
ş›Á
)

193 
chÚe_ts_d©a
 *
ùs_d©a
 = 
NULL
;

194 
»t
 = 0;

196 #ifdeà
CONFIG_CTS_I2C_HOST


197 
	`ùs_šfo
("Probe i2c client:‚ame='%s'‡ddr=0x%02x flags=0x%02x irq=%d",

198 
ş›Á
->
Çme
, cl›Á->
addr
, cl›Á->
æags
, cl›Á->
œq
);

200 #ià!
	`defšed
(
CONFIG_MTK_PLATFORM
)

201 ià(
ş›Á
->
addr
 !ğ
CTS_DEV_NORMAL_MODE_I2CADDR
) {

202 
	`ùs_”r
("Probe i2c‡ddr 0x%02x != driver config‡ddr 0x%02x",

203 
ş›Á
->
addr
, 
CTS_DEV_NORMAL_MODE_I2CADDR
);

204  -
ENODEV
;

208 ià(!
	`i2c_check_funùiÚ®™y
(
ş›Á
->
ad­‹r
, 
I2C_FUNC_I2C
)) {

209 
	`ùs_”r
("Check functionality failed");

210  -
ENODEV
;

214 
ùs_d©a
 = (
chÚe_ts_d©a
 *)
	`kz®loc
((*ùs_d©a), 
GFP_KERNEL
);

215 ià(
ùs_d©a
 =ğ
NULL
) {

216 
	`ùs_”r
("Allocate chipone_ts_data failed");

217  -
ENOMEM
;

220 
ùs_d©a
->
pd©a
 = (
ùs_¶©fÜm_d©a
 *)
	`kz®loc
(

221 (
ùs_¶©fÜm_d©a
), 
GFP_KERNEL
);

222 ià(
ùs_d©a
->
pd©a
 =ğ
NULL
) {

223 
	`ùs_”r
("Allocate cts_platform_data failed");

224 
»t
 = -
ENOMEM
;

225 
”r_ä“_ùs_d©a
;

228 #ifdeà
CONFIG_CTS_I2C_HOST


229 
	`i2c_£t_ş›Ád©a
(
ş›Á
, 
ùs_d©a
);

230 
ùs_d©a
->
i2c_ş›Á
 = 
ş›Á
;

231 
ùs_d©a
->
deviû
 = &
ş›Á
->
dev
;

233 
	`¥i_£t_drvd©a
(
ş›Á
, 
ùs_d©a
);

234 
ùs_d©a
->
¥i_ş›Á
 = 
ş›Á
;

235 
ùs_d©a
->
deviû
 = &
ş›Á
->
dev
;

238 
	`ùs_š™_¶©fÜm_d©a
(
ùs_d©a
->
pd©a
, 
ş›Á
);

240 
ùs_d©a
->
ùs_dev
.
pd©a
 = cts_data->pdata;

241 
ùs_d©a
->
pd©a
->
ùs_dev
 = &cts_data->cts_dev;

243 
ùs_d©a
->
wÜkqueue
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
(
CFG_CTS_DEVICE_NAME
 "-workqueue");

244 ià(
ùs_d©a
->
wÜkqueue
 =ğ
NULL
) {

245 
	`ùs_”r
("Create workqueue failed");

246 
»t
 = -
ENOMEM
;

247 
”r_deš™_¶©fÜm_d©a
;

250 #ifdeà
CONFIG_CTS_ESD_PROTECTION


251 
ùs_d©a
->
esd_wÜkqueue
 = 
	`ü—‹_sšgËth»ad_wÜkqueue
(
CFG_CTS_DEVICE_NAME
 "-esd_workqueue");

252 ià(
ùs_d©a
->
esd_wÜkqueue
 =ğ
NULL
) {

253 
	`ùs_”r
("Createƒsd workqueue failed");

254 
»t
 = -
ENOMEM
;

255 
”r_de¡roy_wÜkqueue
;

258 
»t
 = 
	`ùs_¶©_»que¡_»sourû
(
ùs_d©a
->
pd©a
);

259 ià(
»t
 < 0) {

260 
	`ùs_”r
("Reque¡„esourû faed %d", 
»t
);

261 
”r_de¡roy_esd_wÜkqueue
;

264 
»t
 = 
	`ùs_¶©_»£t_deviû
(
ùs_d©a
->
pd©a
);

265 ià(
»t
 < 0) {

266 
	`ùs_”r
("Re£ˆdeviû faed %d", 
»t
);

267 
”r_ä“_»sourû
;

270 
»t
 = 
	`ùs_´obe_deviû
(&
ùs_d©a
->
ùs_dev
);

271 ià(
»t
) {

272 
	`ùs_”r
("Probdeviû faed %d", 
»t
);

273 
”r_ä“_»sourû
;

276 
»t
 = 
	`ùs_¶©_š™_touch_deviû
(
ùs_d©a
->
pd©a
);

277 ià(
»t
 < 0) {

278 
	`ùs_”r
("In™ouch deviû faed %d", 
»t
);

279 
”r_ä“_»sourû
;

282 
»t
 = 
	`ùs_¶©_š™_vkey_deviû
(
ùs_d©a
->
pd©a
);

283 ià(
»t
 < 0) {

284 
	`ùs_”r
("In™ vkey deviû faed %d", 
»t
);

285 
”r_deš™_touch_deviû
;

288 
»t
 = 
	`ùs_¶©_š™_ge¡u»
(
ùs_d©a
->
pd©a
);

289 ià(
»t
 < 0) {

290 
	`ùs_”r
("In™ ge¡u» faed %d", 
»t
);

291 
”r_deš™_vkey_deviû
;

294 
	`ùs_š™_esd_´ÙeùiÚ
(
ùs_d©a
);

296 
»t
 = 
	`ùs_toŞ_š™
(
ùs_d©a
);

297 ià(
»t
 < 0) {

298 
	`ùs_w¬n
("In™oŞ‚odçed %d", 
»t
);

301 
»t
 = 
	`ùs_sysfs_add_deviû
(&
ş›Á
->
dev
);

302 ià(
»t
 < 0) {

303 
	`ùs_w¬n
("Add sysf ’Œy fÜ deviû faed %d", 
»t
);

306 #ifdeà
CONFIG_CTS_PM_FB_NOTIFIER


307 
»t
 = 
	`ùs_š™_pm_fb_nÙif›r
(
ùs_d©a
);

308 ià(
»t
) {

309 
	`ùs_”r
("In™ FB‚Ùif›¸çed %d", 
»t
);

310 
”r_deš™_sysfs
;

314 
»t
 = 
	`ùs_¶©_»que¡_œq
(
ùs_d©a
->
pd©a
);

315 ià(
»t
 < 0) {

316 
	`ùs_”r
("Reque¡ IRQ faed %d", 
»t
);

317 
”r_»gi¡”_fb
;

320 
»t
 = 
	`ùs_š™_ch¬g”_d‘eù
(
ùs_d©a
);

321 ià(
»t
) {

322 
	`ùs_”r
("In™ ch¬g” d‘eù faed %d", 
»t
);

326 
»t
 = 
	`ùs_š™_—rjack_d‘eù
(
ùs_d©a
);

327 ià(
»t
) {

328 
	`ùs_”r
("In™ƒ¬jack d‘eù faed %d", 
»t
);

332 
»t
 = 
	`ùs_¡¬t_deviû
(&
ùs_d©a
->
ùs_dev
);

333 ià(
»t
) {

334 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

335 
”r_deš™_—rjack_d‘eù
;

340 
”r_deš™_—rjack_d‘eù
:

341 
	`ùs_deš™_—rjack_d‘eù
(
ùs_d©a
);

342 
	`ùs_deš™_ch¬g”_d‘eù
(
ùs_d©a
);

343 
	`ùs_¶©_ä“_œq
(
ùs_d©a
->
pd©a
);

345 
”r_»gi¡”_fb
:

346 #ifdeà
CONFIG_CTS_PM_FB_NOTIFIER


347 
	`ùs_deš™_pm_fb_nÙif›r
(
ùs_d©a
);

348 
”r_deš™_sysfs
:

350 
	`ùs_sysfs_»move_deviû
(&
ş›Á
->
dev
);

351 #ifdeà
CONFIG_CTS_LEGACY_TOOL


352 
	`ùs_toŞ_deš™
(
ùs_d©a
);

355 #ifdeà
CONFIG_CTS_ESD_PROTECTION


356 
	`ùs_deš™_esd_´ÙeùiÚ
(
ùs_d©a
);

359 #ifdeà
CFG_CTS_GESTURE


360 
	`ùs_¶©_deš™_ge¡u»
(
ùs_d©a
->
pd©a
);

363 
”r_deš™_vkey_deviû
:

364 #ifdeà
CONFIG_CTS_VIRTUALKEY


365 
	`ùs_¶©_deš™_vkey_deviû
(
ùs_d©a
->
pd©a
);

368 
”r_deš™_touch_deviû
:

369 
	`ùs_¶©_deš™_touch_deviû
(
ùs_d©a
->
pd©a
);

371 
”r_ä“_»sourû
:

372 
	`ùs_¶©_ä“_»sourû
(
ùs_d©a
->
pd©a
);

373 
”r_de¡roy_esd_wÜkqueue
:

374 #ifdeà
CONFIG_CTS_ESD_PROTECTION


375 
	`de¡roy_wÜkqueue
(
ùs_d©a
->
esd_wÜkqueue
);

376 
”r_de¡roy_wÜkqueue
:

378 
	`de¡roy_wÜkqueue
(
ùs_d©a
->
wÜkqueue
);

379 
”r_deš™_¶©fÜm_d©a
:

380 
	`ùs_deš™_¶©fÜm_d©a
(
ùs_d©a
->
pd©a
);

382 
	`kä“
(
ùs_d©a
->
pd©a
);

383 
”r_ä“_ùs_d©a
:

384 
	`kä“
(
ùs_d©a
);

386 
	`ùs_”r
("Probçed %d", 
»t
);

388  
»t
;

389 
	}
}

391 #ifdeà
CONFIG_CTS_I2C_HOST


392 
	$ùs_driv”_»move
(
i2c_ş›Á
 *
ş›Á
)

394 
	$ùs_driv”_»move
(
¥i_deviû
 *
ş›Á
)

397 
chÚe_ts_d©a
 *
ùs_d©a
;

398 
»t
 = 0;

400 
	`ùs_šfo
("Remove");

402 #ifdeà
CONFIG_CTS_I2C_HOST


403 
ùs_d©a
 = (
chÚe_ts_d©a
 *)
	`i2c_g‘_ş›Ád©a
(
ş›Á
);

405 
ùs_d©a
 = (
chÚe_ts_d©a
 *)
	`¥i_g‘_drvd©a
(
ş›Á
);

407 ià(
ùs_d©a
) {

408 
»t
 = 
	`ùs_¡İ_deviû
(&
ùs_d©a
->
ùs_dev
);

409 ià(
»t
) {

410 
	`ùs_w¬n
("Stİ deviû faed %d", 
»t
);

413 
	`ùs_deš™_ch¬g”_d‘eù
(
ùs_d©a
);

414 
	`ùs_deš™_—rjack_d‘eù
(
ùs_d©a
);

416 
	`ùs_¶©_ä“_œq
(
ùs_d©a
->
pd©a
);

418 #ifdeà
CONFIG_CTS_PM_FB_NOTIFIER


419 
	`ùs_deš™_pm_fb_nÙif›r
(
ùs_d©a
);

422 
	`ùs_toŞ_deš™
(
ùs_d©a
);

424 
	`ùs_sysfs_»move_deviû
(&
ş›Á
->
dev
);

426 
	`ùs_deš™_esd_´ÙeùiÚ
(
ùs_d©a
);

428 
	`ùs_¶©_deš™_touch_deviû
(
ùs_d©a
->
pd©a
);

430 
	`ùs_¶©_deš™_vkey_deviû
(
ùs_d©a
->
pd©a
);

432 
	`ùs_¶©_deš™_ge¡u»
(
ùs_d©a
->
pd©a
);

434 
	`ùs_¶©_ä“_»sourû
(
ùs_d©a
->
pd©a
);

436 #ifdeà
CONFIG_CTS_ESD_PROTECTION


437 ià(
ùs_d©a
->
esd_wÜkqueue
) {

438 
	`de¡roy_wÜkqueue
(
ùs_d©a
->
esd_wÜkqueue
);

442 ià(
ùs_d©a
->
wÜkqueue
) {

443 
	`de¡roy_wÜkqueue
(
ùs_d©a
->
wÜkqueue
);

446 
	`ùs_deš™_¶©fÜm_d©a
(
ùs_d©a
->
pd©a
);

448 ià(
ùs_d©a
->
pd©a
) {

449 
	`kä“
(
ùs_d©a
->
pd©a
);

451 
	`kä“
(
ùs_d©a
);

453 
	`ùs_w¬n
("Chipone i2c driver„emove while NULL chipone_ts_data");

454  -
EINVAL
;

457  
»t
;

458 
	}
}

460 #ifdeà
CONFIG_CTS_PM_LEGACY


461 
	$ùs_i2c_driv”_su¥’d
(
deviû
 *
dev
, 
pm_mes§ge_t
 
¡©e
)

463 
	`ùs_šfo
("Suspend by†egacy…ower management");

464  
	`ùs_su¥’d
(
	`dev_g‘_drvd©a
(
dev
));

465 
	}
}

467 
	$ùs_i2c_driv”_»sume
(
deviû
 *
dev
)

469 
	`ùs_šfo
("Resume by†egacy…ower management");

470  
	`ùs_»sume
(
	`dev_g‘_drvd©a
(
dev
));

471 
	}
}

474 #ifdeà
CONFIG_CTS_PM_GENERIC


475 
	$ùs_i2c_driv”_pm_su¥’d
(
deviû
 *
dev
)

477 
	`ùs_šfo
("Suspend by bus…ower management");

478  
	`ùs_su¥’d
(
	`dev_g‘_drvd©a
(
dev
));

479 
	}
}

481 
	$ùs_i2c_driv”_pm_»sume
(
deviû
 *
dev
)

483 
	`ùs_šfo
("Resume by bus…ower management");

484  
	`ùs_»sume
(
	`dev_g‘_drvd©a
(
dev
));

485 
	}
}

488 cÚ¡ 
dev_pm_İs
 
	gùs_i2c_driv”_pm_İs
 = {

489 .
su¥’d
 = 
ùs_i2c_driv”_pm_su¥’d
,

490 .
	g»sume
 = 
ùs_i2c_driv”_pm_»sume
,

494 #ifdeà
CONFIG_CTS_SYSFS


495 
ssize_t
 
	$»£t_pš_show
(
deviû_driv”
 *
driv”
, *
buf
)

497  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_HAS_RESET_PIN: %c\n",

498 #ifdeà
CFG_CTS_HAS_RESET_PIN


504 
	}
}

505 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

506 
DRIVER_ATTR
(
»£t_pš
, 
S_IRUGO
, 
»£t_pš_show
, 
NULL
);

508 
DRIVER_ATTR_RO
(
»£t_pš
);

511 
ssize_t
 
	$sw­_xy_show
(
deviû_driv”
 *
dev
, *
buf
)

513  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_SWAP_XY: %c\n",

514 #ifdeà
CFG_CTS_SWAP_XY


520 
	}
}

521 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

522 
DRIVER_ATTR
(
sw­_xy
, 
S_IRUGO
, 
sw­_xy_show
, 
NULL
);

524 
DRIVER_ATTR_RO
(
sw­_xy
);

527 
ssize_t
 
	$w¿p_x_show
(
deviû_driv”
 *
dev
, *
buf
)

529  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_WRAP_X: %c\n",

530 #ifdeà
CFG_CTS_WRAP_X


536 
	}
}

537 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

538 
DRIVER_ATTR
(
w¿p_x
, 
S_IRUGO
, 
w¿p_x_show
, 
NULL
);

540 
DRIVER_ATTR_RO
(
w¿p_x
);

543 
ssize_t
 
	$w¿p_y_show
(
deviû_driv”
 *
dev
, *
buf
)

545  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_WRAP_Y: %c\n",

546 #ifdeà
CFG_CTS_WRAP_Y


552 
	}
}

553 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

554 
DRIVER_ATTR
(
w¿p_y
, 
S_IRUGO
, 
w¿p_y_show
, 
NULL
);

556 
DRIVER_ATTR_RO
(
w¿p_y
);

559 
ssize_t
 
	$fÜû_upd©e_show
(
deviû_driv”
 *
dev
, *
buf
)

561  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_HAS_RESET_PIN: %c\n",

562 #ifdeà
CFG_CTS_FIRMWARE_FORCE_UPDATE


568 
	}
}

569 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

570 
DRIVER_ATTR
(
fÜû_upd©e
, 
S_IRUGO
, 
fÜû_upd©e_show
, 
NULL
);

572 
DRIVER_ATTR_RO
(
fÜû_upd©e
);

575 
ssize_t
 
	$max_touch_num_show
(
deviû_driv”
 *
dev
, *
buf
)

577  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_MAX_TOUCH_NUM: %d\n",

578 
CFG_CTS_MAX_TOUCH_NUM
);

579 
	}
}

580 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

581 
DRIVER_ATTR
(
max_touch_num
, 
S_IRUGO
, 
max_touch_num_show
, 
NULL
);

583 
DRIVER_ATTR_RO
(
max_touch_num
);

586 
ssize_t
 
	$vkey_show
(
deviû_driv”
 *
dev
, *
buf
)

588  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CONFIG_CTS_VIRTUALKEY: %c\n",

589 #ifdeà
CONFIG_CTS_VIRTUALKEY


595 
	}
}

596 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

597 
DRIVER_ATTR
(
vkey
, 
S_IRUGO
, 
vkey_show
, 
NULL
);

599 
DRIVER_ATTR_RO
(
vkey
);

602 
ssize_t
 
	$ge¡u»_show
(
deviû_driv”
 *
dev
, *
buf
)

604  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_GESTURE: %c\n",

605 #ifdeà
CFG_CTS_GESTURE


611 
	}
}

612 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

613 
DRIVER_ATTR
(
ge¡u»
, 
S_IRUGO
, 
ge¡u»_show
, 
NULL
);

615 
DRIVER_ATTR_RO
(
ge¡u»
);

618 
ssize_t
 
	$esd_´ÙeùiÚ_show
(
deviû_driv”
 *
dev
, *
buf
)

620  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CONFIG_CTS_ESD_PROTECTION: %c\n",

621 #ifdeà
CONFIG_CTS_ESD_PROTECTION


627 
	}
}

628 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

629 
DRIVER_ATTR
(
esd_´ÙeùiÚ
, 
S_IRUGO
, 
esd_´ÙeùiÚ_show
, 
NULL
);

631 
DRIVER_ATTR_RO
(
esd_´ÙeùiÚ
);

634 
ssize_t
 
	$¦Ù_´ÙocŞ_show
(
deviû_driv”
 *
dev
, *
buf
)

636  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CONFIG_CTS_SLOTPROTOCOL: %c\n",

637 #ifdeà
CONFIG_CTS_SLOTPROTOCOL


643 
	}
}

644 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

645 
DRIVER_ATTR
(
¦Ù_´ÙocŞ
, 
S_IRUGO
, 
¦Ù_´ÙocŞ_show
, 
NULL
);

647 
DRIVER_ATTR_RO
(
¦Ù_´ÙocŞ
);

650 
ssize_t
 
	$max_xãr_size_show
(
deviû_driv”
 *
dev
, *
buf
)

652 #ifdeà
CONFIG_CTS_I2C_HOST


653  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_MAX_I2C_XFER_SIZE: %d\n",

654 
CFG_CTS_MAX_I2C_XFER_SIZE
);

656  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "CFG_CTS_MAX_SPI_XFER_SIZE: %d\n",

657 
CFG_CTS_MAX_SPI_XFER_SIZE
);

659 
	}
}

660 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

661 
DRIVER_ATTR
(
max_xãr_size
, 
S_IRUGO
, 
max_xãr_size_show
, 
NULL
);

663 
DRIVER_ATTR_RO
(
max_xãr_size
);

666 
ssize_t
 
	$driv”_šfo_show
(
deviû_driv”
 *
dev
, *
buf
)

668  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Driv” v”siÚ: %s\n", 
CFG_CTS_DRIVER_VERSION
);

669 
	}
}

670 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4,14,0)

671 
DRIVER_ATTR
(
driv”_šfo
, 
S_IRUGO
, 
driv”_šfo_show
, 
NULL
);

673 
DRIVER_ATTR_RO
(
driv”_šfo
);

676 
©Œibu‹
 *
	gùs_i2c_driv”_cÚfig_©Œs
[] = {

677 &
driv”_©Œ_»£t_pš
.
©Œ
,

678 &
driv”_©Œ_sw­_xy
.
©Œ
,

679 &
driv”_©Œ_w¿p_x
.
©Œ
,

680 &
driv”_©Œ_w¿p_y
.
©Œ
,

681 &
driv”_©Œ_fÜû_upd©e
.
©Œ
,

682 &
driv”_©Œ_max_touch_num
.
©Œ
,

683 &
driv”_©Œ_vkey
.
©Œ
,

684 &
driv”_©Œ_ge¡u»
.
©Œ
,

685 &
driv”_©Œ_esd_´ÙeùiÚ
.
©Œ
,

686 &
driv”_©Œ_¦Ù_´ÙocŞ
.
©Œ
,

687 &
driv”_©Œ_max_xãr_size
.
©Œ
,

688 &
driv”_©Œ_driv”_šfo
.
©Œ
,

689 
NULL


692 cÚ¡ 
©Œibu‹_group
 
	gùs_i2c_driv”_cÚfig_group
 = {

693 .
Çme
 = "config",

694 .
	g©Œs
 = 
ùs_i2c_driv”_cÚfig_©Œs
,

697 cÚ¡ 
©Œibu‹_group
 *
	gùs_i2c_driv”_cÚfig_groups
[] = {

698 &
ùs_i2c_driv”_cÚfig_group
,

699 
NULL
,

703 #ifdeà
CONFIG_CTS_OF


704 cÚ¡ 
of_deviû_id
 
	gùs_i2c_of_m©ch_bË
[] = {

705 {.
com·tibË
 = 
CFG_CTS_OF_DEVICE_ID_NAME
,},

708 
MODULE_DEVICE_TABLE
(
of
, 
ùs_i2c_of_m©ch_bË
);

711 #ifdeà
CONFIG_CTS_I2C_HOST


712 cÚ¡ 
i2c_deviû_id
 
	gùs_deviû_id_bË
[] = {

713 {
CFG_CTS_DEVICE_NAME
, 0},

717 cÚ¡ 
¥i_deviû_id
 
	gùs_deviû_id_bË
[] = {

718 {
CFG_CTS_DEVICE_NAME
, 0},

723 #ifdeà
CONFIG_CTS_I2C_HOST


724 
i2c_driv”
 
	gùs_i2c_driv”
 = {

726 
¥i_driv”
 
ùs_¥i_driv”
 = {

728 .
´obe
 = 
ùs_driv”_´obe
,

729 .
	g»move
 = 
ùs_driv”_»move
,

730 .
	gdriv”
 = {

731 .
Çme
 = 
CFG_CTS_DRIVER_NAME
,

732 .
	gowÃr
 = 
THIS_MODULE
,

733 #ifdeà
CONFIG_CTS_OF


734 .
	gof_m©ch_bË
 = 
of_m©ch_±r
(
ùs_i2c_of_m©ch_bË
),

736 #ifdeà
CONFIG_CTS_SYSFS


737 .
	ggroups
 = 
ùs_i2c_driv”_cÚfig_groups
,

739 #ifdeà
CONFIG_CTS_PM_LEGACY


740 .
	gsu¥’d
 = 
ùs_i2c_driv”_su¥’d
,

741 .
	g»sume
 = 
ùs_i2c_driv”_»sume
,

743 #ifdeà
CONFIG_CTS_PM_GENERIC


744 .
	gpm
 = &
ùs_i2c_driv”_pm_İs
,

748 .
	gid_bË
 = 
ùs_deviû_id_bË
,

751 
__š™
 
	$ùs_driv”_š™
()

753 
»t
 = 0;

755 
	`ùs_šfo
("Init");

757 #ifdeà
CONFIG_CTS_I2C_HOST


758 
»t
 = 
	`i2c_add_driv”
(&
ùs_i2c_driv”
);

760 
»t
 = 
	`¥i_»gi¡”_driv”
(&
ùs_¥i_driv”
);

763 
	`ùs_šfo
("In™„‘uº "
CTS_ERR_FMT_STR
, 
	`CTS_ERR_ARG
(
»t
));

765  
»t
;

766 
	}
}

769 
__ex™
 
	$ùs_driv”_ex™
()

771 
	`ùs_šfo
("Exit");

773 #ifdeà
CONFIG_CTS_I2C_HOST


774 
	`i2c_d–_driv”
(&
ùs_i2c_driv”
);

776 
	`¥i_uÄegi¡”_driv”
(&
ùs_¥i_driv”
);

778 
	}
}

780 
moduË_š™
(
ùs_driv”_š™
);

781 
moduË_ex™
(
ùs_driv”_ex™
);

783 
MODULE_DESCRIPTION
("Chipone TDDIouchscreen Driver for QualComm…latform");

784 
MODULE_VERSION
(
CFG_CTS_DRIVER_VERSION
);

785 
MODULE_AUTHOR
("Miao Defang <dfmiao@chiponeic.com>");

786 
MODULE_LICENSE
("GPL");

	@cts_plat_qcom_config.h

1 #iâdeà
CTS_PLAT_QCOM_CONFIG_H


2 
	#CTS_PLAT_QCOM_CONFIG_H


	)

4 
	#CONFIG_CTS_PM_FB_NOTIFIER


	)

6 #ifdeà
CONFIG_CTS_PM_FB_NOTIFIER


7 #ifdeà
CONFIG_DRM_MSM


8 
	#CFG_CTS_DRM_NOTIFIER


	)

11 #ià
defšed
(
CONFIG_PM_SLEEP
è&& defšed(
CONFIG_PM_SUSPEND
)

15 #ià!
defšed
(
CONFIG_CTS_PM_GENERIC
)

16 
	#CONFIG_CTS_PM_LEGACY


	)

20 
	#CFG_CTS_MAX_I2C_XFER_SIZE
 (48u)

	)

21 
	#CFG_CTS_MAX_SPI_XFER_SIZE
 (1400u)

	)

23 
	#CTS_FW_LOG_REDIRECT_SIGN
 0x60

	)

24 
	#CTS_FW_LOG_BUF_LEN
 128

	)

30 
	#CFG_CTS_DEVICE_NAME
 "chÚe-tddi"

	)

31 
	#CFG_CTS_DRIVER_NAME
 "chÚe-tddi"

	)

33 #ià
CFG_CTS_MAX_I2C_XFER_SIZE
 < 8

37 #ifdeà
CONFIG_OF


38 
	#CONFIG_CTS_OF


	)

40 #ifdeà
CONFIG_CTS_OF


41 
	#CFG_CTS_OF_DEVICE_ID_NAME
 "chÚe-tddi"

	)

43 
	#CFG_CTS_OF_INT_GPIO_NAME
 "chÚe,œq-gpio"

	)

44 
	#CFG_CTS_OF_RST_GPIO_NAME
 "chÚe,r¡-gpio"

	)

45 
	#CFG_CTS_OF_X_RESOLUTION_NAME
 "chÚe,x-»s"

	)

46 
	#CFG_CTS_OF_Y_RESOLUTION_NAME
 "chÚe,y-»s"

	)

	@cts_platform.c

1 
	#LOG_TAG
 "PÏt"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_fœmw¬e.h
"

8 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


9 
size_t
 
	$ùs_¶©_g‘_max_fw_log_size
(
ùs_¶©fÜm_d©a
 *
pd©a
)

11  
CTS_FW_LOG_BUF_LEN
;

12 
	}
}

14 
u8
 *
	$ùs_¶©_g‘_fw_log_buf
(
ùs_¶©fÜm_d©a
 *
pd©a
,

15 
size_t
 
size
)

17  
pd©a
->
fw_log_buf
;

18 
	}
}

21 
size_t
 
	$ùs_¶©_g‘_max_i2c_xãr_size
(
ùs_¶©fÜm_d©a
 *
pd©a
)

23  
CFG_CTS_MAX_I2C_XFER_SIZE
;

24 
	}
}

26 #ifdeà
CONFIG_CTS_I2C_HOST


27 
u8
 *
	$ùs_¶©_g‘_i2c_xãr_buf
(
ùs_¶©fÜm_d©a
 *
pd©a
,

28 
size_t
 
xãr_size
)

30  
pd©a
->
i2c_fifo_buf
;

31 
	}
}

33 
	$ùs_¶©_i2c_wr™e
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
,

34 cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

36 
»t
 = 0, 
»Œ›s
 = 0;

38 
i2c_msg
 
msg
 = {

39 .
æags
 = 0,

40 .
addr
 = 
i2c_addr
,

41 .
buf
 = (
u8
 *)
¤c
,

42 .
Ën
 =†en,

46 
»t
 = 
	`i2c_Œªsãr
(
pd©a
->
i2c_ş›Á
->
ad­‹r
, &
msg
, 1);

47 ià(
»t
 != 1) {

48 ià(
»t
 >= 0) {

49 
»t
 = -
EIO
;

52 ià(
d–ay
) {

53 
	`md–ay
(
d–ay
);

59 } ++
»Œ›s
 < 
»Œy
);

61  
»t
;

62 
	}
}

64 
	$ùs_¶©_i2c_»ad
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
,

65 cÚ¡ 
u8
 *
wbuf
, 
size_t
 
wËn
, *
rbuf
, size_ˆ
¾’
,

66 
»Œy
, 
d–ay
)

68 
num_msg
, 
»t
 = 0, 
»Œ›s
 = 0;

70 
i2c_msg
 
msgs
[2] = {

72 .
addr
 = 
i2c_addr
,

73 .
æags
 = 0,

74 .
buf
 = (
u8
 *)
wbuf
,

75 .
Ën
 = 
wËn


78 .
addr
 = 
i2c_addr
,

79 .
æags
 = 
I2C_M_RD
,

80 .
buf
 = (
u8
 *)
rbuf
,

81 .
Ën
 = 
¾’


85 ià(
wbuf
 =ğ
NULL
 || 
wËn
 == 0) {

86 
num_msg
 = 1;

88 
num_msg
 = 2;

92 
»t
 = 
	`i2c_Œªsãr
(
pd©a
->
i2c_ş›Á
->
ad­‹r
,

93 
msgs
 + 
	`ARRAY_SIZE
(msgsè- 
num_msg
,‚um_msg);

95 ià(
»t
 !ğ
num_msg
) {

96 ià(
»t
 >= 0) {

97 
»t
 = -
EIO
;

100 ià(
d–ay
) {

101 
	`md–ay
(
d–ay
);

107 } ++
»Œ›s
 < 
»Œy
);

109  
»t
;

110 
	}
}

112 
	$ùs_¶©_is_i2c_Úlše
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
)

114 
u8
 
dummy_by‹s
[2] = {0x00, 0x00};

115 
»t
;

117 
»t
 = 
	`ùs_¶©_i2c_wr™e
(
pd©a
, 
i2c_addr
, 
dummy_by‹s
, (dummy_bytes), 5, 2);

118 ià(
»t
) {

119 
	`ùs_”r
("!!! I2C‡dd¸0x%02x i ofæš!!!", 
i2c_addr
);

120  
çl£
;

122 
	`ùs_dbg
("I2C‡dd¸0x%02x i Úlše", 
i2c_addr
);

123  
Œue
;

125 
	}
}

127 
	$ùs_¥i_£nd_»cv
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
size_t
 
Ën
 , 
u8
 *
tx_bufãr
, u8 *
rx_bufãr
)

129 
u16
 
¥“d
;

131 
chÚe_ts_d©a
 *
ùs_d©a
;

132 
¥i_mes§ge
 
msg
;

133 
¥i_Œªsãr
 
cmd
 = {

134 .
cs_chªge
 = 0,

135 .
d–ay_u£cs
 = 0,

137 .
¥“d_hz
 = 
¥“d
 * 1000u,

138 .
tx_buf
 = 
tx_bufãr
,

139 .
rx_buf
 = 
rx_bufãr
,

140 .
Ën
 =†en,

143 .
b™s_³r_wÜd
 = 8,

145 
»t
 = 0;

146 
ùs_d©a
 = 
	`cÚš”_of
(
pd©a
->
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

147 #ifdeà
CFG_CTS_MANUAL_CS


148 
	`ùs_¶©_£t_cs
(
pd©a
, 0);

150 
	`¥i_mes§ge_š™
(&
msg
);

151 
	`¥i_mes§ge_add_
(&
cmd
, &
msg
);

152 
»t
 = 
	`¥i_sync
(
ùs_d©a
->
¥i_ş›Á
, &
msg
);

153 ià(
»t
) {

154 
	`ùs_”r
("¥˜synøçed %d", 
»t
);

156 #ifdeà
CFG_CTS_MANUAL_CS


157 
	`ùs_¶©_£t_cs
(
pd©a
, 1);

159  
»t
;

160 
	}
}

162 
size_t
 
	$ùs_¶©_g‘_max_¥i_xãr_size
(
ùs_¶©fÜm_d©a
 *
pd©a
)

164  
CFG_CTS_MAX_SPI_XFER_SIZE
;

165 
	}
}

167 
u8
 *
	$ùs_¶©_g‘_¥i_xãr_buf
(
ùs_¶©fÜm_d©a
 *
pd©a
,

168 
size_t
 
xãr_size
)

170  
pd©a
->
¥i_ÿche_buf
;

171 
	}
}

173 
	$ùs_¶©_¥i_wr™e
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
dev_addr
,

174 cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
)

176 
»t
 = 0, 
»Œ›s
 = 0;

177 
u16
 
üc
;

178 
size_t
 
d©a_Ën
;

180 ià(
Ën
 > 
CFG_CTS_MAX_SPI_XFER_SIZE
) {

181 
	`ùs_”r
("wr™toØmuch d©a:wËn=%zu\n", 
Ën
);

182  -
EIO
;

185 ià(
pd©a
->
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

186 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
;

187 
	`memıy
(&
pd©a
->
¥i_tx_buf
[1], 
¤c
, 
Ën
);

190 
»t
 = 
	`ùs_¥i_£nd_»cv
(
pd©a
, 
Ën
 + 1,…d©a->
¥i_tx_buf
,…d©a->
¥i_rx_buf
);

191 ià(
»t
) {

192 
	`ùs_”r
("SPI wr™çed %d", 
»t
);

193 ià(
d–ay
) {

194 
	`md–ay
(
d–ay
);

199 } ++
»Œ›s
 < 
»Œy
);

202 
d©a_Ën
 = 
Ën
 - 2;

203 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
;

204 
pd©a
->
¥i_tx_buf
[1] = *((
u8
 *)
¤c
 + 1);

205 
pd©a
->
¥i_tx_buf
[2] = *((
u8
 *)
¤c
);

206 
	`put_uÇligÃd_Ë16
(
d©a_Ën
, &
pd©a
->
¥i_tx_buf
[3]);

207 
üc
 = (
u16
)
	`üc32
(
pd©a
->
¥i_tx_buf
, 5);

208 
	`put_uÇligÃd_Ë16
(
üc
, &
pd©a
->
¥i_tx_buf
[5]);

209 
	`memıy
(&
pd©a
->
¥i_tx_buf
[7], (*)
¤c
 + 2, 
d©a_Ën
);

210 
üc
 = (
u16
)
	`üc32
((*)
¤c
 + 2, 
d©a_Ën
);

211 
	`put_uÇligÃd_Ë16
(
üc
, &
pd©a
->
¥i_tx_buf
[7+
d©a_Ën
]);

213 
»t
 = 
	`ùs_¥i_£nd_»cv
(
pd©a
, 
Ën
 + 7,…d©a->
¥i_tx_buf
,…d©a->
¥i_rx_buf
);

214 
	`ud–ay
(10 * 
d©a_Ën
);

215 ià(
»t
) {

216 
	`ùs_”r
("SPI wr™çed %d", 
»t
);

217 ià(
d–ay
) {

218 
	`md–ay
(
d–ay
);

223 } ++
»Œ›s
 < 
»Œy
);

225  
»t
;

226 
	}
}

228 
	$ùs_¶©_¥i_»ad
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
dev_addr
,

229 cÚ¡ 
u8
 *
wbuf
, 
size_t
 
wËn
, *
rbuf
, size_ˆ
¾’
,

230 
»Œy
, 
d–ay
)

232 
»t
 = 0, 
»Œ›s
 = 0;

233 
u16
 
üc
;

235 ià(
wËn
 > 
CFG_CTS_MAX_SPI_XFER_SIZE
 || 
¾’
 > CFG_CTS_MAX_SPI_XFER_SIZE) {

236 
	`ùs_”r
("wr™e/»adoØmuch d©a:wËn=%zd,„Ën=%zd", 
wËn
, 
¾’
);

237  -
EIO
;

240 ià(
pd©a
->
ùs_dev
->
¹d©a
.
´og¿m_mode
)

242 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
 | 0x01;

243 
	`memıy
(&
pd©a
->
¥i_tx_buf
[1], 
wbuf
, 
wËn
);

245 
»t
 = 
	`ùs_¥i_£nd_»cv
(
pd©a
, 
¾’
 + 5,…d©a->
¥i_tx_buf
,…d©a->
¥i_rx_buf
);

246 ià(
»t
) {

247 
	`ùs_”r
("SPI„—d faed %d", 
»t
);

248 ià(
d–ay
) {

249 
	`md–ay
(
d–ay
);

253 
	`memıy
(
rbuf
, 
pd©a
->
¥i_rx_buf
+5, 
¾’
);

255 } ++
»Œ›s
 < 
»Œy
);

258 ià(
wËn
 != 0) {

259 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
 | 0x01;

260 
pd©a
->
¥i_tx_buf
[1] = 
wbuf
[1];

261 
pd©a
->
¥i_tx_buf
[2] = 
wbuf
[0];

262 
	`put_uÇligÃd_Ë16
(
¾’
, &
pd©a
->
¥i_tx_buf
[3]);

263 
üc
 = (
u16
)
	`üc32
(
pd©a
->
¥i_tx_buf
, 5);

264 
	`put_uÇligÃd_Ë16
(
üc
, &
pd©a
->
¥i_tx_buf
[5]);

265 
»t
 = 
	`ùs_¥i_£nd_»cv
(
pd©a
, 7,…d©a->
¥i_tx_buf
,…d©a->
¥i_rx_buf
);

266 ià(
»t
) {

267 
	`ùs_”r
("SPI„—d faed %d", 
»t
);

268 ià(
d–ay
) {

269 
	`md–ay
(
d–ay
);

274 
	`mem£t
(
pd©a
->
¥i_tx_buf
, 0, 7);

275 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
 | 0x01;

276 
	`ud–ay
(100);

277 
»t
 =

278 
	`ùs_¥i_£nd_»cv
(
pd©a
, 
¾’
 + 2,

279 
pd©a
->
¥i_tx_buf
,

280 
pd©a
->
¥i_rx_buf
);

281 ià(
»t
) {

282 
	`ùs_”r
("SPI„—d faed %d", 
»t
);

283 ià(
d–ay
) {

284 
	`md–ay
(
d–ay
);

288 
	`memıy
(
rbuf
, 
pd©a
->
¥i_rx_buf
, 
¾’
);

289 
üc
 = (
u16
è
	`üc32
(
pd©a
->
¥i_rx_buf
, 
¾’
);

290 ià(
	`g‘_uÇligÃd_Ë16
(&
pd©a
->
¥i_rx_buf
[
¾’
]è!ğ
üc
) {

291 
	`ùs_”r
("SPI RX CRCƒrror:„x_crc %04x != %04x",

292 
	`g‘_uÇligÃd_Ë16
(&
pd©a
->
¥i_rx_buf
[
¾’
]), 
üc
);

296 } ++
»Œ›s
 < 
»Œy
);

298 ià(
»Œ›s
 >ğ
»Œy
) {

299 
	`ùs_”r
("SPI„eadoo much„etry");

302  -
EIO
;

303 
	}
}

305 
	$ùs_¶©_¥i_»ad_d–ay_idË
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
dev_addr
,

306 cÚ¡ 
u8
 *
wbuf
, 
size_t
 
wËn
, *
rbuf
,

307 
size_t
 
¾’
, 
»Œy
, 
d–ay
, 
idË
)

309 
»t
 = 0, 
»Œ›s
 = 0;

310 
u16
 
üc
;

312 ià(
wËn
 > 
CFG_CTS_MAX_SPI_XFER_SIZE
 ||

313 
¾’
 > 
CFG_CTS_MAX_SPI_XFER_SIZE
) {

314 
	`ùs_”r
("wr™e/»adoØmuch d©a:wËn=%zu,„Ën=%zu", 
wËn
,

315 
¾’
);

316  -
E2BIG
;

319 ià(
pd©a
->
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

320 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
 | 0x01;

321 
	`memıy
(&
pd©a
->
¥i_tx_buf
[1], 
wbuf
, 
wËn
);

323 
»t
 =

324 
	`ùs_¥i_£nd_»cv
(
pd©a
, 
¾’
 + 5,

325 
pd©a
->
¥i_tx_buf
,

326 
pd©a
->
¥i_rx_buf
);

327 ià(
»t
) {

328 
	`ùs_”r
("SPI„—d faed %d", 
»t
);

329 ià(
d–ay
) {

330 
	`md–ay
(
d–ay
);

334 
	`memıy
(
rbuf
, 
pd©a
->
¥i_rx_buf
 + 5, 
¾’
);

336 } ++
»Œ›s
 < 
»Œy
);

339 ià(
wËn
 != 0) {

340 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
 | 0x01;

341 
pd©a
->
¥i_tx_buf
[1] = 
wbuf
[1];

342 
pd©a
->
¥i_tx_buf
[2] = 
wbuf
[0];

343 
	`put_uÇligÃd_Ë16
(
¾’
, &
pd©a
->
¥i_tx_buf
[3]);

344 
üc
 = (
u16
è
	`üc32
(
pd©a
->
¥i_tx_buf
, 5);

345 
	`put_uÇligÃd_Ë16
(
üc
, &
pd©a
->
¥i_tx_buf
[5]);

346 
»t
 =

347 
	`ùs_¥i_£nd_»cv
(
pd©a
, 7,

348 
pd©a
->
¥i_tx_buf
,

349 
pd©a
->
¥i_rx_buf
);

350 ià(
»t
) {

351 
	`ùs_”r
("SPI„—d faed %d", 
»t
);

352 ià(
d–ay
) {

353 
	`md–ay
(
d–ay
);

358 
	`mem£t
(
pd©a
->
¥i_tx_buf
, 0, 7);

359 
pd©a
->
¥i_tx_buf
[0] = 
dev_addr
 | 0x01;

360 
	`ud–ay
(
idË
);

361 
»t
 =

362 
	`ùs_¥i_£nd_»cv
(
pd©a
, 
¾’
 + 2,

363 
pd©a
->
¥i_tx_buf
,

364 
pd©a
->
¥i_rx_buf
);

365 ià(
»t
) {

366 ià(
d–ay
) {

367 
	`md–ay
(
d–ay
);

371 
	`memıy
(
rbuf
, 
pd©a
->
¥i_rx_buf
, 
¾’
);

372 
üc
 = (
u16
)
	`üc32
(
pd©a
->
¥i_rx_buf
, 
¾’
);

373 ià(
	`g‘_uÇligÃd_Ë16
(&
pd©a
->
¥i_rx_buf
[
¾’
]è!ğ
üc
) {

377 } ++
»Œ›s
 < 
»Œy
);

379 ià(
»Œ›s
 >ğ
»Œy
) {

380 
	`ùs_”r
("cts_plat_spi_readƒrror");

383  -
EIO
;

384 
	}
}

386 
	$ùs_¶©_is_nÜm®_mode
(
ùs_¶©fÜm_d©a
 *
pd©a
)

388 
chÚe_ts_d©a
 *
ùs_d©a
;

389 
u8
 
tx_buf
[4] = {0};

390 
u16
 
fwid
;

391 
u32
 
addr
;

392 
»t
;

394 
	`ùs_£t_nÜm®_addr
(
pd©a
->
ùs_dev
);

395 
ùs_d©a
 = 
	`cÚš”_of
(
pd©a
->
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

396 
addr
 = 
CTS_DEVICE_FW_REG_CHIP_TYPE
;

397 
	`put_uÇligÃd_be16
(
addr
, 
tx_buf
);

398 
»t
 = 
	`ùs_¶©_¥i_»ad
(
pd©a
, 
CTS_DEV_NORMAL_MODE_SPIADDR
, 
tx_buf
, 2, &
fwid
, 2, 3, 10);

399 
fwid
 = 
	`be16_to_ıu
(fwid);

400 ià(
»t
 || !
	`ùs_is_fwid_v®id
(
fwid
)) {

401  
çl£
;

404  
Œue
;

405 
	}
}

408 
	$ùs_¶©_hªdË_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
)

410 
»t
;

412 
	`ùs_dbg
("Handle IRQ");

414 
	`ùs_lock_deviû
(
pd©a
->
ùs_dev
);

415 
»t
 = 
	`ùs_œq_hªdËr
(
pd©a
->
ùs_dev
);

416 ià(
»t
) {

417 
	`ùs_”r
("Deviû hªdË IRQ faed %d", 
»t
);

419 
	`ùs_uÆock_deviû
(
pd©a
->
ùs_dev
);

420 
	}
}

422 
œq»tuº_t
 
	$ùs_¶©_œq_hªdËr
(
œq
, *
dev_id
)

424 
ùs_¶©fÜm_d©a
 *
pd©a
;

425 #iâdeà
CONFIG_GENERIC_HARDIRQS


426 
chÚe_ts_d©a
 *
ùs_d©a
;

429 
	`ùs_dbg
("IRQ handler");

431 
pd©a
 = (
ùs_¶©fÜm_d©a
 *)
dev_id
;

432 ià(
pd©a
 =ğ
NULL
) {

433 
	`ùs_”r
("IRQ handler with NULL dev_id");

434  
IRQ_NONE
;

437 #ifdeà
CONFIG_GENERIC_HARDIRQS


438 
	`ùs_¶©_hªdË_œq
(
pd©a
);

440 
ùs_d©a
 = 
	`cÚš”_of
(
pd©a
->
ùs_dev
, 
chÚe_ts_d©a
, cts_dev);

442 ià(
	`queue_wÜk
(
ùs_d©a
->
wÜkqueue
, &
pd©a
->
ts_œq_wÜk
)) {

443 
	`ùs_dbg
("IRQ queue work");

444 
	`ùs_¶©_di§bË_œq
(
pd©a
);

446 
	`ùs_w¬n
("IRQ handler queue work failed‡s‡lready onhe queue");

450  
IRQ_HANDLED
;

451 
	}
}

453 #iâdeà
CONFIG_GENERIC_HARDIRQS


454 
	$ùs_¶©_touch_dev_œq_wÜk
(
wÜk_¡ruù
 *
wÜk
)

456 
ùs_¶©fÜm_d©a
 *
pd©a
 =

457 
	`cÚš”_of
(
wÜk
, 
ùs_¶©fÜm_d©a
, 
ts_œq_wÜk
);

459 
	`ùs_dbg
("IRQ work");

461 
	`ùs_¶©_hªdË_œq
(
pd©a
);

463 
	`ùs_¶©_’abË_œq
(
pd©a
);

464 
	}
}

467 #ifdeà
CONFIG_CTS_OF


468 
	$ùs_¶©_·r£_dt
(
ùs_¶©fÜm_d©a
 *
pd©a
,

469 
deviû_node
 *
dev_node
)

471 
»t
;

473 
	`ùs_šfo
("Parse deviceree");

475 
pd©a
->
št_gpio
 = 
	`of_g‘_Çmed_gpio
(
dev_node
, 
CFG_CTS_OF_INT_GPIO_NAME
, 0);

476 ià(!
	`gpio_is_v®id
(
pd©a
->
št_gpio
)) {

477 
	`ùs_”r
("P¬£ INT GPIO from dˆçed %d", 
pd©a
->
št_gpio
);

478 
pd©a
->
št_gpio
 = -1;

480 
	`ùs_šfo
(" %-12s: %d", "šˆgpio", 
pd©a
->
št_gpio
);

482 
pd©a
->
œq
 = 
	`gpio_to_œq
Õd©a->
št_gpio
);

483 ià(
pd©a
->
œq
 < 0) {

484 
	`ùs_”r
("P¬£ irq faed %d", 
»t
);

485  
pd©a
->
œq
;

487 
	`ùs_šfo
(" %-12s: %d", "œq‚um", 
pd©a
->
œq
);

489 #ifdeà
CFG_CTS_HAS_RESET_PIN


490 
pd©a
->
r¡_gpio
 = 
	`of_g‘_Çmed_gpio
(
dev_node
, 
CFG_CTS_OF_RST_GPIO_NAME
, 0);

491 ià(!
	`gpio_is_v®id
(
pd©a
->
r¡_gpio
)) {

492 
	`ùs_”r
("P¬£ RST GPIO from dˆçed %d", 
pd©a
->
r¡_gpio
);

493 
pd©a
->
r¡_gpio
 = -1;

495 
	`ùs_šfo
(" %-12s: %d", "r¡ gpio", 
pd©a
->
r¡_gpio
);

498 
»t
 = 
	`of_´İ”ty_»ad_u32
(
dev_node
, 
CFG_CTS_OF_X_RESOLUTION_NAME
,

499 &
pd©a
->
»s_x
);

500 ià(
»t
) {

501 
	`ùs_w¬n
("P¬£ X„esŞutiÚ from dˆçed %d", 
»t
);

504 
	`ùs_šfo
(" %-12s: %d", "X„esŞutiÚ", 
pd©a
->
»s_x
);

506 
»t
 = 
	`of_´İ”ty_»ad_u32
(
dev_node
, 
CFG_CTS_OF_Y_RESOLUTION_NAME
,

507 &
pd©a
->
»s_y
);

508 ià(
»t
) {

509 
	`ùs_w¬n
("P¬£ Y„esŞutiÚ from dˆçed %d", 
»t
);

512 
	`ùs_šfo
(" %-12s: %d", "Y„esŞutiÚ", 
pd©a
->
»s_y
);

515 
	}
}

518 #ifdeà
CFG_CTS_FORCE_UP


519 
	$ùs_¶©_touch_ev’t_timeout
(
¬g
)

521 
	`ùs_w¬n
("Touchƒventimeout");

523 
	`ùs_¶©_»Ëa£_®l_touch
((
ùs_¶©fÜm_d©a
 *)
¬g
);

524 
	}
}

527 #ifdeà
CONFIG_CTS_I2C_HOST


528 
	$ùs_š™_¶©fÜm_d©a
(
ùs_¶©fÜm_d©a
 *
pd©a
,

529 
i2c_ş›Á
 *i2c_client)

531 
	$ùs_š™_¶©fÜm_d©a
(
ùs_¶©fÜm_d©a
 *
pd©a
,

532 
¥i_deviû
 *
¥i
)

536 
šput_dev
 *input_dev;

537 
»t
 = 0;

539 
	`ùs_šfo
("Init");

541 #ifdeà
CONFIG_CTS_OF


543 
deviû
 *
dev
;

545 #ifdeà
CONFIG_CTS_I2C_HOST


546 
dev
 = &
i2c_ş›Á
->dev;

548 
dev
 = &
¥i
->dev;

550 
»t
 = 
	`ùs_¶©_·r£_dt
(
pd©a
, 
dev
->
of_node
);

551 ià(
»t
) {

552 
	`ùs_”r
("P¬£ dˆçed %d", 
»t
);

553  
»t
;

558 #ifdeà
CONFIG_CTS_I2C_HOST


559 
pd©a
->
i2c_ş›Á
 = i2c_client;

560 
pd©a
->
i2c_ş›Á
->
œq
 =…data->irq;

562 
pd©a
->
¥i_ş›Á
 = 
¥i
;

563 
pd©a
->
¥i_ş›Á
->
œq
 =…data->irq;

565 
	`¹_mu‹x_š™
(&
pd©a
->
dev_lock
);

566 
	`¥š_lock_š™
(&
pd©a
->
œq_lock
);

568 
šput_dev
 = 
	`šput_®loÿ‹_deviû
();

569 ià(
šput_dev
 =ğ
NULL
) {

570 
	`ùs_”r
("Failedo‡llocate input device.");

571  -
ENOMEM
;

575 
šput_dev
->
Çme
 = 
CFG_CTS_DEVICE_NAME
;

576 
šput_dev
->
Çme
 = 
CFG_CTS_DEVICE_NAME
;

577 #ifdeà
CONFIG_CTS_I2C_HOST


578 
šput_dev
->
id
.
bu¡y³
 = 
BUS_I2C
;

579 
šput_dev
->
dev
.
·»Á
 = &
pd©a
->
i2c_ş›Á
->dev;

581 
šput_dev
->
id
.
bu¡y³
 = 
BUS_SPI
;

582 
šput_dev
->
dev
.
·»Á
 = &
pd©a
->
¥i_ş›Á
->dev;

584 
šput_dev
->
evb™
[0] = 
	`BIT_MASK
(
EV_SYN
) |

585 
	`BIT_MASK
(
EV_KEY
) |

586 
	`BIT_MASK
(
EV_ABS
);

587 #ifdeà
CFG_CTS_SWAP_XY


588 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_POSITION_X
,

589 0, 
pd©a
->
»s_y
, 0, 0);

590 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_POSITION_Y
,

591 0, 
pd©a
->
»s_x
, 0, 0);

593 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_POSITION_X
,

594 0, 
pd©a
->
»s_x
, 0, 0);

595 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_POSITION_Y
,

596 0, 
pd©a
->
»s_y
, 0, 0);

599 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_PRESSURE
, 0, 255, 0, 0);

600 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_TOUCH_MAJOR
,0, 255, 0, 0);

601 
	`šput_£t_abs_·¿ms
(
šput_dev
, 
ABS_MT_TRACKING_ID
,0, 
CFG_CTS_MAX_TOUCH_NUM
 * 2, 0, 0);

603 
	`šput_£t_ÿ·b™y
(
šput_dev
, 
EV_KEY
, 
BTN_TOUCH
);

605 #ifdeà
CONFIG_CTS_SLOTPROTOCOL


606 
	`šput_mt_š™_¦Ùs
(
šput_dev
, 
CFG_CTS_MAX_TOUCH_NUM
, 0);

608 
	`__£t_b™
(
INPUT_PROP_DIRECT
, 
šput_dev
->
´İb™
);

609 
	`__£t_b™
(
EV_ABS
, 
šput_dev
->
evb™
);

610 
	`šput_£t_drvd©a
(
šput_dev
, 
pd©a
);

611 
»t
 = 
	`šput_»gi¡”_deviû
(
šput_dev
);

612 ià(
»t
) {

613 
	`ùs_”r
("Failedo„egister input device");

614  
»t
;

617 
pd©a
->
ts_šput_dev
 = 
šput_dev
;

619 #ià!
	`defšed
(
CONFIG_GENERIC_HARDIRQS
)

620 
	`INIT_WORK
(&
pd©a
->
ts_œq_wÜk
, 
ùs_¶©_touch_dev_œq_wÜk
);

623 #ifdeà
CONFIG_CTS_VIRTUALKEY


625 
u8
 
vkey_keym­
[
CFG_CTS_NUM_VKEY
] = 
CFG_CTS_VKEY_KEYCODES
;

626 
	`memıy
(
pd©a
->
vkey_keycodes
, 
vkey_keym­
, (vkey_keymap));

627 
pd©a
->
vkey_num
 = 
CFG_CTS_NUM_VKEY
;

631 #ifdeà
CFG_CTS_GESTURE


633 
u8
 
ge¡u»_keym­
[
CFG_CTS_NUM_GESTURE
][2] = 
CFG_CTS_GESTURE_KEYMAP
;

634 
	`memıy
(
pd©a
->
ge¡u»_keym­
, gesture_keymap, (gesture_keymap));

635 
pd©a
->
ge¡u»_num
 = 
CFG_CTS_NUM_GESTURE
;

639 #ifdeà
CFG_CTS_FORCE_UP


640 
	`£tup_tim”
(&
pd©a
->
touch_ev’t_timeout_tim”
,

641 
ùs_¶©_touch_ev’t_timeout
, ()
pd©a
);

644 #iâdeà
CONFIG_CTS_I2C_HOST


645 
pd©a
->
¥i_¥“d
 = 
CFG_CTS_SPI_SPEED_KHZ
;

648 
	}
}

650 
	$ùs_deš™_¶©fÜm_d©a
(
ùs_¶©fÜm_d©a
 *
pd©a
)

652 
	`ùs_šfo
("De-Init…latform_data");

653 
	`šput_uÄegi¡”_deviû
(
pd©a
->
ts_šput_dev
);

655 
	}
}

657 
	$ùs_¶©_»que¡_»sourû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

659 
»t
;

661 
	`ùs_šfo
("Request„esource");

663 
»t
 = 
	`gpio_»que¡_Úe
(
pd©a
->
št_gpio
, 
GPIOF_IN
,

664 
CFG_CTS_DEVICE_NAME
 "-int");

665 ià(
»t
) {

666 
	`ùs_”r
("Reque¡ INT gpiØ(%dèçed %d", 
pd©a
->
št_gpio
, 
»t
);

667 
”r_out
;

670 #ifdeà
CFG_CTS_HAS_RESET_PIN


671 
»t
 = 
	`gpio_»que¡_Úe
(
pd©a
->
r¡_gpio
, 
GPIOF_OUT_INIT_HIGH
,

672 
CFG_CTS_DEVICE_NAME
 "-rst");

673 ià(
»t
) {

674 
	`ùs_”r
("Reque¡ RST gpiØ(%dèçed %d", 
pd©a
->
r¡_gpio
, 
»t
);

675 
”r_ä“_št
;

682 #ifdeà
CONFIG_CTS_REGULATOR


683 
”r_ä“_r¡
:

685 #ifdeà
CFG_CTS_HAS_RESET_PIN


686 
	`gpio_ä“
(
pd©a
->
r¡_gpio
);

687 
”r_ä“_št
:

689 
	`gpio_ä“
(
pd©a
->
št_gpio
);

690 
”r_out
:

691  
»t
;

692 
	}
}

694 
	$ùs_¶©_ä“_»sourû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

696 
	`ùs_šfo
("Free„esource");

698 ià(
	`gpio_is_v®id
(
pd©a
->
št_gpio
)) {

699 
	`gpio_ä“
(
pd©a
->
št_gpio
);

701 #ifdeà
CFG_CTS_HAS_RESET_PIN


702 ià(
	`gpio_is_v®id
(
pd©a
->
r¡_gpio
)) {

703 
	`gpio_ä“
(
pd©a
->
r¡_gpio
);

706 
	}
}

708 
	$ùs_¶©_»que¡_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
)

710 
»t
;

711 
ùs_deviû
 *
ùs_dev
 = 
pd©a
->cts_dev;

712 
ùs_deviû_fwd©a
 *
fwd©a
 = &
ùs_dev
->fwdata;

713 
u8
 
št_mode
;

715 
	`ùs_šfo
("Request IRQ");

716 
št_mode
 = 
fwd©a
->int_mode;

717 
	`ùs_šfo
("G‘ fw iÁ mode:%d,„eque¡ % IRQ", 
št_mode
,

718 
št_mode
==0?"falling" : "rising");

719 #ifdeà
CONFIG_GENERIC_HARDIRQS


720 ià(
št_mode
) {

721 
»t
 = 
	`»que¡_th»aded_œq
(
pd©a
->
œq
, 
NULL
,

722 
ùs_¶©_œq_hªdËr
, 
IRQF_TRIGGER_RISING
 | 
IRQF_ONESHOT
,

723 
CFG_CTS_DRIVER_NAME
, 
pd©a
);

726 
»t
 = 
	`»que¡_th»aded_œq
(
pd©a
->
œq
, 
NULL
,

727 
ùs_¶©_œq_hªdËr
, 
IRQF_TRIGGER_FALLING
 | 
IRQF_ONESHOT
,

728 
CFG_CTS_DRIVER_NAME
, 
pd©a
);

731 ià(
št_mode
) {

732 
»t
 = 
	`»que¡_œq
(
pd©a
->
œq
,

733 
ùs_¶©_œq_hªdËr
, 
IRQF_TRIGGER_RISING
 | 
IRQF_ONESHOT
,

734 
CFG_CTS_DRIVER_NAME
, 
pd©a
);

737 
»t
 = 
	`»que¡_œq
(
pd©a
->
œq
,

738 
ùs_¶©_œq_hªdËr
, 
IRQF_TRIGGER_FALLING
 | 
IRQF_ONESHOT
,

739 
CFG_CTS_DRIVER_NAME
, 
pd©a
);

742 ià(
»t
) {

743 
	`ùs_”r
("Reque¡ IRQ faed %d", 
»t
);

744  
»t
;

747 
	`ùs_¶©_di§bË_œq
(
pd©a
);

750 
	}
}

752 
	$ùs_¶©_ä“_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
)

754 
	`ä“_œq
(
pd©a
->
œq
,…data);

755 
	}
}

757 
	$ùs_¶©_’abË_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
)

759 
œqæags
;

761 
	`ùs_dbg
("Enable IRQ");

763 ià(
pd©a
->
œq
 > 0) {

764 
	`¥š_lock_œq§ve
(&
pd©a
->
œq_lock
, 
œqæags
);

765 ià(
pd©a
->
œq_is_di§bË
) {

766 
	`’abË_œq
(
pd©a
->
œq
);

767 
pd©a
->
œq_is_di§bË
 = 
çl£
;

769 
	`¥š_uÆock_œq»¡Üe
(&
pd©a
->
œq_lock
, 
œqæags
);

774  -
ENODEV
;

775 
	}
}

777 
	$ùs_¶©_di§bË_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
)

779 
œqæags
;

781 
	`ùs_dbg
("Disable IRQ");

783 ià(
pd©a
->
œq
 > 0) {

784 
	`¥š_lock_œq§ve
(&
pd©a
->
œq_lock
, 
œqæags
);

785 ià(!
pd©a
->
œq_is_di§bË
) {

786 
	`di§bË_œq_nosync
(
pd©a
->
œq
);

787 
pd©a
->
œq_is_di§bË
 = 
Œue
;

789 
	`¥š_uÆock_œq»¡Üe
(&
pd©a
->
œq_lock
, 
œqæags
);

794  -
ENODEV
;

795 
	}
}

797 #ifdeà
CFG_CTS_HAS_RESET_PIN


798 
	$ùs_¶©_»£t_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

803 
	`ùs_šfo
("Reset device");

805 
	`gpio_£t_v®ue
(
pd©a
->
r¡_gpio
, 1);

806 
	`md–ay
(1);

807 
	`gpio_£t_v®ue
(
pd©a
->
r¡_gpio
, 0);

808 
	`md–ay
(10);

809 
	`gpio_£t_v®ue
(
pd©a
->
r¡_gpio
, 1);

810 
	`md–ay
(40);

813 
	}
}

815 
	$ùs_¶©_£t_»£t
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
v®
)

817 
	`ùs_šfo
("S‘ Re£ˆtØ%s", 
v®
 ? "HIGH" : "LOW");

818 ià(
v®
) {

819 
	`gpio_£t_v®ue
(
pd©a
->
r¡_gpio
, 1);

821 
	`gpio_£t_v®ue
(
pd©a
->
r¡_gpio
, 0);

824 
	}
}

827 
	$ùs_¶©_g‘_št_pš
(
ùs_¶©fÜm_d©a
 *
pd©a
)

829  
	`gpio_g‘_v®ue
(
pd©a
->
št_gpio
);

830 
	}
}

832 
	$ùs_¶©_pow”_up_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

834 
	`ùs_šfo
("Power up device");

837 
	}
}

839 
	$ùs_¶©_pow”_down_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

841 
	`ùs_šfo
("Power down device");

844 
	}
}

846 
	$ùs_¶©_š™_touch_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

848 
	`ùs_šfo
("Initouch device");

851 
	}
}

853 
	$ùs_¶©_deš™_touch_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

855 
	`ùs_šfo
("De-initouch device");

857 #iâdeà
CONFIG_GENERIC_HARDIRQS


858 ià(
	`wÜk_³ndšg
(&
pd©a
->
ts_œq_wÜk
)) {

859 
	`ÿnûl_wÜk_sync
(&
pd©a
->
ts_œq_wÜk
);

862 
	}
}

864 
	$ùs_¶©_´oûss_touch_msg
(
ùs_¶©fÜm_d©a
 *
pd©a
,

865 
ùs_deviû_touch_msg
 *
msgs
, 
num
)

867 
šput_dev
 *šput_dev = 
pd©a
->
ts_šput_dev
;

868 
i
;

869 
cÚù
 = 0;

870 #ifdeà
CONFIG_CTS_SLOTPROTOCOL


871 
fšg”_Ï¡
[
CFG_CTS_MAX_TOUCH_NUM
] = {0};

872 
fšg”_cu¼’t
[
CFG_CTS_MAX_TOUCH_NUM
] = {0};

875 
	`ùs_dbg
("Proûs touch %d msgs", 
num
);

876 ià(
num
 ==0 ||‚um > 
CFG_CTS_MAX_TOUCH_NUM
) {

880 
i
 = 0; i < 
num
; i++) {

881 
u16
 
x
, 
y
;

883 
x
 = 
	`Ë16_to_ıu
(
msgs
[
i
].x);

884 
y
 = 
	`Ë16_to_ıu
(
msgs
[
i
].y);

886 #ifdeà
CFG_CTS_SWAP_XY


887 
	`sw­
(
x
,
y
);

889 #ifdeà
CFG_CTS_WRAP_X


890 
x
 = 
	`w¿p
(
pd©a
->
»s_x
,x);

892 #ifdeà
CFG_CTS_WRAP_Y


893 
y
 = 
	`w¿p
(
pd©a
->
»s_y
,y);

895 
	`ùs_dbg
(" Processouch msg[%d]: id[%u]ƒv=%u x=%u y=%u…=%u",

896 
i
, 
msgs
[i].
id
, msgs[i].
ev’t
, 
x
, 
y
, msgs[i].
´essu»
);

897 ià(
msgs
[
i
].
ev’t
 =ğ
CTS_DEVICE_TOUCH_EVENT_DOWN


898 || 
msgs
[
i
].
ev’t
 =ğ
CTS_DEVICE_TOUCH_EVENT_MOVE


899 || 
msgs
[
i
].
ev’t
 =ğ
CTS_DEVICE_TOUCH_EVENT_STAY
) {

900 ià(
msgs
[
i
].
id
 < 
CFG_CTS_MAX_TOUCH_NUM
) {

901 
fšg”_cu¼’t
[
msgs
[
i
].
id
] = 1;

904 #ifdeà
CONFIG_CTS_SLOTPROTOCOL


906 
msgs
[
i
].
ev’t
) {

907 
CTS_DEVICE_TOUCH_EVENT_DOWN
:

908 
CTS_DEVICE_TOUCH_EVENT_MOVE
:

909 
CTS_DEVICE_TOUCH_EVENT_STAY
:

910 
cÚù
++;

911 
	`šput_mt_¦Ù
(
šput_dev
, 
msgs
[
i
].
id
);

912 
	`šput_mt_»pÜt_¦Ù_¡©e
(
šput_dev
, 
MT_TOOL_FINGER
, 
Œue
);

913 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_POSITION_X
, 
x
);

914 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_POSITION_Y
, 
y
);

915 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_TOUCH_MAJOR
, 
msgs
[
i
].
´essu»
);

916 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_PRESSURE
, 
msgs
[
i
].
´essu»
);

919 
CTS_DEVICE_TOUCH_EVENT_UP
:

924 
	`ùs_w¬n
("Processouch msg with unknownƒvent %u id %u",

925 
msgs
[
i
].
ev’t
, msgs[i].
id
);

936 
msgs
[
i
].
ev’t
) {

937 
CTS_DEVICE_TOUCH_EVENT_DOWN
:

938 
CTS_DEVICE_TOUCH_EVENT_MOVE
:

939 
CTS_DEVICE_TOUCH_EVENT_STAY
:

940 
cÚù
++;

941 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_PRESSURE
, 
msgs
[
i
].
´essu»
);

942 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_TOUCH_MAJOR
, 
msgs
[
i
].
´essu»
);

943 
	`šput_»pÜt_key
(
šput_dev
, 
BTN_TOUCH
, 1);

944 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_POSITION_X
, 
x
);

945 
	`šput_»pÜt_abs
(
šput_dev
, 
ABS_MT_POSITION_Y
, 
y
);

946 
	`šput_mt_sync
(
šput_dev
);

949 
CTS_DEVICE_TOUCH_EVENT_UP
:

952 
	`ùs_w¬n
("Processouch msg with unknownƒvent %u id %u",

953 
msgs
[
i
].
ev’t
, msgs[i].
id
);

960 #ifdeà
CONFIG_CTS_SLOTPROTOCOL


961 
i
 = 0; i < 
CFG_CTS_MAX_TOUCH_NUM
; i++) {

962 ià(
fšg”_Ï¡
[
i
] !ğ0 && 
fšg”_cu¼’t
[i] == 0) {

963 
	`šput_mt_¦Ù
(
šput_dev
, 
i
);

964 
	`šput_mt_»pÜt_¦Ù_¡©e
(
šput_dev
, 
MT_TOOL_FINGER
, 
çl£
);

966 
fšg”_Ï¡
[
i
] = 
fšg”_cu¼’t
[i];

968 
	`šput_»pÜt_key
(
šput_dev
, 
BTN_TOUCH
, 
cÚù
 > 0);

970 ià(
cÚù
 == 0) {

971 
	`šput_»pÜt_key
(
šput_dev
, 
BTN_TOUCH
, 0);

972 
	`šput_mt_sync
(
šput_dev
);

975 
	`šput_sync
(
šput_dev
);

976 #ifdeà
CFG_CTS_FORCE_UP


977 ià(
cÚù
) {

978 
	`mod_tim”
(&
pd©a
->
touch_ev’t_timeout_tim”
, 
jiff›s
 + 
	`m£cs_to_jiff›s
(100));

980 
	`d–_tim”
(&
pd©a
->
touch_ev’t_timeout_tim”
);

984 
	}
}

986 
	$ùs_¶©_»Ëa£_®l_touch
(
ùs_¶©fÜm_d©a
 *
pd©a
)

988 
šput_dev
 *šput_dev = 
pd©a
->
ts_šput_dev
;

990 #ià
	`defšed
(
CONFIG_CTS_SLOTPROTOCOL
)

991 
id
;

994 
	`ùs_šfo
("Release‡llouch");

996 #ifdeà
CONFIG_CTS_SLOTPROTOCOL


997 
id
 = 0; id < 
CFG_CTS_MAX_TOUCH_NUM
; id++) {

998 
	`šput_mt_¦Ù
(
šput_dev
, 
id
);

999 
	`šput_mt_»pÜt_¦Ù_¡©e
(
šput_dev
, 
MT_TOOL_FINGER
, 
çl£
);

1001 
	`šput_»pÜt_key
(
šput_dev
, 
BTN_TOUCH
, 0);

1003 
	`šput_»pÜt_key
(
šput_dev
, 
BTN_TOUCH
, 0);

1004 
	`šput_mt_sync
(
šput_dev
);

1006 
	`šput_sync
(
šput_dev
);

1007 #ifdeà
CFG_CTS_FORCE_UP


1008 
	`d–_tim”
(&
pd©a
->
touch_ev’t_timeout_tim”
);

1011 
	}
}

1013 #ifdeà
CONFIG_CTS_VIRTUALKEY


1014 
	$ùs_¶©_š™_vkey_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1016 
i
;

1018 
	`ùs_šfo
("Init VKey");

1020 
pd©a
->
vkey_¡©e
 = 0;

1022 
i
 = 0; i < 
pd©a
->
vkey_num
; i++) {

1023 
	`šput_£t_ÿ·b™y
(
pd©a
->
ts_šput_dev
,

1024 
EV_KEY
, 
pd©a
->
vkey_keycodes
[
i
]);

1028 
	}
}

1030 
	$ùs_¶©_deš™_vkey_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1032 
	`ùs_šfo
("De-init VKey");

1034 
pd©a
->
vkey_¡©e
 = 0;

1035 
	}
}

1037 
	$ùs_¶©_´oûss_vkey
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
vkey_¡©e
)

1039 
u8
 
ev’t
;

1040 
i
;

1042 
ev’t
 = 
pd©a
->
vkey_¡©e
 ^ vkey_state;

1044 
	`ùs_dbg
("Proûs vkey s‹=0x%02x,ƒv’t=0x%02x", 
vkey_¡©e
, 
ev’t
);

1046 
i
 = 0; i < 
pd©a
->
vkey_num
; i++) {

1047 
	`šput_»pÜt_key
(
pd©a
->
ts_šput_dev
,

1048 
pd©a
->
vkey_keycodes
[
i
], 
vkey_¡©e
 & 
	`BIT
(i) ? 1 : 0);

1051 
pd©a
->
vkey_¡©e
 = vkey_state;

1054 
	}
}

1056 
	$ùs_¶©_»Ëa£_®l_vkey
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1058 
i
;

1060 
	`ùs_šfo
("Release‡ll vkeys");

1062 
i
 = 0; i < 
pd©a
->
vkey_num
; i++) {

1063 ià(
pd©a
->
vkey_¡©e
 & 
	`BIT
(
i
)) {

1064 
	`šput_»pÜt_key
(
pd©a
->
ts_šput_dev
,…d©a->
vkey_keycodes
[
i
], 0);

1068 
pd©a
->
vkey_¡©e
 = 0;

1071 
	}
}

1074 #ifdeà
CFG_CTS_GESTURE


1075 
	$ùs_¶©_’abË_œq_wake
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1077 
	`ùs_šfo
("Enable IRQ wake");

1079 ià(
pd©a
->
œq
 > 0) {

1080 ià(!
pd©a
->
œq_wake_’abËd
) {

1081 
pd©a
->
œq_wake_’abËd
 = 
Œue
;

1082  
	`’abË_œq_wake
(
pd©a
->
œq
);

1085 
	`ùs_w¬n
("Enable irq wake while‡lready disabled");

1086  -
EINVAL
;

1089 
	`ùs_w¬n
("EÇbË irq wakwhœq inv®id %d", 
pd©a
->
œq
);

1090  -
ENODEV
;

1091 
	}
}

1093 
	$ùs_¶©_di§bË_œq_wake
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1095 
	`ùs_šfo
("Disable IRQ wake");

1097 ià(
pd©a
->
œq
 > 0) {

1098 ià(
pd©a
->
œq_wake_’abËd
) {

1099 
pd©a
->
œq_wake_’abËd
 = 
çl£
;

1100  
	`di§bË_œq_wake
(
pd©a
->
œq
);

1103 
	`ùs_w¬n
("Disable irq wake while‡lready disabled");

1104  -
EINVAL
;

1107 
	`ùs_w¬n
("Di§bË irq wakwhœq inv®id %d", 
pd©a
->
œq
);

1108  -
ENODEV
;

1109 
	}
}

1111 
	$ùs_¶©_š™_ge¡u»
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1113 
i
;

1115 
	`ùs_šfo
("Init gesture");

1120 
i
 = 0; i < 
pd©a
->
ge¡u»_num
; i ++) {

1121 
	`šput_£t_ÿ·b™y
(
pd©a
->
ts_šput_dev
, 
EV_KEY
,

1122 
pd©a
->
ge¡u»_keym­
[
i
][1]);

1126 
	}
}

1128 
	$ùs_¶©_deš™_ge¡u»
(
ùs_¶©fÜm_d©a
 *
pd©a
)

1130 
	`ùs_šfo
("De-init gesture");

1131 
	}
}

1133 
	$ùs_¶©_´oûss_ge¡u»_šfo
(
ùs_¶©fÜm_d©a
 *
pd©a
,

1134 
ùs_deviû_ge¡u»_šfo
 *
ge¡u»_šfo
)

1136 
i
;

1138 
	`ùs_šfo
("Proûs ge¡u», id=0x%02x", 
ge¡u»_šfo
->
ge¡u»_id
);

1140 #ià
	`defšed
(
CFG_CTS_GESTURE_REPORT_KEY
)

1141 
i
 = 0; i < 
CFG_CTS_NUM_GESTURE
; i++) {

1142 ià(
ge¡u»_šfo
->
ge¡u»_id
 =ğ
pd©a
->
ge¡u»_keym­
[
i
][0]) {

1143 
	`ùs_šfo
("R•Üˆkey[%u]", 
pd©a
->
ge¡u»_keym­
[
i
][1]);

1144 
	`šput_»pÜt_key
(
pd©a
->
ts_šput_dev
,

1145 
pd©a
->
ge¡u»_keym­
[
i
][1], 1);

1146 
	`šput_sync
(
pd©a
->
ts_šput_dev
);

1148 
	`šput_»pÜt_key
(
pd©a
->
ts_šput_dev
,

1149 
pd©a
->
ge¡u»_keym­
[
i
][1], 0);

1150 
	`šput_sync
(
pd©a
->
ts_šput_dev
);

1157 
	`ùs_w¬n
("Process unrecognized gesture id=%u",

1158 
ge¡u»_šfo
->
ge¡u»_id
);

1160  -
EINVAL
;

1161 
	}
}

	@cts_platform.h

1 #iâdeà
CTS_PLATFORM_H


2 
	#CTS_PLATFORM_H


	)

4 
	~<lšux/ty³s.h
>

5 
	~<asm/by‹Üd”.h
>

6 
	~<lšux/b™İs.h
>

7 
	~<lšux/ùy³.h
>

8 
	~<lšux/uÇligÃd/acûss_ok.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/¦ab.h
>

11 
	~<lšux/vm®loc.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/deviû.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/uacûss.h
>

16 
	~<lšux/i2c.h
>

17 
	~<lšux/š‹¼u±.h
>

18 
	~<lšux/œq.h
>

19 
	~<lšux/gpio.h
>

20 
	~<lšux/šput.h
>

21 
	~<lšux/šput/mt.h
>

22 
	~<lšux/¥šlock.h
>

23 
	~<lšux/¹mu‹x.h
>

24 
	~<lšux/by‹Üd”/g’”ic.h
>

25 
	~<lšux/´oc_fs.h
>

26 
	~<lšux/d–ay.h
>

27 
	~<lšux/v”siÚ.h
>

28 
	~<lšux/jiff›s.h
>

29 
	~<lšux/h¹im”.h
>

30 
	~<lšux/¡ršg.h
>

31 
	~<lšux/su¥’d.h
>

32 
	~<lšux/wak–ock.h
>

33 
	~<lšux/fœmw¬e.h
>

35 #ifdeà
CONFIG_OF


36 
	~<lšux/of.h
>

37 
	~<lšux/of_gpio.h
>

38 
	~<lšux/of_œq.h
>

41 
	~<lšux/fb.h
>

42 
	~<lšux/nÙif›r.h
>

44 
	~<lšux/¥i/¥i.h
>

45 
	~<lšux/¥i/¥idev.h
>

47 #ifdeà
CFG_CTS_DRM_NOTIFIER


48 
	~<lšux/msm_drm_nÙify.h
>

51 
	~"ùs_cÚfig.h
"

52 
	~"ùs_cÜe.h
"

54 
boŞ
 
ùs_show_debug_log
;

56 #iâdeà
LOG_TAG


57 
	#LOG_TAG
 ""

	)

60 
	eùs_driv”_log_Ëv–
 {

61 
	mCTS_DRIVER_LOG_ERROR
,

62 
	mCTS_DRIVER_LOG_WARN
,

63 
	mCTS_DRIVER_LOG_INFO
,

64 
	mCTS_DRIVER_LOG_DEBUG
,

67 
ùs_¡¬t_driv”_log_»dœeù
(cÚ¡ *
f•©h
, 
boŞ
 
­³nd_to_fe
,

68 *
log_bufãr
, 
log_buf_size
, 
log_Ëv–
);

69 
ùs_¡İ_driv”_log_»dœeù
();

70 
ùs_g‘_driv”_log_»dœeù_size
();

71 
ùs_log
(
Ëv–
, cÚ¡ *
fmt
, ...);

73 
	#ùs_”r
(
fmt
, ...) \

74 
	`ùs_log
(
CTS_DRIVER_LOG_ERROR
, "<E>CTS-" 
LOG_TAG
 " " 
fmt
"\n", ##
__VA_ARGS__
)

	)

75 
	#ùs_w¬n
(
fmt
, ...) \

76 
	`ùs_log
(
CTS_DRIVER_LOG_WARN
, "<W>CTS-" 
LOG_TAG
 " " 
fmt
"\n", ##
__VA_ARGS__
)

	)

77 
	#ùs_šfo
(
fmt
, ...) \

78 
	`ùs_log
(
CTS_DRIVER_LOG_INFO
, "<I>CTS-" 
LOG_TAG
 " " 
fmt
"\n", ##
__VA_ARGS__
)

	)

79 
	#ùs_dbg
(
fmt
, ...) \

80 
	`ùs_log
(
CTS_DRIVER_LOG_DEBUG
, "<D>CTS-" 
LOG_TAG
 " " 
fmt
"\n", ##
__VA_ARGS__
)

	)

82 
	gùs_deviû
;

83 
	gùs_deviû_touch_msg
;

84 
	gùs_deviû_ge¡u»_šfo
;

86 
	sùs_¶©fÜm_d©a
 {

87 
	mœq
;

88 
	mšt_gpio
;

89 #ifdeà
CFG_CTS_HAS_RESET_PIN


90 
	mr¡_gpio
;

93 
u32
 
	m»s_x
;

94 
u32
 
	m»s_y
;

96 #ifdeà
CONFIG_CTS_VIRTUALKEY


97 
u8
 
	mvkey_num
;

98 
u8
 
	mvkey_¡©e
;

99 
u8
 
	mvkey_keycodes
[
CFG_CTS_MAX_VKEY_NUM
];

102 
ùs_deviû
 *
	mùs_dev
;

104 
šput_dev
 *
	mts_šput_dev
;

106 #iâdeà
CONFIG_GENERIC_HARDIRQS


107 
wÜk_¡ruù
 
	mts_œq_wÜk
;

110 
¹_mu‹x
 
	mdev_lock
;

111 
¥šlock
 
	mœq_lock
;

112 
boŞ
 
	mœq_is_di§bË
;

114 #ifdeà
CFG_CTS_GESTURE


115 
u8
 
	mge¡u»_num
;

116 
u8
 
	mge¡u»_keym­
[
CFG_CTS_NUM_GESTURE
][2];

117 
boŞ
 
	mœq_wake_’abËd
;

120 #ifdeà
CONFIG_CTS_PM_FB_NOTIFIER


121 
nÙif›r_block
 
	mfb_nÙif›r
;

124 #ifdeà
CFG_CTS_FORCE_UP


125 
tim”_li¡
 
	mtouch_ev’t_timeout_tim”
;

128 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


129 
u8
 
	mfw_log_buf
[
CTS_FW_LOG_BUF_LEN
];

132 #ifdeà
CONFIG_CTS_I2C_HOST


133 
i2c_ş›Á
 *
	mi2c_ş›Á
;

134 
u8
 
	mi2c_fifo_buf
[
CFG_CTS_MAX_I2C_XFER_SIZE
];

136 
¥i_deviû
 *
	m¥i_ş›Á
;

137 
u8
 
	m¥i_ÿche_buf
[
ALIGN
(
CFG_CTS_MAX_SPI_XFER_SIZE
+10,4)];

138 
u8
 
	m¥i_rx_buf
[
ALIGN
(
CFG_CTS_MAX_SPI_XFER_SIZE
+10,4)];

139 
u8
 
	m¥i_tx_buf
[
ALIGN
(
CFG_CTS_MAX_SPI_XFER_SIZE
+10,4)];

140 
u32
 
	m¥i_¥“d
;

143 
ùs_deviû_touch_šfo
 
	mtouch_šfo
;

146 #ifdeà
CONFIG_CTS_I2C_HOST


147 
size_t
 
ùs_¶©_g‘_max_i2c_xãr_size
(
ùs_¶©fÜm_d©a
 *
pd©a
);

148 
u8
 *
ùs_¶©_g‘_i2c_xãr_buf
(
ùs_¶©fÜm_d©a
 *
pd©a
,

149 
size_t
 
xãr_size
);

150 
ùs_¶©_i2c_wr™e
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
,

151 cÚ¡ *
¤c
, 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

152 
ùs_¶©_i2c_»ad
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
,

153 cÚ¡ 
u8
 *
wbuf
, 
size_t
 
wËn
, *
rbuf
, size_ˆ
¾’
,

154 
»Œy
, 
d–ay
);

155 
ùs_¶©_is_i2c_Úlše
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
);

157 
size_t
 
ùs_¶©_g‘_max_¥i_xãr_size
(
ùs_¶©fÜm_d©a
 *
pd©a
);

158 
u8
 *
ùs_¶©_g‘_¥i_xãr_buf
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
size_t
 
xãr_size
);

159 
ùs_¶©_¥i_wr™e
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
, cÚ¡ *
¤c
,

160 
size_t
 
Ën
, 
»Œy
, 
d–ay
);

161 
ùs_¶©_¥i_»ad
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
i2c_addr
,

162 cÚ¡ 
u8
 *
wbuf
, 
size_t
 
wËn
, *
rbuf
, size_ˆ
¾’
,

163 
»Œy
, 
d–ay
);

164 
ùs_¶©_¥i_»ad_d–ay_idË
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
dev_addr
,

165 cÚ¡ 
u8
 *
wbuf
, 
size_t
 
wËn
, *
rbuf
, size_ˆ
¾’
,

166 
»Œy
, 
d–ay
, 
idË
);

167 
ùs_¥i_£nd_»cv
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
size_t
 
Ën
 , 
u8
 *
tx_bufãr
, u8 *
rx_bufãr
);

170 #ifdeà
CONFIG_CTS_I2C_HOST


171 
ùs_š™_¶©fÜm_d©a
(
ùs_¶©fÜm_d©a
 *
pd©a
,

172 
i2c_ş›Á
 *i2c_client);

174 
ùs_¶©_is_nÜm®_mode
(
ùs_¶©fÜm_d©a
 *
pd©a
);

175 
ùs_š™_¶©fÜm_d©a
(
ùs_¶©fÜm_d©a
 *
pd©a
,

176 
¥i_deviû
 *
¥i
);

179 
ùs_deš™_¶©fÜm_d©a
(
ùs_¶©fÜm_d©a
 *
pd©a
);

180 
ùs_¶©_»que¡_»sourû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

181 
ùs_¶©_ä“_»sourû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

183 
ùs_¶©_»que¡_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
);

184 
ùs_¶©_ä“_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
);

185 
ùs_¶©_’abË_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
);

186 
ùs_¶©_di§bË_œq
(
ùs_¶©fÜm_d©a
 *
pd©a
);

188 #ifdeà
CFG_CTS_HAS_RESET_PIN


189 
ùs_¶©_»£t_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

191 
šlše
 
	$ùs_¶©_»£t_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
è{ 0;
	}
}

194 
ùs_¶©_š™_touch_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

195 
ùs_¶©_deš™_touch_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

196 
ùs_¶©_´oûss_touch_msg
(
ùs_¶©fÜm_d©a
 *
pd©a
,

197 
ùs_deviû_touch_msg
 *
msgs
, 
num
);

198 
ùs_¶©_»Ëa£_®l_touch
(
ùs_¶©fÜm_d©a
 *
pd©a
);

200 #ifdeà
CONFIG_CTS_VIRTUALKEY


201 
ùs_¶©_š™_vkey_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

202 
ùs_¶©_deš™_vkey_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
);

203 
ùs_¶©_´oûss_vkey
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
vkey_¡©e
);

204 
ùs_¶©_»Ëa£_®l_vkey
(
ùs_¶©fÜm_d©a
 *
pd©a
);

206 
šlše
 
	$ùs_¶©_š™_vkey_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
è{ 0;
	}
}

207 
šlše
 
	$ùs_¶©_deš™_vkey_deviû
(
ùs_¶©fÜm_d©a
 *
pd©a
è{
	}
}

208 
šlše
 
	$ùs_¶©_´oûss_vkey
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
u8
 
vkey_¡©e
è{ 0;
	}
}

209 
šlše
 
	$ùs_¶©_»Ëa£_®l_vkey
(
ùs_¶©fÜm_d©a
 *
pd©a
è{ 0;
	}
}

212 #ifdeà
CFG_CTS_GESTURE


213 
ùs_¶©_’abË_œq_wake
(
ùs_¶©fÜm_d©a
 *
pd©a
);

214 
ùs_¶©_di§bË_œq_wake
(
ùs_¶©fÜm_d©a
 *
pd©a
);

216 
ùs_¶©_š™_ge¡u»
(
ùs_¶©fÜm_d©a
 *
pd©a
);

217 
ùs_¶©_deš™_ge¡u»
(
ùs_¶©fÜm_d©a
 *
pd©a
);

218 
ùs_¶©_´oûss_ge¡u»_šfo
(
ùs_¶©fÜm_d©a
 *
pd©a
,

219 
ùs_deviû_ge¡u»_šfo
 *
ge¡u»_šfo
);

221 
šlše
 
	$ùs_¶©_š™_ge¡u»
(
ùs_¶©fÜm_d©a
 *
pd©a
è{ 0;
	}
}

222 
šlše
 
	$ùs_¶©_deš™_ge¡u»
(
ùs_¶©fÜm_d©a
 *
pd©a
è{
	}
}

225 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


226 
size_t
 
ùs_¶©_g‘_max_fw_log_size
(
ùs_¶©fÜm_d©a
 *
pd©a
);

227 
u8
 *
ùs_¶©_g‘_fw_log_buf
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
size_t
 
size
);

230 
ùs_¶©_£t_»£t
(
ùs_¶©fÜm_d©a
 *
pd©a
, 
v®
);

231 
ùs_¶©_g‘_št_pš
(
ùs_¶©fÜm_d©a
 *
pd©a
);

	@cts_sfctrl.h

1 #iâdeà
CTS_SFCTRL_H


2 
	#CTS_SFCTRL_H


	)

4 
	~"ùs_cÜe.h
"

5 
	~"ùs_¥i_æash.h
"

7 
	gùs_deviû
;

9 
	sùs_sfù¾_İs
 {

10 (*
	mrdid
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
, 
u32
 *
	mid
);

11 (*
	m£
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
, 
u32
 
	m£ùÜ_addr
);

12 (*
	mbe
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
, 
u32
 
	m£ùÜ_addr
);

13 (*
	m»ad
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
,

14 
u32
 
	mæash_addr
, *
	md¡
, 
size_t
 
	mËn
);

15 (*
	m»ad_to_¤am
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
,

16 
u32
 
	mæash_addr
, u32 
	m¤am_addr
, 
size_t
 
	mËn
);

17 (*
	m´og¿m
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
,

18 
u32
 
	mæash_addr
, cÚ¡ *
	m¤c
, 
size_t
 
	mËn
);

19 (*
	m´og¿m_äom_¤am
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
,

20 
u32
 
	mæash_addr
, u32 
	m¤am_addr
, 
size_t
 
	mËn
);

21 (*
	mÿlc_¤am_üc
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
,

22 
u32
 
	m¤am_addr
, 
size_t
 
	mËn
, u32 *
	müc
);

23 (*
	mÿlc_æash_üc
)(cÚ¡ 
ùs_deviû
 *
	mùs_dev
,

24 
u32
 
	mæash_addr
, 
size_t
 
	mËn
, u32 *
	müc
);

28 
	sùs_sfù¾
 {

29 
u32
 
	m»g_ba£
;

30 
u32
 
	mxchg_¤am_ba£
;

31 
size_t
 
	mxchg_¤am_size
;

33 cÚ¡ 
ùs_sfù¾_İs
 *
	mİs
;

36 cÚ¡ 
ùs_sfù¾_İs
 
ùs_sfù¾v2_İs
;

	@cts_sfctrlv2.c

1 
	#LOG_TAG
 "SFCŒl"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sfù¾.h
"

8 
	#rSFCTRLv2_CMD_SEL
 (0x0000)

	)

9 
	#rSFCTRLv2_FLASH_ADDR
 (0x0004)

	)

10 
	#rSFCTRLv2_SRAM_ADDR
 (0x0008)

	)

11 
	#rSFCTRLv2_DATA_LENGTH
 (0x000C)

	)

12 
	#rSFCTRLv2_START_DEXC
 (0x0010)

	)

13 
	#rSFCTRLv2_RELEASE_FLASH
 (0x0014)

	)

14 
	#rSFCTRLv2_HW_STATE
 (0x0018)

	)

15 
	#rSFCTRLv2_CRC_RESULT
 (0x001C)

	)

16 
	#rSFCTRLv2_SRAM_CRC_START
 (0x0020)

	)

17 
	#rSFCTRLv2_FLASH_CRC_START
 (0x0022)

	)

18 
	#rSFCTRLv2_SF_BUSY
 (0x0024)

	)

21 
	esfù¾v2_cmd
 {

22 
	mSFCTRLv2_CMD_FAST_READ
 = 0x01u,

23 
	mSFCTRLv2_CMD_SE
 = 0x02u,

24 
	mSFCTRLv2_CMD_BE
 = 0x03u,

25 
	mSFCTRLv2_CMD_PP
 = 0x04u,

26 
	mSFCTRLv2_CMD_RDSR
 = 0x05u,

27 
	mSFCTRLv2_CMD_RDID
 = 0x06u

31 
	esfù¾v2_İæags
 {

32 
	mSFCTRLv2_OPFLAG_READ
 = 
BIT
(0),

33 
	mSFCTRLv2_OPFLAG_SET_FLASH_ADDR
 = 
BIT
(1),

34 
	mSFCTRLv2_OPFLAG_SRAM_DATA_XCHG
 = 
BIT
(2),

35 
	mSFCTRLv2_OPFLAG_SET_DATA_LENGTH
 = 
BIT
(3),

36 
	mSFCTRLv2_OPFLAG_WAIT_WIP_CLR
 = 
BIT
(4),

40 
	#SFCTRLv2_CMD_RDID_FLAGS
 \

41 (
SFCTRLv2_OPFLAG_READ
 | \

42 
SFCTRLv2_OPFLAG_SRAM_DATA_XCHG
)

	)

44 
	#SFCTRLv2_CMD_RDSR_FLAGS
 \

45 (
SFCTRLv2_OPFLAG_READ
 | \

46 
SFCTRLv2_OPFLAG_SRAM_DATA_XCHG
)

	)

48 
	#SFCTRLv2_CMD_SE_FLAGS
 \

49 (
SFCTRLv2_OPFLAG_SET_FLASH_ADDR
 | \

50 
SFCTRLv2_OPFLAG_WAIT_WIP_CLR
)

	)

52 
	#SFCTRLv2_CMD_BE_FLAGS
 \

53 (
SFCTRLv2_OPFLAG_SET_FLASH_ADDR
 | \

54 
SFCTRLv2_OPFLAG_WAIT_WIP_CLR
)

	)

56 
	#SFCTRLv2_CMD_PP_FLAGS
 \

57 (
SFCTRLv2_OPFLAG_SET_FLASH_ADDR
 | \

58 
SFCTRLv2_OPFLAG_SRAM_DATA_XCHG
 | \

59 
SFCTRLv2_OPFLAG_SET_DATA_LENGTH
 | \

60 
SFCTRLv2_OPFLAG_WAIT_WIP_CLR
)

	)

62 
	#SFCTRLv2_CMD_FAST_READ_FLAGS
 \

63 (
SFCTRLv2_OPFLAG_READ
 | \

64 
SFCTRLv2_OPFLAG_SET_FLASH_ADDR
 | \

65 
SFCTRLv2_OPFLAG_SRAM_DATA_XCHG
 | \

66 
SFCTRLv2_OPFLAG_SET_DATA_LENGTH
)

	)

68 
	#sfù¾_»g_addr
(
ùs_dev
, 
off£t
) \

69 ((
ùs_dev
)->
hwd©a
->
sfù¾
->
»g_ba£
 + 
off£t
)

	)

71 
	#DEFINE_SFCTRL_REG_ACCESS_FUNC
(
acûss_ty³
, 
d©a_ty³
) \

72 
šlše
 
sfù¾_»g_
 ## 
	`acûss_ty³
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, \

73 
u32
 
»g
, 
d©a_ty³
 
d©a
) { \

74  
ùs_hw_»g_
 ## 
	`acûss_ty³
(
ùs_dev
, 
	`sfù¾_»g_addr
(ùs_dev, 
»g
), 
d©a
); \

75 }

	)

77 
	$DEFINE_SFCTRL_REG_ACCESS_FUNC
(
wr™eb
, 
u8
)

78 
	$DEFINE_SFCTRL_REG_ACCESS_FUNC
(
wr™ew
, 
u16
)

79 
	$DEFINE_SFCTRL_REG_ACCESS_FUNC
(
wr™–
, 
u32
)

80 
	$DEFINE_SFCTRL_REG_ACCESS_FUNC
(
»adb
, 
u8
 *)

81 
	$DEFINE_SFCTRL_REG_ACCESS_FUNC
(
»adw
, 
u16
 *)

82 
	$DEFINE_SFCTRL_REG_ACCESS_FUNC
(
»adl
, 
u32
 *)

84 
	#sfù¾_wr™e_»g_check_»t
(
acûss_ty³
, 
»g
, 
v®
) \

86 
»t
; \

87 
	`ùs_dbg
("Wr™" #»g "Ø0x%x", 
v®
); \

88 
»t
 = 
sfù¾_»g_
 ## 
	`acûss_ty³
(
ùs_dev
, 
»g
, 
v®
); \

89 ià(
»t
) { \

90 
	`ùs_”r
("Wr™" #»g " faed %d", 
»t
); \

91  
»t
; \

93 
	}
} 0)

	)

95 
	#sfù¾_»ad_»g_check_»t
(
acûss_ty³
, 
»g
, 
v®
) \

97 
»t
; \

98 
	`ùs_dbg
("Read " #reg ""); \

99 
»t
 = 
sfù¾_»g_
 ## 
	`acûss_ty³
(
ùs_dev
, 
»g
, 
v®
); \

100 ià(
»t
) { \

101 
	`ùs_”r
("R—d " #»g " faed %d", 
»t
); \

102  
»t
; \

104 } 0)

	)

106 
	$wa™_sfù¾_xãr_comp
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

108 
»Œ›s
 = 0;

109 
u8
 
¡©us
;

112 
	`sfù¾_»ad_»g_check_»t
(
»adb
, 
rSFCTRLv2_SF_BUSY
, &
¡©us
);

113 if(
¡©us
 == 0) {

117 
	`md–ay
(1);

118 } 
¡©us
 && 
»Œ›s
++ < 1000);

120  -
ETIMEDOUT
;

121 
	}
}

123 
	$sfù¾v2_rd¤
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u8
 *
¡©us
)

125 
	#RDSR_XCHG_SRAM_ADDR
 (
ùs_dev
->
hwd©a
->
¤am_size
 - 1)

	)

127 
»t
;

129 
	`sfù¾_wr™e_»g_check_»t
(
wr™eb
, 
rSFCTRLv2_CMD_SEL
, 
SFCTRLv2_CMD_RDSR
);

130 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_SRAM_ADDR
, 
RDSR_XCHG_SRAM_ADDR
);

131 
	`sfù¾_wr™e_»g_check_»t
(
wr™eb
, 
rSFCTRLv2_START_DEXC
, 1);

133 if((
»t
 = 
	`wa™_sfù¾_xãr_comp
(
ùs_dev
)) != 0) {

134 
	`ùs_”r
("Wa™ sfù¾„—dy faed %d", 
»t
);

135  
»t
;

138 
»t
 = 
	`ùs_¤am_»adb
(
ùs_dev
, 
RDSR_XCHG_SRAM_ADDR
, 
¡©us
);

139 ià(
»t
) {

140 
	`ùs_”r
("R—dƒxchªg¤am faed %d", 
»t
);

141  
»t
;

143 #undeà
RDSR_XCHG_SRAM_ADDR


146 
	}
}

148 
	$wa™_æash_w_ş—r
(cÚ¡ 
ùs_deviû
 *
ùs_dev
)

150 
	#FLASH_SR_WIP
 
	`BIT
(0è

	)

152 
»t
, 
»Œ›s
 = 0;

153 
u8
 
¡©us
;

156 
»t
 = 
	`sfù¾v2_rd¤
(
ùs_dev
, &
¡©us
);

157 ià(
»t
) {

158 
	`ùs_”r
("R—d fÏsh stu »gi¡” faed %d", 
»t
);

159  
»t
;

162 ià(
¡©us
 & 
FLASH_SR_WIP
) {

163 
	`md–ay
(1);

167 } 
¡©us
 & 
FLASH_SR_WIP
 && 
»Œ›s
++ < 1000);

169  -
ETIMEDOUT
;

170 #undeà
FLASH_SR_WIP


171 
	}
}

173 
	$sfù¾v2_Œªsãr
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

174 
u8
 
cmd
, *
d©a
, 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
, u32 
æags
)

176 
»t
;

178 
	`sfù¾_wr™e_»g_check_»t
(
wr™eb
, 
rSFCTRLv2_CMD_SEL
, 
cmd
);

180 ià(
æags
 & 
SFCTRLv2_OPFLAG_SRAM_DATA_XCHG
) {

181 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_SRAM_ADDR
, 
¤am_addr
);

185 ià((!(
æags
 & 
SFCTRLv2_OPFLAG_READ
)è&& 
d©a
) {

186 
»t
 = 
	`ùs_¤am_wr™esb
(
ùs_dev
, 
¤am_addr
, 
d©a
, 
size
);

187 ià(
»t
) {

188 
	`ùs_”r
("Write dataoƒxchange sram 0x%06x size %zu failed %d",

189 
¤am_addr
, 
size
, 
»t
);

190  
»t
;

195 ià(
æags
 & 
SFCTRLv2_OPFLAG_SET_FLASH_ADDR
) {

196 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_FLASH_ADDR
, 
æash_addr
);

198 ià(
æags
 & 
SFCTRLv2_OPFLAG_SET_DATA_LENGTH
) {

199 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_DATA_LENGTH
, (
u32
)
size
);

202 
	`sfù¾_wr™e_»g_check_»t
(
wr™eb
, 
rSFCTRLv2_START_DEXC
, 1);

204 if((
»t
 = 
	`wa™_sfù¾_xãr_comp
(
ùs_dev
)) != 0) {

205 
	`ùs_”r
("Wa™ sfù¾„—dy faed %d", 
»t
);

206  
»t
;

209 ià(
æags
 & 
SFCTRLv2_OPFLAG_WAIT_WIP_CLR
 &&

210 (
»t
 = 
	`wa™_æash_w_ş—r
(
ùs_dev
)) != 0) {

211 
	`ùs_”r
("Wa™ WIP cË¬ faed %d", 
»t
);

212  
»t
;

215 ià((
æags
 & 
SFCTRLv2_OPFLAG_READ
è&& 
d©a
) {

216 
»t
 = 
	`ùs_¤am_»adsb
(
ùs_dev
, 
¤am_addr
, 
d©a
, 
size
);

217 ià(
»t
) {

218 
	`ùs_”r
("Read data fromƒxchange sram 0x%06x size %zu failed %d",

219 
¤am_addr
, 
size
, 
»t
);

220  
»t
;

225 
	}
}

227 
	$sfù¾v2_rdid
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 *
id
)

229 
»t
;

230 
u8
 
buf
[4];

232 
»t
 = 
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_RDID
, 
buf
,

233 0, 
ùs_dev
->
hwd©a
->
sfù¾
->
xchg_¤am_ba£
, 3,

234 
SFCTRLv2_CMD_RDID_FLAGS
);

235 *
id
 = 
»t
 ? 0 : 
	`g‘_uÇligÃd_be24
(
buf
);

237  
»t
;

238 
	}
}

240 
	$sfù¾v2_£
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
£ùÜ_addr
)

242  
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_SE
, 
NULL
,

243 
£ùÜ_addr
, 0, 0, 
SFCTRLv2_CMD_SE_FLAGS
);

244 
	}
}

246 
	$sfù¾v2_be
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
block_addr
)

248  
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_BE
, 
NULL
,

249 
block_addr
, 0, 0, 
SFCTRLv2_CMD_BE_FLAGS
);

250 
	}
}

252 
	$sfù¾v2_µ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

253 
u32
 
æash_addr
, cÚ¡ *
¤c
, 
size_t
 
size
)

255  
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_PP
, (*)
¤c
,

256 
æash_addr
, 
ùs_dev
->
hwd©a
->
sfù¾
->
xchg_¤am_ba£
, 
size
,

257 
SFCTRLv2_CMD_PP_FLAGS
);

258 
	}
}

260 
	$sfù¾v2_´og¿m_æash_äom_¤am
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

261 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
Ën
)

263  
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_PP
, 
NULL
,

264 
æash_addr
, 
¤am_addr
, 
Ën
, 
SFCTRLv2_CMD_PP_FLAGS
);

265 
	}
}

267 
	$sfù¾v2_»ad
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

268 
u32
 
æash_addr
, *
d¡
, 
size_t
 
size
)

270  
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_FAST_READ
, 
d¡
,

271 
æash_addr
, 
ùs_dev
->
hwd©a
->
sfù¾
->
xchg_¤am_ba£
, 
size
,

272 
SFCTRLv2_CMD_FAST_READ_FLAGS
);

273 
	}
}

275 
	$sfù¾v2_»ad_æash_to_¤am
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

276 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
)

278  
	`sfù¾v2_Œªsãr
(
ùs_dev
, 
SFCTRLv2_CMD_FAST_READ
, 
NULL
,

279 
æash_addr
, 
¤am_addr
, 
size
, 
SFCTRLv2_CMD_FAST_READ_FLAGS
);

280 
	}
}

282 
	$sfù¾v2_ÿlc_¤am_üc
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

283 
u32
 
¤am_addr
, 
size_t
 
size
, u32 *
üc
)

285 
»t
;

287 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_SRAM_ADDR
, 
¤am_addr
);

288 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_DATA_LENGTH
, (
u32
)
size
);

289 
	`sfù¾_wr™e_»g_check_»t
(
wr™eb
, 
rSFCTRLv2_SRAM_CRC_START
, 1);

291 if((
»t
 = 
	`wa™_sfù¾_xãr_comp
(
ùs_dev
)) != 0) {

292 
	`ùs_”r
("Wa™ sfù¾„—dy faed %d", 
»t
);

293  
»t
;

296 
	`sfù¾_»ad_»g_check_»t
(
»adl
, 
rSFCTRLv2_CRC_RESULT
, 
üc
);

299 
	}
}

301 
	$sfù¾v2_ÿlc_æash_üc
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

302 
u32
 
æash_addr
, 
size_t
 
size
, u32 *
üc
)

304 
»t
;

306 
	`ùs_šfo
("C®øüøäom fÏsh 0x%06x siz%zu", 
æash_addr
, 
size
);

308 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_FLASH_ADDR
, 
æash_addr
);

309 
	`sfù¾_wr™e_»g_check_»t
(
wr™–
, 
rSFCTRLv2_DATA_LENGTH
, (
u32
)
size
);

310 
	`sfù¾_wr™e_»g_check_»t
(
wr™eb
, 
rSFCTRLv2_FLASH_CRC_START
, 1);

312 if((
»t
 = 
	`wa™_sfù¾_xãr_comp
(
ùs_dev
)) != 0) {

313 
	`ùs_”r
("Wa™ sfù¾„—dy faed %d", 
»t
);

314  
»t
;

317 
	`sfù¾_»ad_»g_check_»t
(
»adl
, 
rSFCTRLv2_CRC_RESULT
, 
üc
);

320 
	}
}

322 cÚ¡ 
ùs_sfù¾_İs
 
	gùs_sfù¾v2_İs
 = {

323 .
rdid
 = 
sfù¾v2_rdid
,

324 .
	g£
 = 
sfù¾v2_£
,

325 .
	gbe
 = 
sfù¾v2_be
,

326 .
	g»ad
 = 
sfù¾v2_»ad
,

327 .
	g»ad_to_¤am
 = 
sfù¾v2_»ad_æash_to_¤am
,

328 .
	g´og¿m
 = 
sfù¾v2_µ
,

329 .
	g´og¿m_äom_¤am
 = 
sfù¾v2_´og¿m_æash_äom_¤am
,

330 .
	gÿlc_¤am_üc
 = 
sfù¾v2_ÿlc_¤am_üc
,

331 .
	gÿlc_æash_üc
 = 
sfù¾v2_ÿlc_æash_üc
,

	@cts_spi_flash.c

1 
	#LOG_TAG
 "FÏsh"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_sfù¾.h
"

7 
	~"ùs_¥i_æash.h
"

13 cÚ¡ 
ùs_æash
 
	gùs_æashes
[] = {

71 cÚ¡ 
ùs_æash
 *
	$fšd_æash_by_jedec_id
(
u32
 
jedec_id
)

73 
i
;

75 
i
 = 0; i < 
	`ARRAY_SIZE
(
ùs_æashes
); i++) {

76 ià(
ùs_æashes
[
i
].
jedec_id
 == jedec_id) {

77  &
ùs_æashes
[
i
];

81  
NULL
;

82 
	}
}

84 
	$´obe_æash
(
ùs_deviû
 *
ùs_dev
)

86 
»t
;

88 
	`ùs_šfo
("Probe flash");

90 ià(
ùs_dev
->
hwd©a
->
sfù¾
->
İs
->
rdid
 !ğ
NULL
) {

91 
u32
 
id
;

93 
	`ùs_šfo
("Read JEDEC ID");

95 
»t
 = 
ùs_dev
->
hwd©a
->
sfù¾
->
İs
->
	`rdid
(ùs_dev, &
id
);

96 ià(
»t
) {

97 
	`ùs_”r
("R—d JEDEC ID faed %d", 
»t
);

98  
»t
;

101 
ùs_dev
->
æash
 = 
	`fšd_æash_by_jedec_id
(
id
);

102 ià(
ùs_dev
->
æash
 =ğ
NULL
) {

103 
	`ùs_”r
("UnknowÀJEDEC ID: %06x", 
id
);

104  -
ENODEV
;

107 
	`ùs_šfo
("FÏshy³: '%s'", 
ùs_dev
->
æash
->
Çme
);

110 
	`ùs_”r
("Probe flash while„did == NULL");

111  -
ENOTSUPP
;

113 
	}
}

116 
	$”a£_£ùÜ_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

117 
u32
 
£ùÜ_addr
, 
»Œy
)

119 
»t
, 
»Œ›s
;

121 
	`ùs_šfo
(" E¿£ seùÜ 0x%06x", 
£ùÜ_addr
);

123 
»Œ›s
 = 0;

125 
»Œ›s
++;

126 
»t
 = 
ùs_dev
->
hwd©a
->
sfù¾
->
İs
->
	`£
(ùs_dev, 
£ùÜ_addr
);

127 ià(
»t
) {

128 
	`ùs_”r
("Erase sector 0x%06x failed %d„etries %d",

129 
£ùÜ_addr
, 
»t
, 
»Œ›s
);

132 } 
»Œ›s
 < 
»Œy
);

134  
»t
;

135 
	}
}

138 
šlše
 
	$”a£_£ùÜ
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

139 
u32
 
£ùÜ_addr
)

141  
	`”a£_£ùÜ_»Œy
(
ùs_dev
, 
£ùÜ_addr
, 
CTS_FLASH_ERASE_DEFAULT_RETRY
);

142 
	}
}

145 
	$”a£_block_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

146 
u32
 
block_addr
, 
»Œy
)

148 
»t
, 
»Œ›s
;

150 
	`ùs_šfo
(" E¿£ block 0x%06x", 
block_addr
);

152 
»Œ›s
 = 0;

154 
»Œ›s
++;

156 
»t
 = 
ùs_dev
->
hwd©a
->
sfù¾
->
İs
->
	`be
(ùs_dev, 
block_addr
);

157 ià(
»t
) {

158 
	`ùs_”r
("Erase block 0x%06x failed %d„etries %d",

159 
block_addr
, 
»t
, 
»Œ›s
);

162 } 
»Œ›s
 < 
»Œy
);

164  
»t
;

165 
	}
}

168 
šlše
 
	$”a£_block
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

169 
u32
 
block_addr
)

171  
	`”a£_block_»Œy
(
ùs_dev
, 
block_addr
, 
CTS_FLASH_ERASE_DEFAULT_RETRY
);

172 
	}
}

174 
	$ùs_´•¬e_æash_İ”©iÚ
(
ùs_deviû
 *
ùs_dev
)

176 
»t
;

177 
u8
 
diva
 = 0;

178 
boŞ
 
´og¿m_mode
 = 
	`ùs_is_deviû_´og¿m_mode
(
ùs_dev
);

179 
boŞ
 
’abËd
 = 
	`ùs_is_deviû_’abËd
(
ùs_dev
);

181 
	`ùs_šfo
("Prepare for flash operation");

183 ià(
’abËd
) {

184 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

185 ià(
»t
) {

186 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

187  
»t
;

191 ià(!
´og¿m_mode
) {

192 
»t
 = 
	`ùs_’‹r_´og¿m_mode
(
ùs_dev
);

193 ià(
»t
) {

194 
	`ùs_”r
("EÁ”…rog¿m modçed %d", 
»t
);

195 
”r_¡¬t_deviû
;

199 
»t
 = 
	`ùs_hw_»g_»adb_»Œy
(
ùs_dev
, 0x30033, &
diva
, 5, 0);

200 ià(
»t
) {

201 
	`ùs_w¬n
("R—d DIVA faed %d", 
»t
);

203 
	`ùs_dbg
("Deviû DIVA = %d", 
diva
);

206 ià(
»t
 =ğ0 && 
diva
 == 0x0C) {

207 
	`ùs_šfo
("DIVA is„eady‡lready");

209 
»Œ›s
;

212 
»t
 = 
	`ùs_hw_»g_wr™eb_»Œy
(
ùs_dev
, 0x30033, 0x0C, 5, 0);

213 ià(
»t
) {

214 
	`ùs_”r
("Wr™DIVA faed %d", 
»t
);

215 
”r_’‹r_nÜm®_mode
;

219 
»t
 = 
	`ùs_hw_»g_wr™eb_»Œy
(
ùs_dev
, 0x30008, 0xFB, 5, 0);

220 ià(
»t
) {

221 
	`ùs_”r
("Re£ˆsfùÈçed %d", 
»t
);

222 
”r_’‹r_nÜm®_mode
;

225 
»Œ›s
 = 0;

227 
u8
 
¡©e
;

229 
»t
 = 
	`ùs_hw_»g_»adb
(
ùs_dev
, 0x3401B, &
¡©e
);

230 ià(
»t
 =ğ0 && (
¡©e
 & 0x40) != 0) {

231 
š™_æash
;

234 
	`md–ay
(2);

235 } ++
»Œ›s
 < 1000);

237 
	`ùs_w¬n
("Wa™ SFCTRL„—dy faed %d", 
»t
);

241 
š™_æash
:

242 ià(
ùs_dev
->
æash
 =ğ
NULL
) {

243 
	`ùs_šfo
("Flash is‚ot initialized,ryo…robe...");

244 ià((
»t
 = 
	`´obe_æash
(
ùs_dev
)) != 0) {

245 
ùs_dev
->
¹d©a
.
has_æash
 = 
çl£
;

246 
	`ùs_w¬n
("Probæash faed %d", 
»t
);

251 
ùs_dev
->
¹d©a
.
has_æash
 = 
Œue
;

254 
”r_’‹r_nÜm®_mode
:

255 ià(!
´og¿m_mode
) {

256 
r
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

257 ià(
r
) {

258 
	`ùs_”r
("EÁ”‚Üm® modçed %d", 
r
);

261 
”r_¡¬t_deviû
:

262 ià(
’abËd
) {

263 
r
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

264 ià(
r
) {

265 
	`ùs_”r
("S¹ deviû faed %d", 
r
);

269  
»t
;

270 
	}
}

272 
	$ùs_po¡_æash_İ”©iÚ
(
ùs_deviû
 *
ùs_dev
)

274 
	`ùs_šfo
("Post flash operation");

276  
	`ùs_hw_»g_wr™eb_»Œy
(
ùs_dev
, 0x30033, 4, 5, 0);

277 
	}
}

279 
	$ùs_»ad_æash_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

280 
u32
 
æash_addr
, *
d¡
, 
size_t
 
size
, 
»Œy
)

282 cÚ¡ 
ùs_sfù¾
 *
sfù¾
;

283 cÚ¡ 
ùs_æash
 *
æash
;

284 
»t
;

286 
	`ùs_šfo
("R—d from 0x%06x siz%zu", 
æash_addr
, 
size
);

288 
sfù¾
 = 
ùs_dev
->
hwd©a
->sfctrl;

289 
æash
 = 
ùs_dev
->flash;

291 ià(
æash
 =ğ
NULL
 ||

292 
sfù¾
 =ğ
NULL
 ||

293 
sfù¾
->
İs
 =ğ
NULL
 ||

294 
sfù¾
->
İs
->
»ad
 =ğ
NULL
) {

295 
	`ùs_”r
("Read‚ot supported");

296  -
ENOTSUPP
;

299 ià(
æash_addr
 > 
æash
->
tÙ®_size
) {

300 
	`ùs_”r
("Read from 0x%06x > flash size 0x%06zx",

301 
æash_addr
, 
æash
->
tÙ®_size
);

302  -
EINVAL
;

304 
size
 = 
	`mš
(size, 
æash
->
tÙ®_size
 - 
æash_addr
);

306 
	`ùs_šfo
("R—d‡ùu®ly from 0x%06x siz%zu", 
æash_addr
, 
size
);

308 
size
) {

309 
size_t
 
l
;

311 
l
 = 
	`mš
(
sfù¾
->
xchg_¤am_size
, 
size
);

313 
»t
 = 
sfù¾
->
İs
->
	`»ad
(
ùs_dev
, 
æash_addr
, 
d¡
, 
l
);

314 if(
»t
 < 0) {

315 
	`ùs_”r
("Read from 0x%06x size %zu failed %d",

316 
æash_addr
, 
size
, 
»t
);

317  
»t
;

320 
d¡
 +ğ
l
;

321 
size
 -ğ
l
;

322 
æash_addr
 +ğ
l
;

326 
	}
}

328 
	$ùs_»ad_æash_to_¤am_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

329 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
, 
»Œy
)

331 cÚ¡ 
ùs_sfù¾
 *
sfù¾
;

332 cÚ¡ 
ùs_æash
 *
æash
;

333 
»t
, 
»Œ›s
;

335 
	`ùs_šfo
("Read from 0x%06xo sram 0x%06x size %zu",

336 
æash_addr
, 
¤am_addr
, 
size
);

338 
sfù¾
 = 
ùs_dev
->
hwd©a
->sfctrl;

339 
æash
 = 
ùs_dev
->flash;

341 ià(
æash
 =ğ
NULL
 ||

342 
sfù¾
 =ğ
NULL
 ||

343 
sfù¾
->
İs
 =ğ
NULL
 ||

344 
sfù¾
->
İs
->
»ad_to_¤am
 =ğ
NULL
) {

345 
	`ùs_”r
("Reado sram‚ot supported");

346  -
ENOTSUPP
;

349 ià(
æash_addr
 > 
æash
->
tÙ®_size
) {

350 
	`ùs_”r
("Reado sram from 0x%06x > flash size 0x%06zx",

351 
æash_addr
, 
æash
->
tÙ®_size
);

352  -
EINVAL
;

354 
size
 = 
	`mš
(size, 
æash
->
tÙ®_size
 - 
æash_addr
);

356 
	`ùs_šfo
("R—dØ¤am‡ùu®ly from 0x%06x siz%zu", 
æash_addr
, 
size
);

358 
»Œ›s
 = 0;

360 
»Œ›s
++;

361 
»t
 = 
sfù¾
->
İs
->
	`»ad_to_¤am
(
ùs_dev
, 
æash_addr
, 
¤am_addr
, 
size
);

362 if(
»t
) {

363 
	`ùs_”r
("Read from 0x%06xo sram 0x%06x size %zu failed %d„etries %d",

364 
æash_addr
, 
¤am_addr
, 
size
, 
»t
, 
»Œ›s
);

367 } 
»Œ›s
 < 
»Œy
);

369  
»t
;

370 
	}
}

372 
	$ùs_»ad_æash_to_¤am_check_üc_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

373 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
, u32 
üc
, 
»Œy
)

375 cÚ¡ 
ùs_sfù¾
 *
sfù¾
;

376 cÚ¡ 
ùs_æash
 *
æash
;

377 
»t
, 
»Œ›s
;

379 
	`ùs_šfo
("Read from 0x%06xo sram 0x%06x size %zu with crc check",

380 
æash_addr
, 
¤am_addr
, 
size
);

382 
sfù¾
 = 
ùs_dev
->
hwd©a
->sfctrl;

383 
æash
 = 
ùs_dev
->flash;

385 ià(
æash
 =ğ
NULL
 ||

386 
sfù¾
 =ğ
NULL
 ||

387 
sfù¾
->
İs
 =ğ
NULL
 ||

388 
sfù¾
->
İs
->
»ad_to_¤am
 =ğ
NULL
 ||

389 
sfù¾
->
İs
->
ÿlc_¤am_üc
 =ğ
NULL
) {

390 
	`ùs_”r
("Reado sram check crc‚ot supported");

391  -
ENOTSUPP
;

394 ià(
æash_addr
 > 
æash
->
tÙ®_size
) {

395 
	`ùs_”r
("Reado sram from 0x%06x > flash size 0x%06zx",

396 
æash_addr
, 
æash
->
tÙ®_size
);

397  -
EINVAL
;

399 
size
 = 
	`mš
(size, 
æash
->
tÙ®_size
 - 
æash_addr
);

401 
	`ùs_šfo
("Reado sram‡ctually from 0x%06x size %zu with crc check",

402 
æash_addr
, 
size
);

404 
»Œ›s
 = 0;

406 
u32
 
üc_¤am
;

408 
»Œ›s
++;

410 
»t
 = 
sfù¾
->
İs
->
	`»ad_to_¤am
(
ùs_dev
, 
æash_addr
, 
¤am_addr
, 
size
);

411 if(
»t
) {

412 
	`ùs_”r
("Read from 0x%06xo sram 0x%06x size %zu failed %d„etries %d",

413 
æash_addr
, 
¤am_addr
, 
size
, 
»t
, 
»Œ›s
);

417 
»t
 = 
sfù¾
->
İs
->
	`ÿlc_¤am_üc
(
ùs_dev
, 
¤am_addr
, 
size
, &
üc_¤am
);

418 ià(
»t
) {

419 
	`ùs_”r
("Get crc for„ead from 0x%06xo sram 0x%06x size %zu "

421 
æash_addr
, 
¤am_addr
, 
size
, 
»t
, 
»Œ›s
);

425 ià(
üc
 =ğ
üc_¤am
) {

429 
	`ùs_”r
("Check crc for„ead from 0x%06xo sram 0x%06x size %zu "

431 
æash_addr
, 
¤am_addr
, 
size
, 
üc
, 
üc_¤am
, 
»Œ›s
);

432 
»t
 = -
EFAULT
;

433 } 
»Œ›s
 < 
»Œy
);

435  
»t
;

436 
	}
}

438 
	$ùs_´og¿m_æash
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

439 
u32
 
æash_addr
, cÚ¡ *
¤c
, 
size_t
 
size
)

441 cÚ¡ 
ùs_sfù¾
 *
sfù¾
;

442 cÚ¡ 
ùs_æash
 *
æash
;

443 
»t
;

445 
	`ùs_šfo
("Prog¿mØ0x%06x siz%zu", 
æash_addr
, 
size
);

447 
sfù¾
 = 
ùs_dev
->
hwd©a
->sfctrl;

448 
æash
 = 
ùs_dev
->flash;

450 ià(
æash
 =ğ
NULL
 ||

451 
sfù¾
 =ğ
NULL
 ||

452 
sfù¾
->
İs
 =ğ
NULL
 ||

453 
sfù¾
->
İs
->
´og¿m
 =ğ
NULL
) {

454 
	`ùs_”r
("Program‚ot supported");

455  -
ENOTSUPP
;

458 ià(
æash_addr
 >ğ
æash
->
tÙ®_size
) {

459 
	`ùs_”r
("Program from 0x%06x >= flash size 0x%06zx",

460 
æash_addr
, 
æash
->
tÙ®_size
);

461  -
EINVAL
;

463 
size
 = 
	`mš
(size, 
æash
->
tÙ®_size
 - 
æash_addr
);

465 
	`ùs_šfo
("Prog¿m‡ùu®lyØ0x%06x siz%zu", 
æash_addr
, 
size
);

467 
size
) {

468 
size_t
 
l
, 
off£t
;

470 
l
 = 
	`mš
(
æash
->
·ge_size
, 
size
);

471 
off£t
 = 
æash_addr
 & (
æash
->
·ge_size
 - 1);

473 ià(
off£t
) {

474 
l
 = 
	`mš
(
æash
->
·ge_size
 - 
off£t
,†);

477 
»t
 = 
sfù¾
->
İs
->
	`´og¿m
(
ùs_dev
, 
æash_addr
, 
¤c
, 
l
);

478 if(
»t
) {

479 
	`ùs_”r
("Prog¿mØ0x%06x siz%zu faed %d", 
æash_addr
, 
l
, 
»t
);

480  
»t
;

483 
¤c
 +ğ
l
;

484 
size
 -ğ
l
;

485 
æash_addr
 +ğ
l
;

489 
	}
}

491 
	$ùs_´og¿m_æash_äom_¤am
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

492 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
)

494 cÚ¡ 
ùs_sfù¾
 *
sfù¾
;

495 cÚ¡ 
ùs_æash
 *
æash
;

496 
»t
;

498 
	`ùs_šfo
("Programo 0x%06x from sram 0x%06x size %zu",

499 
æash_addr
, 
¤am_addr
, 
size
);

501 
sfù¾
 = 
ùs_dev
->
hwd©a
->sfctrl;

502 
æash
 = 
ùs_dev
->flash;

504 ià(
æash
 =ğ
NULL
 ||

505 
sfù¾
 =ğ
NULL
 ||

506 
sfù¾
->
İs
 =ğ
NULL
 ||

507 
sfù¾
->
İs
->
´og¿m_äom_¤am
 =ğ
NULL
) {

508 
	`ùs_”r
("Program from sram‚ot supported");

509  -
ENOTSUPP
;

512 ià(
æash_addr
 >ğ
æash
->
tÙ®_size
) {

513 
	`ùs_”r
("Program from 0x%06x >= flash size 0x%06zx",

514 
æash_addr
, 
æash
->
tÙ®_size
);

515  -
EINVAL
;

517 
size
 = 
	`mš
(size, 
æash
->
tÙ®_size
 - 
æash_addr
);

519 
	`ùs_šfo
("Program‡ctuallyo 0x%06x from sram 0x%06x size %zu",

520 
æash_addr
, 
¤am_addr
, 
size
);

522 
size
) {

523 
size_t
 
l
, 
off£t
;

525 
l
 = 
	`mš
(
æash
->
·ge_size
, 
size
);

526 
off£t
 = 
æash_addr
 & (
æash
->
·ge_size
 - 1);

528 ià(
off£t
) {

529 
l
 = 
	`mš
(
æash
->
·ge_size
 - 
off£t
,†);

532 
»t
 = 
sfù¾
->
İs
->
	`´og¿m_äom_¤am
(
ùs_dev
, 
æash_addr
, 
¤am_addr
, 
l
);

533 if(
»t
) {

534 
	`ùs_”r
("Programo 0x%06x from sram 0x%06x size %zu failed %d",

535 
æash_addr
, 
¤am_addr
, 
l
, 
»t
);

536  
»t
;

539 
size
 -ğ
l
;

540 
æash_addr
 +ğ
l
;

541 
¤am_addr
 +ğ
l
;

545 
	}
}

547 
	$ùs_”a£_æash
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, 
size_t
 
size
)

549 cÚ¡ 
ùs_sfù¾
 *
sfù¾
;

550 cÚ¡ 
ùs_æash
 *
æash
;

551 
»t
;

553 
	`ùs_šfo
("E¿£ from 0x%06x siz%zu", 
addr
, 
size
);

555 
sfù¾
 = 
ùs_dev
->
hwd©a
->sfctrl;

556 
æash
 = 
ùs_dev
->flash;

558 ià(
æash
 =ğ
NULL
 ||

559 
sfù¾
 =ğ
NULL
 || sfù¾->
İs
 == NULL ||

560 
sfù¾
->
İs
->
£
 =ğ
NULL
 || sfù¾->İs->
be
 == NULL ||

561 
æash
 =ğ
NULL
) {

562 
	`ùs_”r
("Oops");

563  -
EINVAL
;

567 
addr
 = 
	`rounddown
×ddr, 
æash
->
£ùÜ_size
);

568 
size
 = 
	`roundup
(size, 
æash
->
£ùÜ_size
);

570 ià(
addr
 > 
æash
->
tÙ®_size
) {

571 
	`ùs_”r
("Erase from 0x%06x > flash size 0x%06zx",

572 
addr
, 
æash
->
tÙ®_size
);

573  -
EINVAL
;

575 
size
 = 
	`mš
(size, 
æash
->
tÙ®_size
 - 
addr
);

577 
	`ùs_šfo
("E¿£‡ùu®ly from 0x%06x siz%zu", 
addr
, 
size
);

579 ià(
æash
->
block_size
) {

580 
addr
 !ğ
	`ALIGN
×ddr, 
æash
->
block_size
) &&

581 
size
 >ğ
æash
->
£ùÜ_size
) {

582 
»t
 = 
	`”a£_£ùÜ
(
ùs_dev
, 
addr
);

583 ià(
»t
) {

584 
	`ùs_”r
("Erase sector 0x%06x size 0x%04zx failed %d",

585 
addr
, 
æash
->
£ùÜ_size
, 
»t
);

586  
»t
;

588 
addr
 +ğ
æash
->
£ùÜ_size
;

589 
size
 -ğ
æash
->
£ùÜ_size
;

592 
size
 >ğ
æash
->
block_size
) {

593 
»t
 = 
	`”a£_block
(
ùs_dev
, 
addr
);

594 ià(
»t
) {

595 
	`ùs_”r
("Erase block 0x%06x size 0x%04zx failed %d",

596 
addr
, 
æash
->
block_size
, 
»t
);

597  
»t
;

599 
addr
 +ğ
æash
->
block_size
;

600 
size
 -ğ
æash
->
block_size
;

604 
size
 >ğ
æash
->
£ùÜ_size
) {

605 
»t
 = 
	`”a£_£ùÜ
(
ùs_dev
, 
addr
);

606 ià(
»t
) {

607 
	`ùs_”r
("Erase sector 0x%06x size 0x%04zx failed %d",

608 
addr
, 
æash
->
£ùÜ_size
, 
»t
);

609  
»t
;

611 
addr
 +ğ
æash
->
£ùÜ_size
;

612 
size
 -ğ
æash
->
£ùÜ_size
;

616 
	}
}

	@cts_spi_flash.h

1 #iâdeà
CTS_SPI_FLASH_H


2 
	#CTS_SPI_FLASH_H


	)

4 
	sùs_æash
 {

5 cÚ¡ *
	mÇme
;

6 
u32
 
	mjedec_id
;

7 
size_t
 
	m·ge_size
;

8 
size_t
 
	m£ùÜ_size
;

9 
size_t
 
	mblock_size
;

11 
size_t
 
	mtÙ®_size
;

15 
	#CTS_FLASH_READ_DEFAULT_RETRY
 (3)

	)

16 
	#CTS_FLASH_ERASE_DEFAULT_RETRY
 (3)

	)

18 
	gùs_deviû
;

20 
ùs_´•¬e_æash_İ”©iÚ
(
ùs_deviû
 *
ùs_dev
);

21 
ùs_po¡_æash_İ”©iÚ
(
ùs_deviû
 *
ùs_dev
);

23 
ùs_»ad_æash_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

24 
u32
 
æash_addr
, *
d¡
, 
size_t
 
size
, 
»Œy
);

25 
šlše
 
	$ùs_»ad_æash
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

26 
u32
 
æash_addr
, *
d¡
, 
size_t
 
size
)

28  
	`ùs_»ad_æash_»Œy
(
ùs_dev
,

29 
æash_addr
, 
d¡
, 
size
, 
CTS_FLASH_READ_DEFAULT_RETRY
);

30 
	}
}

32 
ùs_»ad_æash_to_¤am_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

33 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
, 
»Œy
);

34 
šlše
 
	$ùs_»ad_æash_to_¤am
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

35 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
)

37  
	`ùs_»ad_æash_to_¤am_»Œy
(
ùs_dev
,

38 
æash_addr
, 
¤am_addr
, 
size
, 
CTS_FLASH_READ_DEFAULT_RETRY
);

39 
	}
}

41 
ùs_»ad_æash_to_¤am_check_üc_»Œy
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

42 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
, u32 
üc
, 
»Œy
);

43 
šlše
 
	$ùs_»ad_æash_to_¤am_check_üc
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

44 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
, u32 
üc
)

46  
	`ùs_»ad_æash_to_¤am_check_üc_»Œy
(
ùs_dev
,

47 
æash_addr
, 
¤am_addr
, 
size
, 
üc
, 
CTS_FLASH_READ_DEFAULT_RETRY
);

48 
	}
}

50 
ùs_”a£_æash
(cÚ¡ 
ùs_deviû
 *
ùs_dev
, 
u32
 
addr
, 
size_t
 
size
);

52 
ùs_´og¿m_æash
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

53 
u32
 
æash_addr
, cÚ¡ *
¤c
, 
size_t
 
size
);

54 
ùs_´og¿m_æash_äom_¤am
(cÚ¡ 
ùs_deviû
 *
ùs_dev
,

55 
u32
 
æash_addr
, u32 
¤am_addr
, 
size_t
 
size
);

	@cts_strerror.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/”ºo.h
>

4 
	#ERROR_TEXT_ENTRY
(
”ºo
, 
”r_desc_¡r
) \

5 [(
”ºo
)] = #”ºØ", " 
”r_desc_¡r


	)

7 cÚ¡ * cÚ¡ 
	g_”rÜ_‹xt
[] = {

9 
ERROR_TEXT_ENTRY
(
EPERM
, "Operation‚ot…ermitted"),

10 
ERROR_TEXT_ENTRY
(
ENOENT
, "No such file or directory"),

11 
ERROR_TEXT_ENTRY
(
ESRCH
, "No such…rocess"),

12 
ERROR_TEXT_ENTRY
(
EINTR
, "Interrupted system call"),

13 
ERROR_TEXT_ENTRY
(
EIO
, "Input/outputƒrror"),

14 
ERROR_TEXT_ENTRY
(
ENXIO
, "No such device or‡ddress"),

15 
ERROR_TEXT_ENTRY
(
E2BIG
, "Argument†istoo†ong"),

16 
ERROR_TEXT_ENTRY
(
ENOEXEC
, "Exec formatƒrror"),

17 
ERROR_TEXT_ENTRY
(
EBADF
, "Bad file descriptor"),

18 
ERROR_TEXT_ENTRY
(
ECHILD
, "No child…rocesses"),

19 
ERROR_TEXT_ENTRY
(
EAGAIN
, "Resourceemporarily unavailable"),

20 
ERROR_TEXT_ENTRY
(
ENOMEM
, "Cannot‡llocate memory"),

21 
ERROR_TEXT_ENTRY
(
EACCES
, "Permission denied"),

22 
ERROR_TEXT_ENTRY
(
EFAULT
, "Bad‡ddress"),

23 
ERROR_TEXT_ENTRY
(
ENOTBLK
, "Block device„equired"),

24 
ERROR_TEXT_ENTRY
(
EBUSY
, "Device or„esource busy"),

25 
ERROR_TEXT_ENTRY
(
EEXIST
, "Fileƒxists"),

26 
ERROR_TEXT_ENTRY
(
EXDEV
, "Invalid cross-device†ink"),

27 
ERROR_TEXT_ENTRY
(
ENODEV
, "No such device"),

28 
ERROR_TEXT_ENTRY
(
ENOTDIR
, "Not‡ directory"),

29 
ERROR_TEXT_ENTRY
(
EISDIR
, "Is‡ directory"),

30 
ERROR_TEXT_ENTRY
(
EINVAL
, "Invalid‡rgument"),

31 
ERROR_TEXT_ENTRY
(
EMFILE
, "Too many open files"),

32 
ERROR_TEXT_ENTRY
(
ENFILE
, "Too many open files in system"),

33 
ERROR_TEXT_ENTRY
(
ENOTTY
, "Inappropriate ioctl for device"),

34 
ERROR_TEXT_ENTRY
(
ETXTBSY
, "Text file busy"),

35 
ERROR_TEXT_ENTRY
(
EFBIG
, "Fileoo†arge"),

36 
ERROR_TEXT_ENTRY
(
ENOSPC
, "No space†eft on device"),

37 
ERROR_TEXT_ENTRY
(
ESPIPE
, "Illegal seek"),

38 
ERROR_TEXT_ENTRY
(
EROFS
, "Read-only file system"),

39 
ERROR_TEXT_ENTRY
(
EMLINK
, "Too many†inks"),

40 
ERROR_TEXT_ENTRY
(
EPIPE
, "Broken…ipe"),

41 
ERROR_TEXT_ENTRY
(
EDOM
, "Numerical‡rgument out of domain"),

42 
ERROR_TEXT_ENTRY
(
ERANGE
, "Numerical„esult out of„ange"),

43 
ERROR_TEXT_ENTRY
(
EDEADLK
, "Resource deadlock‡voided"),

44 
ERROR_TEXT_ENTRY
(
ENAMETOOLONG
, "File‚ameoo†ong"),

45 
ERROR_TEXT_ENTRY
(
ENOLCK
, "No†ocks‡vailable"),

46 
ERROR_TEXT_ENTRY
(
ENOSYS
, "Function‚ot implemented"),

47 
ERROR_TEXT_ENTRY
(
ENOTEMPTY
, "Directory‚otƒmpty"),

48 
ERROR_TEXT_ENTRY
(
ELOOP
, "Too many†evels of symbolic†inks"),

49 
ERROR_TEXT_ENTRY
(
EWOULDBLOCK
, "Operation would block"),

50 
ERROR_TEXT_ENTRY
(
ENOMSG
, "No message of desiredype"),

51 
ERROR_TEXT_ENTRY
(
EIDRM
, "Identifier„emoved"),

52 
ERROR_TEXT_ENTRY
(
ECHRNG
, "Channel‚umber out of„ange"),

53 
ERROR_TEXT_ENTRY
(
EL2NSYNC
, "Level 2‚ot synchronized"),

54 
ERROR_TEXT_ENTRY
(
EL3HLT
, "Level 3 halted"),

55 
ERROR_TEXT_ENTRY
(
EL3RST
, "Level 3„eset"),

56 
ERROR_TEXT_ENTRY
(
ELNRNG
, "Link‚umber out of„ange"),

57 
ERROR_TEXT_ENTRY
(
EUNATCH
, "Protocol driver‚ot‡ttached"),

58 
ERROR_TEXT_ENTRY
(
ENOCSI
, "No CSI structure‡vailable"),

59 
ERROR_TEXT_ENTRY
(
EL2HLT
, "Level 2 halted"),

60 
ERROR_TEXT_ENTRY
(
EBADE
, "Invalidƒxchange"),

61 
ERROR_TEXT_ENTRY
(
EBADR
, "Invalid„equest descriptor"),

62 
ERROR_TEXT_ENTRY
(
EXFULL
, "Exchange full"),

63 
ERROR_TEXT_ENTRY
(
ENOANO
, "No‡node"),

64 
ERROR_TEXT_ENTRY
(
EBADRQC
, "Invalid„equest code"),

65 
ERROR_TEXT_ENTRY
(
EBADSLT
, "Invalid slot"),

66 
ERROR_TEXT_ENTRY
(
EDEADLOCK
, "File†ocking deadlockƒrror"),

67 
ERROR_TEXT_ENTRY
(
EBFONT
, "Bad font file format"),

68 
ERROR_TEXT_ENTRY
(
ENOSTR
, "Device‚ot‡ stream"),

69 
ERROR_TEXT_ENTRY
(
ENODATA
, "No data‡vailable"),

70 
ERROR_TEXT_ENTRY
(
ETIME
, "Timerƒxpired"),

71 
ERROR_TEXT_ENTRY
(
ENOSR
, "Out of streams„esources"),

72 
ERROR_TEXT_ENTRY
(
ENONET
, "Machine is‚ot onhe‚etwork"),

73 
ERROR_TEXT_ENTRY
(
ENOPKG
, "Package‚ot installed"),

74 
ERROR_TEXT_ENTRY
(
EREMOTE
, "Object is„emote"),

75 
ERROR_TEXT_ENTRY
(
ENOLINK
, "Link has been severed"),

76 
ERROR_TEXT_ENTRY
(
EADV
, "Advertiseƒrror"),

77 
ERROR_TEXT_ENTRY
(
ESRMNT
, "Srmountƒrror"),

78 
ERROR_TEXT_ENTRY
(
ECOMM
, "Communicationƒrror on send"),

79 
ERROR_TEXT_ENTRY
(
EPROTO
, "Protocolƒrror"),

80 
ERROR_TEXT_ENTRY
(
EMULTIHOP
, "Multihop‡ttempted"),

81 
ERROR_TEXT_ENTRY
(
EDOTDOT
, "RFS specificƒrror"),

82 
ERROR_TEXT_ENTRY
(
EBADMSG
, "Bad message"),

83 
ERROR_TEXT_ENTRY
(
EOVERFLOW
, "Valueoo†arge for defined dataype"),

84 
ERROR_TEXT_ENTRY
(
ENOTUNIQ
, "Name‚ot unique on‚etwork"),

85 
ERROR_TEXT_ENTRY
(
EBADFD
, "File descriptor in bad state"),

86 
ERROR_TEXT_ENTRY
(
EREMCHG
, "Remote‡ddress changed"),

87 
ERROR_TEXT_ENTRY
(
ELIBACC
, "Can‚ot‡ccess‡‚eeded shared†ibrary"),

88 
ERROR_TEXT_ENTRY
(
ELIBBAD
, "Accessing‡ corrupted shared†ibrary"),

89 
ERROR_TEXT_ENTRY
(
ELIBSCN
, ".lib section in‡.out corrupted"),

90 
ERROR_TEXT_ENTRY
(
ELIBMAX
, "Attemptingo†ink inoo many shared†ibraries"),

91 
ERROR_TEXT_ENTRY
(
ELIBEXEC
, "Cannotƒxec‡ shared†ibrary directly"),

92 
ERROR_TEXT_ENTRY
(
EILSEQ
, "Invalid or incomplete multibyte or wide character"),

93 
ERROR_TEXT_ENTRY
(
ERESTART
, "Interrupted system call should be„estarted"),

94 
ERROR_TEXT_ENTRY
(
ESTRPIPE
, "Streams…ipeƒrror"),

95 
ERROR_TEXT_ENTRY
(
EUSERS
, "Too many users"),

96 
ERROR_TEXT_ENTRY
(
ENOTSOCK
, "Socket operation on‚on-socket"),

97 
ERROR_TEXT_ENTRY
(
EDESTADDRREQ
, "Destination‡ddress„equired"),

98 
ERROR_TEXT_ENTRY
(
EMSGSIZE
, "Messageoo†ong"),

99 
ERROR_TEXT_ENTRY
(
EPROTOTYPE
, "Protocol wrongype for socket"),

100 
ERROR_TEXT_ENTRY
(
ENOPROTOOPT
, "Protocol‚ot‡vailable"),

101 
ERROR_TEXT_ENTRY
(
EPROTONOSUPPORT
, "Protocol‚ot supported"),

102 
ERROR_TEXT_ENTRY
(
ESOCKTNOSUPPORT
, "Socketype‚ot supported"),

103 
ERROR_TEXT_ENTRY
(
EOPNOTSUPP
, "Operation‚ot supported"),

104 
ERROR_TEXT_ENTRY
(
EPFNOSUPPORT
, "Protocol family‚ot supported"),

105 
ERROR_TEXT_ENTRY
(
EAFNOSUPPORT
, "Address family‚ot supported by…rotocol"),

106 
ERROR_TEXT_ENTRY
(
EADDRINUSE
, "Address‡lready in use"),

107 
ERROR_TEXT_ENTRY
(
EADDRNOTAVAIL
, "Cannot‡ssign„equested‡ddress"),

108 
ERROR_TEXT_ENTRY
(
ENETDOWN
, "Network is down"),

109 
ERROR_TEXT_ENTRY
(
ENETUNREACH
, "Network is unreachable"),

110 
ERROR_TEXT_ENTRY
(
ENETRESET
, "Network dropped connection on„eset"),

111 
ERROR_TEXT_ENTRY
(
ECONNABORTED
, "Software caused connection‡bort"),

112 
ERROR_TEXT_ENTRY
(
ECONNRESET
, "Connection„eset by…eer"),

113 
ERROR_TEXT_ENTRY
(
ENOBUFS
, "No buffer space‡vailable"),

114 
ERROR_TEXT_ENTRY
(
EISCONN
, "Transportƒndpoint is‡lready connected"),

115 
ERROR_TEXT_ENTRY
(
ENOTCONN
, "Transportƒndpoint is‚ot connected"),

116 
ERROR_TEXT_ENTRY
(
ESHUTDOWN
, "Cannot send‡fterransportƒndpoint shutdown"),

117 
ERROR_TEXT_ENTRY
(
ETOOMANYREFS
, "Too many„eferences: cannot splice"),

118 
ERROR_TEXT_ENTRY
(
ETIMEDOUT
, "Connectionimed out"),

119 
ERROR_TEXT_ENTRY
(
ECONNREFUSED
, "Connection„efused"),

120 
ERROR_TEXT_ENTRY
(
EHOSTDOWN
, "Host is down"),

121 
ERROR_TEXT_ENTRY
(
EHOSTUNREACH
, "No„outeo host"),

122 
ERROR_TEXT_ENTRY
(
EALREADY
, "Operation‡lready in…rogress"),

123 
ERROR_TEXT_ENTRY
(
EINPROGRESS
, "Operation‚ow in…rogress"),

124 
ERROR_TEXT_ENTRY
(
ESTALE
, "Stale file handle"),

125 
ERROR_TEXT_ENTRY
(
EUCLEAN
, "Structure‚eeds cleaning"),

126 
ERROR_TEXT_ENTRY
(
ENOTNAM
, "Not‡ XENIX‚amedype file"),

127 
ERROR_TEXT_ENTRY
(
ENAVAIL
, "No XENIX semaphores‡vailable"),

128 
ERROR_TEXT_ENTRY
(
EISNAM
, "Is‡‚amedype file"),

129 
ERROR_TEXT_ENTRY
(
EREMOTEIO
, "Remote I/Oƒrror"),

130 
ERROR_TEXT_ENTRY
(
EDQUOT
, "Disk quotaƒxceeded"),

131 
ERROR_TEXT_ENTRY
(
ENOMEDIUM
, "No medium found"),

132 
ERROR_TEXT_ENTRY
(
EMEDIUMTYPE
, "Wrong mediumype"),

133 
ERROR_TEXT_ENTRY
(
ECANCELED
, "Operation canceled"),

134 
ERROR_TEXT_ENTRY
(
ENOKEY
, "Required key‚ot‡vailable"),

135 
ERROR_TEXT_ENTRY
(
EKEYEXPIRED
, "Key hasƒxpired"),

136 
ERROR_TEXT_ENTRY
(
EKEYREVOKED
, "Key has been„evoked"),

137 
ERROR_TEXT_ENTRY
(
EKEYREJECTED
, "Key was„ejected by service"),

138 
ERROR_TEXT_ENTRY
(
EOWNERDEAD
, "Owner died"),

139 
ERROR_TEXT_ENTRY
(
ENOTRECOVERABLE
, "State‚ot„ecoverable"),

140 
ERROR_TEXT_ENTRY
(
ERFKILL
, "Operation‚ot…ossible dueo RF-kill"),

141 
ERROR_TEXT_ENTRY
(
EHWPOISON
, "Memory…age has hardwareƒrror"),

142 
ERROR_TEXT_ENTRY
(
ERESTARTSYS
, "Restart system"),

143 
ERROR_TEXT_ENTRY
(
ERESTARTNOINTR
, "Restart monitor"),

144 
ERROR_TEXT_ENTRY
(
ERESTARTNOHAND
, "Restart if‚o handler"),

145 
ERROR_TEXT_ENTRY
(
ENOIOCTLCMD
, "No ioctl command"),

146 
ERROR_TEXT_ENTRY
(
ERESTART_RESTARTBLOCK
, "Restart by calling sys_restart_syscall"),

147 
ERROR_TEXT_ENTRY
(
EPROBE_DEFER
, "Driver„equests…robe„etry"),

148 
ERROR_TEXT_ENTRY
(
EOPENSTALE
, "Open found‡ stale dentry"),

150 
ERROR_TEXT_ENTRY
(
EBADHANDLE
, "Illegal NFS file handle"),

151 
ERROR_TEXT_ENTRY
(
ENOTSYNC
, "Update synchronization mismatch"),

152 
ERROR_TEXT_ENTRY
(
EBADCOOKIE
, "Cookie is stale"),

153 
ERROR_TEXT_ENTRY
(
ENOTSUPP
, "Operation is‚ot supported"),

154 
ERROR_TEXT_ENTRY
(
ETOOSMALL
, "Buffer or„equest isoo small"),

155 
ERROR_TEXT_ENTRY
(
ESERVERFAULT
, "An untranslatableƒrror occurred"),

156 
ERROR_TEXT_ENTRY
(
EBADTYPE
, "Type‚ot supported by server"),

157 
ERROR_TEXT_ENTRY
(
EJUKEBOX
, "Request initiated, but will‚ot complete beforeimeout"),

158 
ERROR_TEXT_ENTRY
(
EIOCBQUEUED
, "IOCB queued, will get completionƒvent"),

161 
	#ERROR_TEXT_ARRAY_SIZE
 ((
_”rÜ_‹xt
è/ (_”rÜ_‹xt[0]))

	)

163 cÚ¡ *
	$ùs_¡»¼Ü
(
”ºo
)

165 ià(
”ºo
 > 0) {

167 } ià(-
”ºo
 < ()
ERROR_TEXT_ARRAY_SIZE
) {

168 cÚ¡ *
s
 = 
_”rÜ_‹xt
[-
”ºo
];

169 ià(
s
) {

170  
s
;

175 
	}
}

	@cts_strerror.h

1 #iâdeà
CTS_STRERROR_H


2 
	#CTS_STRERROR_H


	)

4 
	#CTS_ERR_FMT_STR
 "%d(%s)"

	)

5 
	#CTS_ERR_ARG
(
”ºo
è”ºo, 
	`ùs_¡»¼Ü
Ó¼no)

	)

7 cÚ¡ *
ùs_¡»¼Ü
(
”ºo
);

	@cts_sysfs.c

1 
	#LOG_TAG
 "Sysfs"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_‹¡.h
"

7 
	~"ùs_sfù¾.h
"

8 
	~"ùs_¥i_æash.h
"

9 
	~"ùs_fœmw¬e.h
"

11 #ifdeà
CONFIG_CTS_SYSFS


13 
	#SPLIT_LINE_STR
 \

14 "-----------------------------------------------------------------------------------------------\n"

	)

15 
	#ROW_NUM_FORMAT_STR
 "%2d | "

	)

16 
	#COL_NUM_FORMAT_STR
 "%4u "

	)

17 
	#DATA_FORMAT_STR
 "%5d"

	)

20 
	#DIFFDATA_BUFFER_SIZE
(
ùs_dev
) \

21 (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
 * 2)

	)

23 
	#MAX_ARG_NUM
 (100)

	)

24 
	#MAX_ARG_LENGTH
 (1024)

	)

26 
	gcmdlše_·¿m
[
MAX_ARG_LENGTH
 + 1];

27 
	g¬gc
;

28 *
	g¬gv
[
MAX_ARG_NUM
];

30 
	gj™‹r_‹¡_äame
 = 10;

31 
s16
 *
	gmªu®diff_ba£
 = 
NULL
;

32 
u16
 
	g¥“d
 = 1000;

34 
	$·r£_¬g
(cÚ¡ *
buf
, 
size_t
 
couÁ
)

36 *
p
;

38 
	`memıy
(
cmdlše_·¿m
, 
buf
, 
	`mš
((
size_t
)
MAX_ARG_LENGTH
, 
couÁ
));

39 
cmdlše_·¿m
[
couÁ
] = '\0';

41 
¬gc
 = 0;

42 
p
 = 
	`¡rim
(
cmdlše_·¿m
);

43 ià(
p
 =ğ
NULL
 ||…[0] == '\0') {

47 
p
 &&…[0] !ğ'\0' && 
¬gc
 < 
MAX_ARG_NUM
) {

48 
¬gv
[
¬gc
++] = 
	`¡r£p
(&
p
, " ,");

51  
¬gc
;

52 
	}
}

55 
ssize_t
 
	$wr™e_fœmw¬e_»gi¡”_¡Üe
(
deviû
 *
dev
,

56 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

58 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

59 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

60 
u16
 
addr
;

61 
i
, 
»t
;

62 
u8
 *
d©a
 = 
NULL
;

64 
	`·r£_¬g
(
buf
, 
couÁ
);

66 
	`ùs_šfo
("Wr™fœmw¬»gi¡” '%.*s'", ()
couÁ
, 
buf
);

68 ià(
¬gc
 < 2) {

69 
	`ùs_”r
("ToØãw‡rg %d", 
¬gc
);

70  -
EFAULT
;

73 
»t
 = 
	`k¡¹ou16
(
¬gv
[0], 0, &
addr
);

74 ià(
»t
) {

75 
	`ùs_”r
("Inv®id‡dd»s %s", 
¬gv
[0]);

76  -
EINVAL
;

79 
d©a
 = (
u8
 *)
	`km®loc
(
¬gc
 - 1, 
GFP_KERNEL
);

80 ià(
d©a
 =ğ
NULL
) {

81 
	`ùs_”r
("Allocate buffer for write data failed\n");

82  -
ENOMEM
;

85 
i
 = 1; i < 
¬gc
; i++) {

86 
»t
 = 
	`k¡¹ou8
(
¬gv
[
i
], 0, 
d©a
 + i - 1);

87 ià(
»t
) {

88 
	`ùs_”r
("Inv®id v®u%s", 
¬gv
[
i
]);

89 
ä“_d©a
;

93 
»t
 = 
	`ùs_fw_»g_wr™esb
(
ùs_dev
, 
addr
, 
d©a
, 
¬gc
 - 1);

94 ià(
»t
) {

95 
	`ùs_”r
("Write firmware„egister‡ddr: 0x%04x size: %d failed",

96 
addr
, 
¬gc
 - 1);

97 
ä“_d©a
;

100 
ä“_d©a
:

101 
	`kä“
(
d©a
);

103  (
»t
 < 0 ?„‘ : 
couÁ
);

104 
	}
}

105 
DEVICE_ATTR
(
wr™e_»g
, 
S_IWUSR
, 
NULL
, 
wr™e_fœmw¬e_»gi¡”_¡Üe
);

107 
ssize_t
 
	$»ad_fœmw¬e_»gi¡”_show
(
deviû
 *
dev
,

108 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

110 
	#PRINT_ROW_SIZE
 (16)

	)

111 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

112 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

113 
u16
 
addr
, 
size
, 
i
, 
»maššg
;

114 
u8
 *
d©a
 = 
NULL
;

115 
ssize_t
 
couÁ
 = 0;

116 
»t
;

118 
	`ùs_šfo
("Read firmware„egister ");

120 ià(
¬gc
 != 2) {

121  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

124 " 2. c©„—d_»g\n", 
¬gc
);

127 
»t
 = 
	`k¡¹ou16
(
¬gv
[0], 0, &
addr
);

128 ià(
»t
) {

129  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id‡dd»ss: %s\n", 
¬gv
[0]);

131 
»t
 = 
	`k¡¹ou16
(
¬gv
[1], 0, &
size
);

132 ià(
»t
) {

133  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id size: %s\n", 
¬gv
[1]);

136 
d©a
 = (
u8
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

137 ià(
d©a
 =ğ
NULL
) {

138  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Allocate buffer for„ead data failed\n");

141 
	`ùs_šfo
("R—d fœmw¬»gi¡” from 0x%04x siz%u", 
addr
, 
size
);

142 
	`ùs_lock_deviû
(
ùs_dev
);

143 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
addr
, 
d©a
, (
size_t
)
size
);

144 
	`ùs_uÆock_deviû
(
ùs_dev
);

145 ià(
»t
) {

146 
couÁ
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
,

148 
addr
, 
size
, 
»t
);

149 
”r_ä“_d©a
;

152 
»maššg
 = 
size
;

153 
i
 = 0; i < 
size
 && 
couÁ
 <ğ
PAGE_SIZE
; i +ğ
PRINT_ROW_SIZE
) {

154 
size_t
 
lš–’
 = 
	`mš
((size_t)
»maššg
, (size_t)
PRINT_ROW_SIZE
);

155 
»maššg
 -ğ
PRINT_ROW_SIZE
;

157 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, "%04x: ", 
addr
);

160 
	`hex_dump_to_bufãr
(
d©a
 + 
i
, 
lš–’
, 
PRINT_ROW_SIZE
, 1,

161 
buf
 + 
couÁ
, 
PAGE_SIZE
 - couÁ, 
Œue
);

162 
couÁ
 +ğ
	`¡¾’
(
buf
 + count);

164 ià(
couÁ
 < 
PAGE_SIZE
) {

165 
buf
[
couÁ
++] = '\n';

166 
addr
 +ğ
PRINT_ROW_SIZE
;

172 
”r_ä“_d©a
:

173 
	`kä“
(
d©a
);

175  
couÁ
;

176 #undeà
PRINT_ROW_SIZE


177 
	}
}

180 
ssize_t
 
	$»ad_fœmw¬e_»gi¡”_¡Üe
(
deviû
 *
dev
,

181 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

183 
	`·r£_¬g
(
buf
, 
couÁ
);

185  (
¬gc
 =ğ0 ? 0 : 
couÁ
);

186 
	}
}

187 
DEVICE_ATTR
(
»ad_»g
, 
S_IWUSR
 | 
S_IRUSR
,

188 
»ad_fœmw¬e_»gi¡”_show
, 
»ad_fœmw¬e_»gi¡”_¡Üe
);

192 
ssize_t
 
	$»ad_hw_»g_show
(
deviû
 *
dev
,

193 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

195 
	#PRINT_ROW_SIZE
 (16)

	)

196 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

197 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

198 
u32
 
addr
, 
size
, 
i
, 
»maššg
;

199 
u8
 *
d©a
 = 
NULL
;

200 
ssize_t
 
couÁ
 = 0;

201 
»t
;

203 
	`ùs_šfo
("Read hw„egister");

205 ià(
¬gc
 != 2) {

206  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

209 " 2. c©„—d_hw_»g\n", 
¬gc
);

212 
»t
 = 
	`k¡¹ou32
(
¬gv
[0], 0, &
addr
);

213 ià(
»t
) {

214  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id‡dd»ss: %s\n", 
¬gv
[0]);

216 
»t
 = 
	`k¡¹ou32
(
¬gv
[1], 0, &
size
);

217 ià(
»t
) {

218  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id size: %s\n", 
¬gv
[1]);

221 
d©a
 = (
u8
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

222 ià(
d©a
 =ğ
NULL
) {

223  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Allocate buffer for„ead data failed\n");

226 
	`ùs_šfo
("R—d hw„egi¡” from 0x%08x siz%u", 
addr
, 
size
);

227 
	`ùs_lock_deviû
(
ùs_dev
);

228 
»t
 = 
	`ùs_hw_»g_»adsb
(
ùs_dev
, 
addr
, 
d©a
, 
size
);

229 
	`ùs_uÆock_deviû
(
ùs_dev
);

231 ià(
»t
) {

232 
couÁ
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
, "R—d hw„egi¡” faed %d", 
»t
);

233 
”r_ä“_d©a
;

236 
»maššg
 = 
size
;

237 
i
 = 0; i < 
size
 && 
couÁ
 <ğ
PAGE_SIZE
; i +ğ
PRINT_ROW_SIZE
) {

238 
size_t
 
lš–’
 = 
	`mš
((size_t)
»maššg
, (size_t)
PRINT_ROW_SIZE
);

239 
»maššg
 -ğ
PRINT_ROW_SIZE
;

241 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count, "%04x-%04x: ",

242 (
u16
)(
addr
 >> 16), (u16)addr);

245 
	`hex_dump_to_bufãr
(
d©a
 + 
i
, 
lš–’
, 
PRINT_ROW_SIZE
, 1,

246 
buf
 + 
couÁ
, 
PAGE_SIZE
 - couÁ, 
Œue
);

247 
couÁ
 +ğ
	`¡¾’
(
buf
 + count);

249 ià(
couÁ
 < 
PAGE_SIZE
) {

250 
buf
[
couÁ
++] = '\n';

251 
addr
 +ğ
PRINT_ROW_SIZE
;

257 
”r_ä“_d©a
:

258 
	`kä“
(
d©a
);

260  
couÁ
;

261 #undeà
PRINT_ROW_SIZE


262 
	}
}

265 
ssize_t
 
	$»ad_hw_»g_¡Üe
(
deviû
 *
dev
,

266 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

268 
	`·r£_¬g
(
buf
, 
couÁ
);

270  (
¬gc
 =ğ0 ? 0 : 
couÁ
);

271 
	}
}

273 
DEVICE_ATTR
(
»ad_hw_»g
, 
S_IRUSR
 | 
S_IWUSR
, 
»ad_hw_»g_show
, 
»ad_hw_»g_¡Üe
);

275 
ssize_t
 
	$wr™e_hw_»g_¡Üe
(
deviû
 *
dev
,

276 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

278 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

279 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

280 
u32
 
addr
;

281 
i
, 
»t
;

282 
u8
 *
d©a
 = 
NULL
;

284 
	`·r£_¬g
(
buf
, 
couÁ
);

286 
	`ùs_šfo
("Write hw„egister");

288 ià(
¬gc
 < 2) {

289 
	`ùs_”r
("ToØãw‡rg %d", 
¬gc
);

290  -
EFAULT
;

293 
»t
 = 
	`k¡¹ou32
(
¬gv
[0], 0, &
addr
);

294 ià(
»t
) {

295 
	`ùs_”r
("Inv®id‡dd»s %s", 
¬gv
[0]);

296  -
EINVAL
;

299 
d©a
 = (
u8
 *)
	`km®loc
(
¬gc
 - 1, 
GFP_KERNEL
);

300 ià(
d©a
 =ğ
NULL
) {

301 
	`ùs_”r
("Allocate buffer for write data failed\n");

302  -
ENOMEM
;

305 
i
 = 1; i < 
¬gc
; i++) {

306 
»t
 = 
	`k¡¹ou8
(
¬gv
[
i
], 0, 
d©a
 + i - 1);

307 ià(
»t
) {

308 
	`ùs_”r
("Inv®id v®u%s", 
¬gv
[
i
]);

309 
ä“_d©a
;

313 
	`ùs_šfo
("Wr™hw„egi¡” from 0x%08x siz%u", 
addr
, 
¬gc
 - 1);

315 
	`ùs_lock_deviû
(
ùs_dev
);

316 
»t
 = 
	`ùs_hw_»g_wr™esb
(
ùs_dev
, 
addr
, 
d©a
, 
¬gc
 - 1);

317 
	`ùs_uÆock_deviû
(
ùs_dev
);

319 ià(
»t
) {

320 
	`ùs_”r
("Wr™hw„egi¡” faed %d", 
»t
);

323 
ä“_d©a
:

324 
	`kä“
(
d©a
);

326  (
»t
 < 0 ?„‘ : 
couÁ
);

327 
	}
}

329 
DEVICE_ATTR
(
wr™e_hw_»g
, 
S_IWUSR
, 
NULL
, 
wr™e_hw_»g_¡Üe
);

332 
ssize_t
 
	$cu¼_fœmw¬e_v”siÚ_show
(
deviû
 *
dev
,

333 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

335 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

337  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Current firmware version: %04x\n",

338 
ùs_d©a
->
ùs_dev
.
fwd©a
.
v”siÚ
);

339 
	}
}

340 
DEVICE_ATTR
(
cu¼_v”siÚ
, 
S_IRUGO
, 
cu¼_fœmw¬e_v”siÚ_show
, 
NULL
);

342 
ssize_t
 
	$cu¼_ddi_v”siÚ_show
(
deviû
 *
dev
,

343 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

345 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

347  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Current ddi version: %02x\n",

348 
ùs_d©a
->
ùs_dev
.
fwd©a
.
ddi_v”siÚ
);

349 
	}
}

350 
DEVICE_ATTR
(
cu¼_ddi_v”siÚ
, 
S_IRUGO
, 
cu¼_ddi_v”siÚ_show
, 
NULL
);

352 
ssize_t
 
	$rows_show
(
deviû
 *
dev
,

353 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

355 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

357  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Num„ows: %u\n",

358 
ùs_d©a
->
ùs_dev
.
fwd©a
.
rows
);

359 
	}
}

360 
DEVICE_ATTR
(
rows
, 
S_IRUGO
, 
rows_show
, 
NULL
);

362 
ssize_t
 
	$cŞs_show
(
deviû
 *
dev
,

363 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

365 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

367  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Num cols: %u\n",

368 
ùs_d©a
->
ùs_dev
.
fwd©a
.
cŞs
);

369 
	}
}

370 
DEVICE_ATTR
(
cŞs
, 
S_IRUGO
, 
cŞs_show
, 
NULL
);

372 
ssize_t
 
	$»s_x_show
(
deviû
 *
dev
,

373 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

375 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

377  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "X Resolution: %u\n",

378 
ùs_d©a
->
ùs_dev
.
fwd©a
.
»s_x
);

379 
	}
}

380 
DEVICE_ATTR
(
»s_x
, 
S_IRUGO
, 
»s_x_show
, 
NULL
);

382 
ssize_t
 
	$»s_y_show
(
deviû
 *
dev
,

383 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

385 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

387  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Y Resolution: %u\n",

388 
ùs_d©a
->
ùs_dev
.
fwd©a
.
»s_y
);

389 
	}
}

390 
DEVICE_ATTR
(
»s_y
, 
S_IRUGO
, 
»s_y_show
, 
NULL
);

392 
ssize_t
 
	$esd_´ÙeùiÚ_show
(
deviû
 *
dev
,

393 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

395 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

396 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

397 
»t
;

398 
u8
 
esd_´ÙeùiÚ
;

400 
	`ùs_lock_deviû
(
ùs_dev
);

401 
»t
 = 
	`ùs_fw_»g_»adb
(&
ùs_d©a
->
ùs_dev
,

402 
CTS_DEVICE_FW_REG_ESD_PROTECTION
, &
esd_´ÙeùiÚ
);

403 
	`ùs_uÆock_deviû
(
ùs_dev
);

404 ià(
»t
) {

405  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

406 "R—d fœmw¬ESD…rÙeùiÚ„egi¡” faed %d\n", 
»t
);

409  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "ESD…rÙeùiÚ: %u\n", 
esd_´ÙeùiÚ
);

410 
	}
}

411 
DEVICE_ATTR
(
esd_´ÙeùiÚ
, 
S_IRUGO
, 
esd_´ÙeùiÚ_show
, 
NULL
);

413 
ssize_t
 
	$mÚ™Ü_mode_show
(
deviû
 *
dev
,

414 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

416 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

417 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

418 
»t
;

419 
u8
 
v®ue
;

421 
	`ùs_lock_deviû
(
ùs_dev
);

422 
»t
 = 
	`ùs_fw_»g_»adb
(&
ùs_d©a
->
ùs_dev
,

423 
CTS_DEVICE_FW_REG_FLAG_BITS
, &
v®ue
);

424 
	`ùs_uÆock_deviû
(
ùs_dev
);

425 ià(
»t
) {

426  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

427 "R—d fœmw¬mÚ™ÜƒÇbË„egi¡” faed %d\n", 
»t
);

430  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Monitor mode: %s\n",

431 
v®ue
 & 
	`BIT
(0) ? "Enable" : "Disable");

432 
	}
}

434 
ssize_t
 
	$mÚ™Ü_mode_¡Üe
(
deviû
 *
dev
,

435 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

437 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

438 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

439 
»t
;

440 
u8
 
v®ue
, 
’abË
 = 0;

442 ià(
buf
[0] == 'Y' || buf[0] == 'y' || buf[0] == '1') {

443 
’abË
 = 1;

446 
	`ùs_šfo
("Write firmware monitor modeo '%c', %s",

447 
buf
[0], 
’abË
 ? "Enable" : "Disable");

449 
	`ùs_lock_deviû
(
ùs_dev
);

450 
»t
 = 
	`ùs_fw_»g_»adb
(&
ùs_d©a
->
ùs_dev
,

451 
CTS_DEVICE_FW_REG_FLAG_BITS
, &
v®ue
);

452 
	`ùs_uÆock_deviû
(
ùs_dev
);

453 ià(
»t
) {

454 
	`ùs_”r
("Wr™fœmw¬mÚ™ÜƒÇbË„egi¡” faed %d", 
»t
);

455  -
EIO
;

458 ià((
v®ue
 & 
	`BIT
(0)è&& 
’abË
) {

459 
	`ùs_šfo
("Monitor mode‡lreadyƒnabled");

460 } ià((
v®ue
 & 
	`BIT
(0)è=ğ0 && 
’abË
 == 0) {

461 
	`ùs_šfo
("Monitor mode‡lready disabled");

463 ià(
’abË
) {

464 
v®ue
 |ğ
	`BIT
(0);

466 
v®ue
 &ğ~
	`BIT
(0);

469 
	`ùs_lock_deviû
(
ùs_dev
);

470 
»t
 = 
	`ùs_fw_»g_wr™eb
(&
ùs_d©a
->
ùs_dev
,

471 
CTS_DEVICE_FW_REG_FLAG_BITS
, 
v®ue
);

472 
	`ùs_uÆock_deviû
(
ùs_dev
);

473 ià(
»t
) {

474 
	`ùs_”r
("Wr™fœmw¬mÚ™ÜƒÇbË„egi¡” faed %d", 
»t
);

475  -
EIO
;

479  
couÁ
;

480 
	}
}

481 
DEVICE_ATTR
(
mÚ™Ü_mode
, 
S_IRUGO
, 
mÚ™Ü_mode_show
, 
mÚ™Ü_mode_¡Üe
);

483 
ssize_t
 
	$auto_com³n§‹_show
(
deviû
 *
dev
,

484 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

486 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

487 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

488 
»t
;

489 
u8
 
v®ue
;

491 
	`ùs_lock_deviû
(
ùs_dev
);

492 
»t
 = 
	`ùs_fw_»g_»adb
(&
ùs_d©a
->
ùs_dev
,

493 
CTS_DEVICE_FW_REG_AUTO_CALIB_COMP_CAP_ENABLE
, &
v®ue
);

494 
	`ùs_uÆock_deviû
(
ùs_dev
);

495 ià(
»t
) {

496  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

497 "R—d‡utØcom³n§‹ƒÇbË„egi¡” faed %d\n", 
»t
);

500  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

501 "AutØcom³n§‹: %s\n", 
v®ue
 ? "Enable" : "Disable");

502 
	}
}

503 
DEVICE_ATTR
(
auto_com³n§‹
, 
S_IRUGO
, 
auto_com³n§‹_show
, 
NULL
);

505 #ifdeà
CFG_CTS_DRIVER_BUILTIN_FIRMWARE


506 
ssize_t
 
	$driv”_butš_fœmw¬e_show
(
deviû
 *
dev
,

507 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

509 
i
, 
couÁ
 = 0;

511 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

513 
	`ùs_g‘_num_driv”_butš_fœmw¬e
());

515 
i
 = 0; i < 
	`ùs_g‘_num_driv”_butš_fœmw¬e
(); i++) {

516 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
 =

517 
	`ùs_»que¡_driv”_butš_fœmw¬e_by_šdex
(
i
);

518 ià(
fœmw¬e
) {

519 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

521 
i
, 
fœmw¬e
->
hwid
, fœmw¬e->
fwid
, 
	`FIRMWARE_VERSION
(firmware),

522 
fœmw¬e
->
size
, fœmw¬e->
Çme
);

524 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

525 "%-2d: INVALID\n", 
i
);

529  
couÁ
;

530 
	}
}

533 
ssize_t
 
	$driv”_butš_fœmw¬e_¡Üe
(
deviû
 *
dev
,

534 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

536 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

537 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

538 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

539 
boŞ
 
to_æash
 = 
Œue
;

540 
»t
, 
šdex
 = -1;

542 
	`·r£_¬g
(
buf
, 
couÁ
);

544 ià(
¬gc
 != 1 &&‡rgc != 2) {

545 
	`ùs_”r
("Invalid‚um‡rgs %d\n"

546 "ƒchØšdex/Çm[æash/¤am] > driv”_butš_fœmw¬e\n", 
¬gc
);

547  -
EFAULT
;

550 ià(
	`isdig™
(*
¬gv
[0])) {

551 
šdex
 = 
	`sim¶e_¡¹oul
(
¬gv
[0], 
NULL
, 0);

554 ià(
¬gc
 > 1) {

555 ià(
	`¡ºÿ£cmp
(
¬gv
[1], "flash", 5) == 0) {

556 
to_æash
 = 
Œue
;

557 } ià(
	`¡ºÿ£cmp
(
¬gv
[1], "sram", 4) == 0) {

558 
to_æash
 = 
çl£
;

560 
	`ùs_”r
("Inv®id†oÿtiÚ '%s', mu¡ b'æash' o¸'¤am'", 
¬gv
[1]);

561  -
EINVAL
;

565 
	`ùs_šfo
("Update driver builtin firmware '%s'o %s",

566 
¬gv
[1], 
to_æash
 ? "flash" : "sram");

568 ià(
šdex
 >ğ0 && index < 
	`ùs_g‘_num_driv”_butš_fœmw¬e
()) {

569 
fœmw¬e
 = 
	`ùs_»que¡_driv”_butš_fœmw¬e_by_šdex
(
šdex
);

571 
fœmw¬e
 = 
	`ùs_»que¡_driv”_butš_fœmw¬e_by_Çme
(
¬gv
[0]);

574 ià(
fœmw¬e
) {

575 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

576 ià(
»t
) {

577 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

578  
»t
;

581 
	`ùs_lock_deviû
(
ùs_dev
);

582 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, 
fœmw¬e
, 
to_æash
);

583 
	`ùs_uÆock_deviû
(
ùs_dev
);

585 ià(
»t
) {

586 
	`ùs_”r
("Upd©fœmw¬çed %d", 
»t
);

587 
”r_¡¬t_deviû
;

590 
»t
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

591 ià(
»t
) {

592 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

593  
»t
;

596 
	`ùs_”r
("Fœmw¬'%s' NOT found", 
¬gv
[0]);

597  -
ENOENT
;

600  
couÁ
;

602 
”r_¡¬t_deviû
:

603 
	`ùs_¡¬t_deviû
(
ùs_dev
);

605  
»t
;

606 
	}
}

607 
DEVICE_ATTR
(
driv”_butš_fœmw¬e
, 
S_IWUSR
 | 
S_IRUGO
,

608 
driv”_butš_fœmw¬e_show
, 
driv”_butš_fœmw¬e_¡Üe
);

611 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


613 
ssize_t
 
	$upd©e_fœmw¬e_äom_fe_¡Üe
(
deviû
 *
dev
,

614 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

616 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

617 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

618 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

619 
boŞ
 
to_æash
 = 
Œue
;

620 
»t
;

623 
	`·r£_¬g
(
buf
, 
couÁ
);

625 ià(
¬gc
 > 2) {

626 
	`ùs_”r
("Invalid‚um‡rgs %d\n"

627 "ƒchØf•©h [æash/¤am] > upd©e_äom_fe\n", 
¬gc
);

628  -
EFAULT
;

629 } ià(
¬gc
 > 1) {

630 ià(
	`¡ºÿ£cmp
(
¬gv
[1], "flash", 5) == 0) {

631 
to_æash
 = 
Œue
;

632 } ià(
	`¡ºÿ£cmp
(
¬gv
[1], "sram", 4) == 0) {

633 
to_æash
 = 
çl£
;

635 
	`ùs_”r
("Inv®id†oÿtiÚ '%s', mu¡ b'æash' o¸'¤am'", 
¬gv
[1]);

636  -
EINVAL
;

640 
	`ùs_šfo
("Upd©fœmw¬äom f'%s'", 
¬gv
[0]);

642 
fœmw¬e
 = 
	`ùs_»que¡_fœmw¬e_äom_fs
(
¬gv
[0]);

643 ià(
fœmw¬e
 =ğ
NULL
) {

644 
	`ùs_”r
("Reque¡ fœmw¬äom f'%s' faed", 
¬gv
[0]);

645  -
ENOENT
;

648 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

649 ià(
»t
) {

650 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

651 
”r_»Ëa£_fœmw¬e
;

654 
	`ùs_lock_deviû
(
ùs_dev
);

655 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, 
fœmw¬e
, 
to_æash
);

656 
	`ùs_uÆock_deviû
(
ùs_dev
);

658 ià(
»t
) {

659 
	`ùs_”r
("Upd©fœmw¬çed %d", 
»t
);

660 
”r_»Ëa£_fœmw¬e
;

663 
»t
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

664 ià(
»t
) {

665 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

666 
”r_»Ëa£_fœmw¬e
;

669  
couÁ
;

671 
”r_»Ëa£_fœmw¬e
:

672 
	`ùs_»Ëa£_fœmw¬e
(
fœmw¬e
);

674  
»t
;

675 
	}
}

676 
DEVICE_ATTR
(
upd©e_äom_fe
, 
S_IWUSR
, 
NULL
, 
upd©e_fœmw¬e_äom_fe_¡Üe
);

679 
ssize_t
 
	$upd©šg_show
(
deviû
 *
dev
,

680 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

682 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

684  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Updating: %s\n",

685 
ùs_d©a
->
ùs_dev
.
¹d©a
.
upd©šg
 ? "Y" : "N");

686 
	}
}

687 
DEVICE_ATTR
(
upd©šg
, 
S_IRUGO
, 
upd©šg_show
, 
NULL
);

689 
©Œibu‹
 *
	gùs_dev_fœmw¬e_©ts
[] = {

690 &
dev_©Œ_cu¼_v”siÚ
.
©Œ
,

691 &
dev_©Œ_cu¼_ddi_v”siÚ
.
©Œ
,

692 &
dev_©Œ_rows
.
©Œ
,

693 &
dev_©Œ_cŞs
.
©Œ
,

694 &
dev_©Œ_»s_x
.
©Œ
,

695 &
dev_©Œ_»s_y
.
©Œ
,

696 &
dev_©Œ_esd_´ÙeùiÚ
.
©Œ
,

697 &
dev_©Œ_mÚ™Ü_mode
.
©Œ
,

698 &
dev_©Œ_auto_com³n§‹
.
©Œ
,

699 #ifdeà
CFG_CTS_DRIVER_BUILTIN_FIRMWARE


700 &
dev_©Œ_driv”_butš_fœmw¬e
.
©Œ
,

702 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


703 &
dev_©Œ_upd©e_äom_fe
.
©Œ
,

705 &
dev_©Œ_upd©šg
.
©Œ
,

706 
NULL


709 cÚ¡ 
©Œibu‹_group
 
	gùs_dev_fœmw¬e_©Œ_group
 = {

710 .
Çme
 = "cts_firmware",

711 .
	g©Œs
 = 
ùs_dev_fœmw¬e_©ts
,

714 
ssize_t
 
	$æash_šfo_show
(
deviû
 *
dev
,

715 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

717 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

718 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

719 cÚ¡ 
ùs_æash
 *
æash
;

721 ià(
ùs_dev
->
æash
 =ğ
NULL
) {

722 
boŞ
 
´og¿m_mode
;

723 
boŞ
 
’abËd
;

724 
»t
;

726 
´og¿m_mode
 = 
	`ùs_is_deviû_´og¿m_mode
(
ùs_dev
);

727 
’abËd
 = 
	`ùs_is_deviû_’abËd
(
ùs_dev
);

729 
»t
 = 
	`ùs_´•¬e_æash_İ”©iÚ
(
ùs_dev
);

730 ià(
»t
) {

731  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "P»·» fÏsh o³¿tiÚ faed %d", 
»t
);

734 
	`ùs_po¡_æash_İ”©iÚ
(
ùs_dev
);

736 ià(!
´og¿m_mode
) {

737 
»t
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

738 ià(
»t
) {

739  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "EÁ”‚Üm® modçed %d", 
»t
);

743 ià(
’abËd
) {

744 
»t
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

745 ià(
»t
) {

746  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "S¹ deviû faed %d", 
»t
);

750 ià(
ùs_dev
->
æash
 =ğ
NULL
) {

751  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Flash‚ot found\n");

755 
æash
 = 
ùs_dev
->flash;

756  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

763 
æash
->
Çme
, fÏsh->
jedec_id
, fÏsh->
·ge_size
,

764 
æash
->
£ùÜ_size
, fÏsh->
block_size
, fÏsh->
tÙ®_size
);

765 
	}
}

766 
DEVICE_ATTR
(
šfo
, 
S_IRUGO
, 
æash_šfo_show
, 
NULL
);

768 
ssize_t
 
	$»ad_æash_show
(
deviû
 *
dev
,

769 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

771 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

772 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

773 
u32
 
æash_addr
, 
size
, 
i
, 
»maššg
;

774 
u8
 *
d©a
 = 
NULL
;

775 
ssize_t
 
couÁ
 = 0;

776 
»t
;

777 
boŞ
 
´og¿m_mode
;

778 
boŞ
 
’abËd
;

779 
loff_t
 
pos
 = 0;

781 ià(
¬gc
 != 2 &&‡rgc != 3) {

782  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id‚um‡rg %d\n", 
¬gc
);

785 
»t
 = 
	`k¡¹ou32
(
¬gv
[0], 0, &
æash_addr
);

786 ià(
»t
) {

787  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id fÏsh‡ddr: %s\n", 
¬gv
[0]);

789 
»t
 = 
	`k¡¹ou32
(
¬gv
[1], 0, &
size
);

790 ià(
»t
) {

791  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id size: %s\n", 
¬gv
[1]);

794 
d©a
 = (
u8
 *)
	`km®loc
(
size
, 
GFP_KERNEL
);

795 ià(
d©a
 =ğ
NULL
) {

796  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Allocate buffer for„ead data failed\n");

799 
	`ùs_šfo
("Read flash from 0x%06x size %u%s%s",

800 
æash_addr
, 
size
, 
¬gc
 == 3 ? "o file " : "",

801 
¬gc
 =ğ3 ? 
¬gv
[2] : "");

803 
	`ùs_lock_deviû
(
ùs_dev
);

804 
´og¿m_mode
 = 
	`ùs_is_deviû_´og¿m_mode
(
ùs_dev
);

805 
’abËd
 = 
	`ùs_is_deviû_’abËd
(
ùs_dev
);

807 
»t
 = 
	`ùs_´•¬e_æash_İ”©iÚ
(
ùs_dev
);

808 ià(
»t
) {

809 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "P»·» fÏsh o³¿tiÚ faed %d", 
»t
);

810 
”r_ä“_d©a
;

813 
»t
 = 
	`ùs_»ad_æash
(
ùs_dev
, 
æash_addr
, 
d©a
, 
size
);

814 ià(
»t
) {

815 
couÁ
 = 
	`sú´štf
(
buf
, 
PAGE_SIZE
, "R—d fÏsh d©¨çed %d\n", 
»t
);

816 
”r_po¡_æash_İ”©iÚ
;

819 ià(
¬gc
 == 3) {

820 
fe
 *file;

822 
	`ùs_šfo
("Wr™æash d©¨tØf'%s'", 
¬gv
[2]);

824 
fe
 = 
	`fp_İ’
(
¬gv
[2], 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 0666);

825 ià(
	`IS_ERR
(
fe
)) {

826 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Open file '%s' failed %ld",

827 
¬gv
[2], 
	`PTR_ERR
(
fe
));

828 
”r_po¡_æash_İ”©iÚ
;

830 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

831 
»t
 = 
	`k”Ãl_wr™e
(
fe
, 
d©a
, 
size
, &
pos
);

833 
»t
 = 
	`k”Ãl_wr™e
(
fe
, 
d©a
, 
size
, 
pos
);

835 ià(
»t
 !ğ
size
) {

836 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Write flash datao file '%s' failed %d",

837 
¬gv
[2], 
»t
);

840 
»t
 = 
	`fp_şo£
(
fe
, 
NULL
);

841 ià(
»t
) {

842 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Clo£ f'%s' faed %d", 
¬gv
[2], 
»t
);

845 
	#PRINT_ROW_SIZE
 (16)

	)

846 
»maššg
 = 
size
;

847 
i
 = 0; i < 
size
 && 
couÁ
 <ğ
PAGE_SIZE
; i +ğ
PRINT_ROW_SIZE
) {

848 
size_t
 
lš–’
 = 
	`mš
((size_t)
»maššg
, (size_t)
PRINT_ROW_SIZE
);

849 
»maššg
 -ğ
PRINT_ROW_SIZE
;

851 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count - 1,

852 "%04x-%04x: ", 
æash_addr
 >> 16, flash_addr & 0xFFFF);

854 
	`hex_dump_to_bufãr
(
d©a
 + 
i
, 
lš–’
, 
PRINT_ROW_SIZE
, 1,

855 
buf
 + 
couÁ
, 
PAGE_SIZE
 - couÁ - 1, 
Œue
);

856 
couÁ
 +ğ
	`¡¾’
(
buf
 + count);

857 
buf
[
couÁ
++] = '\n';

858 
æash_addr
 +ğ
lš–’
;

859 #undeà
PRINT_ROW_SIZE


863 
”r_po¡_æash_İ”©iÚ
:

864 
	`ùs_po¡_æash_İ”©iÚ
(
ùs_dev
);

866 ià(!
´og¿m_mode
) {

867 
r
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

868 ià(
r
) {

869 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "EÁ”‚Üm® modçed %d", 
r
);

873 ià(
’abËd
) {

874 
r
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

875 ià(
r
) {

876 
	`ùs_uÆock_deviû
(
ùs_dev
);

877  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "S¹ deviû faed %d", 
r
);

880 
”r_ä“_d©a
:

881 
	`ùs_uÆock_deviû
(
ùs_dev
);

882 
	`kä“
(
d©a
);

884  (
»t
 < 0 ?„‘ : 
couÁ
);

885 
	}
}

888 
ssize_t
 
	$»ad_æash_¡Üe
(
deviû
 *
dev
,

889 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

891 
	`·r£_¬g
(
buf
, 
couÁ
);

893  
couÁ
;

894 
	}
}

895 
DEVICE_ATTR
(
»ad
, 
S_IWUSR
 | 
S_IRUGO
, 
»ad_æash_show
, 
»ad_æash_¡Üe
);

898 
ssize_t
 
	$”a£_æash_¡Üe
(
deviû
 *
dev
,

899 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

901 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

902 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

903 
u32
 
æash_addr
, 
size
;

904 
»t
;

905 
boŞ
 
´og¿m_mode
;

906 
boŞ
 
’abËd
;

908 
	`·r£_¬g
(
buf
, 
couÁ
);

910 ià(
¬gc
 != 2) {

911 
	`ùs_”r
("Inv®id‚um‡rg %d", 
¬gc
);

912  -
EFAULT
;

915 
»t
 = 
	`k¡¹ou32
(
¬gv
[0], 0, &
æash_addr
);

916 ià(
»t
) {

917 
	`ùs_”r
("Inv®id fÏsh‡ddr: %s", 
¬gv
[0]);

918  -
EINVAL
;

920 
»t
 = 
	`k¡¹ou32
(
¬gv
[1], 0, &
size
);

921 ià(
»t
) {

922 
	`ùs_”r
("Inv®id size: %s", 
¬gv
[1]);

923  -
EINVAL
;

926 
	`ùs_šfo
("E¿£ fÏsh from 0x%06x siz%u", 
æash_addr
, 
size
);

928 
	`ùs_lock_deviû
(
ùs_dev
);

929 
´og¿m_mode
 = 
	`ùs_is_deviû_´og¿m_mode
(
ùs_dev
);

930 
’abËd
 = 
	`ùs_is_deviû_’abËd
(
ùs_dev
);

932 
»t
 = 
	`ùs_´•¬e_æash_İ”©iÚ
(
ùs_dev
);

933 ià(
»t
) {

934 
	`ùs_”r
("P»·» fÏsh o³¿tiÚ faed %d", 
»t
);

935 
	`ùs_uÆock_deviû
(
ùs_dev
);

936  
»t
;

939 
»t
 = 
	`ùs_”a£_æash
(
ùs_dev
, 
æash_addr
, 
size
);

940 ià(
»t
) {

941 
	`ùs_”r
("Erase flash from 0x%06x size %u failed %d",

942 
æash_addr
, 
size
, 
»t
);

943 
”r_po¡_æash_İ”©iÚ
;

946 
”r_po¡_æash_İ”©iÚ
:

947 
	`ùs_po¡_æash_İ”©iÚ
(
ùs_dev
);

949 ià(!
´og¿m_mode
) {

950 
r
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

951 ià(
r
) {

952 
	`ùs_”r
("EÁ”‚Üm® modçed %d", 
r
);

956 ià(
’abËd
) {

957 
r
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

958 ià(
r
) {

959 
	`ùs_”r
("S¹ deviû faed %d", 
r
);

962 
	`ùs_uÆock_deviû
(
ùs_dev
);

964  (
»t
 < 0 ?„‘ : 
couÁ
);

965 
	}
}

966 
DEVICE_ATTR
(
”a£
, 
S_IWUSR
, 
NULL
, 
”a£_æash_¡Üe
);

968 
©Œibu‹
 *
	gùs_dev_æash_©Œs
[] = {

969 &
dev_©Œ_šfo
.
©Œ
,

970 &
dev_©Œ_»ad
.
©Œ
,

971 &
dev_©Œ_”a£
.
©Œ
,

973 
NULL


976 cÚ¡ 
©Œibu‹_group
 
	gùs_dev_æash_©Œ_group
 = {

977 .
Çme
 = "flash",

978 .
	g©Œs
 = 
ùs_dev_æash_©Œs
,

981 
ssize_t
 
	$İ’_‹¡_show
(
deviû
 *
dev
,

982 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

984 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

985 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

986 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

987 .
æags
 = 
CTS_TEST_FLAG_VALIDATE_DATA
 |

988 
CTS_TEST_FLAG_VALIDATE_MIN
 |

989 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
 |

990 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
,

991 .
num_šv®id_node
 = 0,

992 .
šv®id_nodes
 = 
NULL
,

994 
mš
 = 0;

995 
»t
;

997 ià(
¬gc
 != 1) {

998  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id‚um‡rg %d\n", 
¬gc
);

1001 
»t
 = 
	`k¡¹ošt
(
¬gv
[0], 0, &
mš
);

1002 ià(
»t
) {

1003  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id mšh»s: %s\n", 
¬gv
[0]);

1006 
	`ùs_šfo
("O³À‹¡,h»shŞd = %u", 
mš
);

1008 
‹¡_·¿m
.
mš
 = &min;

1010 
»t
 = 
	`ùs_‹¡_İ’
(
ùs_dev
, &
‹¡_·¿m
);

1011 ià(
»t
) {

1012  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1013 "O³À‹¡ FAILED %d,h»shŞd = %u\n", 
»t
, 
mš
);

1015  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1016 "O³À‹¡ PASSED,h»shŞd = %u\n", 
mš
);

1018 
	}
}

1022 
ssize_t
 
	$İ’_‹¡_¡Üe
(
deviû
 *
dev
,

1023 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1025 
	`·r£_¬g
(
buf
, 
couÁ
);

1027  
couÁ
;

1028 
	}
}

1029 
DEVICE_ATTR
(
İ’_‹¡
, 
S_IWUSR
 | 
S_IRUGO
, 
İ’_‹¡_show
, 
İ’_‹¡_¡Üe
);

1031 
ssize_t
 
	$shÜt_‹¡_show
(
deviû
 *
dev
,

1032 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1034 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1035 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1036 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

1037 .
æags
 = 
CTS_TEST_FLAG_VALIDATE_DATA
 |

1038 
CTS_TEST_FLAG_VALIDATE_MIN
 |

1039 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
 |

1040 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
,

1041 .
num_šv®id_node
 = 0,

1042 .
šv®id_nodes
 = 
NULL
,

1044 
mš
 = 0;

1045 
»t
;

1047 ià(
¬gc
 != 1) {

1048  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id‚um‡rg %d\n", 
¬gc
);

1051 
»t
 = 
	`k¡¹ošt
(
¬gv
[0], 0, &
mš
);

1052 ià(
»t
) {

1053  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id mšh»s: %s\n", 
¬gv
[0]);

1056 
	`ùs_šfo
("ShÜˆ‹¡,h»shŞd = %u", 
mš
);

1058 
‹¡_·¿m
.
mš
 = &min;

1060 
»t
 = 
	`ùs_‹¡_shÜt
(
ùs_dev
, &
‹¡_·¿m
);

1061 ià(
»t
) {

1062  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1063 "ShÜˆ‹¡ FAILED %d,h»shŞd = %u\n", 
»t
, 
mš
);

1065  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1066 "ShÜˆ‹¡ PASSED,h»shŞd = %u\n", 
mš
);

1068 
	}
}

1072 
ssize_t
 
	$shÜt_‹¡_¡Üe
(
deviû
 *
dev
,

1073 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1075 
	`·r£_¬g
(
buf
, 
couÁ
);

1077  
couÁ
;

1078 
	}
}

1079 
DEVICE_ATTR
(
shÜt_‹¡
, 
S_IWUSR
 | 
S_IRUGO
,

1080 
shÜt_‹¡_show
, 
shÜt_‹¡_¡Üe
);

1082 
ssize_t
 
	$‹¡šg_show
(
deviû
 *
dev
,

1083 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1085 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1087  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Testting: %s\n",

1088 
ùs_d©a
->
ùs_dev
.
¹d©a
.
‹¡šg
 ? "Y" : "N");

1089 
	}
}

1090 
DEVICE_ATTR
(
‹¡šg
, 
S_IRUGO
, 
‹¡šg_show
, 
NULL
);

1092 
ssize_t
 
	$»£t_pš_‹¡_show
(
deviû
 *
dev
,

1093 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1095 #ifdeà
CFG_CTS_HAS_RESET_PIN


1096 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1097 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1098 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

1099 .
æags
 = 0,

1101 
»t
;

1103 
»t
 = 
	`ùs_‹¡_»£t_pš
(
ùs_dev
, &
‹¡_·¿m
);

1104 ià(
»t
) {

1105  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1106 "Re£t-Pše¡ FAIL %d\n", 
»t
);

1108  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1112  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1115 
	}
}

1116 
DEVICE_ATTR
(
»£t_pš_‹¡
, 
S_IRUGO
, 
»£t_pš_‹¡_show
, 
NULL
);

1118 
ssize_t
 
	$št_pš_‹¡_show
(
deviû
 *
dev
,

1119 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1121 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1122 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1123 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

1124 .
æags
 = 0,

1126 
»t
;

1128 
»t
 = 
	`ùs_‹¡_št_pš
(
ùs_dev
, &
‹¡_·¿m
);

1129 ià(
»t
) {

1130  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1131 "IÁ-Pše¡ FAIL %d\n", 
»t
);

1133  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1136 
	}
}

1137 
DEVICE_ATTR
(
št_pš_‹¡
, 
S_IRUGO
, 
št_pš_‹¡_show
, 
NULL
);

1139 
ssize_t
 
	$com³n§‹_ÿp_‹¡_show
(
deviû
 *
dev
,

1140 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1142 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1143 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1144 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

1145 .
æags
 = 
CTS_TEST_FLAG_VALIDATE_DATA
 |

1146 
CTS_TEST_FLAG_VALIDATE_MIN
 |

1147 
CTS_TEST_FLAG_VALIDATE_MAX
 |

1148 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
 |

1149 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
,

1150 .
num_šv®id_node
 = 0,

1151 .
šv®id_nodes
 = 
NULL
,

1153 
mš
 = 0, 
max
 = 0;

1154 
»t
;

1156 ià(
¬gc
 != 2) {

1157  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Invalid‚um‡rgs\n"

1163 
»t
 = 
	`k¡¹ošt
(
¬gv
[0], 0, &
mš
);

1164 ià(
»t
) {

1165  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id mšh»s: %s\n", 
¬gv
[0]);

1168 
»t
 = 
	`k¡¹ošt
(
¬gv
[1], 0, &
max
);

1169 ià(
»t
) {

1170  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id maxh»s: %s\n", 
¬gv
[1]);

1173 
	`ùs_šfo
("Compensate capest, min: %u, max: %u",

1174 
mš
, 
max
);

1176 
‹¡_·¿m
.
mš
 = &min;

1177 
‹¡_·¿m
.
max
 = &max;

1179 
»t
 = 
	`ùs_‹¡_com³n§‹_ÿp
(
ùs_dev
, &
‹¡_·¿m
);

1180 ià(
»t
) {

1181  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1182 "Com³n§‹ c­e¡ FAILED, mš: %u, max: %u\n", 
mš
, 
max
);

1184  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1185 "Com³n§‹ c­e¡ PASSED, mš: %u, max: %u\n", 
mš
, 
max
);

1187 
	}
}

1191 
ssize_t
 
	$com³n§‹_ÿp_‹¡_¡Üe
(
deviû
 *
dev
,

1192 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1194 
	`·r£_¬g
(
buf
, 
couÁ
);

1196  
couÁ
;

1197 
	}
}

1198 
DEVICE_ATTR
(
com³n§‹_ÿp_‹¡
, 
S_IWUSR
 | 
S_IRUGO
,

1199 
com³n§‹_ÿp_‹¡_show
, 
com³n§‹_ÿp_‹¡_¡Üe
);

1201 
ssize_t
 
	$¿wd©a_‹¡_show
(
deviû
 *
dev
,

1202 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1204 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1205 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1206 
ùs_¿wd©a_‹¡_´iv_·¿m
 
´iv_·¿m
 = {

1207 .
äames
 = 16,

1210 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

1211 .
æags
 = 
CTS_TEST_FLAG_VALIDATE_DATA
 |

1212 
CTS_TEST_FLAG_VALIDATE_MIN
 |

1213 
CTS_TEST_FLAG_VALIDATE_MAX
 |

1214 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
 |

1215 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
,

1216 .
num_šv®id_node
 = 0,

1217 .
šv®id_nodes
 = 
NULL
,

1218 .
´iv_·¿m
 = &priv_param,

1219 .
´iv_·¿m_size
 = (
´iv_·¿m
),

1222 
mš_th»s
, 
max_th»s
;

1223 
»t
;

1225 ià(
¬gc
 < 2 ||‡rgc > 3) {

1226  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Invalid‚um‡rgs\n"

1232 
»t
 = 
	`k¡¹ošt
(
¬gv
[0], 0, &
mš_th»s
);

1233 ià(
»t
) {

1234  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id mšh»s: %s\n", 
¬gv
[0]);

1237 
»t
 = 
	`k¡¹ošt
(
¬gv
[1], 0, &
max_th»s
);

1238 ià(
»t
) {

1239  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id maxh»s: %s\n", 
¬gv
[1]);

1242 ià(
¬gc
 > 2) {

1243 
»t
 = 
	`k¡¹ou32
(
¬gv
[2], 0, &
´iv_·¿m
.
äames
);

1244 ià(
»t
) {

1245  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id f¿mes: %s\n", 
¬gv
[2]);

1249 
	`ùs_šfo
("Rawdataest, frames: %u min: %d, max: %d",

1250 
´iv_·¿m
.
äames
, 
mš_th»s
, 
max_th»s
);

1252 
‹¡_·¿m
.
mš
 = &
mš_th»s
;

1253 
‹¡_·¿m
.
max
 = &
max_th»s
;

1255 
»t
 = 
	`ùs_‹¡_¿wd©a
(
ùs_dev
, &
‹¡_·¿m
);

1256 ià(
»t
) {

1257  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1259 
»t
, 
mš_th»s
, 
max_th»s
);

1261  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1263 
mš_th»s
, 
max_th»s
);

1265 
	}
}

1267 
ssize_t
 
	$¿wd©a_‹¡_¡Üe
(
deviû
 *
dev
,

1268 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1270 
	`·r£_¬g
(
buf
, 
couÁ
);

1272  
couÁ
;

1273 
	}
}

1274 
DEVICE_ATTR
(
¿wd©a_‹¡
, 
S_IWUSR
 | 
S_IRUGO
,

1275 
¿wd©a_‹¡_show
, 
¿wd©a_‹¡_¡Üe
);

1277 
ssize_t
 
	$noi£_‹¡_show
(
deviû
 *
dev
,

1278 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1280 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1281 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1282 
ùs_noi£_‹¡_´iv_·¿m
 
´iv_·¿m
 = {

1283 .
äames
 = 16,

1286 
ùs_‹¡_·¿m
 
‹¡_·¿m
 = {

1287 .
æags
 = 
CTS_TEST_FLAG_VALIDATE_DATA
 |

1288 
CTS_TEST_FLAG_VALIDATE_MAX
 |

1289 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
 |

1290 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
,

1291 .
num_šv®id_node
 = 0,

1292 .
šv®id_nodes
 = 
NULL
,

1293 .
´iv_·¿m
 = &priv_param,

1294 .
´iv_·¿m_size
 = (
´iv_·¿m
),

1297 
th»shlod
;

1298 
»t
;

1300 ià(
¬gc
 < 1 ||‡rgc > 2) {

1301  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Invalid‚um‡rgs\n"

1307 
»t
 = 
	`k¡¹ošt
(
¬gv
[0], 0, &
th»shlod
);

1308 ià(
»t
) {

1309  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id mšh»s: %s\n", 
¬gv
[0]);

1312 ià(
¬gc
 > 1) {

1313 
»t
 = 
	`k¡¹ou32
(
¬gv
[1], 0, &
´iv_·¿m
.
äames
);

1314 ià(
»t
) {

1315  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Inv®id f¿mes: %s\n", 
¬gv
[1]);

1319 
	`ùs_šfo
("Noiseest, frames: %uhreshold: %d",

1320 
´iv_·¿m
.
äames
, 
th»shlod
);

1322 
‹¡_·¿m
.
max
 = &
th»shlod
;

1324 
»t
 = 
	`ùs_‹¡_noi£
(
ùs_dev
, &
‹¡_·¿m
);

1325 ià(
»t
) {

1326  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1328 
»t
, 
th»shlod
);

1330  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1331 "Noi£e¡ PASS,h»shŞd: %u\n", 
th»shlod
);

1333 
	}
}

1335 
ssize_t
 
	$noi£_‹¡_¡Üe
(
deviû
 *
dev
,

1336 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1338 
	`·r£_¬g
(
buf
, 
couÁ
);

1340  
couÁ
;

1341 
	}
}

1342 
DEVICE_ATTR
(
noi£_‹¡
, 
S_IWUSR
 | 
S_IRUGO
,

1343 
noi£_‹¡_show
, 
noi£_‹¡_¡Üe
);

1345 
©Œibu‹
 *
	gùs_dev_‹¡_©ts
[] = {

1346 &
dev_©Œ_‹¡šg
.
©Œ
,

1347 &
dev_©Œ_»£t_pš_‹¡
.
©Œ
,

1348 &
dev_©Œ_št_pš_‹¡
.
©Œ
,

1349 &
dev_©Œ_¿wd©a_‹¡
.
©Œ
,

1350 &
dev_©Œ_noi£_‹¡
.
©Œ
,

1351 &
dev_©Œ_İ’_‹¡
.
©Œ
,

1352 &
dev_©Œ_shÜt_‹¡
.
©Œ
,

1353 &
dev_©Œ_com³n§‹_ÿp_‹¡
.
©Œ
,

1354 
NULL


1357 cÚ¡ 
©Œibu‹_group
 
	gùs_dev_‹¡_©Œ_group
 = {

1358 .
Çme
 = "test",

1359 .
	g©Œs
 = 
ùs_dev_‹¡_©ts
,

1362 
ssize_t
 
	$ic_ty³_show
(
deviû
 *
dev
,

1363 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1365 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1367  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "IC Type : %s\n",

1368 
ùs_d©a
->
ùs_dev
.
hwd©a
->
Çme
);

1369 
	}
}

1370 
DEVICE_ATTR
(
ic_ty³
, 
S_IRUGO
, 
ic_ty³_show
, 
NULL
);

1372 
ssize_t
 
	$´og¿m_mode_show
(
deviû
 *
dev
,

1373 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1375 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1377  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Program mode: %s\n",

1378 
ùs_d©a
->
ùs_dev
.
¹d©a
.
´og¿m_mode
 ? "Y" : "N");

1379 
	}
}

1380 
ssize_t
 
	$´og¿m_mode_¡Üe
(
deviû
 *
dev
,

1381 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1383 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1384 
»t
;

1385 
	`·r£_¬g
(
buf
, 
couÁ
);

1387 ià(
¬gc
 != 1) {

1388 
	`ùs_”r
("Inv®id‚um‡rg %d", 
¬gc
);

1389  -
EFAULT
;

1392 ià(*
¬gv
[0] =ğ'1' || 
	`tŞow”
(*argv[0]) == 'y') {

1393 
»t
 = 
	`ùs_’‹r_´og¿m_mode
(&
ùs_d©a
->
ùs_dev
);

1394 ià(
»t
) {

1395 
	`ùs_”r
("EÁ”…rog¿m modçed %d", 
»t
);

1396  
»t
;

1398 } ià(*
¬gv
[0] =ğ'0' || 
	`tŞow”
(*argv[0]) == 'n') {

1399 
»t
 = 
	`ùs_’‹r_nÜm®_mode
(&
ùs_d©a
->
ùs_dev
);

1400 ià(
»t
) {

1401 
	`ùs_”r
("Ex™…rog¿m modçed %d", 
»t
);

1402  
»t
;

1405 
	`ùs_”r
("Invalid‡rgs");

1408  
couÁ
;

1409 
	}
}

1410 
DEVICE_ATTR
(
´og¿m_mode
, 
S_IWUSR
 | 
S_IRUGO
,

1411 
´og¿m_mode_show
, 
´og¿m_mode_¡Üe
);

1413 
ssize_t
 
	$¿wd©a_show
(
deviû
 *
dev
,

1414 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1416 
	#RAWDATA_BUFFER_SIZE
(
ùs_dev
) \

1417 (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
 * 2)

	)

1419 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1420 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1421 
u16
 *
¿wd©a
 = 
NULL
;

1422 
»t
, 
r
, 
c
, 
couÁ
 = 0;

1423 
u32
 
max
, 
mš
, 
sum
, 
av”age
;

1424 
max_r
, 
max_c
, 
mš_r
, 
mš_c
;

1425 
boŞ
 
d©a_v®id
 = 
Œue
;

1427 
	`ùs_šfo
("Show„awdata");

1429 
¿wd©a
 = (
u16
 *)
	`km®loc
(
	`RAWDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

1430 ià(
¿wd©a
 =ğ
NULL
) {

1431  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Allocate memory for„awdata failed\n");

1434 
	`ùs_lock_deviû
(
ùs_dev
);

1435 
»t
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1436 ià(
»t
) {

1437 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "EÇbË„—d„aw d©¨çed %d\n", 
»t
);

1438 
”r_ä“_¿wd©a
;

1441 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1442 ià(
»t
) {

1443 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "S’d cmd QUIT_GESTURE_MONITOR faed %d\n", 
»t
);

1444 
”r_ä“_¿wd©a
;

1446 
	`m¦“p
(50);

1448 
»t
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
¿wd©a
);

1449 if(
»t
) {

1450 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "G‘„aw d©¨çed %d\n", 
»t
);

1451 
d©a_v®id
 = 
çl£
;

1454 
»t
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1455 ià(
»t
) {

1456 
couÁ
 +ğ
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Di§bË„—d„aw d©¨çed %d\n", 
»t
);

1460 ià(
d©a_v®id
) {

1461 
max
 = 
mš
 = 
¿wd©a
[0];

1462 
sum
 = 0;

1463 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

1464 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1465 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1466 
u16
 
v®
 = 
¿wd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
];

1467 
sum
 +ğ
v®
;

1468 ià(
v®
 > 
max
) {

1469 
max
 = 
v®
;

1470 
max_r
 = 
r
;

1471 
max_c
 = 
c
;

1472 } ià(
v®
 < 
mš
) {

1473 
mš
 = 
v®
;

1474 
mš_r
 = 
r
;

1475 
mš_c
 = 
c
;

1479 
av”age
 = 
sum
 / (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
);

1481 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1482 
SPLIT_LINE_STR


1484 
SPLIT_LINE_STR


1485 " | ", 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
);

1486 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1487 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
COL_NUM_FORMAT_STR
, 
c
);

1489 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, "\n" 
SPLIT_LINE_STR
);

1491 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
 && 
couÁ
 < 
PAGE_SIZE
;„++) {

1492 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
ROW_NUM_FORMAT_STR
, 
r
);

1493 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
 && 
couÁ
 < 
PAGE_SIZE
; c++) {

1494 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1495 
DATA_FORMAT_STR
, 
¿wd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
]);

1497 
buf
[
couÁ
++] = '\n';

1501 
”r_ä“_¿wd©a
:

1502 
	`ùs_uÆock_deviû
(
ùs_dev
);

1503 
	`kä“
(
¿wd©a
);

1505  (
d©a_v®id
 ? 
couÁ
 : 
»t
);

1507 #undeà
RAWDATA_BUFFER_SIZE


1508 
	}
}

1509 
DEVICE_ATTR
(
¿wd©a
, 
S_IRUGO
, 
¿wd©a_show
, 
NULL
);

1511 
ssize_t
 
	$diffd©a_show
(
deviû
 *
dev
,

1512 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1514 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1515 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1516 
s16
 *
diffd©a
 = 
NULL
;

1517 
»t
, 
r
, 
c
, 
couÁ
 = 0;

1518 
max
, 
mš
, 
sum
, 
av”age
;

1519 
max_r
, 
max_c
, 
mš_r
, 
mš_c
;

1520 
boŞ
 
d©a_v®id
 = 
Œue
;

1522 
	`ùs_šfo
("Show diffdata");

1524 
diffd©a
 = (
s16
 *)
	`km®loc
(
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

1525 ià(
diffd©a
 =ğ
NULL
) {

1526 
	`ùs_”r
("Allocate memory for diffdata failed");

1527  -
ENOMEM
;

1530 
	`ùs_lock_deviû
(
ùs_dev
);

1531 
»t
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1532 ià(
»t
) {

1533 
	`ùs_”r
("EÇbË„—d difàd©¨çed %d", 
»t
);

1534 
”r_ä“_diffd©a
;

1537 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1538 ià(
»t
) {

1539 
	`ùs_”r
("S’d cmd QUIT_GESTURE_MONITOR faed %d", 
»t
);

1540 
”r_ä“_diffd©a
;

1542 
	`m¦“p
(50);

1544 
»t
 = 
	`ùs_g‘_diffd©a
(
ùs_dev
, 
diffd©a
);

1545 if(
»t
) {

1546 
	`ùs_”r
("G‘ difàd©¨çed %d", 
»t
);

1547 
d©a_v®id
 = 
çl£
;

1550 
»t
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1551 ià(
»t
) {

1552 
	`ùs_”r
("Di§bË„—d difàd©¨çed %d", 
»t
);

1556 ià(
d©a_v®id
) {

1557 
max
 = 
mš
 = 
diffd©a
[0];

1558 
sum
 = 0;

1559 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

1560 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1561 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1562 
s16
 
v®
 = 
diffd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
];

1564 
sum
 +ğ
v®
;

1565 ià(
v®
 > 
max
) {

1566 
max
 = 
v®
;

1567 
max_r
 = 
r
;

1568 
max_c
 = 
c
;

1569 } ià(
v®
 < 
mš
) {

1570 
mš
 = 
v®
;

1571 
mš_r
 = 
r
;

1572 
mš_c
 = 
c
;

1576 
av”age
 = 
sum
 / (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
);

1578 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1579 
SPLIT_LINE_STR


1581 
SPLIT_LINE_STR


1582 " | ", 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
);

1583 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1584 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
COL_NUM_FORMAT_STR
, 
c
);

1586 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, "\n" 
SPLIT_LINE_STR
);

1588 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1589 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
ROW_NUM_FORMAT_STR
, 
r
);

1590 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1591 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1592 
DATA_FORMAT_STR
, 
diffd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
]);

1594 
buf
[
couÁ
++] = '\n';

1598 
”r_ä“_diffd©a
:

1599 
	`ùs_uÆock_deviû
(
ùs_dev
);

1600 
	`kä“
(
diffd©a
);

1602  (
d©a_v®id
 ? 
couÁ
 : 
»t
);

1603 
	}
}

1604 
DEVICE_ATTR
(
diffd©a
, 
S_IRUGO
, 
diffd©a_show
, 
NULL
);

1606 
ssize_t
 
	$mªu®diffd©a_show
(
deviû
 *
dev
,

1607 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1609 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1610 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1611 
s16
 *
¿wd©a
 = 
NULL
;

1612 
»t
, 
r
, 
c
, 
couÁ
 = 0;

1613 
max
, 
mš
, 
sum
, 
av”age
;

1614 
max_r
, 
max_c
, 
mš_r
, 
mš_c
;

1615 
boŞ
 
d©a_v®id
 = 
Œue
;

1616 
äame
;

1617 
fe
 *fğ
NULL
;

1618 
i
;

1619 
loff_t
 
pos
 = 0;

1621 
	`ùs_šfo
("Show manualdiff");

1623 ià(
¬gc
 != 1 &&‡rgc != 2) {

1624  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Invalid‚um‡rgs\n"

1634 ià(
¬gc
 == 2) {

1635 
»t
 = 
	`k¡¹ou32
(
¬gv
[0], 0, &
äame
);

1636 ià(
»t
) {

1637  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Invalid frame‚um\n");

1639 
fe
 = 
	`fp_İ’
(
¬gv
[1], 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 0666);

1640 ià(
	`IS_ERR
(
fe
)) {

1641  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Cª'ˆİ’ fe:%s", 
¬gv
[1]);

1645 
äame
 = 1;

1648 
¿wd©a
 = (
s16
 *)
	`km®loc
(
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

1649 ià(
¿wd©a
 =ğ
NULL
) {

1650 
	`ùs_”r
("Allocate memory for„awdata failed");

1651 
	`fp_şo£
(
fe
, 
NULL
);

1652  -
ENOMEM
;

1655 
	`ùs_lock_deviû
(
ùs_dev
);

1656 
»t
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1657 ià(
»t
) {

1658 
	`ùs_”r
("EÇbË„—d„aw d©¨çed %d", 
»t
);

1659 
”r_ä“_diffd©a
;

1662 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1663 ià(
»t
) {

1664 
	`ùs_”r
("S’d cmd QUIT_GESTURE_MONITOR faed %d", 
»t
);

1665 
”r_ä“_diffd©a
;

1667 
	`m¦“p
(50);

1669 
	`ùs_šfo
("äam%d, fe:%s", 
äame
, 
¬gv
[1]);

1670 
i
 = 0; i < 
äame
; i++) {

1671 
»t
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
¿wd©a
);

1672 if(
»t
) {

1673 
	`ùs_”r
("G‘„aw d©¨çed %d", 
»t
);

1674 
d©a_v®id
 = 
çl£
;

1677 
d©a_v®id
 = 
Œue
;

1679 
	`m¦“p
(50);

1681 ià(
d©a_v®id
) {

1682 
max
 = -32768;

1683 
mš
 = 32767;

1684 
sum
 = 0;

1685 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

1686 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1687 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1688 
s16
 
v®
;

1690 
¿wd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
] -ğ
mªu®diff_ba£
[r * cts_dev->fwdata.cols + c];

1691 
v®
 = 
¿wd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
];

1692 
sum
 +ğ
v®
;

1693 ià(
v®
 > 
max
) {

1694 
max
 = 
v®
;

1695 
max_r
 = 
r
;

1696 
max_c
 = 
c
;

1697 } ià(
v®
 < 
mš
) {

1698 
mš
 = 
v®
;

1699 
mš_r
 = 
r
;

1700 
mš_c
 = 
c
;

1704 
av”age
 = 
sum
 / (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
);

1705 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1706 
SPLIT_LINE_STR


1708 
SPLIT_LINE_STR


1709 " | ", 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
);

1710 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1711 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ,
PAGE_SIZE
 - couÁ, 
COL_NUM_FORMAT_STR
, 
c
);

1713 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, "\n" 
SPLIT_LINE_STR
);

1715 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1716 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
ROW_NUM_FORMAT_STR
, 
r
);

1717 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1718 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1719 
DATA_FORMAT_STR
, 
¿wd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
]);

1721 
buf
[
couÁ
++] = '\n';

1724 ià(
¬gc
 == 2) {

1725 
pos
 = 
fe
->
f_pos
;

1726 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

1727 
»t
 = 
	`k”Ãl_wr™e
(
fe
, 
buf
, 
couÁ
, &
pos
);

1729 
»t
 = 
	`k”Ãl_wr™e
(
fe
, 
buf
, 
couÁ
, 
pos
);

1731 ià(
»t
 !ğ
couÁ
) {

1732 
	`ùs_”r
("Wr™d©¨tØf'%s' faed %d", 
¬gv
[1], 
»t
);

1734 
fe
->
f_pos
 +ğ
couÁ
;

1735 
couÁ
 = 0;

1739 ià(
¬gc
 == 2) {

1740 
	`fp_şo£
(
fe
, 
NULL
);

1743 
»t
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1744 ià(
»t
) {

1745 
	`ùs_”r
("Di§bË„—d„aw d©¨çed %d", 
»t
);

1749 
”r_ä“_diffd©a
:

1750 
	`ùs_uÆock_deviû
(
ùs_dev
);

1751 
	`kä“
(
¿wd©a
);

1753  (
d©a_v®id
 ? 
couÁ
 : 
»t
);

1754 
	}
}

1756 
ssize_t
 
	$mªu®diffd©a_¡Üe
(
deviû
 *
dev
,

1757 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1759 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1760 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1761 
»t
;

1763 
	`·r£_¬g
(
buf
, 
couÁ
);

1765 
	`ùs_lock_deviû
(
ùs_dev
);

1766 ià(
	`¡ºÿ£cmp
("upd©eba£", 
¬gv
[0], 10) == 0) {

1767 
»t
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1768 ià(
»t
) {

1769 
	`ùs_”r
("EÇbË„—d„aw d©¨çed %d", 
»t
);

1770 
”r_mªu®_diff_¡Üe
;

1773 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1774 ià(
»t
) {

1775 
	`ùs_”r
("S’d cmd QUIT_GESTURE_MONITOR faed %d", 
»t
);

1776 
”r_mªu®_diff_¡Üe
;

1778 
	`m¦“p
(50);

1780 ià(
mªu®diff_ba£
 !ğ
NULL
) {

1781 
»t
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
mªu®diff_ba£
);

1782 if(
»t
) {

1783 
	`ùs_”r
("G‘„aw d©¨çed %d", 
»t
);

1787 
»t
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1788 ià(
»t
) {

1789 
	`ùs_”r
("Di§bË„—d„aw d©¨çed %d", 
»t
);

1792 
”r_mªu®_diff_¡Üe
:

1793 
	`ùs_uÆock_deviû
(
ùs_dev
);

1794  
couÁ
;

1795 
	}
}

1797 
DEVICE_ATTR
(
mªu®diff
, 
S_IRUSR
|
S_IWUSR
, 
mªu®diffd©a_show
, 
mªu®diffd©a_¡Üe
);

1799 
ssize_t
 
	$j™‹r_¡Üe
(
deviû
 *
dev
,

1800 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

1802 
u16
 
út
;

1803 
»t
;

1805 
	`·r£_¬g
(
buf
, 
couÁ
);

1807 ià(
¬gc
 != 1) {

1808 
	`ùs_”r
("Inv®id‚um‡rg %d", 
¬gc
);

1809  -
EFAULT
;

1812 
»t
 = 
	`k¡¹ou16
(
¬gv
[0], 0, &
út
);

1813 ià(
»t
 == 0) {

1814 ià(
út
 > 2 || cnt < 10000) {

1815 
j™‹r_‹¡_äame
 = 
út
;

1819 
	`ùs_šfo
("j™‹¸‹¡ f¿me: %d", 
j™‹r_‹¡_äame
);

1820  
couÁ
;

1821 
	}
}

1823 
ssize_t
 
	$j™‹r_show
(
deviû
 *
dev
,

1824 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1826 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1827 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1828 
s16
 *
¿wd©a
 = 
NULL
;

1829 
s16
 *
¿wd©a_mš
 = 
NULL
;

1830 
s16
 *
¿wd©a_max
 = 
NULL
;

1831 
»t
, 
r
, 
c
, 
couÁ
 = 0;

1832 
max
, 
mš
, 
sum
, 
av”age
;

1833 
max_r
, 
max_c
, 
mš_r
, 
mš_c
;

1834 
boŞ
 
d©a_v®id
 = 
çl£
;

1835 
i
;

1837 
	`ùs_šfo
("Show jitter");

1838 
	`ùs_lock_deviû
(
ùs_dev
);

1839 
¿wd©a
 = (
s16
 *)
	`km®loc
(
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

1840 ià(
¿wd©a
 =ğ
NULL
) {

1841 
	`ùs_”r
("Allocate memory for„awdata failed");

1842 
»t
 = -
ENOMEM
;

1843 
”r_j™‹r_show_ex™
;

1845 
¿wd©a_mš
 = (
s16
 *)
	`km®loc
(
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

1846 ià(
¿wd©a_mš
 =ğ
NULL
) {

1847 
	`ùs_”r
("Allocate memory for„awdata failed");

1848 
»t
 = -
ENOMEM
;

1849 
”r_ä“_¿wd©a
;

1851 
¿wd©a_max
 = (
s16
 *)
	`km®loc
(
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

1852 ià(
¿wd©a_max
 =ğ
NULL
) {

1853 
	`ùs_”r
("Allocate memory for„awdata failed");

1854 
»t
 = -
ENOMEM
;

1855 
”r_ä“_¿wd©a_mš
;

1858 
i
 = 0; i < 
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
)/2; i++) {

1859 
¿wd©a_mš
[
i
] = 32767;

1860 
¿wd©a_max
[
i
] = -32768;

1863 
»t
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1864 ià(
»t
) {

1865 
	`ùs_”r
("EÇbË„—d„aw d©¨çed %d", 
»t
);

1866 
”r_ä“_¿wd©a_max
;

1869 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1870 ià(
»t
) {

1871 
	`ùs_”r
("S’d cmd QUIT_GESTURE_MONITOR faed %d", 
»t
);

1872 
”r_ä“_¿wd©a_max
;

1874 
	`m¦“p
(50);

1875 
d©a_v®id
 = 
Œue
;

1876 
i
 = 0; i < 
j™‹r_‹¡_äame
; i++)

1878 
»t
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
¿wd©a
);

1879 if(
»t
) {

1880 
	`ùs_”r
("G‘„aw d©¨çed %d", 
»t
);

1883 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1884 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1885 
šdex
;

1886 
šdex
 = 
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
;

1887 ià(
¿wd©a_mš
[
šdex
] > 
¿wd©a
[index])

1888 
¿wd©a_mš
[
šdex
] = 
¿wd©a
[index];

1889 ià(
¿wd©a_max
[
šdex
] < 
¿wd©a
[index])

1890 
¿wd©a_max
[
šdex
] = 
¿wd©a
[index];

1893 
	`m¦“p
(1);

1895 
»t
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1896 ià(
»t
) {

1897 
	`ùs_”r
("Di§bË„—d„aw d©¨çed %d", 
»t
);

1900 ià(
d©a_v®id
) {

1901 
max
 = -32768;

1902 
mš
 = 32767;

1903 
sum
 = 0;

1904 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

1905 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1906 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1907 
s16
 
v®
;

1908 
šdex
 = 
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
;

1910 
v®
 = 
¿wd©a_max
[
šdex
] - 
¿wd©a_mš
[index];

1911 
¿wd©a
[
šdex
] = 
v®
;

1912 
sum
 +ğ
v®
;

1913 ià(
v®
 > 
max
) {

1914 
max
 = 
v®
;

1915 
max_r
 = 
r
;

1916 
max_c
 = 
c
;

1917 } ià(
v®
 < 
mš
) {

1918 
mš
 = 
v®
;

1919 
mš_r
 = 
r
;

1920 
mš_c
 = 
c
;

1924 
av”age
 = 
sum
 / (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
);

1926 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1927 
SPLIT_LINE_STR


1929 
SPLIT_LINE_STR


1930 " | ", 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
, 
j™‹r_‹¡_äame
);

1931 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1932 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
COL_NUM_FORMAT_STR
, 
c
);

1934 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, "\n" 
SPLIT_LINE_STR
);

1936 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1937 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, 
ROW_NUM_FORMAT_STR
, 
r
);

1938 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1939 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

1940 
DATA_FORMAT_STR
, 
¿wd©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
]);

1942 
buf
[
couÁ
++] = '\n';

1946 
”r_ä“_¿wd©a_max
:

1947 
	`kä“
(
¿wd©a_max
);

1948 
”r_ä“_¿wd©a_mš
:

1949 
	`kä“
(
¿wd©a_mš
);

1950 
”r_ä“_¿wd©a
:

1951 
	`kä“
(
¿wd©a
);

1952 
”r_j™‹r_show_ex™
:

1953 
	`ùs_uÆock_deviû
(
ùs_dev
);

1954  (
d©a_v®id
 ? 
couÁ
 : 
»t
);

1955 
	}
}

1957 
DEVICE_ATTR
(
j™‹r
, 
S_IRUSR
|
S_IWUSR
, 
j™‹r_show
, 
j™‹r_¡Üe
);

1959 
ssize_t
 
	$com³n§‹_ÿp_show
(
deviû
 *
dev
,

1960 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

1962 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

1963 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

1964 
u8
 *
ÿp
 = 
NULL
;

1965 
»t
;

1966 
ssize_t
 
couÁ
 = 0;

1967 
r
, 
c
, 
mš
, 
max
, 
max_r
, 
max_c
, 
mš_r
, 
mš_c
, 
sum
, 
av”age
;

1969 
	`ùs_šfo
("R—d '%s'", 
©Œ
->©Œ.
Çme
);

1971 
ÿp
 = 
	`kz®loc
(
ùs_dev
->
hwd©a
->
num_row
 * cts_dev->hwd©a->
num_cŞ
,

1972 
GFP_KERNEL
);

1973 ià(
ÿp
 =ğ
NULL
) {

1974  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1978 
	`ùs_lock_deviû
(
ùs_dev
);

1979 
»t
 = 
	`ùs_g‘_com³n§‹_ÿp
(
ùs_dev
, 
ÿp
);

1980 
	`ùs_uÆock_deviû
(
ùs_dev
);

1981 ià(
»t
) {

1982 
	`kä“
(
ÿp
);

1983  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

1984 "G‘ com³n§‹ c­ faed %d\n", 
»t
);

1987 
max
 = 
mš
 = 
ÿp
[0];

1988 
sum
 = 0;

1989 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

1990 
r
 = 0;„ < 
ùs_dev
->
hwd©a
->
num_row
;„++) {

1991 
c
 = 0; c < 
ùs_dev
->
hwd©a
->
num_cŞ
; c++) {

1992 
u16
 
v®
 = 
ÿp
[
r
 * 
ùs_dev
->
hwd©a
->
num_cŞ
 + 
c
];

1993 
sum
 +ğ
v®
;

1994 ià(
v®
 > 
max
) {

1995 
max
 = 
v®
;

1996 
max_r
 = 
r
;

1997 
max_c
 = 
c
;

1998 } ià(
v®
 < 
mš
) {

1999 
mš
 = 
v®
;

2000 
mš_r
 = 
r
;

2001 
mš_c
 = 
c
;

2005 
av”age
 = 
sum
 / (
ùs_dev
->
hwd©a
->
num_row
 * cts_dev->hwd©a->
num_cŞ
);

2007 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

2011 " |", 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
);

2012 
c
 = 0; c < 
ùs_dev
->
hwd©a
->
num_cŞ
; c++) {

2013 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, " %3u", 
c
);

2015 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

2019 
r
 = 0;„ < 
ùs_dev
->
hwd©a
->
num_row
;„++) {

2020 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - couÁ, "%2u |", 
r
);

2021 
c
 = 0; c < 
ùs_dev
->
hwd©a
->
num_cŞ
; c++) {

2022 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

2023 " %3u", 
ÿp
[
r
 * 
ùs_dev
->
hwd©a
->
num_cŞ
 + 
c
]);

2025 
buf
[
couÁ
++] = '\n';

2027 
couÁ
 +ğ
	`sú´štf
(
buf
 + couÁ, 
PAGE_SIZE
 - count,

2030 
	`kä“
(
ÿp
);

2032  
couÁ
;

2033 
	}
}

2034 
DEVICE_ATTR
(
com³n§‹_ÿp
, 
S_IRUGO
, 
com³n§‹_ÿp_show
, 
NULL
);

2036 #ifdeà
CFG_CTS_HAS_RESET_PIN


2037 
ssize_t
 
	$»£t_pš_show
(
deviû
 *
dev
,

2038 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

2040 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2042 
	`ùs_šfo
("Read RESET-PIN");

2044  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

2046 
ùs_d©a
->
pd©a
->
r¡_gpio
,

2047 
	`gpio_g‘_v®ue
(
ùs_d©a
->
pd©a
->
r¡_gpio
));

2048 
	}
}

2050 
ssize_t
 
	$»£t_pš_¡Üe
(
deviû
 *
dev
,

2051 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2053 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2054 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

2056 
	`ùs_šfo
("Write RESET-PIN");

2057 
	`ùs_šfo
("Chip staus maybe changed");

2059 
	`ùs_¶©_£t_»£t
(
ùs_dev
->
pd©a
, (
buf
[0] == '1') ? 1 : 0);

2060  
couÁ
;

2061 
	}
}

2062 
DEVICE_ATTR
(
»£t_pš
, 
S_IRUSR
 | 
S_IWUSR
, 
»£t_pš_show
, 
»£t_pš_¡Üe
);

2065 
ssize_t
 
	$œq_pš_show
(
deviû
 *
dev
,

2066 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

2068 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2070 
	`ùs_šfo
("Read IRQ-PIN");

2072  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

2074 
ùs_d©a
->
pd©a
->
št_gpio
,

2075 
	`gpio_g‘_v®ue
(
ùs_d©a
->
pd©a
->
št_gpio
));

2076 
	}
}

2077 
DEVICE_ATTR
(
œq_pš
, 
S_IRUGO
, 
œq_pš_show
, 
NULL
);

2079 
ssize_t
 
	$œq_šfo_show
(
deviû
 *
dev
,

2080 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

2082 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2083 
œq_desc
 *
desc
;

2085 
	`ùs_šfo
("Read IRQ-INFO");

2087 
desc
 = 
	`œq_to_desc
(
ùs_d©a
->
pd©a
->
œq
);

2088 ià(
desc
 =ğ
NULL
) {

2089  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "IRQ: %d descriptor‚ot found\n",

2090 
ùs_d©a
->
pd©a
->
œq
);

2093  
	`sú´štf
(
buf
, 
PAGE_SIZE
,

2096 
ùs_d©a
->
pd©a
->
œq
, 
desc
->
d•th
,

2097 
desc
->
œq_couÁ
, desc->
œqs_unhªdËd
,

2098 
desc
->
Ï¡_unhªdËd
);

2099 
	}
}

2100 
DEVICE_ATTR
(
œq_šfo
, 
S_IRUGO
, 
œq_šfo_show
, 
NULL
);

2102 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


2103 
ssize_t
 
	$fw_log_»dœeù_show
(
deviû
 *
dev
,

2104 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

2106 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2107 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

2109  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Fw†og„edirect is %s\n",

2110 
	`ùs_is_fw_log_»dœeù
(
ùs_dev
)? "enable":"disable");

2111 
	}
}

2113 
ssize_t
 
	$fw_log_»dœeù_¡Üe
(
deviû
 *
dev
,

2114 
deviû_©Œibu‹
 *
©Œ
,

2115 cÚ¡ *
buf
, 
size_t
 
couÁ
)

2117 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2118 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

2119 
u8
 
’abË
 = 0;

2121 ià(
buf
[0] == 'Y' || buf[0] == 'y' || buf[0] == '1') {

2122 
’abË
 = 1;

2124 ià(
’abË
) {

2125 
	`ùs_’abË_fw_log_»dœeù
(
ùs_dev
);

2127 
	`ùs_di§bË_fw_log_»dœeù
(
ùs_dev
);

2130  
couÁ
;

2131 
	}
}

2133 
DEVICE_ATTR
(
fw_log_»dœeù
, 
S_IRUSR
 | 
S_IWUSR
,

2134 
fw_log_»dœeù_show
, 
fw_log_»dœeù_¡Üe
);

2137 
ssize_t
 
	$debug_¥i_show
(
deviû
 *
dev
,

2138 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

2143  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "¥i_¥“d=%d\n", 
¥“d
);

2144 
	}
}

2146 
ssize_t
 
	$debug_¥i_¡Üe
(
deviû
 *
dev
,

2147 
deviû_©Œibu‹
 *
©Œ
,

2148 cÚ¡ *
buf
, 
size_t
 
couÁ
)

2150 
u16
 
s
 = 0;

2151 
»t
 = 0;

2153 
	`·r£_¬g
(
buf
, 
couÁ
);

2155 ià(
¬gc
 != 1) {

2156 
	`ùs_”r
("Inv®id‚um‡rg %d", 
¬gc
);

2157  -
EFAULT
;

2160 
»t
 = 
	`k¡¹ou16
(
¬gv
[0], 0, &
s
);

2161 ià(
»t
) {

2162 
	`ùs_”r
("Inv®id sp˜¥“d: %s", 
¬gv
[0]);

2163  -
EINVAL
;

2166 
¥“d
 = 
s
;

2168  
couÁ
;

2169 
	}
}

2171 
DEVICE_ATTR
(
debug_¥i
, 
S_IRUSR
 | 
S_IWUSR
,

2172 
debug_¥i_show
, 
debug_¥i_¡Üe
);

2174 #ifdeà
CFG_CTS_GESTURE


2175 
ssize_t
 
	$ge¡u»_’_show
(
deviû
 *
dev
,

2176 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

2178 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2179 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

2181  
	`sú´štf
(
buf
, 
PAGE_SIZE
, "Gesture wakup is %s\n",

2182 
	`ùs_is_ge¡u»_wakeup_’abËd
(
ùs_dev
)? "enable":"disable");

2183 
	}
}

2185 
ssize_t
 
	$ge¡u»_’_¡Üe
(
deviû
 *
dev
,

2186 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

2188 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2189 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

2190 
u8
 
’abË
 = 0;

2192 ià(
buf
[0] == 'Y' || buf[0] == 'y' || buf[0] == '1') {

2193 
’abË
 = 1;

2195 ià(
’abË
) {

2196 
	`ùs_’abË_ge¡u»_wakeup
(
ùs_dev
);

2199 
	`ùs_di§bË_ge¡u»_wakeup
(
ùs_dev
);

2202  
couÁ
;

2203 
	}
}

2204 
DEVICE_ATTR
(
ge¡u»_’
, 
S_IRUSR
|
S_IWUSR
, 
ge¡u»_’_show
, 
ge¡u»_’_¡Üe
);

2207 
©Œibu‹
 *
	gùs_dev_misc_©ts
[] = {

2208 &
dev_©Œ_ic_ty³
.
©Œ
,

2209 &
dev_©Œ_´og¿m_mode
.
©Œ
,

2210 &
dev_©Œ_¿wd©a
.
©Œ
,

2211 &
dev_©Œ_diffd©a
.
©Œ
,

2212 &
dev_©Œ_mªu®diff
.
©Œ
,

2213 &
dev_©Œ_j™‹r
.
©Œ
,

2214 #ifdeà
CFG_CTS_HAS_RESET_PIN


2215 &
dev_©Œ_»£t_pš
.
©Œ
,

2217 &
dev_©Œ_œq_pš
.
©Œ
,

2218 &
dev_©Œ_œq_šfo
.
©Œ
,

2219 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


2220 &
dev_©Œ_fw_log_»dœeù
.
©Œ
,

2222 &
dev_©Œ_com³n§‹_ÿp
.
©Œ
,

2223 &
dev_©Œ_»ad_»g
.
©Œ
,

2224 &
dev_©Œ_wr™e_»g
.
©Œ
,

2225 &
dev_©Œ_»ad_hw_»g
.
©Œ
,

2226 &
dev_©Œ_wr™e_hw_»g
.
©Œ
,

2227 &
dev_©Œ_debug_¥i
.
©Œ
,

2228 #ifdeà
CFG_CTS_GESTURE


2229 &
dev_©Œ_ge¡u»_’
.
©Œ
,

2231 
NULL


2234 cÚ¡ 
©Œibu‹_group
 
	gùs_dev_misc_©Œ_group
 = {

2235 .
Çme
 = "misc",

2236 .
	g©Œs
 = 
ùs_dev_misc_©ts
,

2239 cÚ¡ 
©Œibu‹_group
 *
	gùs_dev_©Œ_groups
[] = {

2240 &
ùs_dev_fœmw¬e_©Œ_group
,

2241 &
ùs_dev_æash_©Œ_group
,

2242 &
ùs_dev_‹¡_©Œ_group
,

2243 &
ùs_dev_misc_©Œ_group
,

2244 
NULL


2247 
	$ùs_sysfs_add_deviû
(
deviû
 *
dev
)

2249 
chÚe_ts_d©a
 *
ùs_d©a
 = 
	`dev_g‘_drvd©a
(
dev
);

2250 
ùs_deviû
 *
ùs_dev
 = &
ùs_d©a
->cts_dev;

2251 
»t
 = 0, 
i
;

2253 
	`ùs_šfo
("Add device‡ttr groups");

2256 
i
 = 0; 
ùs_dev_©Œ_groups
[i]; i++) {

2257 
»t
 = 
	`sysfs_ü—‹_group
(&
dev
->
kobj
, 
ùs_dev_©Œ_groups
[
i
]);

2258 ià(
»t
) {

2259 --
i
 >= 0) {

2260 
	`sysfs_»move_group
(&
dev
->
kobj
, 
ùs_dev_©Œ_groups
[
i
]);

2266 ià(
»t
) {

2267 
	`ùs_”r
("Add deviû‡‰¸çed %d", 
»t
);

2268  
»t
;

2271 
mªu®diff_ba£
 = (
s16
 *)
	`kz®loc
(
	`DIFFDATA_BUFFER_SIZE
(
ùs_dev
), 
GFP_KERNEL
);

2272 ià(
mªu®diff_ba£
 =ğ
NULL
) {

2273 
	`ùs_”r
("Malloc manualdiff_base failed");

2274  -
ENOMEM
;

2277 
»t
 = 
	`sysfs_ü—‹_lšk
(
NULL
, &
dev
->
kobj
, "chipone-tddi");

2278 ià(
»t
) {

2279 
	`ùs_”r
("C»©sysf lškƒ¼Ü:%d", 
»t
);

2282 
	}
}

2284 
	$ùs_sysfs_»move_deviû
(
deviû
 *
dev
)

2286 
i
;

2288 
	`ùs_šfo
("Remove device‡ttr groups");

2290 ià(
mªu®diff_ba£
 !ğ
NULL
) {

2291 
	`kä“
(
mªu®diff_ba£
);

2292 
mªu®diff_ba£
 = 
NULL
;

2295 
	`sysfs_»move_lšk
(
NULL
, "chipone-tddi");

2297 
i
 = 0; 
ùs_dev_©Œ_groups
[i]; i++) {

2298 
	`sysfs_»move_group
(&
dev
->
kobj
, 
ùs_dev_©Œ_groups
[
i
]);

2300 
	}
}

2302 #undeà
SPLIT_LINE_STR


2303 #undeà
ROW_NUM_FORMAT_STR


2304 #undeà
COL_NUM_FORMAT_STR


2305 #undeà
DATA_FORMAT_STR


	@cts_sysfs.h

1 #iâdeà
CTS_SYSFS_H


2 
	#CTS_SYSFS_H


	)

4 
	~"ùs_cÚfig.h
"

6 
	gdeviû
;

8 
u16
 
¥“d
;

10 #ifdeà
CONFIG_CTS_SYSFS


11 
ùs_sysfs_add_deviû
(
deviû
 *
dev
);

12 
ùs_sysfs_»move_deviû
(
deviû
 *
dev
);

14 
šlše
 
	$ùs_sysfs_add_deviû
(
deviû
 *
dev
è{ -
ENOTSUPP
;
	}
}

15 
šlše
 
	$ùs_sysfs_»move_deviû
(
deviû
 *
dev
è{
	}
}

	@cts_test.c

1 
	#LOG_TAG
 "Te¡"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_‹¡.h
"

8 cÚ¡ *
	$ùs_‹¡_™em_¡r
(
‹¡_™em
)

10 
	#ÿ£_‹¡_™em
(
™em
) \

11 
CTS_TEST_
 ## 
™em
:  #™em "-TEST"

	)

13 
‹¡_™em
) {

14 
	`ÿ£_‹¡_™em
(
RESET_PIN
);

15 
	`ÿ£_‹¡_™em
(
INT_PIN
);

16 
	`ÿ£_‹¡_™em
(
RAWDATA
);

17 
	`ÿ£_‹¡_™em
(
NOISE
);

18 
	`ÿ£_‹¡_™em
(
OPEN
);

19 
	`ÿ£_‹¡_™em
(
SHORT
);

20 
	`ÿ£_‹¡_™em
(
COMPENSATE_CAP
);

24 #undeà
ÿ£_‹¡_™em


25 
	}
}

27 
	#CTS_FIRMWARE_WORK_MODE_NORMAL
 (0x00)

	)

28 
	#CTS_FIRMWARE_WORK_MODE_FACTORY
 (0x01)

	)

29 
	#CTS_FIRMWARE_WORK_MODE_CONFIG
 (0x02)

	)

30 
	#CTS_FIRMWARE_WORK_MODE_TEST
 (0x03)

	)

32 
	#CTS_TEST_SHORT
 (0x01)

	)

33 
	#CTS_TEST_OPEN
 (0x02)

	)

35 
	#CTS_SHORT_TEST_UNDEFINED
 (0x00)

	)

36 
	#CTS_SHORT_TEST_BETWEEN_COLS
 (0x01)

	)

37 
	#CTS_SHORT_TEST_BETWEEN_ROWS
 (0x02)

	)

38 
	#CTS_SHORT_TEST_BETWEEN_GND
 (0x03)

	)

40 
	#TEST_RESULT_BUFFER_SIZE
(
ùs_dev
) \

41 (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
 * 2)

	)

43 
	#RAWDATA_BUFFER_SIZE
(
ùs_dev
) \

44 (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
 * 2)

	)

46 
	$di§bË_fw_mÚ™Ü_mode
(
ùs_deviû
 *
ùs_dev
)

48 
»t
;

49 
u8
 
v®ue
;

51 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_FLAG_BITS
, &
v®ue
);

52 ià(
»t
) {

53  
»t
;

56 ià(
v®ue
 & 
	`BIT
(0)) {

57  
	`ùs_fw_»g_wr™eb
(
ùs_dev
,

58 
CTS_DEVICE_FW_REG_FLAG_BITS
, 
v®ue
 & (~
	`BIT
(0)));

62 
	}
}

64 
	$di§bË_fw_auto_com³n§‹
(
ùs_deviû
 *
ùs_dev
)

66  
	`ùs_fw_»g_wr™eb
(
ùs_dev
,

67 
CTS_DEVICE_FW_REG_AUTO_CALIB_COMP_CAP_ENABLE
, 0);

68 
	}
}

70 
	$£t_fw_wÜk_mode
(
ùs_deviû
 *
ùs_dev
, 
u8
 
mode
)

72 
»t
, 
»Œ›s
;

73 
u8
 
pwr_mode
;

75 
	`ùs_šfo
("S‘ fœmw¬wÜk modtØ%u", 
mode
);

77 
»t
 = 
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_WORK_MODE
, 
mode
);

78 ià(
»t
) {

79 
	`ùs_”r
("Wr™fœmw¬wÜk mod»gi¡” faed %d", 
»t
);

80  
»t
;

83 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_POWER_MODE
,

84 &
pwr_mode
);

85 ià(
»t
) {

86 
	`ùs_”r
("R—d fœmw¬pow” mod»gi¡” faed %d", 
»t
);

87  
»t
;

90 ià(
pwr_mode
 == 1) {

91 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

92 ià(
»t
) {

93 
	`ùs_”r
("S’d cmd QUIT_GESTURE_MONITOR faed %d", 
»t
);

94  
»t
;

97 
	`m¦“p
(50);

100 
»Œ›s
 = 0;

102 
u8
 
sys_busy
, 
cu¼_mode
;

104 
	`m¦“p
(10);

106 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_SYS_BUSY
,

107 &
sys_busy
);

108 ià(
»t
) {

109 
	`ùs_”r
("R—d fœmw¬sy¡em busy„egi¡” faed %d", 
»t
);

113 ià(
sys_busy
)

116 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_GET_WORK_MODE
,

117 &
cu¼_mode
);

118 ià(
»t
) {

119 
	`ùs_”r
("R—d fœmw¬cu¼’ˆwÜk modçed %d", 
»t
);

124 ià(
cu¼_mode
 =ğ
mode
 ) {

127 } 
»Œ›s
++ < 1000);

129  (
»Œ›s
 >ğ1000 ? -
ETIMEDOUT
 : 0);

130 
	}
}

132 
	$£t_di¥Ïy_¡©e
(
ùs_deviû
 *
ùs_dev
, 
boŞ
 
aùive
)

134 
»t
;

135 
u8
 
acûss_æag
;

137 
	`ùs_šfo
("S‘ di¥Ïy s‹Ø%s", 
aùive
 ? "ACTIVE" : "SLEEP");

139 
»t
 = 
	`ùs_hw_»g_»adb
(
ùs_dev
, 0x3002C, &
acûss_æag
);

140 ià(
»t
) {

141 
	`ùs_”r
("R—d di¥Ïy‡cûs æag faed %d", 
»t
);

142  
»t
;

145 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x3002C, 
acûss_æag
 | 0x01);

146 ià(
»t
) {

147 
	`ùs_”r
("Wr™di¥Ïy‡cûs æag %02x faed %d", 
acûss_æag
, 
»t
);

148  
»t
;

151 ià(
aùive
) {

152 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x3C044, 0x55);

153 ià(
»t
) {

154 
	`ùs_”r
("Write DCS-CMD11 fail");

155  
»t
;

158 
	`m¦“p
(100);

160 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x3C0A4, 0x55);

161 ià(
»t
) {

162 
	`ùs_”r
("Write DCS-CMD29 fail");

163  
»t
;

166 
	`m¦“p
(100);

168 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x3C0A0, 0x55);

169 ià(
»t
) {

170 
	`ùs_”r
("Write DCS-CMD28 fail");

171  
»t
;

174 
	`m¦“p
(100);

176 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x3C040, 0x55);

177 ià(
»t
) {

178 
	`ùs_”r
("Write DCS-CMD10 fail");

179  
»t
;

182 
	`m¦“p
(100);

185 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x3002C, 
acûss_æag
);

186 ià(
»t
) {

187 
	`ùs_”r
("Re¡Üdi¥Ïy‡cûs æag %02x faed %d", 
acûss_æag
, 
»t
);

188  
»t
;

192 
	}
}

194 
	$wa™_‹¡_com¶‘e
(
ùs_deviû
 *
ùs_dev
, 
sk_äames
)

196 
»t
, 
i
, 
j
;

198 
	`ùs_šfo
("Wa™e¡ com¶‘sk %d f¿mes", 
sk_äames
);

200 
i
 = 0; i < (
sk_äames
 + 1); i++) {

201 
u8
 
»ady
;

203 
j
 = 0; j < 1000; j++) {

204 
	`md–ay
(1);

206 
»ady
 = 0;

207 
»t
 = 
	`ùs_g‘_d©a_»ady_æag
(
ùs_dev
, &
»ady
);

208 ià(
»t
) {

209 
	`ùs_”r
("G‘ d©¨»ady fÏg faed %d", 
»t
);

210  
»t
;

213 ià(
»ady
) {

218 ià(
»ady
 == 0) {

219 
	`ùs_”r
("Waitest completeimeout");

220  -
ETIMEDOUT
;

222 ià(
i
 < 
sk_äames
) {

223 
»t
 = 
	`ùs_şr_d©a_»ady_æag
(
ùs_dev
);

224 ià(
»t
) {

225 
	`ùs_”r
("CÌ d©¨»ady fÏg faed %d", 
»t
);

226  
»t
;

232 
	}
}

234 
	$g‘_‹¡_»suÉ
(
ùs_deviû
 *
ùs_dev
, 
u16
 *
»suÉ
)

236 
»t
;

238 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_RAW_DATA
, 
»suÉ
,

239 
	`TEST_RESULT_BUFFER_SIZE
(
ùs_dev
));

240 ià(
»t
) {

241 
	`ùs_”r
("G‘e¡„esuÉ d©¨çed %d", 
»t
);

242  
»t
;

245 
»t
 = 
	`ùs_şr_d©a_»ady_æag
(
ùs_dev
);

246 ià(
»t
) {

247 
	`ùs_”r
("CË¬ d©¨»ady fÏg faed %d", 
»t
);

248  
»t
;

252 
	}
}

254 
	$£t_fw_‹¡_ty³
(
ùs_deviû
 *
ùs_dev
, 
u8
 
ty³
)

256 
»t
, 
»Œ›s
 = 0;

257 
u8
 
sys_busy
;

258 
u8
 
ty³_»adback
;

260 
	`ùs_šfo
("S‘e¡y³ %d", 
ty³
);

262 
»t
 = 
	`ùs_fw_»g_wr™eb
(
ùs_dev
, 0x34, 
ty³
);

263 ià(
»t
) {

264 
	`ùs_”r
("Wr™‹¡y³„egi¡”Øçed %d", 
»t
);

265  
»t
;

269 
	`m¦“p
(1);

271 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 0x01, &
sys_busy
);

272 ià(
»t
) {

273 
	`ùs_”r
("R—d sy¡em busy„egi¡” faed %d", 
»t
);

274  
»t
;

276 } 
sys_busy
 && 
»Œ›s
++ < 1000);

278 ià(
»Œ›s
 >= 1000) {

279 
	`ùs_”r
("Wait system„eadyimeout");

280  -
ETIMEDOUT
;

283 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 0x34, &
ty³_»adback
);

284 ià(
»t
) {

285 
	`ùs_”r
("R—de¡y³„egi¡” faed %d", 
»t
);

286  
»t
;

289 ià(
ty³
 !ğ
ty³_»adback
) {

290 
	`ùs_”r
("S‘e¡y³ %u !ğ»adback %u", 
ty³
, 
ty³_»adback
);

291  -
EFAULT
;

295 
	}
}

297 
boŞ
 
	$£t_shÜt_‹¡_ty³
(
ùs_deviû
 *
ùs_dev
, 
u8
 
ty³
)

299 
	sfw_shÜt_‹¡_·¿m
 {

300 
u8
 
ty³
;

301 
u32
 
cŞ_·‰”n
[2];

302 
u32
 
row_·‰”n
[2];

303 } 
·¿m
 = {

304 .
ty³
 = 
CTS_SHORT_TEST_BETWEEN_COLS
,

305 .
cŞ_·‰”n
 = {0, 0},

306 .
row_·‰”n
 = {0, 0}

308 
i
, 
»t
;

310 
	`ùs_šfo
("S‘ shÜˆ‹¡y³Ø%u", 
ty³
);

312 
·¿m
.
ty³
 =ype;

313 
i
 = 0; i < 5; i++) {

314 
u8
 
ty³_»adback
;

316 
»t
 = 
	`ùs_fw_»g_wr™esb
(
ùs_dev
, 0x5000, &
·¿m
, (param));

317 ià(
»t
) {

318 
	`ùs_”r
("S‘ shÜˆ‹¡y³Ø%u faed %d", 
ty³
, 
»t
);

321 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 0x5000, &
ty³_»adback
);

322 ià(
»t
) {

323 
	`ùs_”r
("G‘ shÜˆ‹¡y³ faed %d", 
»t
);

326 ià(
ty³
 =ğ
ty³_»adback
) {

329 
	`ùs_”r
("S‘e¡y³ %u !ğ»adback %u", 
ty³
, 
ty³_»adback
);

334  
»t
;

335 
	}
}

337 
	$ùs_wr™e_fe
(
fe
 *
fp
, cÚ¡ *
d©a
, 
size_t
 
size
)

339 
loff_t
 
pos
;

340 
ssize_t
 
»t
;

342 
pos
 = 
fp
->
f_pos
;

344 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4,14,0)

345 
»t
 = 
	`k”Ãl_wr™e
(
fp
, 
d©a
, 
size
, &
pos
);

347 
»t
 = 
	`k”Ãl_wr™e
(
fp
, 
d©a
, 
size
, 
pos
);

350 ià(
»t
 >= 0) {

351 
fp
->
f_pos
 +ğ
»t
;

354  
»t
;

355 
	}
}

357 
fe
 *
	gùs_‹¡_d©a_fp
 = 
NULL
;

358 
	$ùs_¡¬t_dump_‹¡_d©a_to_fe
(cÚ¡ *
f•©h
, 
boŞ
 
­³nd_to_fe
)

360 
	#START_BANNER
 \

361 ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n"

	)

363 
	`ùs_šfo
("S¹ dum°‹¡ d©¨tØf'%s'", 
f•©h
);

365 
ùs_‹¡_d©a_fp
 = 
	`fp_İ’
(
f•©h
,

366 
O_WRONLY
 | 
O_CREAT
 | (
­³nd_to_fe
 ? 
O_APPEND
 : 
O_TRUNC
),

367 
S_IRUGO
 | 
S_IWUGO
);

368 ià(
	`IS_ERR
(
ùs_‹¡_d©a_fp
)) {

369 
»t
 = 
	`PTR_ERR
(
ùs_‹¡_d©a_fp
);

370 
ùs_‹¡_d©a_fp
 = 
NULL
;

371 
	`ùs_”r
("Open file '%s' forest data failed %d",

372 
ùs_‹¡_d©a_fp
, 
»t
);

373  
»t
;

376 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
START_BANNER
, 
	`¡¾’
(START_BANNER));

379 #undeà
START_BANNER


380 
	}
}

382 
	$ùs_¡İ_dump_‹¡_d©a_to_fe
()

384 
	#END_BANNER
 \

385 "<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\n"

	)

386 
r
;

388 
	`ùs_šfo
("Stop dumpest datao file");

390 ià(
ùs_‹¡_d©a_fp
) {

391 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
,

392 
END_BANNER
, 
	`¡¾’
(END_BANNER));

393 
r
 = 
	`fp_şo£
(
ùs_‹¡_d©a_fp
, 
NULL
);

394 ià(
r
) {

395 
	`ùs_”r
("Clo£e¡ d©¨fçed %d", 
r
);

397 
ùs_‹¡_d©a_fp
 = 
NULL
;

399 
	`ùs_w¬n
("Stop dumpsdatao file with filp = NULL");

401 #undeà
END_BANNER


402 
	}
}

404 
	$ùs_dump_tsd©a
(
ùs_deviû
 *
ùs_dev
,

405 cÚ¡ *
desc
, cÚ¡ 
u16
 *
d©a
, 
boŞ
 
to_cÚsŞe
)

407 
	#SPLIT_LINE_STR
 \

408 "---------------------------------------------------------------------------------------------------------------"

	)

409 
	#ROW_NUM_FORMAT_STR
 "%2d | "

	)

410 
	#COL_NUM_FORMAT_STR
 "%-5u "

	)

411 
	#DATA_FORMAT_STR
 "%-5u "

	)

413 
r
, 
c
;

414 
u32
 
max
, 
mš
, 
sum
, 
av”age
;

415 
max_r
, 
max_c
, 
mš_r
, 
mš_c
;

416 
lše_buf
[128];

417 
couÁ
 = 0;

419 
max
 = 
mš
 = 
d©a
[0];

420 
sum
 = 0;

421 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

422 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

423 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

424 
u16
 
v®
 = 
d©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
];

426 
sum
 +ğ
v®
;

427 ià(
v®
 > 
max
) {

428 
max
 = 
v®
;

429 
max_r
 = 
r
;

430 
max_c
 = 
c
;

431 } ià(
v®
 < 
mš
) {

432 
mš
 = 
v®
;

433 
mš_r
 = 
r
;

434 
mš_c
 = 
c
;

438 
av”age
 = 
sum
 / (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
);

440 
couÁ
 = 0;

441 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count,

443 
desc
, 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
);

444 ià(
to_cÚsŞe
) {

445 
	`ùs_šfo
(
SPLIT_LINE_STR
);

446 
	`ùs_šfo
("%s", 
lše_buf
);

447 
	`ùs_šfo
(
SPLIT_LINE_STR
);

449 ià(
ùs_‹¡_d©a_fp
) {

450 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

451 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

452 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
lše_buf
, 
couÁ
);

453 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

454 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

455 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

458 
couÁ
 = 0;

459 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count, " | ");

460 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

461 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count,

462 
COL_NUM_FORMAT_STR
, 
c
);

464 ià(
to_cÚsŞe
) {

465 
	`ùs_šfo
("%s", 
lše_buf
);

466 
	`ùs_šfo
(
SPLIT_LINE_STR
);

468 ià(
ùs_‹¡_d©a_fp
) {

469 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
lše_buf
, 
couÁ
);

470 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

471 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

472 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

475 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

476 
couÁ
 = 0;

477 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count,

478 
ROW_NUM_FORMAT_STR
, 
r
);

479 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

480 
couÁ
 +=

481 
	`sú´štf
(
lše_buf
 + 
couÁ
, (line_buf) - count,

482 
DATA_FORMAT_STR
,

483 
d©a
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
]);

485 ià(
to_cÚsŞe
) {

486 
	`ùs_šfo
("%s", 
lše_buf
);

488 ià(
ùs_‹¡_d©a_fp
) {

489 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
lše_buf
, 
couÁ
);

490 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

493 ià(
to_cÚsŞe
) {

494 
	`ùs_šfo
(
SPLIT_LINE_STR
);

496 ià(
ùs_‹¡_d©a_fp
) {

497 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

498 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

501 #undeà
SPLIT_LINE_STR


502 #undeà
ROW_NUM_FORMAT_STR


503 #undeà
COL_NUM_FORMAT_STR


504 #undeà
DATA_FORMAT_STR


505 
	}
}

507 
boŞ
 
	$is_šv®id_node
(
u32
 *
šv®id_nodes
, u32 
num_šv®id_nodes
,

508 
u16
 
row
, u16 
cŞ
)

510 
i
;

512 
i
 = 0; i < 
num_šv®id_nodes
; i++) {

513 ià(
	`MAKE_INVALID_NODE
(
row
,
cŞ
)=ğ
šv®id_nodes
[
i
]) {

514  
Œue
;

518  
çl£
;

519 
	}
}

521 
	$v®id©e_tsd©a
(
ùs_deviû
 *
ùs_dev
,

522 cÚ¡ *
desc
, 
u16
 *
d©a
,

523 
u32
 *
šv®id_nodes
, u32 
num_šv®id_nodes
,

524 
boŞ
 
³r_node
, *
mš
, *
max
)

526 
	#SPLIT_LINE_STR
 \

527 "------------------------------"

	)

529 
r
, 
c
;

530 
çed_út
 = 0;

532 
	`ùs_šfo
("%s validate data: %s,‚um invalid‚ode: %u,hresh[0]=[%d, %d]",

533 
desc
, 
³r_node
 ? "Per-Node" : "Uniform-Threshold",

534 
num_šv®id_nodes
, 
mš
 ? mš[0] : 
INT_MIN
, 
max
 ? max[0] : 
INT_MAX
);

536 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

537 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

538 
off£t
 = 
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
;

540 ià(
num_šv®id_nodes
 &&

541 
	`is_šv®id_node
(
šv®id_nodes
, 
num_šv®id_nodes
, 
r
,
c
)) {

545 ià((
mš
 !ğ
NULL
 && 
d©a
[
off£t
] < mš[
³r_node
 ? offset : 0]) ||

546 (
max
 !ğ
NULL
 && 
d©a
[
off£t
] > max[
³r_node
 ? offset : 0])) {

547 ià(
çed_út
 == 0) {

548 
	`ùs_šfo
(
SPLIT_LINE_STR
);

549 
	`ùs_šfo
("% çed‚odes:", 
desc
);

551 
çed_út
++;

553 
	`ùs_šfo
(" %3d: [%-2d][%-2d] = %u",

554 
çed_út
, 
r
, 
c
, 
d©a
[
off£t
]);

559 ià(
çed_út
) {

560 
	`ùs_šfo
(
SPLIT_LINE_STR
);

561 
	`ùs_šfo
("% ‹¡ %d‚odtÙ® faed", 
desc
, 
çed_út
);

564  
çed_út
;

566 #undeà
SPLIT_LINE_STR


567 
	}
}

569 
	$v®id©e_comp_ÿp
(
ùs_deviû
 *
ùs_dev
,

570 cÚ¡ *
desc
, 
u8
 *
ÿp
,

571 
u32
 *
šv®id_nodes
, u32 
num_šv®id_nodes
,

572 
boŞ
 
³r_node
, *
mš
, *
max
)

574 
	#SPLIT_LINE_STR
 \

575 "------------------------------"

	)

577 
r
, 
c
;

578 
çed_út
 = 0;

580 
	`ùs_šfo
("Validate %s data: %s,‚um invalid‚ode: %u,hresh[0]=[%d, %d]",

581 
desc
, 
³r_node
 ? "Per-Node" : "Uniform-Threshold",

582 
num_šv®id_nodes
, 
mš
 ? mš[0] : 
INT_MIN
, 
max
 ? max[0] : 
INT_MAX
);

584 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

585 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

586 
off£t
 = 
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
;

588 ià(
num_šv®id_nodes
 &&

589 
	`is_šv®id_node
(
šv®id_nodes
, 
num_šv®id_nodes
, 
r
,
c
)) {

593 ià((
mš
 !ğ
NULL
 && 
ÿp
[
off£t
] < mš[
³r_node
 ? offset : 0]) ||

594 (
max
 !ğ
NULL
 && 
ÿp
[
off£t
] > max[
³r_node
 ? offset : 0])) {

595 ià(
çed_út
 == 0) {

596 
	`ùs_šfo
(
SPLIT_LINE_STR
);

597 
	`ùs_šfo
("% çed‚odes:", 
desc
);

599 
çed_út
++;

601 
	`ùs_šfo
(" %3d: [%-2d][%-2d] = %u",

602 
çed_út
, 
r
, 
c
, 
ÿp
[
off£t
]);

607 ià(
çed_út
) {

608 
	`ùs_šfo
(
SPLIT_LINE_STR
);

609 
	`ùs_šfo
("% ‹¡ %d‚odtÙ® faed", 
desc
, 
çed_út
);

612  
çed_út
;

614 #undeà
SPLIT_LINE_STR


615 
	}
}

617 
	$wa™_fw_to_nÜm®_wÜk
(
ùs_deviû
 *
ùs_dev
)

619 
i
 = 0;

620 
»t
;

622 
	`ùs_šfo
 ("Wait fwo‚ormal work");

625 
u8
 
wÜk_mode
;

627 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

628 
CTS_DEVICE_FW_REG_GET_WORK_MODE
, &
wÜk_mode
);

629 ià(
»t
) {

630 
	`ùs_”r
("G‘ fw cu¼ wÜk modçed %d", 
wÜk_mode
);

633 ià(
wÜk_mode
 =ğ
CTS_FIRMWARE_WORK_MODE_NORMAL
) {

638 
	`md–ay
 (10);

639 } ++
i
 < 100);

641  
»t
 ?„‘ : -
ETIMEDOUT
;

642 
	}
}

644 
	$´•¬e_‹¡
(
ùs_deviû
 *
ùs_dev
)

646 
»t
;

648 
	`ùs_šfo
("Prepareest");

650 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

652 
»t
 = 
	`ùs_£t_dev_esd_´ÙeùiÚ
(
ùs_dev
, 
çl£
);

653 ià(
»t
) {

654 
	`ùs_”r
("Di§bË fœmw¬ESD…rÙeùiÚ faed %d", 
»t
);

655  
»t
;

658 
»t
 = 
	`di§bË_fw_mÚ™Ü_mode
(
ùs_dev
);

659 ià(
»t
) {

660 
	`ùs_”r
("Di§bË fœmw¬mÚ™Ü modçed %d", 
»t
);

661  
»t
;

664 
»t
 = 
	`di§bË_fw_auto_com³n§‹
(
ùs_dev
);

665 ià(
»t
) {

666 
	`ùs_”r
("Di§bË fœmw¬autØcom³n§‹ faed %d", 
»t
);

667  
»t
;

670 
»t
 = 
	`£t_fw_wÜk_mode
(
ùs_dev
, 
CTS_FIRMWARE_WORK_MODE_CONFIG
);

671 ià(
»t
) {

672 
	`ùs_”r
("S‘ fœmw¬wÜk modtØWORK_MODE_CONFIG faed %d", 
»t
);

673  
»t
;

676 
ùs_dev
->
¹d©a
.
‹¡šg
 = 
Œue
;

679 
	}
}

681 
	$po¡_‹¡
(
ùs_deviû
 *
ùs_dev
)

683 
»t
;

685 
	`ùs_šfo
("Postest");

687 
	`ùs_¶©_»£t_deviû
(
ùs_dev
->
pd©a
);

689 
»t
 = 
	`£t_fw_wÜk_mode
(
ùs_dev
, 
CTS_FIRMWARE_WORK_MODE_NORMAL
);

690 ià(
»t
) {

691 
	`ùs_”r
("S‘ fœmw¬wÜk modtØWORK_MODE_NORMAL faed %d", 
»t
);

694 
»t
 = 
	`wa™_fw_to_nÜm®_wÜk
(
ùs_dev
);

695 ià(
»t
) {

696 
	`ùs_”r
("Wa™ fwØnÜm® wÜk faed %d", 
»t
);

700 
ùs_dev
->
¹d©a
.
‹¡šg
 = 
çl£
;

701 
	}
}

706 
	$ùs_‹¡_shÜt
(
ùs_deviû
 *
ùs_dev
,

707 
ùs_‹¡_·¿m
 *
·¿m
)

709 
boŞ
 
driv”_v®id©e_d©a
 = 
çl£
;

710 
boŞ
 
v®id©e_d©a_³r_node
 = 
çl£
;

711 
boŞ
 
¡İ_if_çed
 = 
çl£
;

712 
boŞ
 
dump_‹¡_d©e_to_u£r
 = 
çl£
;

713 
boŞ
 
dump_‹¡_d©e_to_cÚsŞe
 = 
çl£
;

714 
boŞ
 
dump_‹¡_d©e_to_fe
 = 
çl£
;

715 
num_nodes
;

716 
tsd©a_äame_size
;

717 
loİút
;

718 
»t
;

719 
u16
 *
‹¡_»suÉ
 = 
NULL
;

720 
boŞ
 
»cov”y_di¥Ïy_¡©e
 = 
çl£
;

721 
u8
 
Ãed_di¥Ïy_Ú
;

722 
u8
 
ã©u»_v”
;

724 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL) {

725 
	`ùs_”r
("Shortest with invalid…aram: cts_dev: %pest…aram: %p",

726 
ùs_dev
, 
·¿m
);

727  -
EINVAL
;

730 
num_nodes
 = 
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
;

731 
tsd©a_äame_size
 = 2 * 
num_nodes
;

733 
driv”_v®id©e_d©a
 =

734 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_DATA
);

735 
v®id©e_d©a_³r_node
 =

736 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_PER_NODE
);

737 
dump_‹¡_d©e_to_u£r
 =

738 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
);

739 
dump_‹¡_d©e_to_cÚsŞe
 =

740 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
);

741 
dump_‹¡_d©e_to_fe
 =

742 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
);

743 
¡İ_if_çed
 =

744 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
);

746 
	`ùs_šfo
("Shortest, flags: 0x%08x,"

750 
·¿m
->
æags
,…¬am->
num_šv®id_node
,

751 
·¿m
->
‹¡_d©a_f•©h
,…¬am->
‹¡_d©a_buf_size
,

752 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

754 ià(
dump_‹¡_d©e_to_u£r
) {

755 
‹¡_»suÉ
 = (
u16
 *)
·¿m
->
‹¡_d©a_buf
;

757 
‹¡_»suÉ
 = (
u16
 *)
	`km®loc
(
tsd©a_äame_size
, 
GFP_KERNEL
);

758 ià(
‹¡_»suÉ
 =ğ
NULL
) {

759 
	`ùs_”r
("Allocateest„esult buffer failed");

760  -
ENOMEM
;

764 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

765 ià(
»t
) {

766 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

767  
»t
;

770 
	`ùs_lock_deviû
(
ùs_dev
);

772 
»t
 = 
	`´•¬e_‹¡
(
ùs_dev
);

773 ià(
»t
) {

774 
	`ùs_”r
("P»·»e¡ faed %d", 
»t
);

775 
”r_ä“_‹¡_»suÉ
;

778 
	`ùs_šfo
("Test shorto GND");

780 
»t
 = 
	`ùs_¤am_»adb
(
ùs_dev
, 0xE8, &
ã©u»_v”
);

781 ià(
»t
) {

782 
	`ùs_”r
("R—d fœmw¬ã©u» v”siÚ faed %d", 
»t
);

783 
”r_ä“_‹¡_»suÉ
;

785 
	`ùs_šfo
("F—tu» v”siÚ: %u", 
ã©u»_v”
);

787 ià(
ã©u»_v”
 > 0) {

788 
»t
 = 
	`£t_shÜt_‹¡_ty³
(
ùs_dev
, 
CTS_SHORT_TEST_UNDEFINED
);

789 ià(
»t
) {

790 
	`ùs_”r
("S‘ shÜˆ‹¡y³ØUNDEFINED faed %d", 
»t
);

791 
”r_ä“_‹¡_»suÉ
;

794 
»t
 = 
	`£t_fw_‹¡_ty³
(
ùs_dev
, 
CTS_TEST_SHORT
);

795 ià(
»t
) {

796 
	`ùs_”r
("S‘e¡y³ØSHORT faed %d", 
»t
);

797 
”r_ä“_‹¡_»suÉ
;

800 
»t
 = 
	`£t_fw_wÜk_mode
(
ùs_dev
, 
CTS_FIRMWARE_WORK_MODE_TEST
);

801 ià(
»t
) {

802 
	`ùs_”r
("Set firmware work modeo WORK_MODE_TEST failed %d",

803 
»t
);

804 
”r_ä“_‹¡_»suÉ
;

807 ià(
ã©u»_v”
 <= 3) {

808 
u8
 
v®
;

810 
	`ùs_šfo
("Patch shortest issue");

812 
»t
 = 
	`ùs_hw_»g_»adb
(
ùs_dev
, 0x350E2, &
v®
);

813 ià(
»t
) {

814 
	`ùs_”r
("R—d 0x350E2 faed %d", 
»t
);

815  
»t
;

817 ià((
v®
 & (
	`BIT
(2) | BIT(5))) != 0) {

818 
»t
 = 
	`ùs_hw_»g_wr™eb
(
ùs_dev
, 0x350E2, 
v®
 & 0xDB);

819 ià(
»t
) {

820 
	`ùs_”r
("Wr™0x350E2 faed %d", 
»t
);

821  
»t
;

826 
»t
 = 
	`£t_shÜt_‹¡_ty³
(
ùs_dev
, 
CTS_SHORT_TEST_BETWEEN_GND
);

827 ià(
»t
) {

828 
	`ùs_”r
("S‘ shÜˆ‹¡y³ØSHORT_TO_GND faed %d", 
»t
);

829 
”r_ä“_‹¡_»suÉ
;

832 
»t
 = 
	`wa™_‹¡_com¶‘e
(
ùs_dev
, 0);

833 ià(
»t
) {

834 
	`ùs_”r
("Wa™e¡ com¶‘çed %d", 
»t
);

835 
”r_ä“_‹¡_»suÉ
;

838 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_RECOVERY_TX_VOL
);

839 ià(
»t
) {

840 
	`ùs_”r
("S’d commªd RECOVERY_TX_VOL faed %d", 
»t
);

841 
”r_ä“_‹¡_»suÉ
;

844 
»t
 = 
	`wa™_‹¡_com¶‘e
(
ùs_dev
, 2);

845 ià(
»t
) {

846 
	`ùs_”r
("Wa™e¡ com¶‘çed %d", 
»t
);

847 
”r_ä“_‹¡_»suÉ
;

853 
»t
 = 
	`g‘_‹¡_»suÉ
(
ùs_dev
, 
‹¡_»suÉ
);

854 ià(
»t
) {

855 
	`ùs_”r
("R—de¡„esuÉ faed %d", 
»t
);

856 
”r_ä“_‹¡_»suÉ
;

859 ià(
dump_‹¡_d©e_to_u£r
) {

860 *
·¿m
->
‹¡_d©a_wr_size
 +ğ
tsd©a_äame_size
;

863 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

864 
	`ùs_dump_tsd©a
(
ùs_dev
, "GND-shÜt", 
‹¡_»suÉ
,

865 
dump_‹¡_d©e_to_cÚsŞe
);

868 ià(
driv”_v®id©e_d©a
) {

869 
»t
 = 
	`v®id©e_tsd©a
(
ùs_dev
, "GND-short",

870 
‹¡_»suÉ
, 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

871 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

872 ià(
»t
) {

873 
	`ùs_”r
("ShÜˆtØGNDe¡ faed %d", 
»t
);

874 ià(
¡İ_if_çed
) {

875 
”r_ä“_‹¡_»suÉ
;

880 ià(
dump_‹¡_d©e_to_u£r
) {

881 
‹¡_»suÉ
 +ğ
num_nodes
;

884 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

885 
CTS_DEVICE_FW_REG_TEST_WITH_DISPLAY_ON
, &
Ãed_di¥Ïy_Ú
);

886 ià(
»t
) {

887 
	`ùs_”r
("R—d‚“d di¥Ïy oÀ»gi¡” faed %d", 
»t
);

888 
”r_ä“_‹¡_»suÉ
;

891 ià(
Ãed_di¥Ïy_Ú
 == 0) {

892 
»t
 = 
	`£t_di¥Ïy_¡©e
(
ùs_dev
, 
çl£
);

893 ià(
»t
) {

894 
	`ùs_”r
("S‘ di¥Ïy s‹ØSLEEP faed %d", 
»t
);

895 
”r_ä“_‹¡_»suÉ
;

897 
»cov”y_di¥Ïy_¡©e
 = 
Œue
;

903 
	`ùs_šfo
("Test short between columns");

906 
»t
 = 
	`£t_fw_‹¡_ty³
(
ùs_dev
, 
CTS_TEST_SHORT
);

907 ià(
»t
) {

908 
	`ùs_”r
("S‘e¡y³ØSHORT faed %d", 
»t
);

909  
»t
;

913 
»t
 = 
	`£t_shÜt_‹¡_ty³
(
ùs_dev
, 
CTS_SHORT_TEST_BETWEEN_COLS
);

914 ià(
»t
) {

915 
	`ùs_”r
("S‘ shÜˆ‹¡y³ØBETWEEN_COLS faed %d", 
»t
);

916 
”r_»cov”y_di¥Ïy_¡©e
;

920 
»t
 = 
	`£t_fw_wÜk_mode
(
ùs_dev
, 
CTS_FIRMWARE_WORK_MODE_TEST
);

921 ià(
»t
) {

922 
	`ùs_”r
("Set firmware work modeo WORK_MODE_TEST failed %d",

923 
»t
);

924  
»t
;

928 ià(
Ãed_di¥Ïy_Ú
 == 0) {

929 
	`ùs_šfo
("Skip first frame data");

931 
»t
 = 
	`wa™_‹¡_com¶‘e
(
ùs_dev
, 0);

932 ià(
»t
) {

933 
	`ùs_”r
("Wa™e¡ com¶‘çed %d", 
»t
);

934 
”r_»cov”y_di¥Ïy_¡©e
;

937 
»t
 = 
	`g‘_‹¡_»suÉ
(
ùs_dev
, 
‹¡_»suÉ
);

938 ià(
»t
) {

939 
	`ùs_”r
("R—d ske¡„esuÉ faed %d", 
»t
);

940 
”r_»cov”y_di¥Ïy_¡©e
;

943 
»t
 = 
	`£t_shÜt_‹¡_ty³
(
ùs_dev
, 
CTS_SHORT_TEST_BETWEEN_COLS
);

944 ià(
»t
) {

945 
	`ùs_”r
("Set shortestypeo BETWEEN_COLS failed %d",

946 
»t
);

947 
”r_»cov”y_di¥Ïy_¡©e
;

951 
»t
 = 
	`wa™_‹¡_com¶‘e
(
ùs_dev
, 0);

952 ià(
»t
) {

953 
	`ùs_”r
("Wa™e¡ com¶‘çed %d", 
»t
);

954 
”r_»cov”y_di¥Ïy_¡©e
;

957 
»t
 = 
	`g‘_‹¡_»suÉ
(
ùs_dev
, 
‹¡_»suÉ
);

958 ià(
»t
) {

959 
	`ùs_”r
("R—de¡„esuÉ faed %d", 
»t
);

960 
”r_»cov”y_di¥Ïy_¡©e
;

963 ià(
dump_‹¡_d©e_to_u£r
) {

964 *
·¿m
->
‹¡_d©a_wr_size
 +ğ
tsd©a_äame_size
;

967 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

968 
	`ùs_dump_tsd©a
(
ùs_dev
, "CŞ-shÜt", 
‹¡_»suÉ
,

969 
dump_‹¡_d©e_to_cÚsŞe
);

972 ià(
driv”_v®id©e_d©a
) {

973 
»t
 = 
	`v®id©e_tsd©a
(
ùs_dev
, "Col-short",

974 
‹¡_»suÉ
, 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

975 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

976 ià(
»t
) {

977 
	`ùs_”r
("ShÜˆb‘w“ÀcŞumn ‹¡ faed %d", 
»t
);

978 ià(
¡İ_if_çed
) {

979 
”r_»cov”y_di¥Ïy_¡©e
;

984 ià(
dump_‹¡_d©e_to_u£r
) {

985 
‹¡_»suÉ
 +ğ
num_nodes
;

991 
	`ùs_šfo
("Test short between„ows");

993 
»t
 = 
	`£t_shÜt_‹¡_ty³
(
ùs_dev
, 
CTS_SHORT_TEST_BETWEEN_ROWS
);

994 ià(
»t
) {

995 
	`ùs_”r
("S‘ shÜˆ‹¡y³ØBETWEEN_ROWS faed %d", 
»t
);

996 
”r_»cov”y_di¥Ïy_¡©e
;

999 
loİút
 = 
ùs_dev
->
hwd©a
->
num_row
;

1000 
loİút
 > 1) {

1001 
»t
 = 
	`wa™_‹¡_com¶‘e
(
ùs_dev
, 0);

1002 ià(
»t
) {

1003 
	`ùs_”r
("Wa™e¡ com¶‘çed %d", 
»t
);

1004 
”r_»cov”y_di¥Ïy_¡©e
;

1007 
»t
 = 
	`g‘_‹¡_»suÉ
(
ùs_dev
, 
‹¡_»suÉ
);

1008 ià(
»t
) {

1009 
	`ùs_”r
("R—de¡„esuÉ faed %d", 
»t
);

1010 
”r_»cov”y_di¥Ïy_¡©e
;

1013 ià(
dump_‹¡_d©e_to_u£r
) {

1014 *
·¿m
->
‹¡_d©a_wr_size
 +ğ
tsd©a_äame_size
;

1017 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

1018 
	`ùs_dump_tsd©a
(
ùs_dev
, "Row-shÜt", 
‹¡_»suÉ
,

1019 
dump_‹¡_d©e_to_cÚsŞe
);

1022 ià(
driv”_v®id©e_d©a
) {

1023 
»t
 = 
	`v®id©e_tsd©a
(
ùs_dev
, "Row-short",

1024 
‹¡_»suÉ
, 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

1025 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

1026 ià(
»t
) {

1027 
	`ùs_”r
("ShÜˆb‘w“ÀcŞumn ‹¡ faed %d", 
»t
);

1028 ià(
¡İ_if_çed
) {

1029 
”r_»cov”y_di¥Ïy_¡©e
;

1034 ià(
dump_‹¡_d©e_to_u£r
) {

1035 
‹¡_»suÉ
 +ğ
num_nodes
;

1038 
loİút
 +=†oopcnt % 2;

1039 
loİút
 =†oopcnt >> 1;

1042 
”r_»cov”y_di¥Ïy_¡©e
:

1043 ià(
»cov”y_di¥Ïy_¡©e
) {

1044 
r
 = 
	`£t_di¥Ïy_¡©e
(
ùs_dev
, 
Œue
);

1045 ià(
r
) {

1046 
	`ùs_”r
("S‘ di¥Ïy s‹ØACTIVE faed %d", 
r
);

1049 
”r_ä“_‹¡_»suÉ
:

1050 ià(!
dump_‹¡_d©e_to_u£r
 && 
‹¡_»suÉ
) {

1051 
	`kä“
(
‹¡_»suÉ
);

1053 
	`po¡_‹¡
(
ùs_dev
);

1055 
	`ùs_uÆock_deviû
(
ùs_dev
);

1057 
	`ùs_šfo
("ShÜˆ‹¡ %s", 
»t
 ? "FAILED" : "PASSED");

1059 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1061  
»t
;

1062 
	}
}

1067 
	$ùs_‹¡_İ’
(
ùs_deviû
 *
ùs_dev
,

1068 
ùs_‹¡_·¿m
 *
·¿m
)

1070 
boŞ
 
driv”_v®id©e_d©a
 = 
çl£
;

1071 
boŞ
 
v®id©e_d©a_³r_node
 = 
çl£
;

1072 
boŞ
 
dump_‹¡_d©e_to_u£r
 = 
çl£
;

1073 
boŞ
 
dump_‹¡_d©e_to_cÚsŞe
 = 
çl£
;

1074 
boŞ
 
dump_‹¡_d©e_to_fe
 = 
çl£
;

1075 
num_nodes
;

1076 
tsd©a_äame_size
;

1077 
»t
;

1078 
u16
 *
‹¡_»suÉ
 = 
NULL
;

1079 
boŞ
 
»cov”y_di¥Ïy_¡©e
 = 
çl£
;

1080 
u8
 
Ãed_di¥Ïy_Ú
;

1082 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL) {

1083 
	`ùs_”r
("Openest with invalid…aram: cts_dev: %pest…aram: %p",

1084 
ùs_dev
, 
·¿m
);

1085  -
EINVAL
;

1088 
num_nodes
 = 
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
;

1089 
tsd©a_äame_size
 = 2 * 
num_nodes
;

1091 
driv”_v®id©e_d©a
 =

1092 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_DATA
);

1093 
v®id©e_d©a_³r_node
 =

1094 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_PER_NODE
);

1095 
dump_‹¡_d©e_to_u£r
 =

1096 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
);

1097 
dump_‹¡_d©e_to_cÚsŞe
 =

1098 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
);

1099 
dump_‹¡_d©e_to_fe
 =

1100 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
);

1102 
	`ùs_šfo
("Openest, flags: 0x%08x,"

1106 
·¿m
->
æags
,…¬am->
num_šv®id_node
,

1107 
·¿m
->
‹¡_d©a_f•©h
,…¬am->
‹¡_d©a_buf_size
,

1108 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

1110 ià(
dump_‹¡_d©e_to_u£r
) {

1111 
‹¡_»suÉ
 = (
u16
 *)
·¿m
->
‹¡_d©a_buf
;

1113 
‹¡_»suÉ
 = (
u16
 *è
	`km®loc
(
tsd©a_äame_size
, 
GFP_KERNEL
);

1114 ià(
‹¡_»suÉ
 =ğ
NULL
) {

1115 
	`ùs_”r
("Allocate memory forest„esult faild");

1116  -
ENOMEM
;

1120 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1121 ià(
»t
) {

1122 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1123  
»t
;

1126 
	`ùs_lock_deviû
(
ùs_dev
);

1127 
»t
 = 
	`´•¬e_‹¡
(
ùs_dev
);

1128 ià(
»t
) {

1129 
	`ùs_”r
("P»·»e¡ faed %d", 
»t
);

1130 
”r_ä“_‹¡_»suÉ
;

1133 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

1134 
CTS_DEVICE_FW_REG_TEST_WITH_DISPLAY_ON
, &
Ãed_di¥Ïy_Ú
);

1135 ià(
»t
) {

1136 
	`ùs_”r
("R—d‚“d di¥Ïy oÀ»gi¡” faed %d", 
»t
);

1137 
”r_ä“_‹¡_»suÉ
;

1140 ià(
Ãed_di¥Ïy_Ú
 == 0) {

1141 
»t
 = 
	`£t_di¥Ïy_¡©e
(
ùs_dev
, 
çl£
);

1142 ià(
»t
) {

1143 
	`ùs_”r
("S‘ di¥Ïy s‹ØSLEEP faed %d", 
»t
);

1144 
”r_ä“_‹¡_»suÉ
;

1146 
»cov”y_di¥Ïy_¡©e
 = 
Œue
;

1149 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_RECOVERY_TX_VOL
);

1150 ià(
»t
) {

1151 
	`ùs_”r
("Recov”yx vŞgçed %d", 
»t
);

1152 
”r_»cov”y_di¥Ïy_¡©e
;

1155 
»t
 = 
	`£t_fw_‹¡_ty³
(
ùs_dev
, 
CTS_TEST_OPEN
);

1156 ià(
»t
) {

1157 
	`ùs_”r
("S‘e¡y³ØOPEN_TEST faed %d", 
»t
);

1158 
”r_»cov”y_di¥Ïy_¡©e
;

1161 
»t
 = 
	`£t_fw_wÜk_mode
(
ùs_dev
, 
CTS_FIRMWARE_WORK_MODE_TEST
);

1162 ià(
»t
) {

1163 
	`ùs_”r
("Set firmware work modeo WORK_MODE_TEST failed %d",

1164 
»t
);

1165 
”r_»cov”y_di¥Ïy_¡©e
;

1168 
»t
 = 
	`wa™_‹¡_com¶‘e
(
ùs_dev
, 2);

1169 ià(
»t
) {

1170 
	`ùs_”r
("Wa™e¡ com¶‘çed %d", 
»t
);

1171 
”r_»cov”y_di¥Ïy_¡©e
;

1174 
»t
 = 
	`g‘_‹¡_»suÉ
(
ùs_dev
, 
‹¡_»suÉ
);

1175 ià(
»t
) {

1176 
	`ùs_”r
("R—de¡„esuÉ faed %d", 
»t
);

1177 
”r_»cov”y_di¥Ïy_¡©e
;

1180 ià(
dump_‹¡_d©e_to_u£r
) {

1181 *
·¿m
->
‹¡_d©a_wr_size
 +ğ
tsd©a_äame_size
;

1184 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

1185 
	`ùs_dump_tsd©a
(
ùs_dev
, "O³n-cœcu™", 
‹¡_»suÉ
,

1186 
dump_‹¡_d©e_to_cÚsŞe
);

1189 ià(
driv”_v®id©e_d©a
) {

1190 
»t
 = 
	`v®id©e_tsd©a
(
ùs_dev
, "Open-circuit",

1191 
‹¡_»suÉ
, 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

1192 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

1194 
”r_»cov”y_di¥Ïy_¡©e
:

1195 ià(
»cov”y_di¥Ïy_¡©e
) {

1196 
r
 = 
	`£t_di¥Ïy_¡©e
(
ùs_dev
, 
Œue
);

1197 ià(
r
) {

1198 
	`ùs_”r
("S‘ di¥Ïy s‹ØACTIVE faed %d", 
r
);

1201 
”r_ä“_‹¡_»suÉ
:

1202 ià(!
dump_‹¡_d©e_to_u£r
 && 
‹¡_»suÉ
) {

1203 
	`kä“
(
‹¡_»suÉ
);

1205 
	`po¡_‹¡
(
ùs_dev
);

1207 
	`ùs_uÆock_deviû
(
ùs_dev
);

1208 
	`ùs_šfo
("O³À‹¡ %s", 
»t
 ? "FAILED" : "PASSED");

1210 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1212  
»t
;

1213 
	}
}

1215 #ifdeà
CFG_CTS_HAS_RESET_PIN


1216 
	$ùs_‹¡_»£t_pš
(
ùs_deviû
 *
ùs_dev
, 
ùs_‹¡_·¿m
 *
·¿m
)

1218 
»t
;

1219 
v®
 = 0;

1221 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL) {

1222  -
EINVAL
;

1225 
	`ùs_šfo
("Reset Pinest, flags: 0x%08x, "

1227 
·¿m
->
æags
,

1228 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

1230 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1231 ià(
»t
) {

1232 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1233  
»t
;

1236 
	`ùs_lock_deviû
(
ùs_dev
);

1238 
	`ùs_¶©_£t_»£t
(
ùs_dev
->
pd©a
, 0);

1239 
	`md–ay
(50);

1240 #ifdeà
CONFIG_CTS_I2C_HOST


1242 ià(!
	`ùs_¶©_is_i2c_Úlše
(
ùs_dev
->
pd©a
,

1243 
CTS_DEV_NORMAL_MODE_I2CADDR
)) {

1245 ià(!
	`ùs_¶©_is_nÜm®_mode
(
ùs_dev
->
pd©a
)) {

1247 
v®
++;

1249 
	`ùs_”r
("Device is‡live while„eset is†ow");

1251 
	`ùs_¶©_£t_»£t
(
ùs_dev
->
pd©a
, 1);

1252 
	`md–ay
(50);

1254 
»t
 = 
	`wa™_fw_to_nÜm®_wÜk
(
ùs_dev
);

1255 ià(
»t
) {

1256 
	`ùs_”r
("Wa™ fwØnÜm® wÜk faed %d", 
»t
);

1259 #ifdeà
CONFIG_CTS_I2C_HOST


1261 ià(
	`ùs_¶©_is_i2c_Úlše
(
ùs_dev
->
pd©a
, 
CTS_DEV_NORMAL_MODE_I2CADDR
)) {

1263 ià(
	`ùs_¶©_is_nÜm®_mode
(
ùs_dev
->
pd©a
)) {

1265 
v®
++;

1267 
	`ùs_”r
("Device is offline while„eset is high");

1269 #ifdeà
CONFIG_CTS_CHARGER_DETECT


1270 ià(
	`ùs_is_ch¬g”_exi¡
(
ùs_dev
)) {

1271 
r
 = 
	`ùs_£t_dev_ch¬g”_©ched
(
ùs_dev
, 
Œue
);

1272 ià(
r
) {

1273 
	`ùs_”r
("S‘ dev ch¬g”‡‰ached faed %d", 
r
);

1278 #ifdeà
CONFIG_CTS_EARJACK_DETECT


1279 ià(
ùs_dev
->
fwd©a
.
suµ_h—dphÚe_ÿbË_»jeù
 &&

1280 
	`ùs_is_—rjack_exi¡
(
ùs_dev
)) {

1281 
r
 = 
	`ùs_£t_dev_—rjack_©ched
(
ùs_dev
, 
Œue
);

1282 ià(
r
) {

1283 
	`ùs_”r
("S‘ devƒ¬jack‡‰ached faed %d", 
r
);

1289 #ifdeà
CONFIG_CTS_GLOVE


1290 ià(
	`ùs_is_glove_’abËd
(
ùs_dev
)) {

1291 
	`ùs_’‹r_glove_mode
(
ùs_dev
);

1295 #ifdeà
CFG_CTS_FW_LOG_REDIRECT


1296 ià(
	`ùs_is_fw_log_»dœeù
(
ùs_dev
)) {

1297 
	`ùs_’abË_fw_log_»dœeù
(
ùs_dev
);

1301 
	`ùs_uÆock_deviû
(
ùs_dev
);

1303 
»t
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1304 ià(
»t
) {

1305 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

1308 
	`ùs_šfo
("Re£t-Pše¡ %s", 
v®
 == 2 ? "PASS" : "FAIL");

1309 ià(
v®
 == 2) {

1310 ià(!
ùs_dev
->
¹d©a
.
´og¿m_mode
) {

1311 
	`ùs_£t_nÜm®_addr
(
ùs_dev
);

1316  -
EFAULT
;

1317 
	}
}

1320 
	$ùs_‹¡_št_pš
(
ùs_deviû
 *
ùs_dev
, 
ùs_‹¡_·¿m
 *
·¿m
)

1322 
»t
;

1324 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL) {

1325  -
EINVAL
;

1328 
	`ùs_šfo
("Int Pinest, flags: 0x%08x, "

1330 
·¿m
->
æags
,

1331 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

1333 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1334 ià(
»t
) {

1335 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1336  
»t
;

1339 
	`ùs_lock_deviû
(
ùs_dev
);

1341 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_WRTITE_INT_HIGH
);

1342 ià(
»t
) {

1343 
	`ùs_”r
("S’d commªd WRTITE_INT_HIGH faed %d", 
»t
);

1344 
uÆock_deviû
;

1346 
	`md–ay
(10);

1347 ià(
	`ùs_¶©_g‘_št_pš
(
ùs_dev
->
pd©a
) == 0) {

1348 
	`ùs_”r
("INT…in state != HIGH");

1349 
»t
 = -
EFAULT
;

1350 
uÆock_deviû
;

1353 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_WRTITE_INT_LOW
);

1354 ià(
»t
) {

1355 
	`ùs_”r
("S’d commªd WRTITE_INT_LOW faed %d", 
»t
);

1356 
uÆock_deviû
;

1358 
	`md–ay
(10);

1359 ià(
	`ùs_¶©_g‘_št_pš
(
ùs_dev
->
pd©a
) != 0) {

1360 
	`ùs_”r
("INT…in state != LOW");

1361 
»t
 = -
EFAULT
;

1362 
uÆock_deviû
;

1365 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_RELASE_INT_TEST
);

1366 ià(
»t
) {

1367 
	`ùs_”r
("S’d commªd RELASE_INT_TEST faed %d", 
»t
);

1368 
»t
 = 0;

1370 
	`md–ay
(10);

1372 
uÆock_deviû
:

1373 
	`ùs_uÆock_deviû
(
ùs_dev
);

1375 
»t
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1376 ià(
»t
) {

1377 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

1378 
»t
 = 0;

1381 
	`ùs_šfo
("IÁ-Pše¡ %s", 
»t
 == 0 ? "PASS" : "FAIL");

1382  
»t
;

1383 
	}
}

1385 
	$ùs_dump_comp_ÿp
(
ùs_deviû
 *
ùs_dev
, 
u8
 *
ÿp
, 
boŞ
 
to_cÚsŞe
)

1387 
	#SPLIT_LINE_STR
 \

1388 "-----------------------------------------------------------------------------"

	)

1389 
	#ROW_NUM_FORMAT_STR
 "%2d | "

	)

1390 
	#COL_NUM_FORMAT_STR
 "%3u "

	)

1391 
	#DATA_FORMAT_STR
 "%4d"

	)

1393 
r
, 
c
;

1394 
u32
 
max
, 
mš
, 
sum
, 
av”age
;

1395 
max_r
, 
max_c
, 
mš_r
, 
mš_c
;

1396 
lše_buf
[128];

1397 
couÁ
;

1399 
max
 = 
mš
 = 
ÿp
[0];

1400 
sum
 = 0;

1401 
max_r
 = 
max_c
 = 
mš_r
 = 
mš_c
 = 0;

1402 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1403 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1404 
u16
 
v®
 = 
ÿp
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
];

1406 
sum
 +ğ
v®
;

1407 ià(
v®
 > 
max
) {

1408 
max
 = 
v®
;

1409 
max_r
 = 
r
;

1410 
max_c
 = 
c
;

1411 } ià(
v®
 < 
mš
) {

1412 
mš
 = 
v®
;

1413 
mš_r
 = 
r
;

1414 
mš_c
 = 
c
;

1418 
av”age
 = 
sum
 / (
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
);

1420 
couÁ
 = 0;

1421 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count,

1423 
mš_r
, 
mš_c
, 
mš
, 
max_r
, 
max_c
, 
max
, 
av”age
);

1424 ià(
to_cÚsŞe
) {

1425 
	`ùs_šfo
(
SPLIT_LINE_STR
);

1426 
	`ùs_šfo
("%s", 
lše_buf
);

1427 
	`ùs_šfo
(
SPLIT_LINE_STR
);

1429 ià(
ùs_‹¡_d©a_fp
) {

1430 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

1431 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1432 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
lše_buf
, 
couÁ
);

1433 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1434 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

1435 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1438 
couÁ
 = 0;

1439 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count, " ");

1440 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1441 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count,

1442 
COL_NUM_FORMAT_STR
, 
c
);

1444 ià(
to_cÚsŞe
) {

1445 
	`ùs_šfo
("%s", 
lše_buf
);

1446 
	`ùs_šfo
(
SPLIT_LINE_STR
);

1448 ià(
ùs_‹¡_d©a_fp
) {

1449 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
lše_buf
, 
couÁ
);

1450 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1451 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

1452 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1455 
r
 = 0;„ < 
ùs_dev
->
fwd©a
.
rows
;„++) {

1456 
couÁ
 = 0;

1457 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count, (line_buf) - count,

1458 
ROW_NUM_FORMAT_STR
, 
r
);

1459 
c
 = 0; c < 
ùs_dev
->
fwd©a
.
cŞs
; c++) {

1460 
couÁ
 +ğ
	`sú´štf
(
lše_buf
 + count,

1461 (
lše_buf
è- 
couÁ
,

1462 
DATA_FORMAT_STR
,

1463 
ÿp
[
r
 * 
ùs_dev
->
fwd©a
.
cŞs
 + 
c
]);

1465 ià(
to_cÚsŞe
) {

1466 
	`ùs_šfo
("%s", 
lše_buf
);

1468 ià(
ùs_‹¡_d©a_fp
) {

1469 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
lše_buf
, 
couÁ
);

1470 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1474 ià(
to_cÚsŞe
) {

1475 
	`ùs_šfo
(
SPLIT_LINE_STR
);

1477 ià(
ùs_‹¡_d©a_fp
) {

1478 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, 
SPLIT_LINE_STR
, 
	`¡¾’
(SPLIT_LINE_STR));

1479 
	`ùs_wr™e_fe
(
ùs_‹¡_d©a_fp
, "\n", 1);

1481 #undeà
SPLIT_LINE_STR


1482 #undeà
ROW_NUM_FORMAT_STR


1483 #undeà
COL_NUM_FORMAT_STR


1484 #undeà
DATA_FORMAT_STR


1485 
	}
}

1487 
	$ùs_‹¡_com³n§‹_ÿp
(
ùs_deviû
 *
ùs_dev
,

1488 
ùs_‹¡_·¿m
 *
·¿m
)

1490 
boŞ
 
driv”_v®id©e_d©a
 = 
çl£
;

1491 
boŞ
 
v®id©e_d©a_³r_node
 = 
çl£
;

1492 
boŞ
 
dump_‹¡_d©e_to_u£r
 = 
çl£
;

1493 
boŞ
 
dump_‹¡_d©e_to_cÚsŞe
 = 
çl£
;

1494 
boŞ
 
dump_‹¡_d©e_to_fe
 = 
çl£
;

1495 
num_nodes
;

1496 
u8
 * 
ÿp
 = 
NULL
;

1497 
»t
 = 0;

1499 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL) {

1500 
	`ùs_”r
("Compensate capest with invalid…aram: cts_dev: %pest…aram: %p",

1501 
ùs_dev
, 
·¿m
);

1502  -
EINVAL
;

1505 
num_nodes
 = 
ùs_dev
->
hwd©a
->
num_row
 * cts_dev->hwd©a->
num_cŞ
;

1507 
driv”_v®id©e_d©a
 =

1508 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_DATA
);

1509 ià(
driv”_v®id©e_d©a
) {

1510 
v®id©e_d©a_³r_node
 =

1511 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_PER_NODE
);

1513 
dump_‹¡_d©e_to_u£r
 =

1514 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
);

1515 
dump_‹¡_d©e_to_cÚsŞe
 =

1516 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
);

1517 
dump_‹¡_d©e_to_fe
 =

1518 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
);

1520 
	`ùs_šfo
("Compensate capest, flags: 0x%08x "

1524 
·¿m
->
æags
,…¬am->
num_šv®id_node
,

1525 
·¿m
->
‹¡_d©a_f•©h
,…¬am->
‹¡_d©a_buf_size
,

1526 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

1528 ià(
dump_‹¡_d©e_to_u£r
) {

1529 
ÿp
 = (
u8
 *)
·¿m
->
‹¡_d©a_buf
;

1531 
ÿp
 = (
u8
 *)
	`kz®loc
(
num_nodes
, 
GFP_KERNEL
);

1532 ià(
ÿp
 =ğ
NULL
) {

1533 
	`ùs_”r
("AÎoÿ‹ mem fÜ com³n§‹ c­ faed %d", 
»t
);

1534  -
ENOMEM
;

1538 
	`ùs_lock_deviû
(
ùs_dev
);

1539 
»t
 = 
	`ùs_g‘_com³n§‹_ÿp
(
ùs_dev
, 
ÿp
);

1540 
	`ùs_uÆock_deviû
(
ùs_dev
);

1541 ià(
»t
) {

1542 
	`ùs_”r
("G‘ com³n§‹ c­ faed %d", 
»t
);

1543 
ä“_ÿp
;

1546 ià(
dump_‹¡_d©e_to_u£r
) {

1547 *
·¿m
->
‹¡_d©a_wr_size
 = 
num_nodes
;

1550 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

1551 
	`ùs_dump_comp_ÿp
(
ùs_dev
, 
ÿp
,

1552 
dump_‹¡_d©e_to_cÚsŞe
);

1555 ià(
driv”_v®id©e_d©a
) {

1556 
»t
 = 
	`v®id©e_comp_ÿp
(
ùs_dev
, "Compensate-Cap",

1557 
ÿp
, 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

1558 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

1561 
ä“_ÿp
:

1562 ià(!
dump_‹¡_d©e_to_u£r
 && 
ÿp
) {

1563 
	`kä“
(
ÿp
);

1566 
	`ùs_šfo
("Com³n§‹-C­e¡ %s", 
»t
 == 0 ? "PASS" : "FAIL");

1568  
»t
;

1569 
	}
}

1571 
	$ùs_‹¡_¿wd©a
(
ùs_deviû
 *
ùs_dev
,

1572 
ùs_‹¡_·¿m
 *
·¿m
)

1574 
ùs_¿wd©a_‹¡_´iv_·¿m
 *
´iv_·¿m
;

1575 
boŞ
 
driv”_v®id©e_d©a
 = 
çl£
;

1576 
boŞ
 
v®id©e_d©a_³r_node
 = 
çl£
;

1577 
boŞ
 
¡İ_‹¡_if_v®id©e_ç
 = 
çl£
;

1578 
boŞ
 
dump_‹¡_d©e_to_u£r
 = 
çl£
;

1579 
boŞ
 
dump_‹¡_d©e_to_cÚsŞe
 = 
çl£
;

1580 
boŞ
 
dump_‹¡_d©e_to_fe
 = 
çl£
;

1581 
num_nodes
;

1582 
tsd©a_äame_size
;

1583 
äame
;

1584 
u16
 *
¿wd©a
 = 
NULL
;

1585 
i
;

1586 
»t
;

1588 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL ||

1589 
·¿m
->
´iv_·¿m_size
 !ğ(*
´iv_·¿m
) ||

1590 
·¿m
->
´iv_·¿m
 =ğ
NULL
) {

1591 
	`ùs_”r
("Rawdataest with invalid…aram:…riv…aram: %p size: %d",

1592 
·¿m
->
´iv_·¿m
,…¬am->
´iv_·¿m_size
);

1593  -
EINVAL
;

1596 
´iv_·¿m
 = 
·¿m
->priv_param;

1597 ià(
´iv_·¿m
->
äames
 <= 0) {

1598 
	`ùs_šfo
("Rawdataest withoo†ittle frame %u",

1599 
´iv_·¿m
->
äames
);

1600  -
EINVAL
;

1603 
num_nodes
 = 
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
;

1604 
tsd©a_äame_size
 = 2 * 
num_nodes
;

1606 
driv”_v®id©e_d©a
 =

1607 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_DATA
);

1608 
v®id©e_d©a_³r_node
 =

1609 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_PER_NODE
);

1610 
dump_‹¡_d©e_to_u£r
 =

1611 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
);

1612 
dump_‹¡_d©e_to_cÚsŞe
 =

1613 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
);

1614 
dump_‹¡_d©e_to_fe
=

1615 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
);

1616 
¡İ_‹¡_if_v®id©e_ç
 =

1617 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
);

1619 
	`ùs_šfo
("Rawdataest, flags: 0x%08x, frames: %d, "

1623 
·¿m
->
æags
, 
´iv_·¿m
->
äames
,…¬am->
num_šv®id_node
,

1624 
·¿m
->
‹¡_d©a_f•©h
,…¬am->
‹¡_d©a_buf_size
,

1625 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

1627 ià(
dump_‹¡_d©e_to_u£r
) {

1628 
¿wd©a
 = (
u16
 *)
·¿m
->
‹¡_d©a_buf
;

1630 
¿wd©a
 = (
u16
 *)
	`km®loc
(
tsd©a_äame_size
, 
GFP_KERNEL
);

1631 ià(
¿wd©a
 =ğ
NULL
) {

1632 
	`ùs_”r
("Allocate memory for„awdata failed");

1633  -
ENOMEM
;

1638 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1639 ià(
»t
) {

1640 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1641  
»t
;

1644 
	`ùs_lock_deviû
(
ùs_dev
);

1646 
i
 = 0; i < 5; i++) {

1647 
r
;

1648 
u8
 
v®
;

1649 
r
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1650 ià(
r
) {

1651 
	`ùs_”r
("EÇbË g‘sd©¨çed %d", 
r
);

1654 
	`md–ay
(1);

1655 
r
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 0x12, &
v®
);

1656 ià(
r
) {

1657 
	`ùs_”r
("R—dƒÇbË g‘sd©¨çed %d", 
r
);

1660 ià(
v®
 != 0) {

1665 ià(
i
 >= 5) {

1666 
	`ùs_”r
("Enable„eadsdata failed");

1667 
»t
 = -
EIO
;

1668 
uÆock_deviû
;

1671 
äame
 = 0; f¿m< 
´iv_·¿m
->
äames
; frame++) {

1672 
boŞ
 
d©a_v®id
 = 
çl£
;

1675 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1676 ià(
»t
) {

1677 
	`ùs_”r
("S’d CMD_QUIT_GESTURE_MONITOR faed %d", 
»t
);

1681 
i
 = 0; i < 3; i++) {

1682 
»t
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
¿wd©a
);

1683 ià(
»t
) {

1684 
	`ùs_”r
("G‘„awd©¨çed %d", 
»t
);

1685 
	`md–ay
(30);

1687 
d©a_v®id
 = 
Œue
;

1692 ià(!
d©a_v®id
) {

1693 
»t
 = -
EIO
;

1697 ià(
dump_‹¡_d©e_to_u£r
) {

1698 *
·¿m
->
‹¡_d©a_wr_size
 +ğ
tsd©a_äame_size
;

1701 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

1702 
	`ùs_dump_tsd©a
(
ùs_dev
, "Rawd©a", 
¿wd©a
,

1703 
dump_‹¡_d©e_to_cÚsŞe
);

1706 ià(
driv”_v®id©e_d©a
) {

1707 
»t
 = 
	`v®id©e_tsd©a
(
ùs_dev
,

1708 "Rawd©a", 
¿wd©a
,

1709 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

1710 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

1711 ià(
»t
) {

1712 
	`ùs_”r
("Rawd©¨‹¡ faed %d", 
»t
);

1713 ià(
¡İ_‹¡_if_v®id©e_ç
) {

1719 ià(
dump_‹¡_d©e_to_u£r
) {

1720 
¿wd©a
 +ğ
num_nodes
;

1724 
i
 = 0; i < 5; i++) {

1725 
r
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1726 ià(
r
) {

1727 
	`ùs_”r
("Di§bË g‘„awd©¨çed %d", 
r
);

1734 
uÆock_deviû
:

1735 
	`ùs_uÆock_deviû
(
ùs_dev
);

1738 
r
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1739 ià(
r
) {

1740 
	`ùs_”r
("S¹ deviû faed %d", 
r
);

1744 ià(!
dump_‹¡_d©e_to_u£r
 && 
¿wd©a
 !ğ
NULL
) {

1745 
	`kä“
(
¿wd©a
);

1748 
	`ùs_šfo
("Rawd©¨‹¡ %s", (
»t
 == 0) ? "PASS" : "FAIL");

1750  
»t
;

1751 
	}
}

1753 
	$ùs_‹¡_noi£
(
ùs_deviû
 *
ùs_dev
,

1754 
ùs_‹¡_·¿m
 *
·¿m
)

1756 
ùs_noi£_‹¡_´iv_·¿m
 *
´iv_·¿m
;

1757 
boŞ
 
driv”_v®id©e_d©a
 = 
çl£
;

1758 
boŞ
 
v®id©e_d©a_³r_node
 = 
çl£
;

1759 
boŞ
 
dump_‹¡_d©e_to_u£r
 = 
çl£
;

1760 
boŞ
 
dump_‹¡_d©e_to_cÚsŞe
 = 
çl£
;

1761 
boŞ
 
dump_‹¡_d©e_to_fe
 = 
çl£
;

1762 
num_nodes
;

1763 
tsd©a_äame_size
;

1764 
äame
;

1765 
u16
 *
bufãr
 = 
NULL
;

1766 
u16
 *
cu¼_¿wd©a
 = 
NULL
;

1767 
u16
 *
max_¿wd©a
 = 
NULL
;

1768 
u16
 *
mš_¿wd©a
 = 
NULL
;

1769 
u16
 *
noi£
 = 
NULL
;

1770 
boŞ
 
fœ¡_äame
 = 
Œue
;

1771 
boŞ
 
d©a_v®id
 = 
çl£
;

1772 
i
;

1773 
»t
;

1775 ià(
ùs_dev
 =ğ
NULL
 || 
·¿m
 == NULL ||

1776 
·¿m
->
´iv_·¿m_size
 !ğ(*
´iv_·¿m
) ||

1777 
·¿m
->
´iv_·¿m
 =ğ
NULL
) {

1778 
	`ùs_”r
("Noiseest with invalid…aram:…riv…aram: %p size: %d",

1779 
·¿m
->
´iv_·¿m
,…¬am->
´iv_·¿m_size
);

1780  -
EINVAL
;

1783 
´iv_·¿m
 = 
·¿m
->priv_param;

1784 ià(
´iv_·¿m
->
äames
 < 2) {

1785 
	`ùs_”r
("Noiseest withoo†ittle frame %u",

1786 
´iv_·¿m
->
äames
);

1787  -
EINVAL
;

1790 
num_nodes
 = 
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
;

1791 
tsd©a_äame_size
 = 2 * 
num_nodes
;

1793 
driv”_v®id©e_d©a
 =

1794 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_DATA
);

1795 
v®id©e_d©a_³r_node
 =

1796 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_VALIDATE_PER_NODE
);

1797 
dump_‹¡_d©e_to_u£r
 =

1798 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
);

1799 
dump_‹¡_d©e_to_cÚsŞe
 =

1800 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
);

1801 
dump_‹¡_d©e_to_fe
 =

1802 !!(
·¿m
->
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
);

1804 
	`ùs_šfo
("Noiseest, flags: 0x%08x, frames: %d, "

1808 
·¿m
->
æags
, 
´iv_·¿m
->
äames
,…¬am->
num_šv®id_node
,

1809 
·¿m
->
‹¡_d©a_f•©h
,…¬am->
‹¡_d©a_buf_size
,

1810 
·¿m
->
driv”_log_f•©h
,…¬am->
driv”_log_buf_size
);

1812 ià(
driv”_v®id©e_d©a
 || !
dump_‹¡_d©e_to_u£r
) {

1813 
bufãr
 = (
u16
 *)
	`km®loc
(
tsd©a_äame_size
 * 4, 
GFP_KERNEL
);

1814 ià(
bufãr
 =ğ
NULL
) {

1815 
	`ùs_”r
("Alloc mem forsdata failed");

1816  -
ENOMEM
;

1819 ià(
dump_‹¡_d©e_to_u£r
) {

1820 
cu¼_¿wd©a
 = (
u16
 *)
·¿m
->
‹¡_d©a_buf
;

1822 
cu¼_¿wd©a
 = 
bufãr
;

1825 ià(
driv”_v®id©e_d©a
) {

1826 
max_¿wd©a
 = 
bufãr
 + 1 * 
num_nodes
;

1827 
mš_¿wd©a
 = 
bufãr
 + 2 * 
num_nodes
;

1828 
noi£
 = 
bufãr
 + 3 * 
num_nodes
;

1833 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1834 ià(
»t
) {

1835 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1836  
»t
;

1839 
	`ùs_lock_deviû
(
ùs_dev
);

1841 
i
 = 0; i < 5; i++) {

1842 
r
;

1843 
u8
 
v®
;

1844 
r
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

1845 ià(
r
) {

1846 
	`ùs_”r
("EÇbË g‘ d©¨çed %d", 
r
);

1849 
	`md–ay
(1);

1850 
r
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
, 0x12, &
v®
);

1851 ià(
r
) {

1852 
	`ùs_”r
("R—dƒÇbË g‘ d©¨çed %d", 
r
);

1855 ià(
v®
 != 0) {

1860 ià(
i
 >= 5) {

1861 
	`ùs_”r
("Enable„eadsdata failed");

1862 
»t
 = -
EIO
;

1863 
uÆock_deviû
;

1866 
	`m¦“p
(50);

1868 
äame
 = 0; f¿m< 
´iv_·¿m
->
äames
; frame++) {

1869 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_QUIT_GESTURE_MONITOR
);

1870 ià(
»t
) {

1871 
	`ùs_”r
("send quit gesture monitorƒrr");

1875 
i
 = 0; i < 3; i++) {

1876 
r
;

1877 
r
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
cu¼_¿wd©a
);

1878 ià(
r
) {

1879 
	`ùs_”r
("G‘„awd©¨çed %d", 
r
);

1880 
	`md–ay
(30);

1886 ià(
i
 >= 3) {

1887 
	`ùs_”r
("Read„awdata failed");

1888 
»t
 = -
EIO
;

1889 
di§bË_g‘_tsd©a
;

1892 ià(
dump_‹¡_d©e_to_u£r
) {

1893 *
·¿m
->
‹¡_d©a_wr_size
 +ğ
tsd©a_äame_size
;

1896 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

1897 
	`ùs_dump_tsd©a
(
ùs_dev
, "Noi£-¿wd©a", 
cu¼_¿wd©a
,

1898 
dump_‹¡_d©e_to_cÚsŞe
);

1901 ià(
driv”_v®id©e_d©a
) {

1902 ià(
	`uÆik–y
(
fœ¡_äame
)) {

1903 
	`memıy
(
max_¿wd©a
, 
cu¼_¿wd©a
, 
tsd©a_äame_size
);

1904 
	`memıy
(
mš_¿wd©a
, 
cu¼_¿wd©a
, 
tsd©a_äame_size
);

1905 
fœ¡_äame
 = 
çl£
;

1907 
i
 = 0; i < 
num_nodes
; i++) {

1908 ià(
cu¼_¿wd©a
[
i
] > 
max_¿wd©a
[i]) {

1909 
max_¿wd©a
[
i
] = 
cu¼_¿wd©a
[i];

1910 } ià(
cu¼_¿wd©a
[
i
] < 
mš_¿wd©a
[i]) {

1911 
mš_¿wd©a
[
i
] = 
cu¼_¿wd©a
[i];

1917 ià(
dump_‹¡_d©e_to_u£r
) {

1918 
cu¼_¿wd©a
 +ğ
num_nodes
;

1922 
d©a_v®id
 = 
Œue
;

1924 
di§bË_g‘_tsd©a
:

1925 
i
 = 0; i < 5; i++) {

1926 
r
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

1927 ià(
r
) {

1928 
	`ùs_”r
("Di§bË g‘„awd©¨çed %d", 
r
);

1935 
uÆock_deviû
:

1936 
	`ùs_uÆock_deviû
(
ùs_dev
);

1939 
r
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1940 ià(
r
) {

1941 
	`ùs_”r
("S¹ deviû faed %d", 
r
);

1945 ià(
driv”_v®id©e_d©a
 && 
d©a_v®id
) {

1946 
i
 = 0; i < 
num_nodes
; i++) {

1947 
noi£
[
i
] = 
max_¿wd©a
[i] - 
mš_¿wd©a
[i];

1950 ià(
dump_‹¡_d©e_to_cÚsŞe
 || 
dump_‹¡_d©e_to_fe
) {

1951 
	`ùs_dump_tsd©a
(
ùs_dev
, "Noi£", 
noi£
,

1952 
dump_‹¡_d©e_to_cÚsŞe
);

1955 
»t
 = 
	`v®id©e_tsd©a
(
ùs_dev
, "Noiseest",

1956 
noi£
, 
·¿m
->
šv®id_nodes
,…¬am->
num_šv®id_node
,

1957 
v®id©e_d©a_³r_node
, 
·¿m
->
mš
,…¬am->
max
);

1960 ià(
bufãr
) {

1961 
	`kä“
(
bufãr
);

1964 
	`ùs_šfo
("Noiseest %s",

1965 (
d©a_v®id
 && (
»t
 == 0)) ? "PASS" : "FAIL");

1967  
»t
;

1968 
	}
}

	@cts_test.h

1 #iâdeà
CTS_TEST_H


2 
	#CTS_TEST_H


	)

4 
	gùs_deviû
;

6 
	#CTS_TEST_FLAG_RESET_BEFORE_TEST
 (1u << 0)

	)

7 
	#CTS_TEST_FLAG_RESET_AFTER_TEST
 (1u << 1)

	)

8 
	#CTS_TEST_FLAG_DISPLAY_ON
 (1u << 2)

	)

9 
	#CTS_TEST_FLAG_DISABLE_GAS
 (1u << 3)

	)

10 
	#CTS_TEST_FLAG_DISABLE_LINESHIFT
 (1u << 4)

	)

12 
	#CTS_TEST_FLAG_VALIDATE_DATA
 (1u << 8)

	)

13 
	#CTS_TEST_FLAG_VALIDATE_PER_NODE
 (1u << 9)

	)

14 
	#CTS_TEST_FLAG_VALIDATE_MIN
 (1u << 10)

	)

15 
	#CTS_TEST_FLAG_VALIDATE_MAX
 (1u << 11)

	)

16 
	#CTS_TEST_FLAG_VALIDATE_SKIP_INVALID_NODE
 (1u << 12)

	)

17 
	#CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
 (1u << 13)

	)

19 
	#CTS_TEST_FLAG_DUMP_TEST_DATA_TO_CONSOLE
 (1u << 16)

	)

20 
	#CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
 (1u << 17)

	)

21 
	#CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
 (1u << 18)

	)

22 
	#CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE_APPEND
 (1u << 19)

	)

23 
	#CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE_CSV
 (1u << 20)

	)

25 
	#CTS_TEST_FLAG_DRIVER_LOG_TO_USERSPACE
 (1u << 24)

	)

26 
	#CTS_TEST_FLAG_DRIVER_LOG_TO_FILE
 (1u << 25)

	)

27 
	#CTS_TEST_FLAG_DRIVER_LOG_TO_FILE_APPEND
 (1u << 26)

	)

29 
	#MAKE_INVALID_NODE
(
r
,
c
è(((cè<< 16è| (r))

	)

30 
	#INVALID_NODE_ROW
(
node
è((
u16
)Òode))

	)

31 
	#INVALID_NODE_COL
(
node
è((
u16
)(Òodeè>> 16))

	)

33 
	eùs_‹¡_™em
 {

34 
	mCTS_TEST_RESET_PIN
 = 1,

35 
	mCTS_TEST_INT_PIN
,

36 
	mCTS_TEST_RAWDATA
,

37 
	mCTS_TEST_NOISE
,

38 
	mCTS_TEST_OPEN
,

39 
	mCTS_TEST_SHORT
,

40 
	mCTS_TEST_COMPENSATE_CAP
,

43 
	sùs_‹¡_·¿m
 {

44 
	m‹¡_™em
;

46 
__u32
 
	mæags
;

48 
__u32
 
	mnum_šv®id_node
;

49 
__u32
 *
	mšv®id_nodes
;

50 *
	mmš
;

51 *
	mmax
;

53 *
	m‹¡_»suÉ
;

55 *
	m‹¡_d©a_buf
;

56 
	m‹¡_d©a_buf_size
;

57 *
	m‹¡_d©a_wr_size
;

58 cÚ¡ *
	m‹¡_d©a_f•©h
;

60 
	mdriv”_log_Ëv–
;

61 *
	mdriv”_log_buf
;

62 
	mdriv”_log_buf_size
;

63 *
	mdriv”_log_wr_size
;

64 cÚ¡ *
	mdriv”_log_f•©h
;

66 *
	m´iv_·¿m
;

67 
	m´iv_·¿m_size
;

70 
	sùs_¿wd©a_‹¡_´iv_·¿m
 {

71 
__u32
 
	mäames
;

75 
	sùs_noi£_‹¡_´iv_·¿m
 {

76 
__u32
 
	mäames
;

80 cÚ¡ *
ùs_‹¡_™em_¡r
(
‹¡_™em
);

81 
ùs_wr™e_fe
(
fe
 *
fp
, cÚ¡ *
d©a
, 
size_t
 
size
);

83 
ùs_¡¬t_dump_‹¡_d©a_to_fe
(cÚ¡ *
f•©h
,

84 
boŞ
 
­³nd_to_fe
);

85 
ùs_¡İ_dump_‹¡_d©a_to_fe
();

87 
ùs_‹¡_»£t_pš
(
ùs_deviû
 *
ùs_dev
,

88 
ùs_‹¡_·¿m
 *
·¿m
);

89 
ùs_‹¡_št_pš
(
ùs_deviû
 *
ùs_dev
,

90 
ùs_‹¡_·¿m
 *
·¿m
);

91 
ùs_‹¡_¿wd©a
(
ùs_deviû
 *
ùs_dev
,

92 
ùs_‹¡_·¿m
 *
·¿m
);

93 
ùs_‹¡_noi£
(
ùs_deviû
 *
ùs_dev
,

94 
ùs_‹¡_·¿m
 *
·¿m
);

95 
ùs_‹¡_İ’
(
ùs_deviû
 *
ùs_dev
,

96 
ùs_‹¡_·¿m
 *
·¿m
);

97 
ùs_‹¡_shÜt
(
ùs_deviû
 *
ùs_dev
,

98 
ùs_‹¡_·¿m
 *
·¿m
);

99 
ùs_‹¡_com³n§‹_ÿp
(
ùs_deviû
 *
ùs_dev
,

100 
ùs_‹¡_·¿m
 *
·¿m
);

	@cts_tool.c

1 
	#LOG_TAG
 "ToŞ"

	)

3 
	~"ùs_cÚfig.h
"

4 
	~"ùs_¶©fÜm.h
"

5 
	~"ùs_cÜe.h
"

6 
	~"ùs_fœmw¬e.h
"

7 
	~"ùs_‹¡.h
"

9 #ifdeà
CONFIG_CTS_LEGACY_TOOL


11 #´agm¨
·ck
(1)

13 
	sùs_toŞ_cmd
 {

14 
u8
 
	mcmd
;

15 
u8
 
	mæag
;

16 
u8
 
	mcœşe
;

17 
u8
 
	mtimes
;

18 
u8
 
	m»Œy
;

19 
u32
 
	md©a_Ën
;

20 
u8
 
	maddr_Ën
;

21 
u8
 
	maddr
[2];

22 
u8
 
	md©a
[
PAGE_SIZE
];

25 #´agm¨
·ck
()

27 
	#CTS_TOOL_CMD_HEADER_LENGTH
 (12)

	)

29 
	eùs_toŞ_cmd_code
 {

30 
	mCTS_TOOL_CMD_GET_PANEL_PARAM
 = 0,

31 
	mCTS_TOOL_CMD_GET_DOWNLOAD_STATUS
 = 2,

32 
	mCTS_TOOL_CMD_GET_RAW_DATA
 = 4,

33 
	mCTS_TOOL_CMD_GET_DIFF_DATA
 = 6,

34 
	mCTS_TOOL_CMD_READ_HOSTCOMM
 = 12,

35 
	mCTS_TOOL_CMD_READ_ADC_STATUS
 = 14,

36 
	mCTS_TOOL_CMD_READ_GESTURE_INFO
 = 16,

37 
	mCTS_TOOL_CMD_READ_HOSTCOMM_MULTIBYTE
 = 18,

38 
	mCTS_TOOL_CMD_READ_PROGRAM_MODE_MULTIBYTE
 = 20,

39 
	mCTS_TOOL_CMD_READ_ICTYPE
 = 22,

40 
	mCTS_TOOL_CMD_I2C_DIRECT_READ
 = 24,

41 
	mCTS_TOOL_CMD_GET_DRIVER_INFO
 = 26,

43 
	mCTS_TOOL_CMD_UPDATE_PANEL_PARAM_IN_SRAM
 = 1,

44 
	mCTS_TOOL_CMD_DOWNLOAD_FIRMWARE_WITH_FILENAME
 = 3,

45 
	mCTS_TOOL_CMD_DOWNLOAD_FIRMWARE
 = 5,

46 
	mCTS_TOOL_CMD_WRITE_HOSTCOMM
 = 11,

47 
	mCTS_TOOL_CMD_WRITE_HOSTCOMM_MULTIBYTE
 = 15,

48 
	mCTS_TOOL_CMD_WRITE_PROGRAM_MODE_MULTIBYTE
 = 17,

49 
	mCTS_TOOL_CMD_I2C_DIRECT_WRITE
 = 19,

53 
	sùs_‹¡_ioùl_d©a
 {

54 
__u32
 
	mÁe¡s
;

55 
ùs_‹¡_·¿m
 
__u£r
 *
	m‹¡s
;

58 
	#CTS_IOCTL_RDWR_REG_FLAG_RD
 (0x0001)

	)

61 
	sùs_rdwr_»g
 {

62 
__u32
 
	maddr
;

63 
__u32
 
	mæags
;

64 
__u8
 
__u£r
 *
	md©a
;

65 
__u32
 
	mËn
;

66 
__u32
 
	md–ay_ms
;

69 
	#CTS_IOCTL_RDWR_REG_TYPE_FW
 (1)

	)

70 
	#CTS_IOCTL_RDWR_REG_TYPE_HW
 (2)

	)

71 
	#CTS_IOCTL_RDWR_REG_TYPE_DDI
 (3)

	)

73 
	#CTS_RDWR_REG_IOCTL_MAX_REGS
 (128)

	)

75 
	sùs_rdwr_»g_ioùl_d©a
 {

76 
__u8
 
	m»g_ty³
;

77 
__u32
 
	mÄegs
;

78 
ùs_rdwr_»g
 
__u£r
 *
	m»gs
;

81 
	#CTS_IOCTL_UPGRADE_FW_FLAG_TO_FLASH
 (0x00000001)

	)

82 
	#CTS_IOCTL_UPGRADE_FW_FLAG_BUILTIN
 (0x00000002)

	)

83 
	#CTS_IOCTL_UPGRADE_FW_FLAG_FILE
 (0x00000004)

	)

84 
	#CTS_IOCTL_UPGRADE_FW_FLAG_FW_DATA
 (0x00000008)

	)

86 
	sùs_upg¿de_fw_ioùl_d©a
 {

87 
__u32
 
	mæags
;

88 
__u32
 
	mbutš_fw_šdex
;

89 cÚ¡ 
__u£r
 *
	mf•©h
;

90 cÚ¡ 
__u8
 
__u£r
 *
	mfw_d©a
;

91 
__u32
 
	mfw_d©a_size
;

92 
__u32
 
	m¥l™_size
;

95 
	#CTS_TOOL_IOCTL_GET_DRIVER_VERSION
 
	`_IOR
('C', 0x00, *)

	)

96 
	#CTS_TOOL_IOCTL_GET_DEVICE_TYPE
 
	`_IOR
('C', 0x01, *)

	)

97 
	#CTS_TOOL_IOCTL_GET_FW_VERSION
 
	`_IOR
('C', 0x02, *)

	)

98 
	#CTS_TOOL_IOCTL_GET_RESOLUTION
 
	`_IOR
('C', 0x03, *è

	)

99 
	#CTS_TOOL_IOCTL_GET_ROW_COL
 
	`_IOR
('C', 0x04, *è

	)

101 
	#CTS_TOOL_IOCTL_TEST
 
	`_IOWR
('C', 0x10, 
ùs_‹¡_ioùl_d©a
 *)

	)

102 
	#CTS_TOOL_IOCTL_RDWR_REG
 
	`_IOWR
('C', 0x20, 
ùs_rdwr_»g_ioùl_d©a
 *)

	)

103 
	#CTS_TOOL_IOCTL_UPGRADE_FW
 
	`_IOWR
('C', 0x21, 
ùs_upg¿de_fw_ioùl_d©a
 *)

	)

105 
	#CTS_DRIVER_VERSION_CODE
 \

106 ((
CFG_CTS_DRIVER_MAJOR_VERSION
 << 16) | \

107 (
CFG_CTS_DRIVER_MINOR_VERSION
 << 8) | \

108 (
CFG_CTS_DRIVER_PATCH_VERSION
 << 0))

	)

110 
ùs_toŞ_cmd
 
	gùs_toŞ_cmd
;

111 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


112 
	gùs_toŞ_fœmw¬e_f•©h
[
PATH_MAX
];

114 #ifdeà
CONFIG_CTS_I2C_HOST


116 
u32
 
	gùs_toŞ_dœeù_acûss_addr
 = 0;

119 
	$ùs_toŞ_İ’
(
šode
 *šode, 
fe
 *file)

121 
fe
->
´iv©e_d©a
 = 
	`PDE_DATA
(
šode
);

123 
	}
}

125 
ssize_t
 
	$ùs_toŞ_»ad
(
fe
 *file,

126 
__u£r
 *
bufãr
, 
size_t
 
couÁ
, 
loff_t
 *
µos
)

128 
chÚe_ts_d©a
 *
ùs_d©a
;

129 
ùs_toŞ_cmd
 *
cmd
;

130 
ùs_deviû
 *
ùs_dev
;

131 
»t
 = 0;

133 
ùs_d©a
 = (
chÚe_ts_d©a
 *)
fe
->
´iv©e_d©a
;

134 ià(
ùs_d©a
 =ğ
NULL
) {

135 
	`ùs_”r
("Read with…rivate_data = NULL");

136  -
EIO
;

139 
cmd
 = &
ùs_toŞ_cmd
;

140 
ùs_dev
 = &
ùs_d©a
->cts_dev;

141 
	`ùs_lock_deviû
(
ùs_dev
);

143 
cmd
->cmd) {

144 
CTS_TOOL_CMD_GET_PANEL_PARAM
:

145 
	`ùs_šfo
("G‘…ª–…¬am†’: %u", 
cmd
->
d©a_Ën
);

146 
»t
 = 
	`ùs_g‘_·Ãl_·¿m
(
ùs_dev
, 
cmd
->
d©a
, cmd->
d©a_Ën
);

147 ià(
»t
) {

148 
	`ùs_”r
("G‘…ª–…¬am†’: %u faed %d", 
cmd
->
d©a_Ën
, 
»t
);

152 
CTS_TOOL_CMD_GET_DOWNLOAD_STATUS
:

153 
cmd
->
d©a
[0] = 100;

154 
	`ùs_šfo
("G‘ upd©¡©u ğ%hhu", 
cmd
->
d©a
[0]);

157 
CTS_TOOL_CMD_GET_RAW_DATA
:

158 
CTS_TOOL_CMD_GET_DIFF_DATA
:

159 
	`ùs_dbg
("Get %s data„ow: %u col: %u†en: %u",

160 
cmd
->cmd =ğ
CTS_TOOL_CMD_GET_RAW_DATA
 ? "raw" : "diff",

161 
cmd
->
addr
[1], cmd->addr[0], cmd->
d©a_Ën
);

163 
»t
 = 
	`ùs_’abË_g‘_¿wd©a
(
ùs_dev
);

164 ià(
»t
) {

165 
	`ùs_”r
("EÇbË„—d„aw/difàd©¨çed %d", 
»t
);

168 
	`md–ay
(1);

170 ià(
cmd
->cmd =ğ
CTS_TOOL_CMD_GET_RAW_DATA
) {

171 
»t
 = 
	`ùs_g‘_¿wd©a
(
ùs_dev
, 
cmd
->
d©a
);

172 } ià(
cmd
->cmd =ğ
CTS_TOOL_CMD_GET_DIFF_DATA
) {

173 
»t
 = 
	`ùs_g‘_diffd©a
(
ùs_dev
, 
cmd
->
d©a
);

175 if(
»t
) {

176 
	`ùs_”r
("Get %s data failed %d",

177 
cmd
->cmd =ğ
CTS_TOOL_CMD_GET_RAW_DATA
 ? "¿w" : "diff", 
»t
);

181 
»t
 = 
	`ùs_di§bË_g‘_¿wd©a
(
ùs_dev
);

182 ià(
»t
) {

183 
	`ùs_”r
("Di§bË„—d„aw/difàd©¨çed %d", 
»t
);

189 
CTS_TOOL_CMD_READ_HOSTCOMM
:

190 
»t
 = 
	`ùs_fw_»g_»adb
(
ùs_dev
,

191 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a
);

192 ià(
»t
) {

193 
	`ùs_”r
("Read firmware„eg‡ddr 0x%04x failed %d",

194 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), 
»t
);

196 
	`ùs_dbg
("Read firmware„eg‡ddr 0x%04x, val=0x%02x",

197 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a
[0]);

201 #ifdeà
CFG_CTS_GESTURE


202 
CTS_TOOL_CMD_READ_GESTURE_INFO
:

203 
»t
 = 
	`ùs_g‘_ge¡u»_šfo
(
ùs_dev
, 
cmd
->
d©a
, 
Œue
);

204 ià(
»t
) {

205 
	`ùs_”r
("G‘ ge¡u» infØçed %d", 
»t
);

210 
CTS_TOOL_CMD_READ_HOSTCOMM_MULTIBYTE
:

211 
cmd
->
d©a_Ën
 = 
	`mš
((
size_t
)cmd->d©a_Ën, (cmd->
d©a
));

212 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
, 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
),

213 
cmd
->
d©a
, cmd->
d©a_Ën
);

214 ià(
»t
) {

215 
	`ùs_”r
("Read firmware„eg‡ddr 0x%04x†en %u failed %d",

216 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a_Ën
, 
»t
);

218 
	`ùs_dbg
("Read firmware„eg‡ddr 0x%04x†en %u",

219 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a_Ën
);

223 
CTS_TOOL_CMD_READ_PROGRAM_MODE_MULTIBYTE
:

224 
	`ùs_dbg
("Read under…rogram mode‡ddr 0x%06x†en %u",

225 (
cmd
->
æag
 << 16è| 
	`g‘_uÇligÃd_Ë16
(cmd->
addr
),

226 
cmd
->
d©a_Ën
);

227 
»t
 = 
	`ùs_’‹r_´og¿m_mode
(
ùs_dev
);

228 ià(
»t
) {

229 
	`ùs_”r
("EÁ”…rog¿m modçed %d", 
»t
);

233 
»t
 = 
	`ùs_¤am_»adsb
(&
ùs_d©a
->
ùs_dev
,

234 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a
, cmd->
d©a_Ën
);

235 ià(
»t
) {

236 
	`ùs_”r
("R—d und”…rog¿m modI2C xã¸çed %d", 
»t
);

240 
»t
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

241 ià(
»t
) {

242 
	`ùs_”r
("EÁ”‚Üm® modçed %d", 
»t
);

247 
CTS_TOOL_CMD_READ_ICTYPE
:

248 
	`ùs_šfo
("Get ICype");

249 ià(
ùs_dev
->
hwd©a
) {

250 
ùs_dev
->
hwd©a
->
hwid
) {

251 
CTS_DEV_HWID_ICNL9911
: 
cmd
->
d©a
[0] = 0x91; ;

252 
CTS_DEV_HWID_ICNL9911S
: 
cmd
->
d©a
[0] = 0x91; ;

253 
CTS_DEV_HWID_ICNL9911C
: 
cmd
->
d©a
[0] = 0x91; ;

254 : 
cmd
->
d©a
[0] = 0x00; ;

257 
cmd
->
d©a
[0] = 0x10;

261 #ifdeà
CONFIG_CTS_I2C_HOST


262 
CTS_TOOL_CMD_I2C_DIRECT_READ
:

264 
u32
 
addr_width
;

265 *
wr_buff
 = 
NULL
;

266 
u8
 
addr_buff
[4];

267 
size_t
 
Ëá_size
, 
max_xãr_size
;

268 
u8
 *
d©a
;

270 ià(
cmd
->
addr
[0] !ğ
CTS_DEV_PROGRAM_MODE_I2CADDR
) {

271 
cmd
->
addr
[0] = 
CTS_DEV_NORMAL_MODE_I2CADDR
;

272 
addr_width
 = 2;

274 
addr_width
 = 
ùs_dev
->
hwd©a
->
´og¿m_addr_width
;

277 
	`ùs_dbg
("Direct„ead from i2c_addr 0x%02x‡ddr 0x%06x size %u",

278 
cmd
->
addr
[0], 
ùs_toŞ_dœeù_acûss_addr
, cmd->
d©a_Ën
);

280 
Ëá_size
 = 
cmd
->
d©a_Ën
;

281 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_i2c_xãr_size
(
ùs_dev
->
pd©a
);

282 
d©a
 = 
cmd
->data;

283 
Ëá_size
) {

284 
size_t
 
xãr_size
 = 
	`mš
(
Ëá_size
, 
max_xãr_size
);

285 
»t
 = 
	`ùs_¶©_i2c_»ad
(
ùs_d©a
->
pd©a
, 
cmd
->
addr
[0],

286 
wr_buff
, 
addr_width
, 
d©a
, 
xãr_size
, 1, 0);

287 ià(
»t
) {

288 
	`ùs_”r
("Direct„ead i2c_addr 0x%02x‡ddr 0x%06x†en %zu failed %d",

289 
cmd
->
addr
[0], 
ùs_toŞ_dœeù_acûss_addr
, 
xãr_size
, 
»t
);

293 
Ëá_size
 -ğ
xãr_size
;

294 ià(
Ëá_size
) {

295 
d©a
 +ğ
xãr_size
;

296 
ùs_toŞ_dœeù_acûss_addr
 +ğ
xãr_size
;

297 ià(
addr_width
 == 2) {

298 
	`put_uÇligÃd_be16
(
ùs_toŞ_dœeù_acûss_addr
, 
addr_buff
);

299 } ià(
addr_width
 == 3) {

300 
	`put_uÇligÃd_be24
(
ùs_toŞ_dœeù_acûss_addr
, 
addr_buff
);

302 
wr_buff
 = 
addr_buff
;

308 
CTS_TOOL_CMD_GET_DRIVER_INFO
:

312 
	`ùs_w¬n
("R—d unknowÀcommªd %u", 
cmd
->cmd);

313 
»t
 = -
EINVAL
;

317 
	`ùs_uÆock_deviû
(
ùs_dev
);

319 ià(
»t
 == 0) {

320 if(
cmd
->cmd =ğ
CTS_TOOL_CMD_I2C_DIRECT_READ
) {

321 
»t
 = 
	`cİy_to_u£r
(
bufãr
 + 
CTS_TOOL_CMD_HEADER_LENGTH
,

322 
cmd
->
d©a
, cmd->
d©a_Ën
);

324 
»t
 = 
	`cİy_to_u£r
(
bufãr
, 
cmd
->
d©a
, cmd->
d©a_Ën
);

326 ià(
»t
) {

327 
	`ùs_”r
("Cİy d©¨tØu£¸bufã¸çed %d", 
»t
);

331  
cmd
->
d©a_Ën
;

335 
	}
}

337 
ssize_t
 
	$ùs_toŞ_wr™e
(
fe
 *file,

338 cÚ¡ 
__u£r
 * 
bufãr
, 
size_t
 
couÁ
, 
loff_t
 * 
µos
)

340 
chÚe_ts_d©a
 *
ùs_d©a
;

341 
ùs_deviû
 *
ùs_dev
;

342 
ùs_toŞ_cmd
 *
cmd
;

343 
»t
 = 0;

345 ià(
couÁ
 < 
CTS_TOOL_CMD_HEADER_LENGTH
 || couÁ > 
PAGE_SIZE
) {

346 
	`ùs_”r
("Wr™ËÀ%zu inv®id", 
couÁ
);

347  -
EFAULT
;

350 
ùs_d©a
 = (
chÚe_ts_d©a
 *)
fe
->
´iv©e_d©a
;

351 ià(
ùs_d©a
 =ğ
NULL
) {

352 
	`ùs_”r
("Write with…rivate_data = NULL");

353  -
EIO
;

356 
cmd
 = &
ùs_toŞ_cmd
;

357 
»t
 = 
	`cİy_äom_u£r
(
cmd
, 
bufãr
, 
CTS_TOOL_CMD_HEADER_LENGTH
);

358 ià(
»t
) {

359 
	`ùs_”r
("Cİy commªd h—d” from u£¸bufã¸çed %d", 
»t
);

360  -
EIO
;

362 
»t
 = 
CTS_TOOL_CMD_HEADER_LENGTH
;

365 ià(
cmd
->
d©a_Ën
 > 
PAGE_SIZE
) {

366 
	`ùs_”r
("Wr™w™h inv®id couÁ %d", 
cmd
->
d©a_Ën
);

367  -
EIO
;

370 if(
cmd
->cmd & 
	`BIT
(0)) {

371 if(
cmd
->
d©a_Ën
) {

372 
»t
 = 
	`cİy_äom_u£r
(
cmd
->
d©a
,

373 
bufãr
 + 
CTS_TOOL_CMD_HEADER_LENGTH
, 
cmd
->
d©a_Ën
);

374 ià(
»t
) {

375 
	`ùs_”r
("Copy command…ayload from user buffer†en %u failed %d",

376 
cmd
->
d©a_Ën
, 
»t
);

377  -
EIO
;

382 
	`ùs_dbg
("Write„ead command(%d) header,…repare„ead size: %d",

383 
cmd
->cmd, cmd->
d©a_Ën
);

384  
CTS_TOOL_CMD_HEADER_LENGTH
 + 
cmd
->
d©a_Ën
;

387 
ùs_dev
 = &
ùs_d©a
->cts_dev;

388 
	`ùs_lock_deviû
(
ùs_dev
);

390 
cmd
->cmd) {

391 
CTS_TOOL_CMD_UPDATE_PANEL_PARAM_IN_SRAM
:

392 
	`ùs_šfo
("Wr™·ÃÈ·¿m†’ %u d©a\n", 
cmd
->
d©a_Ën
);

393 
»t
 = 
	`ùs_fw_»g_wr™esb
(
ùs_dev
, 
CTS_DEVICE_FW_REG_PANEL_PARAM
,

394 
cmd
->
d©a
, cmd->
d©a_Ën
);

395 ià(
»t
) {

396 
	`ùs_”r
("Wr™·ÃÈ·¿m faed %d", 
»t
);

400 
»t
 = 
	`ùs_£nd_commªd
(
ùs_dev
, 
CTS_CMD_RESET
);

401 ià(
»t
) {

405 
»t
 = 
	`ùs_£t_wÜk_mode
(
ùs_dev
, 1);

406 ià(
»t
) {

410 
	`md–ay
(100);

412 
»t
 = 
	`ùs_£t_wÜk_mode
(
ùs_dev
, 0);

413 ià(
»t
) {

416 
	`md–ay
(100);

420 #ifdeà
CFG_CTS_FIRMWARE_IN_FS


421 
CTS_TOOL_CMD_DOWNLOAD_FIRMWARE_WITH_FILENAME
:

422 
	`ùs_šfo
("Write firmware…ath: '%.*s'",

423 
cmd
->
d©a_Ën
, cmd->
d©a
);

425 
	`memıy
(
ùs_toŞ_fœmw¬e_f•©h
, 
cmd
->
d©a
, cmd->
d©a_Ën
);

426 
ùs_toŞ_fœmw¬e_f•©h
[
cmd
->
d©a_Ën
] = '\0';

429 
CTS_TOOL_CMD_DOWNLOAD_FIRMWARE
:

430 
	`ùs_šfo
("Start download firmware…ath: '%s'",

431 
ùs_toŞ_fœmw¬e_f•©h
);

433 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

434 ià(
»t
) {

435 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

440 
»t
 = 
	`ùs_upd©e_fœmw¬e_äom_fe
(
ùs_dev
, 
ùs_toŞ_fœmw¬e_f•©h
, 
Œue
);

441 ià(
»t
) {

442 
	`ùs_”r
("Upd©¨fœmw¬çed %d", 
»t
);

446 
»t
 = 
	`ùs_¡¬t_deviû
(
ùs_dev
);

447 ià(
»t
) {

448 
	`ùs_”r
("S¹ deviû faed %d", 
»t
);

454 
CTS_TOOL_CMD_WRITE_HOSTCOMM
:

455 
	`ùs_dbg
("Write firmware„eg‡ddr: 0x%04x val=0x%02x",

456 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a
[0]);

458 
»t
 = 
	`ùs_fw_»g_wr™eb
(
ùs_dev
,

459 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a
[0]);

460 ià(
»t
) {

461 
	`ùs_”r
("Write firmware„eg‡ddr: 0x%04x val=0x%02x failed %d",

462 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a
[0], 
»t
);

466 
CTS_TOOL_CMD_WRITE_HOSTCOMM_MULTIBYTE
:

467 
	`ùs_dbg
("Write firmare„eg‡ddr: 0x%04x†en %u",

468 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a_Ën
);

469 
»t
 = 
	`ùs_fw_»g_wr™esb
(
ùs_dev
, 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
),

470 
cmd
->
d©a
, cmd->
d©a_Ën
);

471 ià(
»t
) {

472 
	`ùs_”r
("Write firmare„eg‡ddr: 0x%04x†en %u failed %d",

473 
	`g‘_uÇligÃd_Ë16
(
cmd
->
addr
), cmd->
d©a_Ën
, 
»t
);

477 
CTS_TOOL_CMD_WRITE_PROGRAM_MODE_MULTIBYTE
:

478 
	`ùs_dbg
("Writeo‡ddr 0x%06x size %u under…rogram mode",

479 (
cmd
->
æag
 << 16è| (cmd->
addr
[1] << 8) | cmd->addr[0],

480 
cmd
->
d©a_Ën
);

481 
»t
 = 
	`ùs_’‹r_´og¿m_mode
(
ùs_dev
);

482 ià(
»t
) {

483 
	`ùs_”r
("EÁ”…rog¿m modçed %d", 
»t
);

487 
»t
 = 
	`ùs_¤am_wr™esb
(
ùs_dev
,

488 (
cmd
->
æag
 << 16è| (cmd->
addr
[1] << 8) | cmd->addr[0],

489 
cmd
->
d©a
, cmd->
d©a_Ën
);

490 ià(
»t
) {

491 
	`ùs_”r
("Wr™´og¿m modmuÉiby‹ faed %d", 
»t
);

495 
»t
 = 
	`ùs_’‹r_nÜm®_mode
(
ùs_dev
);

496 ià(
»t
) {

497 
	`ùs_”r
("EÁ”‚Üm® modçed %d", 
»t
);

503 #ifdeà
CONFIG_CTS_I2C_HOST


504 
CTS_TOOL_CMD_I2C_DIRECT_WRITE
:

506 
u32
 
addr_width
;

507 
size_t
 
Ëá_·ylßd_size
;

508 
size_t
 
max_xãr_size
;

509 *
·ylßd
;

511 ià(
cmd
->
addr
[0] !ğ
CTS_DEV_PROGRAM_MODE_I2CADDR
) {

512 
cmd
->
addr
[0] = 
CTS_DEV_NORMAL_MODE_I2CADDR
;

513 
addr_width
 = 2;

514 
ùs_toŞ_dœeù_acûss_addr
 = 
	`g‘_uÇligÃd_be16
(
cmd
->
d©a
);

516 
addr_width
 = 
ùs_dev
->
hwd©a
->
´og¿m_addr_width
;

517 
ùs_toŞ_dœeù_acûss_addr
 = 
	`g‘_uÇligÃd_be24
(
cmd
->
d©a
);

520 ià(
cmd
->
d©a_Ën
 < 
addr_width
) {

521 
	`ùs_”r
("Direct writeoo short %d <‡ddress width %d",

522 
cmd
->
d©a_Ën
, 
addr_width
);

523 
»t
 = -
EINVAL
;

527 
	`ùs_dbg
("Direct writeo i2c_addr 0x%02x‡ddr 0x%06x size %u",

528 
cmd
->
addr
[0], 
ùs_toŞ_dœeù_acûss_addr
, cmd->
d©a_Ën
);

530 
Ëá_·ylßd_size
 = 
cmd
->
d©a_Ën
 - 
addr_width
;

531 
max_xãr_size
 = 
	`ùs_¶©_g‘_max_i2c_xãr_size
(
ùs_dev
->
pd©a
);

532 
·ylßd
 = 
cmd
->
d©a
 + 
addr_width
;

534 
size_t
 
xãr_·ylßd_size
 = 
	`mš
(
Ëá_·ylßd_size
,

535 
max_xãr_size
 - 
addr_width
);

536 
size_t
 
xãr_Ën
 = 
xãr_·ylßd_size
 + 
addr_width
;

538 
»t
 = 
	`ùs_¶©_i2c_wr™e
(
ùs_d©a
->
pd©a
, 
cmd
->
addr
[0],

539 
·ylßd
 - 
addr_width
, 
xãr_Ën
, 1, 0);

540 ià(
»t
) {

541 
	`ùs_”r
("Direct write i2c_addr 0x%02x‡ddr 0x%06x†en %zu failed %d",

542 
cmd
->
addr
[0], 
ùs_toŞ_dœeù_acûss_addr
, 
xãr_Ën
, 
»t
);

546 
Ëá_·ylßd_size
 -ğ
xãr_·ylßd_size
;

547 ià(
Ëá_·ylßd_size
) {

548 
·ylßd
 +ğ
xãr_·ylßd_size
;

549 
ùs_toŞ_dœeù_acûss_addr
 +ğ
xãr_·ylßd_size
;

550 ià(
addr_width
 == 2) {

551 
	`put_uÇligÃd_be16
(
ùs_toŞ_dœeù_acûss_addr
, 
·ylßd
 - 
addr_width
);

552 } ià(
addr_width
 == 3) {

553 
	`put_uÇligÃd_be24
(
ùs_toŞ_dœeù_acûss_addr
, 
·ylßd
 - 
addr_width
);

556 } 
Ëá_·ylßd_size
);

561 
	`ùs_w¬n
("Wr™unknowÀcommªd %u", 
cmd
->cmd);

562 
»t
 = -
EINVAL
;

566 
	`ùs_uÆock_deviû
(
ùs_dev
);

568  
»t
 ? 0 : 
cmd
->
d©a_Ën
 + 
CTS_TOOL_CMD_HEADER_LENGTH
;

569 
	}
}

571 
	$ùs_ioùl_‹¡
(
ùs_deviû
 *
ùs_dev
,

572 
u32
 
Áe¡s
, 
ùs_‹¡_·¿m
 *
‹¡s
)

574 
u32
 
num_nodes
 = 0;

575 
i
, 
»t
 = 0;

577 
	`ùs_šfo
("ioùÈ‹¡Ù® %u i‹ms", 
Áe¡s
);

579 
num_nodes
 = 
ùs_dev
->
fwd©a
.
rows
 * cts_dev->fwd©a.
cŞs
;

581 
i
 = 0; i < 
Áe¡s
; i++) {

582 
boŞ
 
v®id©e_d©a
 = 
çl£
;

583 
boŞ
 
v®id©e_d©a_³r_node
 = 
çl£
;

584 
boŞ
 
v®id©e_mš
 = 
çl£
;

585 
boŞ
 
v®id©e_max
 = 
çl£
;

586 
boŞ
 
sk_šv®id_node
 = 
çl£
;

587 
boŞ
 
¡İ_‹¡_if_v®id©e_ç
 = 
çl£
;

588 
boŞ
 
dump_‹¡_d©e_to_cÚsŞe
 = 
çl£
;

589 
boŞ
 
dump_‹¡_d©e_to_u£r
 = 
çl£
;

590 
boŞ
 
dump_‹¡_d©e_to_fe
 = 
çl£
;

591 
boŞ
 
dump_‹¡_d©e_to_fe_­³nd
 = 
çl£
;

592 
boŞ
 
driv”_log_to_u£r
 = 
çl£
;

593 
boŞ
 
driv”_log_to_fe
 = 
çl£
;

594 
boŞ
 
driv”_log_to_fe_­³nd
 = 
çl£
;

595 
u32
 
__u£r
 *
u£r_mš_th»shŞd
 = 
NULL
;

596 
u32
 
__u£r
 *
u£r_max_th»shŞd
 = 
NULL
;

597 
u32
 
__u£r
 *
u£r_šv®id_nodes
 = 
NULL
;

598 
__u£r
 *
u£r_‹¡_»suÉ
 = 
NULL
;

599 
__u£r
 *
u£r_‹¡_d©a
 = 
NULL
;

600 
__u£r
 *
u£r_‹¡_d©a_wr_size
 = 
NULL
;

601 cÚ¡ 
__u£r
 *
u£r_‹¡_d©a_f•©h
 = 
NULL
;

602 
__u£r
 *
u£r_driv”_log_buf
 = 
NULL
;

603 
__u£r
 *
u£r_driv”_log_wr_size
 = 
NULL
;

604 cÚ¡ 
__u£r
 *
u£r_driv”_log_f•©h
 = 
NULL
;

605 
__u£r
 *
u£r_´iv_·¿m
 = 
NULL
;

606 
‹¡_»suÉ
 = 0;

607 
‹¡_d©a_wr_size
 = 0;

608 
driv”_log_wr_size
 = 0;

610 
	`ùs_šfo
("ioctlest item %d: %d(%s) flags: %08x…riv…aram size: %d",

611 
i
, 
‹¡s
[i].
‹¡_™em
, 
	`ùs_‹¡_™em_¡r
(tests[i].test_item),

612 
‹¡s
[
i
].
æags
,e¡s[i].
´iv_·¿m_size
);

616 
v®id©e_d©a
 =

617 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_VALIDATE_DATA
);

618 
v®id©e_d©a_³r_node
 =

619 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_VALIDATE_PER_NODE
);

620 
v®id©e_mš
 =

621 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_VALIDATE_MIN
);

622 
v®id©e_max
 =

623 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_VALIDATE_MAX
);

624 
sk_šv®id_node
 =

625 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_VALIDATE_SKIP_INVALID_NODE
);

626 
¡İ_‹¡_if_v®id©e_ç
 =

627 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_STOP_TEST_IF_VALIDATE_FAILED
);

628 
dump_‹¡_d©e_to_u£r
 =

629 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_USERSPACE
);

630 
dump_‹¡_d©e_to_fe
 =

631 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE
);

632 
dump_‹¡_d©e_to_fe_­³nd
 =

633 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_DUMP_TEST_DATA_TO_FILE_APPEND
);

634 
driv”_log_to_u£r
 =

635 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_DRIVER_LOG_TO_USERSPACE
);

636 
driv”_log_to_fe
 =

637 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_DRIVER_LOG_TO_FILE
);

638 
driv”_log_to_fe_­³nd
 =

639 !!(
‹¡s
[
i
].
æags
 & 
CTS_TEST_FLAG_DRIVER_LOG_TO_FILE_APPEND
);

641 ià(
‹¡s
[
i
].
‹¡_»suÉ
 =ğ
NULL
) {

642 
	`ùs_”r
("Result…ointer = NULL");

643  -
EFAULT
;

646 ià(
v®id©e_d©a
) {

647 
	`ùs_šfo
(" - Flag: Validate data");

649 ià(
v®id©e_d©a_³r_node
) {

650 
	`ùs_šfo
(" - Flag: Validate data…er-node");

652 ià(
v®id©e_mš
) {

653 
	`ùs_šfo
(" - Flag: Validate minhreshold");

655 ià(
v®id©e_max
) {

656 
	`ùs_šfo
(" - Flag: Validate maxhreshold");

658 ià(
¡İ_‹¡_if_v®id©e_ç
) {

659 
	`ùs_šfo
(" - Flag: Stopest if validate fail");

662 ià(
v®id©e_mš
 && 
‹¡s
[
i
].
mš
 =ğ
NULL
) {

663 
	`ùs_”r
("Minhreshold…ointer = NULL");

664 
»t
 = -
EINVAL
;

665 
¡Üe_»suÉ
;

667 ià(
v®id©e_max
 && 
‹¡s
[
i
].
max
 =ğ
NULL
) {

668 
	`ùs_”r
("Maxhreshold…ointer = NULL");

669 
»t
 = -
EINVAL
;

670 
¡Üe_»suÉ
;

672 ià(
sk_šv®id_node
) {

673 
	`ùs_šfo
(" - Flag: Skip invalid‚ode");

675 ià(
‹¡s
[
i
].
num_šv®id_node
 == 0 ||

676 
‹¡s
[
i
].
num_šv®id_node
 >ğ
num_nodes
) {

677 
	`ùs_”r
("Num invalid‚ode %u out of„ange[0, %u]",

678 
‹¡s
[
i
].
num_šv®id_node
, 
num_nodes
);

679 
»t
 = -
EINVAL
;

680 
¡Üe_»suÉ
;

683 ià(
‹¡s
[
i
].
šv®id_nodes
 =ğ
NULL
) {

684 
	`ùs_”r
("Invalid‚odes…ointer = NULL");

685 
»t
 = -
EINVAL
;

686 
¡Üe_»suÉ
;

691 ià(
dump_‹¡_d©e_to_cÚsŞe
) {

692 
	`ùs_šfo
(" - Flag: Dumpest datao console");

695 ià(
dump_‹¡_d©e_to_u£r
) {

696 
	`ùs_šfo
(" - Flag: Dumpest datao user, size: %d",

697 
‹¡s
[
i
].
‹¡_d©a_buf_size
);

699 ià(
‹¡s
[
i
].
‹¡_d©a_buf
 =ğ
NULL
) {

700 
	`ùs_”r
("Test data…ointer = NULL");

701 
»t
 = -
EINVAL
;

702 
¡Üe_»suÉ
;

704 ià(
‹¡s
[
i
].
‹¡_d©a_wr_size
 =ğ
NULL
) {

705 
	`ùs_”r
("Test data write size…ointer = NULL");

706 
»t
 = -
EINVAL
;

707 
¡Üe_»suÉ
;

709 ià(
‹¡s
[
i
].
‹¡_d©a_buf_size
 < 
num_nodes
) {

710 
	`ùs_”r
("Test data size %doo small < %u",

711 
‹¡s
[
i
].
‹¡_d©a_buf_size
, 
num_nodes
);

712 
»t
 = -
EINVAL
;

713 
¡Üe_»suÉ
;

717 ià(
dump_‹¡_d©e_to_fe
) {

718 
	`ùs_šfo
(" - Flag: Dumpest datao file%s",

719 
dump_‹¡_d©e_to_fe_­³nd
 ? "[Append]" : "");

721 ià(
‹¡s
[
i
].
‹¡_d©a_f•©h
 =ğ
NULL
) {

722 
	`ùs_”r
("Test data filepath = NULL");

723 
»t
 = -
EINVAL
;

724 
¡Üe_»suÉ
;

728 ià(
driv”_log_to_u£r
) {

729 
	`ùs_šfo
(" - Flag: Dump driver†ogo user, size: %d",

730 
‹¡s
[
i
].
driv”_log_buf_size
);

732 ià(
‹¡s
[
i
].
driv”_log_buf
 =ğ
NULL
) {

733 
	`ùs_”r
("Driver†og buf…ointer = NULL");

734 
»t
 = -
EINVAL
;

735 
¡Üe_»suÉ
;

737 ià(
‹¡s
[
i
].
driv”_log_wr_size
 =ğ
NULL
) {

738 
	`ùs_”r
("Driver†og write size…ointer = NULL");

739 
»t
 = -
EINVAL
;

740 
¡Üe_»suÉ
;

742 ià(
‹¡s
[
i
].
driv”_log_buf_size
 < 1024) {

743 
	`ùs_”r
("Driver†og buf size %doo small < 1024",

744 
‹¡s
[
i
].
‹¡_d©a_buf_size
);

745 
»t
 = -
EINVAL
;

746 
¡Üe_»suÉ
;

750 ià(
driv”_log_to_fe
) {

751 
	`ùs_šfo
(" - Flag: Dump driver†ogo file",

752 
driv”_log_to_fe_­³nd
 ? "[Append]" : "");

754 ià(
‹¡s
[
i
].
driv”_log_f•©h
 =ğ
NULL
) {

755 
	`ùs_”r
("Driver†og filepath = NULL");

756 
»t
 = -
EINVAL
;

757 
¡Üe_»suÉ
;

766 
u£r_‹¡_»suÉ
 = (
__u£r
 *)
‹¡s
[
i
].
‹¡_»suÉ
;

767 
‹¡s
[
i
].
‹¡_»suÉ
 = &test_result;

769 ià(
v®id©e_d©a
) {

770 
num_th»shŞd
 = 
v®id©e_d©a_³r_node
 ? 
num_nodes
 : 1;

771 
th»shŞd_size
 = 
num_th»shŞd
 * (
‹¡s
[
i
].
mš
[0]);

773 ià(
v®id©e_mš
) {

774 
u£r_mš_th»shŞd
 = (
__u£r
 *)
‹¡s
[
i
].
mš
;

775 
‹¡s
[
i
].
mš
 = 
	`memdup_u£r
(
u£r_mš_th»shŞd
, 
th»shŞd_size
);

776 ià(
	`IS_ERR
(
‹¡s
[
i
].
mš
)) {

777 
»t
 = 
	`PTR_ERR
(
‹¡s
[
i
].
mš
);

778 
‹¡s
[
i
].
mš
 = 
NULL
;

779 
	`ùs_”r
("Memdu°mšh»shŞd from u£¸çed %d", 
»t
);

780 
¡Üe_»suÉ
;

783 
‹¡s
[
i
].
mš
 = 
NULL
;

785 ià(
v®id©e_max
) {

786 
u£r_max_th»shŞd
 = (
__u£r
 *)
‹¡s
[
i
].
max
;

787 
‹¡s
[
i
].
max
 = 
	`memdup_u£r
(
u£r_max_th»shŞd
, 
th»shŞd_size
);

788 ià(
	`IS_ERR
(
‹¡s
[
i
].
max
)) {

789 
»t
 = 
	`PTR_ERR
(
‹¡s
[
i
].
max
);

790 
‹¡s
[
i
].
max
 = 
NULL
;

791 
	`ùs_”r
("Memdu°maxh»shŞd from u£¸çed %d", 
»t
);

792 
¡Üe_»suÉ
;

795 
‹¡s
[
i
].
max
 = 
NULL
;

797 ià(
sk_šv®id_node
) {

798 
u£r_šv®id_nodes
 = (
u32
 
__u£r
 *)
‹¡s
[
i
].
šv®id_nodes
;

799 
‹¡s
[
i
].
šv®id_nodes
 = 
	`memdup_u£r
(
u£r_šv®id_nodes
,

800 
‹¡s
[
i
].
num_šv®id_node
 * Ñe¡s[i].
šv®id_nodes
[0]));

801 ià(
	`IS_ERR
(
‹¡s
[
i
].
šv®id_nodes
)) {

802 
»t
 = 
	`PTR_ERR
(
‹¡s
[
i
].
šv®id_nodes
);

803 
‹¡s
[
i
].
šv®id_nodes
 = 
NULL
;

804 
	`ùs_”r
("Memdu°šv®id‚odäom u£¸çed %d", 
»t
);

805 
¡Üe_»suÉ
;

810 ià(
dump_‹¡_d©e_to_u£r
) {

811 
u£r_‹¡_d©a
 = (
__u£r
 *)
‹¡s
[
i
].
‹¡_d©a_buf
;

812 
‹¡s
[
i
].
‹¡_d©a_buf
 = 
	`km®loc
Ñe¡s[i].
‹¡_d©a_buf_size
, 
GFP_KERNEL
);

813 ià(
‹¡s
[
i
].
‹¡_d©a_buf
 =ğ
NULL
) {

814 
»t
 = -
ENOMEM
;

815 
	`ùs_”r
("Allocest data mem failed");

816 
¡Üe_»suÉ
;

818 
u£r_‹¡_d©a_wr_size
 = (
__u£r
 *)
‹¡s
[
i
].
‹¡_d©a_wr_size
;

819 
‹¡s
[
i
].
‹¡_d©a_wr_size
 = &test_data_wr_size;

822 ià(
dump_‹¡_d©e_to_fe
) {

823 
u£r_‹¡_d©a_f•©h
 = (cÚ¡ 
__u£r
 *)
‹¡s
[
i
].
‹¡_d©a_f•©h
;

824 
‹¡s
[
i
].
‹¡_d©a_f•©h
 = 
	`¡ºdup_u£r
(
u£r_‹¡_d©a_f•©h
, 
PATH_MAX
);

825 ià(
‹¡s
[
i
].
‹¡_d©a_f•©h
 =ğ
NULL
) {

826 
	`ùs_”r
("Strdupest data filepath failed");

827 
¡Üe_»suÉ
;

829 
	`ùs_¡¬t_dump_‹¡_d©a_to_fe
(
‹¡s
[
i
].
‹¡_d©a_f•©h
,

830 
dump_‹¡_d©e_to_fe_­³nd
);

833 ià(
driv”_log_to_u£r
) {

834 
u£r_driv”_log_buf
 = (
__u£r
 *)
‹¡s
[
i
].
driv”_log_buf
;

835 
‹¡s
[
i
].
driv”_log_buf
 = 
	`km®loc
Ñe¡s[i].
driv”_log_buf_size
, 
GFP_KERNEL
);

836 ià(
‹¡s
[
i
].
driv”_log_buf
 =ğ
NULL
) {

837 
»t
 = -
ENOMEM
;

838 
	`ùs_”r
("Alloc driver†og mem failed");

839 
¡Üe_»suÉ
;

841 
u£r_driv”_log_wr_size
 = (
__u£r
 *)
‹¡s
[
i
].
driv”_log_wr_size
;

842 
‹¡s
[
i
].
driv”_log_wr_size
 = &driver_log_wr_size;

845 ià(
driv”_log_to_fe
) {

846 
u£r_driv”_log_f•©h
 = (cÚ¡ 
__u£r
 *)
‹¡s
[
i
].
driv”_log_f•©h
;

847 
‹¡s
[
i
].
driv”_log_f•©h
 = 
	`¡ºdup_u£r
(
u£r_driv”_log_f•©h
, 
PATH_MAX
);

848 ià(
‹¡s
[
i
].
driv”_log_f•©h
 =ğ
NULL
) {

849 
	`ùs_”r
("Strdup driver†og filepath failed");

850 
¡Üe_»suÉ
;

852 
	`ùs_šfo
("Log driv”†ogØf'%s'", 
‹¡s
[
i
].
driv”_log_f•©h
);

855 ià(
driv”_log_to_fe
 || 
driv”_log_to_u£r
) {

856 
»t
 = 
	`ùs_¡¬t_driv”_log_»dœeù
(

857 
‹¡s
[
i
].
driv”_log_f•©h
, 
driv”_log_to_fe_­³nd
,

858 
‹¡s
[
i
].
driv”_log_buf
,e¡s[i].
driv”_log_buf_size
,

859 
‹¡s
[
i
].
driv”_log_Ëv–
);

860 ià(
»t
) {

861 
	`ùs_”r
("S¹ driv”†og„edœeù faed %d", 
»t
);

862 
¡Üe_»suÉ
;

866 ià(
‹¡s
[
i
].
´iv_·¿m_size
 &&e¡s[i].
´iv_·¿m
) {

867 
u£r_´iv_·¿m
 = (
__u£r
 *)
‹¡s
[
i
].
´iv_·¿m
;

868 
‹¡s
[
i
].
´iv_·¿m
 = 
	`memdup_u£r
(
u£r_´iv_·¿m
,e¡s[i].
´iv_·¿m_size
);

869 ià(
	`IS_ERR
(
‹¡s
[
i
].
´iv_·¿m
)) {

870 
»t
 = 
	`PTR_ERR
(
‹¡s
[
i
].
´iv_·¿m
);

871 
‹¡s
[
i
].
´iv_·¿m
 = 
NULL
;

872 
	`ùs_”r
("Memdu°´iv…¬am from u£¸çed %d", 
»t
);

873 
¡Üe_»suÉ
;

880 
‹¡s
[
i
].
‹¡_™em
) {

881 
CTS_TEST_RESET_PIN
:

882 
»t
 = 
	`ùs_‹¡_»£t_pš
(
ùs_dev
, &
‹¡s
[
i
]);

884 
CTS_TEST_INT_PIN
:

885 
»t
 = 
	`ùs_‹¡_št_pš
(
ùs_dev
, &
‹¡s
[
i
]);

887 
CTS_TEST_RAWDATA
:

888 
»t
 = 
	`ùs_‹¡_¿wd©a
(
ùs_dev
, &
‹¡s
[
i
]);

890 
CTS_TEST_NOISE
:

891 
»t
 = 
	`ùs_‹¡_noi£
(
ùs_dev
, &
‹¡s
[
i
]);

893 
CTS_TEST_OPEN
:

894 
»t
 = 
	`ùs_‹¡_İ’
(
ùs_dev
, &
‹¡s
[
i
]);

896 
CTS_TEST_SHORT
:

897 
»t
 = 
	`ùs_‹¡_shÜt
(
ùs_dev
, &
‹¡s
[
i
]);

899 
CTS_TEST_COMPENSATE_CAP
:

900 
»t
 = 
	`ùs_‹¡_com³n§‹_ÿp
(
ùs_dev
, &
‹¡s
[
i
]);

903 
»t
 = 
ENOTSUPP
;

904 
	`ùs_”r
("Un-supportedest item");

911 
¡Üe_»suÉ
:

912 ià(
dump_‹¡_d©e_to_u£r
) {

913 ià(
u£r_‹¡_d©a
 !ğ
NULL
 && 
‹¡_d©a_wr_size
 > 0) {

914 
	`ùs_šfo
("Cİye¡ d©¨tØu£r, size: %d", 
‹¡_d©a_wr_size
);

915 ià(
	`cİy_to_u£r
(
u£r_‹¡_d©a
, 
‹¡s
[
i
].
‹¡_d©a_buf
,

916 
‹¡_d©a_wr_size
)) {

917 
	`ùs_”r
("Copyest datao user failed");

918 
‹¡_d©a_wr_size
 = 0;

923 ià(
u£r_‹¡_d©a_wr_size
 !ğ
NULL
) {

924 
	`put_u£r
(
‹¡_d©a_wr_size
, 
u£r_‹¡_d©a_wr_size
);

928 ià(
driv”_log_to_u£r
) {

929 
driv”_log_wr_size
 = 
	`ùs_g‘_driv”_log_»dœeù_size
();

930 ià(
u£r_driv”_log_buf
 !ğ
NULL
 && 
driv”_log_wr_size
 > 0) {

931 
	`ùs_šfo
("Cİy driv”†ogØu£r, size: %d", 
driv”_log_wr_size
);

932 ià(
	`cİy_to_u£r
(
u£r_driv”_log_buf
, 
‹¡s
[
i
].
driv”_log_buf
,

933 
driv”_log_wr_size
)) {

934 
	`ùs_”r
("Copy driver†ogo user failed");

935 
driv”_log_wr_size
 = 0;

940 ià(
u£r_driv”_log_wr_size
 !ğ
NULL
) {

941 
	`put_u£r
(
driv”_log_wr_size
, 
u£r_driv”_log_wr_size
);

945 ià(
u£r_‹¡_»suÉ
 !ğ
NULL
) {

946 
	`put_u£r
(
»t
, 
u£r_‹¡_»suÉ
);

947 } ià(
‹¡s
[
i
].
‹¡_»suÉ
 !ğ
NULL
){

948 
	`put_u£r
(
»t
, 
‹¡s
[
i
].
‹¡_»suÉ
);

954 ià(
dump_‹¡_d©e_to_u£r
) {

955 ià(
u£r_‹¡_d©a
 !ğ
NULL
 && 
‹¡s
[
i
].
‹¡_d©a_buf
 != NULL) {

956 
	`kä“
(
‹¡s
[
i
].
‹¡_d©a_buf
);

959 ià(
v®id©e_d©a
) {

960 ià(
v®id©e_mš
 && 
u£r_mš_th»shŞd
 !ğ
NULL
 && 
‹¡s
[
i
].
mš
 != NULL) {

961 
	`kä“
(
‹¡s
[
i
].
mš
);

963 ià(
v®id©e_max
 && 
u£r_max_th»shŞd
 !ğ
NULL
 && 
‹¡s
[
i
].
max
 != NULL) {

964 
	`kä“
(
‹¡s
[
i
].
max
);

966 ià(
sk_šv®id_node
) {

967 ià(
u£r_šv®id_nodes
 !ğ
NULL
 && 
‹¡s
[
i
].
šv®id_nodes
 != NULL) {

968 
	`kä“
(
‹¡s
[
i
].
šv®id_nodes
);

973 ià(
dump_‹¡_d©e_to_fe
) {

974 
	`ùs_¡İ_dump_‹¡_d©a_to_fe
();

976 ià(
u£r_‹¡_d©a_f•©h
 !ğ
NULL
 &&

977 
‹¡s
[
i
].
‹¡_d©a_f•©h
 !ğ
NULL
) {

978 
	`kä“
(
‹¡s
[
i
].
‹¡_d©a_f•©h
);

982 ià(
driv”_log_to_u£r
) {

983 ià(
u£r_driv”_log_buf
 !ğ
NULL
 &&

984 
‹¡s
[
i
].
driv”_log_buf
 !ğ
NULL
) {

985 
	`kä“
(
‹¡s
[
i
].
driv”_log_buf
);

989 ià(
driv”_log_to_fe
) {

990 ià(
u£r_driv”_log_f•©h
 !ğ
NULL
 &&

991 
‹¡s
[
i
].
driv”_log_f•©h
 !ğ
NULL
) {

992 
	`kä“
(
‹¡s
[
i
].
driv”_log_f•©h
);

996 ià(
driv”_log_to_fe
 || 
driv”_log_to_u£r
) {

997 
	`ùs_¡İ_driv”_log_»dœeù
();

1000 ià(
u£r_´iv_·¿m
 && 
‹¡s
[
i
].
´iv_·¿m
) {

1001 
	`kä“
(
‹¡s
[
i
].
´iv_·¿m
);

1004 ià(
»t
 && 
¡İ_‹¡_if_v®id©e_ç
) {

1009 
	`kä“
(
‹¡s
);

1011  
»t
;

1012 
	}
}

1014 
	$ùs_ioùl_rdwr_»g
(
ùs_deviû
 *
ùs_dev
,

1015 
u8
 
»g_ty³
, 
u32
 
Äegs
, 
ùs_rdwr_»g
 *
»gs
)

1017 
i
, 
»t
 = 0;

1018 
boŞ
 
fw_esd_´Ùeù
 = 
çl£
;

1020 
	`ùs_šfo
("ioùÈRDWR_REGy³: %uÙ® %u„egs", 
»g_ty³
, 
Äegs
);

1022 
	`ùs_lock_deviû
(
ùs_dev
);

1024 ià(
»g_ty³
 =ğ
CTS_IOCTL_RDWR_REG_TYPE_DDI
) {

1025 
»t
 = 
	`ùs_g‘_dev_esd_´ÙeùiÚ
(
ùs_dev
, &
fw_esd_´Ùeù
);

1026 ià(
»t
) {

1027 
	`ùs_”r
("G‘ fwƒsd…rÙeùiÚ faed %d", 
»t
);

1028 
uÆock_deviû
;

1031 ià(
fw_esd_´Ùeù
) {

1032 
»t
 = 
	`ùs_£t_dev_esd_´ÙeùiÚ
(
ùs_dev
, 
çl£
);

1033 ià(
»t
) {

1034 
	`ùs_”r
("S‘ fwƒsd…rÙeùiÚ faed %d", 
»t
);

1035 
uÆock_deviû
;

1039 
»t
 = 
ùs_dev
->
hwd©a
->
	`’abË_acûss_ddi_»g
(ùs_dev, 
Œue
);

1040 ià(
»t
) {

1041 
	`ùs_”r
("EÇbË‡cûs dd˜»g faed %d", 
»t
);

1042 
»cov”y_fw_esd_´Ùeù
;

1046 
i
 = 0; i < 
Äegs
; i++) {

1047 
ùs_rdwr_»g
 *
»g
 = 
»gs
 + 
i
;

1048 
u8
 *
d©a
 = 
NULL
;

1050 
	`ùs_dbg
("„eg: %p flags: 0x%x data: %p†en: %u delay: %u",

1051 
»g
,„eg->
æags
,„eg->
d©a
,„eg->
Ën
,„eg->
d–ay_ms
);

1053 ià(
»g
->
d©a
 =ğ
NULL
 ||„eg->
Ën
 == 0) {

1054 
	`ùs_”r
("Rdwr„eg(addr: 0x%06x) with data: %p or†en: %u",

1055 
»g
->
addr
,„eg->
d©a
,„eg->
Ën
);

1056 
»t
 = -
EINVAL
;

1057 
di§bË_acûss_ddi_»g
;

1060 ià(
»g
->
æags
 & 
CTS_IOCTL_RDWR_REG_FLAG_RD
) {

1061 
u8
 
__u£r
 *
u£r_d©a
 = 
»g
->
d©a
;

1063 
d©a
 = 
	`km®loc
(
»g
->
Ën
, 
GFP_KERNEL
);

1064 ià(
d©a
 =ğ
NULL
) {

1065 
	`ùs_”r
("Alloc mem for„ead„eg(addr: 0x%06x†en: %u) data failed",

1066 
»g
->
addr
,„eg->
Ën
);

1067 
»t
 = -
ENOMEM
;

1068 
di§bË_acûss_ddi_»g
;

1070 ià(
»g_ty³
 =ğ
CTS_IOCTL_RDWR_REG_TYPE_FW
) {

1071 
»t
 = 
	`ùs_fw_»g_»adsb
(
ùs_dev
,

1072 
»gs
->
addr
, 
d©a
, 
»g
->
Ën
);

1074 
»t
 = 
	`ùs_hw_»g_»adsb
(
ùs_dev
,

1075 
»gs
->
addr
, 
d©a
, 
»g
->
Ën
);

1077 ià(
»t
) {

1078 
	`kä“
(
d©a
);

1079 
	`ùs_”r
("Read„eg from‡ddr: 0x%06x†en: %u failed %d",

1080 
»g
->
addr
,„eg->
Ën
, 
»t
);

1081 
di§bË_acûss_ddi_»g
;

1083 ià(
	`cİy_to_u£r
(
u£r_d©a
, 
d©a
, 
»g
->
Ën
)) {

1084 
	`kä“
(
d©a
);

1085 
	`ùs_”r
("Copy„eg(addr: 0x%06x†en: %u) datao user failed",

1086 
»g
->
addr
,„eg->
Ën
);

1088 
	`kä“
(
d©a
);

1090 
d©a
 = 
	`memdup_u£r
(
»g
->d©a,„eg->
Ën
);

1091 ià(
	`IS_ERR
(
d©a
)) {

1092 
»t
 = 
	`PTR_ERR
(
d©a
);

1093 
	`ùs_”r
("Memdup„eg(addr: 0x%06x†en: %u) data from user failed",

1094 
»g
->
addr
,„eg->
Ën
);

1095 
di§bË_acûss_ddi_»g
;

1097 ià(
»g_ty³
 =ğ
CTS_IOCTL_RDWR_REG_TYPE_FW
) {

1098 
»t
 = 
	`ùs_fw_»g_wr™esb
(
ùs_dev
,

1099 
»gs
->
addr
, 
d©a
, 
»g
->
Ën
);

1101 
»t
 = 
	`ùs_hw_»g_wr™esb
(
ùs_dev
,

1102 
»gs
->
addr
, 
d©a
, 
»g
->
Ën
);

1104 
	`kä“
(
d©a
);

1105 ià(
»t
) {

1106 
	`ùs_”r
("Write„eg from‡ddr 0x%06x†en %u failed %d",

1107 
»g
->
addr
,„eg->
Ën
, 
»t
);

1108 
di§bË_acûss_ddi_»g
;

1112 ià(
»g
->
d–ay_ms
) {

1113 
	`md–ay
(
»g
->
d–ay_ms
);

1117 
di§bË_acûss_ddi_»g
:

1118 ià(
»g_ty³
 =ğ
CTS_IOCTL_RDWR_REG_TYPE_DDI
) {

1119 
r
 = 
ùs_dev
->
hwd©a
->
	`’abË_acûss_ddi_»g
(ùs_dev, 
çl£
);

1120 ià(
r
) {

1121 
	`ùs_”r
("Di§bË‡cûs dd˜»g faed %d", 
r
);

1125 
»cov”y_fw_esd_´Ùeù
:

1126 ià(
»g_ty³
 =ğ
CTS_IOCTL_RDWR_REG_TYPE_DDI
 && 
fw_esd_´Ùeù
) {

1127 
r
 = 
	`ùs_£t_dev_esd_´ÙeùiÚ
(
ùs_dev
, 
Œue
);

1128 ià(
r
) {

1129 
	`ùs_”r
("Re-EÇbË fwƒsd…rÙeùiÚ faed %d", 
r
);

1133 
uÆock_deviû
:

1134 
	`ùs_uÆock_deviû
(
ùs_dev
);

1136 
	`kä“
(
»gs
);

1138  
»t
;

1139 
	}
}

1141 
	$ùs_ioùl_upg¿de_fw
(
ùs_deviû
 *
ùs_dev
,

1142 
ùs_upg¿de_fw_ioùl_d©a
 *
ioùl_d©a
)

1144 
boŞ
 
to_æash
;

1145 
»t
;

1147 
	`ùs_šfo
("ioctl UPGRADE-FW flags: 0x%x "

1149 
ioùl_d©a
->
æags
,

1150 
ioùl_d©a
->
butš_fw_šdex
, ioùl_d©a->
f•©h
,

1151 
ioùl_d©a
->
fw_d©a
, ioùl_d©a->
fw_d©a_size
);

1153 
to_æash
 = !!(
ioùl_d©a
->
æags
 & 
CTS_IOCTL_UPGRADE_FW_FLAG_TO_FLASH
);

1155 ià(!!(
ioùl_d©a
->
æags
 & 
CTS_IOCTL_UPGRADE_FW_FLAG_BUILTIN
)) {

1156 cÚ¡ 
ùs_fœmw¬e
 *
fœmw¬e
;

1158 
fœmw¬e
 = 
	`ùs_»que¡_driv”_butš_fœmw¬e_by_šdex
(

1159 
ioùl_d©a
->
butš_fw_šdex
);

1160 ià(
fœmw¬e
) {

1161 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1162 ià(
»t
) {

1163 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1164  
»t
;

1167 
	`ùs_lock_deviû
(
ùs_dev
);

1168 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, 
fœmw¬e
, 
to_æash
);

1169 
	`ùs_uÆock_deviû
(
ùs_dev
);

1171 ià(
»t
) {

1172 
	`ùs_”r
("Upd©fœmw¬çed %d", 
»t
);

1175 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1177  
»t
;

1179 
	`ùs_”r
("Upgrade fw by builtin NOT found index %u",

1180 
ioùl_d©a
->
butš_fw_šdex
);

1181  -
EINVAL
;

1185 ià(!!(
ioùl_d©a
->
æags
 & 
CTS_IOCTL_UPGRADE_FW_FLAG_FILE
)) {

1186 *
f•©h
;

1188 ià(
ioùl_d©a
->
f•©h
 =ğ
NULL
) {

1189 
	`ùs_”r
("Upgrade fw by file with filepath = NULL");

1190  -
EINVAL
;

1193 
f•©h
 = 
	`¡ºdup_u£r
(
ioùl_d©a
->f•©h, 
PATH_MAX
);

1194 ià(
	`IS_ERR
(
f•©h
)) {

1195 
»t
 = 
	`PTR_ERR
(
f•©h
);

1196 
	`ùs_”r
("Memdum°f•©hØk”ÃÈçed %d", 
»t
);

1197  
»t
;

1200 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1201 ià(
»t
) {

1202 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1203  
»t
;

1206 
	`ùs_lock_deviû
(
ùs_dev
);

1207 
»t
 = 
	`ùs_upd©e_fœmw¬e_äom_fe
(
ùs_dev
,

1208 
f•©h
, 
to_æash
);

1209 
	`ùs_uÆock_deviû
(
ùs_dev
);

1211 ià(
»t
) {

1212 
	`ùs_”r
("Upg¿dfw from f'%s' faed %d", 
f•©h
);

1214 
	`kä“
(
f•©h
);

1216 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1218  
»t
;

1221 ià(!!(
ioùl_d©a
->
æags
 & 
CTS_IOCTL_UPGRADE_FW_FLAG_FW_DATA
)) {

1222 
ùs_fœmw¬e
 
fœmw¬e
;

1224 ià(
ioùl_d©a
->
fw_d©a
 =ğ
NULL
 ||

1225 
ioùl_d©a
->
fw_d©a_size
 < 0x102 ||

1226 
ioùl_d©a
->
fw_d©a_size
 > 0x20000) {

1227 
	`ùs_”r
("Upgrade fw by data with "

1229 
ioùl_d©a
->
fw_d©a
, ioùl_d©a->
fw_d©a_size
);

1230  -
EINVAL
;

1233 
	`mem£t
(&
fœmw¬e
, 0, (firmware));

1234 
fœmw¬e
.
d©a
 = 
	`memdup_u£r
(
ioùl_d©a
->
fw_d©a
,

1235 
ioùl_d©a
->
fw_d©a_size
);

1236 ià(
	`IS_ERR
(
fœmw¬e
.
d©a
)) {

1237 
»t
 = 
	`PTR_ERR
(
fœmw¬e
.
d©a
);

1238 
	`ùs_”r
("Memdum°fw d©¨tØk”ÃÈçed %d", 
»t
);

1239  
»t
;

1241 
fœmw¬e
.
size
 = 
ioùl_d©a
->
fw_d©a_size
;

1243 
»t
 = 
	`ùs_¡İ_deviû
(
ùs_dev
);

1244 ià(
»t
) {

1245 
	`ùs_”r
("Stİ deviû faed %d", 
»t
);

1246  
»t
;

1249 
	`ùs_lock_deviû
(
ùs_dev
);

1250 
»t
 = 
	`ùs_upd©e_fœmw¬e
(
ùs_dev
, &
fœmw¬e
, 
to_æash
);

1251 
	`ùs_uÆock_deviû
(
ùs_dev
);

1253 ià(
»t
) {

1254 
	`ùs_”r
("Upg¿dfœmw¬d©¨çed %d", 
»t
);

1256 
	`kä“
(
fœmw¬e
.
d©a
);

1258 
	`ùs_¡¬t_deviû
(
ùs_dev
);

1262 
	`ùs_”r
("ioctl UPGRADE-FW both filepath‡nd data = NULL");

1263  -
EINVAL
;

1265 
	}
}

1267 
	$ùs_toŞ_ioùl
(
fe
 *fe, 
cmd
,

1268 
¬g
)

1270 
chÚe_ts_d©a
 *
ùs_d©a
;

1271 
ùs_deviû
 *
ùs_dev
;

1273 
	`ùs_šfo
("ioùl, cmd=0x%08x,‡rg=0x%08lx", 
cmd
, 
¬g
);

1275 
ùs_d©a
 = 
fe
->
´iv©e_d©a
;

1276 ià(
ùs_d©a
 =ğ
NULL
) {

1277 
	`ùs_”r
("IOCTL with…rivate data = NULL");

1278  -
EFAULT
;

1281 
ùs_dev
 = &
ùs_d©a
->cts_dev;

1283 
cmd
) {

1284 
CTS_TOOL_IOCTL_GET_DRIVER_VERSION
:

1285  
	`put_u£r
(
CTS_DRIVER_VERSION_CODE
,

1286 (
__u£r
 *)
¬g
);

1287 
CTS_TOOL_IOCTL_GET_DEVICE_TYPE
:

1288  
	`put_u£r
(
ùs_dev
->
hwd©a
->
hwid
,

1289 (
__u£r
 *)
¬g
);

1290 
CTS_TOOL_IOCTL_GET_FW_VERSION
:

1291  
	`put_u£r
(
ùs_dev
->
fwd©a
.
v”siÚ
,

1292 (
__u£r
 *)
¬g
);

1293 
CTS_TOOL_IOCTL_GET_RESOLUTION
:

1294  
	`put_u£r
((
ùs_dev
->
fwd©a
.
»s_y
 << 16è+ cts_dev->fwd©a.
»s_x
,

1295 (
__u£r
 *)
¬g
);

1296 
CTS_TOOL_IOCTL_GET_ROW_COL
:

1297  
	`put_u£r
((
ùs_dev
->
fwd©a
.
cŞs
 << 16è+ cts_dev->fwd©a.
rows
,

1298 (
__u£r
 *)
¬g
);

1300 
CTS_TOOL_IOCTL_TEST
:{

1301 
ùs_‹¡_ioùl_d©a
 
‹¡_¬g
;

1302 
ùs_‹¡_·¿m
 *
‹¡s_·
;

1304 ià(
	`cİy_äom_u£r
(&
‹¡_¬g
,

1305 (
ùs_‹¡_ioùl_d©a
 
__u£r
 *)
¬g
,

1306 (
‹¡_¬g
))) {

1307 
	`ùs_”r
("Copy ioctlest‡rgo kernel failed");

1308  -
EFAULT
;

1311 ià(
‹¡_¬g
.
Áe¡s
 > 8) {

1312 
	`ùs_”r
("ioctlest withoo manyests %u",

1313 
‹¡_¬g
.
Áe¡s
);

1314  -
EINVAL
;

1317 
‹¡s_·
 = 
	`memdup_u£r
(
‹¡_¬g
.
‹¡s
,

1318 
‹¡_¬g
.
Áe¡s
 * (
ùs_‹¡_·¿m
));

1319 ià(
	`IS_ERR
(
‹¡s_·
)) {

1320 
»t
 = 
	`PTR_ERR
(
‹¡s_·
);

1321 
	`ùs_”r
("Memdum°‹¡…¬amØk”ÃÈçed %d", 
»t
);

1322  
»t
;

1325  
	`ùs_ioùl_‹¡
(
ùs_dev
, 
‹¡_¬g
.
Áe¡s
, 
‹¡s_·
);

1327 
CTS_TOOL_IOCTL_RDWR_REG
:{

1328 
ùs_rdwr_»g_ioùl_d©a
 
ioùl_d©a
;

1329 
ùs_rdwr_»g
 *
»gs_·
;

1331 ià(
	`cİy_äom_u£r
(&
ioùl_d©a
,

1332 (
ùs_rdwr_»g_ioùl_d©a
 
__u£r
 *)
¬g
,

1333 (
ioùl_d©a
))) {

1334 
	`ùs_”r
("Copy ioctl„dwr_reg‡rgo kernel failed");

1335  -
EFAULT
;

1338 ià(
ioùl_d©a
.
Äegs
 > 
CTS_RDWR_REG_IOCTL_MAX_REGS
) {

1339 
	`ùs_”r
("ioctl„dwr_reg withoo many„egs %u",

1340 
ioùl_d©a
.
Äegs
);

1341  -
EINVAL
;

1344 
»gs_·
 = 
	`memdup_u£r
(
ioùl_d©a
.
»gs
,

1345 
ioùl_d©a
.
Äegs
 * (
ùs_rdwr_»g
));

1346 ià(
	`IS_ERR
(
»gs_·
)) {

1347 
»t
 = 
	`PTR_ERR
(
»gs_·
);

1348 
	`ùs_”r
("Memdum°ùs_rdwr_»gØk”ÃÈçed %d", 
»t
);

1349  
»t
;

1352  
	`ùs_ioùl_rdwr_»g
(
ùs_dev
,

1353 
ioùl_d©a
.
»g_ty³
, ioùl_d©a.
Äegs
, 
»gs_·
);

1355 
CTS_TOOL_IOCTL_UPGRADE_FW
:{

1356 
ùs_upg¿de_fw_ioùl_d©a
 
ioùl_d©a
;

1358 ià(
	`cİy_äom_u£r
(&
ioùl_d©a
,

1359 (
ùs_upg¿de_fw_ioùl_d©a
 
__u£r
 *)
¬g
,

1360 (
ioùl_d©a
))) {

1361 
	`ùs_”r
("Copy ioctl UPGRADE-FW‡rgo kernel failed");

1362  -
EFAULT
;

1365  
	`ùs_ioùl_upg¿de_fw
(
ùs_dev
, &
ioùl_d©a
);

1368 
	`ùs_”r
("UnsuµÜ‹d ioùÈcmd=0x%08x,‡rg=0x%08lx", 
cmd
, 
¬g
);

1372  -
ENOTSUPP
;

1373 
	}
}

1375 
fe_İ”©iÚs
 
	gùs_toŞ_fİs
 = {

1376 .
owÃr
 = 
THIS_MODULE
,

1377 .
	gÎ£ek
 = 
no_Î£ek
,

1378 .
	gİ’
 = 
ùs_toŞ_İ’
,

1379 .
	g»ad
 = 
ùs_toŞ_»ad
,

1380 .
	gwr™e
 = 
ùs_toŞ_wr™e
,

1381 .
	guÆocked_ioùl
 = 
ùs_toŞ_ioùl
,

1384 
	$ùs_toŞ_š™
(
chÚe_ts_d©a
 *
ùs_d©a
)

1386 
	`ùs_šfo
("Init");

1388 
ùs_d©a
->
´ocfs_’Œy
 = 
	`´oc_ü—‹_d©a
(
CFG_CTS_TOOL_PROC_FILENAME
,

1389 0666, 
NULL
, &
ùs_toŞ_fİs
, 
ùs_d©a
);

1390 ià(
ùs_d©a
->
´ocfs_’Œy
 =ğ
NULL
) {

1391 
	`ùs_”r
("Create…rocƒntry failed");

1392  -
EFAULT
;

1396 
	}
}

1398 
	$ùs_toŞ_deš™
(
chÚe_ts_d©a
 *
d©a
)

1400 
	`ùs_šfo
("Deinit");

1402 ià(
d©a
->
´ocfs_’Œy
) {

1403 
	`»move_´oc_’Œy
(
CFG_CTS_TOOL_PROC_FILENAME
, 
NULL
);

1405 
	}
}

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/fb.h

2 #iâdeà
_LINUX_FB_H


3 
	#_LINUX_FB_H


	)

5 
	~<lšux/ty³s.h
>

6 
	~<lšux/i2c.h
>

10 
	#FB_MAX
 32

	)

14 
	#FBIOGET_VSCREENINFO
 0x4600

	)

15 
	#FBIOPUT_VSCREENINFO
 0x4601

	)

16 
	#FBIOGET_FSCREENINFO
 0x4602

	)

17 
	#FBIOGETCMAP
 0x4604

	)

18 
	#FBIOPUTCMAP
 0x4605

	)

19 
	#FBIOPAN_DISPLAY
 0x4606

	)

20 
	#FBIO_CURSOR
 
	`_IOWR
('F', 0x08, 
fb_cursÜ
)

	)

25 
	#FBIOGET_CON2FBMAP
 0x460F

	)

26 
	#FBIOPUT_CON2FBMAP
 0x4610

	)

27 
	#FBIOBLANK
 0x4611

	)

28 
	#FBIOGET_VBLANK
 
	`_IOR
('F', 0x12, 
fb_vbÏnk
)

	)

29 
	#FBIO_ALLOC
 0x4613

	)

30 
	#FBIO_FREE
 0x4614

	)

31 
	#FBIOGET_GLYPH
 0x4615

	)

32 
	#FBIOGET_HWCINFO
 0x4616

	)

33 
	#FBIOPUT_MODEINFO
 0x4617

	)

34 
	#FBIOGET_DISPINFO
 0x4618

	)

35 
	#FBIO_WAITFORVSYNC
 
	`_IOW
('F', 0x20, 
__u32
)

	)

37 
	#FB_TYPE_PACKED_PIXELS
 0

	)

38 
	#FB_TYPE_PLANES
 1

	)

39 
	#FB_TYPE_INTERLEAVED_PLANES
 2

	)

40 
	#FB_TYPE_TEXT
 3

	)

41 
	#FB_TYPE_VGA_PLANES
 4

	)

42 
	#FB_TYPE_FOURCC
 5

	)

44 
	#FB_AUX_TEXT_MDA
 0

	)

45 
	#FB_AUX_TEXT_CGA
 1

	)

46 
	#FB_AUX_TEXT_S3_MMIO
 2

	)

47 
	#FB_AUX_TEXT_MGA_STEP16
 3

	)

48 
	#FB_AUX_TEXT_MGA_STEP8
 4

	)

49 
	#FB_AUX_TEXT_SVGA_GROUP
 8

	)

50 
	#FB_AUX_TEXT_SVGA_MASK
 7

	)

51 
	#FB_AUX_TEXT_SVGA_STEP2
 8

	)

52 
	#FB_AUX_TEXT_SVGA_STEP4
 9

	)

53 
	#FB_AUX_TEXT_SVGA_STEP8
 10

	)

54 
	#FB_AUX_TEXT_SVGA_STEP16
 11

	)

55 
	#FB_AUX_TEXT_SVGA_LAST
 15

	)

57 
	#FB_AUX_VGA_PLANES_VGA4
 0

	)

58 
	#FB_AUX_VGA_PLANES_CFB4
 1

	)

59 
	#FB_AUX_VGA_PLANES_CFB8
 2

	)

61 
	#FB_VISUAL_MONO01
 0

	)

62 
	#FB_VISUAL_MONO10
 1

	)

63 
	#FB_VISUAL_TRUECOLOR
 2

	)

64 
	#FB_VISUAL_PSEUDOCOLOR
 3

	)

65 
	#FB_VISUAL_DIRECTCOLOR
 4

	)

66 
	#FB_VISUAL_STATIC_PSEUDOCOLOR
 5

	)

67 
	#FB_VISUAL_FOURCC
 6

	)

69 
	#FB_ACCEL_NONE
 0

	)

70 
	#FB_ACCEL_ATARIBLITT
 1

	)

71 
	#FB_ACCEL_AMIGABLITT
 2

	)

72 
	#FB_ACCEL_S3_TRIO64
 3

	)

73 
	#FB_ACCEL_NCR_77C32BLT
 4

	)

74 
	#FB_ACCEL_S3_VIRGE
 5

	)

75 
	#FB_ACCEL_ATI_MACH64GX
 6

	)

76 
	#FB_ACCEL_DEC_TGA
 7

	)

77 
	#FB_ACCEL_ATI_MACH64CT
 8

	)

78 
	#FB_ACCEL_ATI_MACH64VT
 9

	)

79 
	#FB_ACCEL_ATI_MACH64GT
 10

	)

80 
	#FB_ACCEL_SUN_CREATOR
 11

	)

81 
	#FB_ACCEL_SUN_CGSIX
 12

	)

82 
	#FB_ACCEL_SUN_LEO
 13

	)

83 
	#FB_ACCEL_IMS_TWINTURBO
 14

	)

84 
	#FB_ACCEL_3DLABS_PERMEDIA2
 15

	)

85 
	#FB_ACCEL_MATROX_MGA2064W
 16

	)

86 
	#FB_ACCEL_MATROX_MGA1064SG
 17

	)

87 
	#FB_ACCEL_MATROX_MGA2164W
 18

	)

88 
	#FB_ACCEL_MATROX_MGA2164W_AGP
 19

	)

89 
	#FB_ACCEL_MATROX_MGAG100
 20

	)

90 
	#FB_ACCEL_MATROX_MGAG200
 21

	)

91 
	#FB_ACCEL_SUN_CG14
 22

	)

92 
	#FB_ACCEL_SUN_BWTWO
 23

	)

93 
	#FB_ACCEL_SUN_CGTHREE
 24

	)

94 
	#FB_ACCEL_SUN_TCX
 25

	)

95 
	#FB_ACCEL_MATROX_MGAG400
 26

	)

96 
	#FB_ACCEL_NV3
 27

	)

97 
	#FB_ACCEL_NV4
 28

	)

98 
	#FB_ACCEL_NV5
 29

	)

99 
	#FB_ACCEL_CT_6555x
 30

	)

100 
	#FB_ACCEL_3DFX_BANSHEE
 31

	)

101 
	#FB_ACCEL_ATI_RAGE128
 32

	)

102 
	#FB_ACCEL_IGS_CYBER2000
 33

	)

103 
	#FB_ACCEL_IGS_CYBER2010
 34

	)

104 
	#FB_ACCEL_IGS_CYBER5000
 35

	)

105 
	#FB_ACCEL_SIS_GLAMOUR
 36

	)

106 
	#FB_ACCEL_3DLABS_PERMEDIA3
 37

	)

107 
	#FB_ACCEL_ATI_RADEON
 38

	)

108 
	#FB_ACCEL_I810
 39

	)

109 
	#FB_ACCEL_SIS_GLAMOUR_2
 40

	)

110 
	#FB_ACCEL_SIS_XABRE
 41

	)

111 
	#FB_ACCEL_I830
 42

	)

112 
	#FB_ACCEL_NV_10
 43

	)

113 
	#FB_ACCEL_NV_20
 44

	)

114 
	#FB_ACCEL_NV_30
 45

	)

115 
	#FB_ACCEL_NV_40
 46

	)

116 
	#FB_ACCEL_XGI_VOLARI_V
 47

	)

117 
	#FB_ACCEL_XGI_VOLARI_Z
 48

	)

118 
	#FB_ACCEL_OMAP1610
 49

	)

119 
	#FB_ACCEL_TRIDENT_TGUI
 50

	)

120 
	#FB_ACCEL_TRIDENT_3DIMAGE
 51

	)

121 
	#FB_ACCEL_TRIDENT_BLADE3D
 52

	)

122 
	#FB_ACCEL_TRIDENT_BLADEXP
 53

	)

123 
	#FB_ACCEL_CIRRUS_ALPINE
 53

	)

124 
	#FB_ACCEL_NEOMAGIC_NM2070
 90

	)

125 
	#FB_ACCEL_NEOMAGIC_NM2090
 91

	)

126 
	#FB_ACCEL_NEOMAGIC_NM2093
 92

	)

127 
	#FB_ACCEL_NEOMAGIC_NM2097
 93

	)

128 
	#FB_ACCEL_NEOMAGIC_NM2160
 94

	)

129 
	#FB_ACCEL_NEOMAGIC_NM2200
 95

	)

130 
	#FB_ACCEL_NEOMAGIC_NM2230
 96

	)

131 
	#FB_ACCEL_NEOMAGIC_NM2360
 97

	)

132 
	#FB_ACCEL_NEOMAGIC_NM2380
 98

	)

133 
	#FB_ACCEL_PXA3XX
 99

	)

135 
	#FB_ACCEL_SAVAGE4
 0x80

	)

136 
	#FB_ACCEL_SAVAGE3D
 0x81

	)

137 
	#FB_ACCEL_SAVAGE3D_MV
 0x82

	)

138 
	#FB_ACCEL_SAVAGE2000
 0x83

	)

139 
	#FB_ACCEL_SAVAGE_MX_MV
 0x84

	)

140 
	#FB_ACCEL_SAVAGE_MX
 0x85

	)

141 
	#FB_ACCEL_SAVAGE_IX_MV
 0x86

	)

142 
	#FB_ACCEL_SAVAGE_IX
 0x87

	)

143 
	#FB_ACCEL_PROSAVAGE_PM
 0x88

	)

144 
	#FB_ACCEL_PROSAVAGE_KM
 0x89

	)

145 
	#FB_ACCEL_S3TWISTER_P
 0x8¨

	)

146 
	#FB_ACCEL_S3TWISTER_K
 0x8b

	)

147 
	#FB_ACCEL_SUPERSAVAGE
 0x8ø

	)

148 
	#FB_ACCEL_PROSAVAGE_DDR
 0x8d

	)

149 
	#FB_ACCEL_PROSAVAGE_DDRK
 0x8

	)

151 
	#FB_ACCEL_PUV3_UNIGFX
 0xa0

	)

153 
	#FB_CAP_FOURCC
 1

	)

155 
	sfb_fix_sü“nšfo
 {

156 
	mid
[16];

157 
	msmem_¡¬t
;

159 
__u32
 
	msmem_Ën
;

160 
__u32
 
	mty³
;

161 
__u32
 
	mty³_aux
;

162 
__u32
 
	mvisu®
;

163 
__u16
 
	mx·n¡•
;

164 
__u16
 
	my·n¡•
;

165 
__u16
 
	myw¿p¡•
;

166 
__u32
 
	mlše_Ëngth
;

167 
	mmmio_¡¬t
;

169 
__u32
 
	mmmio_Ën
;

170 
__u32
 
	macûl
;

172 
__u16
 
	mÿ·b™›s
;

173 
__u16
 
	m»£rved
[2];

186 
	sfb_b™f›ld
 {

187 
__u32
 
	moff£t
;

188 
__u32
 
	mËngth
;

189 
__u32
 
	mmsb_right
;

193 
	#FB_NONSTD_HAM
 1

	)

194 
	#FB_NONSTD_REV_PIX_IN_B
 2

	)

196 
	#FB_ACTIVATE_NOW
 0

	)

197 
	#FB_ACTIVATE_NXTOPEN
 1

	)

198 
	#FB_ACTIVATE_TEST
 2

	)

199 
	#FB_ACTIVATE_MASK
 15

	)

201 
	#FB_ACTIVATE_VBL
 16

	)

202 
	#FB_CHANGE_CMAP_VBL
 32

	)

203 
	#FB_ACTIVATE_ALL
 64

	)

204 
	#FB_ACTIVATE_FORCE
 128

	)

205 
	#FB_ACTIVATE_INV_MODE
 256

	)

207 
	#FB_ACCELF_TEXT
 1

	)

209 
	#FB_SYNC_HOR_HIGH_ACT
 1

	)

210 
	#FB_SYNC_VERT_HIGH_ACT
 2

	)

211 
	#FB_SYNC_EXT
 4

	)

212 
	#FB_SYNC_COMP_HIGH_ACT
 8

	)

213 
	#FB_SYNC_BROADCAST
 16

	)

216 
	#FB_SYNC_ON_GREEN
 32

	)

218 
	#FB_VMODE_NONINTERLACED
 0

	)

219 
	#FB_VMODE_INTERLACED
 1

	)

220 
	#FB_VMODE_DOUBLE
 2

	)

221 
	#FB_VMODE_ODD_FLD_FIRST
 4

	)

222 
	#FB_VMODE_MASK
 255

	)

224 
	#FB_VMODE_YWRAP
 256

	)

225 
	#FB_VMODE_SMOOTH_XPAN
 512

	)

226 
	#FB_VMODE_CONUPDATE
 512

	)

231 
	#FB_ROTATE_UR
 0

	)

232 
	#FB_ROTATE_CW
 1

	)

233 
	#FB_ROTATE_UD
 2

	)

234 
	#FB_ROTATE_CCW
 3

	)

236 
	#PICOS2KHZ
(
a
è(1000000000UL/×))

	)

237 
	#KHZ2PICOS
(
a
è(1000000000UL/×))

	)

239 
	sfb_v¬_sü“nšfo
 {

240 
__u32
 
	mx»s
;

241 
__u32
 
	my»s
;

242 
__u32
 
	mx»s_vœtu®
;

243 
__u32
 
	my»s_vœtu®
;

244 
__u32
 
	mxoff£t
;

245 
__u32
 
	myoff£t
;

247 
__u32
 
	mb™s_³r_pix–
;

248 
__u32
 
	mg¿ysÿË
;

250 
fb_b™f›ld
 
	m»d
;

251 
fb_b™f›ld
 
	mg»’
;

252 
fb_b™f›ld
 
	mblue
;

253 
fb_b™f›ld
 
	mŒª¥
;

255 
__u32
 
	mnÚ¡d
;

257 
__u32
 
	maùiv©e
;

259 
__u32
 
	mheight
;

260 
__u32
 
	mwidth
;

262 
__u32
 
	macûl_æags
;

265 
__u32
 
	mpixşock
;

266 
__u32
 
	mËá_m¬gš
;

267 
__u32
 
	mright_m¬gš
;

268 
__u32
 
	muµ”_m¬gš
;

269 
__u32
 
	mlow”_m¬gš
;

270 
__u32
 
	mhsync_Ën
;

271 
__u32
 
	mvsync_Ën
;

272 
__u32
 
	msync
;

273 
__u32
 
	mvmode
;

274 
__u32
 
	mrÙ©e
;

275 
__u32
 
	mcŞÜ¥aû
;

276 
__u32
 
	m»£rved
[4];

279 
	sfb_cm­
 {

280 
__u32
 
	m¡¬t
;

281 
__u32
 
	mËn
;

282 
__u16
 *
	m»d
;

283 
__u16
 *
	mg»’
;

284 
__u16
 *
	mblue
;

285 
__u16
 *
	mŒª¥
;

288 
	sfb_cÚ2fbm­
 {

289 
__u32
 
	mcÚsŞe
;

290 
__u32
 
	mäamebufãr
;

294 
	#VESA_NO_BLANKING
 0

	)

295 
	#VESA_VSYNC_SUSPEND
 1

	)

296 
	#VESA_HSYNC_SUSPEND
 2

	)

297 
	#VESA_POWERDOWN
 3

	)

302 
	mFB_BLANK_UNBLANK
 = 
VESA_NO_BLANKING
,

305 
	mFB_BLANK_NORMAL
 = 
VESA_NO_BLANKING
 + 1,

308 
	mFB_BLANK_VSYNC_SUSPEND
 = 
VESA_VSYNC_SUSPEND
 + 1,

311 
	mFB_BLANK_HSYNC_SUSPEND
 = 
VESA_HSYNC_SUSPEND
 + 1,

314 
	mFB_BLANK_POWERDOWN
 = 
VESA_POWERDOWN
 + 1

317 
	#FB_VBLANK_VBLANKING
 0x001

	)

318 
	#FB_VBLANK_HBLANKING
 0x002

	)

319 
	#FB_VBLANK_HAVE_VBLANK
 0x004

	)

320 
	#FB_VBLANK_HAVE_HBLANK
 0x008

	)

321 
	#FB_VBLANK_HAVE_COUNT
 0x010

	)

322 
	#FB_VBLANK_HAVE_VCOUNT
 0x020

	)

323 
	#FB_VBLANK_HAVE_HCOUNT
 0x040

	)

324 
	#FB_VBLANK_VSYNCING
 0x080

	)

325 
	#FB_VBLANK_HAVE_VSYNC
 0x100

	)

327 
	sfb_vbÏnk
 {

328 
__u32
 
	mæags
;

329 
__u32
 
	mcouÁ
;

330 
__u32
 
	mvcouÁ
;

331 
__u32
 
	mhcouÁ
;

332 
__u32
 
	m»£rved
[4];

336 
	#ROP_COPY
 0

	)

337 
	#ROP_XOR
 1

	)

339 
	sfb_cİy¬—
 {

340 
__u32
 
	mdx
;

341 
__u32
 
	mdy
;

342 
__u32
 
	mwidth
;

343 
__u32
 
	mheight
;

344 
__u32
 
	msx
;

345 
__u32
 
	msy
;

348 
	sfb_fÌeù
 {

349 
__u32
 
	mdx
;

350 
__u32
 
	mdy
;

351 
__u32
 
	mwidth
;

352 
__u32
 
	mheight
;

353 
__u32
 
	mcŞÜ
;

354 
__u32
 
	mrİ
;

357 
	sfb_image
 {

358 
__u32
 
	mdx
;

359 
__u32
 
	mdy
;

360 
__u32
 
	mwidth
;

361 
__u32
 
	mheight
;

362 
__u32
 
	mfg_cŞÜ
;

363 
__u32
 
	mbg_cŞÜ
;

364 
__u8
 
	md•th
;

365 cÚ¡ *
	md©a
;

366 
fb_cm­
 
	mcm­
;

373 
	#FB_CUR_SETIMAGE
 0x01

	)

374 
	#FB_CUR_SETPOS
 0x02

	)

375 
	#FB_CUR_SETHOT
 0x04

	)

376 
	#FB_CUR_SETCMAP
 0x08

	)

377 
	#FB_CUR_SETSHAPE
 0x10

	)

378 
	#FB_CUR_SETSIZE
 0x20

	)

379 
	#FB_CUR_SETALL
 0xFF

	)

381 
	sfbcu½os
 {

382 
__u16
 
	mx
, 
	my
;

385 
	sfb_cursÜ
 {

386 
__u16
 
	m£t
;

387 
__u16
 
	m’abË
;

388 
__u16
 
	mrİ
;

389 cÚ¡ *
	mmask
;

390 
fbcu½os
 
	mhÙ
;

391 
fb_image
 
	mimage
;

395 
	#FB_BACKLIGHT_LEVELS
 128

	)

396 
	#FB_BACKLIGHT_MAX
 0xFF

	)

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

16 
	~<lšux/fsüy±.h
>

19 
	~<lšux/mouÁ.h
>

32 #undeà
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0è

	)

47 
	#RENAME_EXCHANGE
 (1 << 1è

	)

48 
	#RENAME_WHITEOUT
 (1 << 2è

	)

50 
	sfe_şÚe_¿nge
 {

51 
__s64
 
	m¤c_fd
;

52 
__u64
 
	m¤c_off£t
;

53 
__u64
 
	m¤c_Ëngth
;

54 
__u64
 
	mde¡_off£t
;

57 
	sf¡rim_¿nge
 {

58 
__u64
 
	m¡¬t
;

59 
__u64
 
	mËn
;

60 
__u64
 
	mmšËn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfe_dedu³_¿nge_šfo
 {

69 
__s64
 
	mde¡_fd
;

70 
__u64
 
	mde¡_off£t
;

71 
__u64
 
	mby‹s_dedu³d
;

78 
__s32
 
	m¡©us
;

79 
__u32
 
	m»£rved
;

83 
	sfe_dedu³_¿nge
 {

84 
__u64
 
	m¤c_off£t
;

85 
__u64
 
	m¤c_Ëngth
;

86 
__u16
 
	mde¡_couÁ
;

87 
__u16
 
	m»£rved1
;

88 
__u32
 
	m»£rved2
;

89 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

93 
	sfes_¡©_¡ruù
 {

94 
	mÄ_fes
;

95 
	mÄ_ä“_fes
;

96 
	mmax_fes
;

99 
	sšodes_¡©_t
 {

100 
	mÄ_šodes
;

101 
	mÄ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©Œ
 {

112 
__u32
 
	mfsx_xæags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_Ãx‹Ás
;

115 
__u32
 
	mfsx_´ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_·d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

188 
	#BMAP_IOCTL
 1

	)

189 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

190 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

191 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

192 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

193 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

194 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

195 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

196 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

198 
	#FSLABEL_MAX
 256

	)

200 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

201 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

202 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

203 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

204 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

205 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

206 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

207 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

208 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

209 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©Œ
)

	)

210 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©Œ
)

	)

211 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

212 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

234 
	#FS_SECRM_FL
 0x00000001

	)

235 
	#FS_UNRM_FL
 0x00000002

	)

236 
	#FS_COMPR_FL
 0x00000004

	)

237 
	#FS_SYNC_FL
 0x00000008

	)

238 
	#FS_IMMUTABLE_FL
 0x00000010

	)

239 
	#FS_APPEND_FL
 0x00000020

	)

240 
	#FS_NODUMP_FL
 0x00000040

	)

241 
	#FS_NOATIME_FL
 0x00000080

	)

243 
	#FS_DIRTY_FL
 0x00000100

	)

244 
	#FS_COMPRBLK_FL
 0x00000200

	)

245 
	#FS_NOCOMP_FL
 0x00000400

	)

247 
	#FS_ENCRYPT_FL
 0x00000800

	)

248 
	#FS_BTREE_FL
 0x00001000

	)

249 
	#FS_INDEX_FL
 0x00001000

	)

250 
	#FS_IMAGIC_FL
 0x00002000

	)

251 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

252 
	#FS_NOTAIL_FL
 0x00008000

	)

253 
	#FS_DIRSYNC_FL
 0x00010000

	)

254 
	#FS_TOPDIR_FL
 0x00020000

	)

255 
	#FS_HUGE_FILE_FL
 0x00040000

	)

256 
	#FS_EXTENT_FL
 0x00080000

	)

257 
	#FS_VERITY_FL
 0x00100000

	)

258 
	#FS_EA_INODE_FL
 0x00200000

	)

259 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

260 
	#FS_NOCOW_FL
 0x00800000

	)

261 
	#FS_INLINE_DATA_FL
 0x10000000

	)

262 
	#FS_PROJINHERIT_FL
 0x20000000

	)

263 
	#FS_CASEFOLD_FL
 0x40000000

	)

264 
	#FS_RESERVED_FL
 0x80000000

	)

266 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

267 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

270 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

271 
	#SYNC_FILE_RANGE_WRITE
 2

	)

272 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

273 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

274 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

275 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

281 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

284 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

287 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

290 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

293 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

296 
	#RWF_APPEND
 ((
__k”Ãl_rwf_t
)0x00000010)

	)

299 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

300 
RWF_APPEND
)

	)

	@/usr/include/linux/gpio.h

11 #iâdeà
_GPIO_H_


12 
	#_GPIO_H_


	)

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

24 
	sgpioch_šfo
 {

25 
	mÇme
[32];

26 
	mÏb–
[32];

27 
__u32
 
	mlšes
;

31 
	#GPIOLINE_FLAG_KERNEL
 (1UL << 0è

	)

32 
	#GPIOLINE_FLAG_IS_OUT
 (1UL << 1)

	)

33 
	#GPIOLINE_FLAG_ACTIVE_LOW
 (1UL << 2)

	)

34 
	#GPIOLINE_FLAG_OPEN_DRAIN
 (1UL << 3)

	)

35 
	#GPIOLINE_FLAG_OPEN_SOURCE
 (1UL << 4)

	)

49 
	sgpiŞše_šfo
 {

50 
__u32
 
	mlše_off£t
;

51 
__u32
 
	mæags
;

52 
	mÇme
[32];

53 
	mcÚsum”
[32];

57 
	#GPIOHANDLES_MAX
 64

	)

60 
	#GPIOHANDLE_REQUEST_INPUT
 (1UL << 0)

	)

61 
	#GPIOHANDLE_REQUEST_OUTPUT
 (1UL << 1)

	)

62 
	#GPIOHANDLE_REQUEST_ACTIVE_LOW
 (1UL << 2)

	)

63 
	#GPIOHANDLE_REQUEST_OPEN_DRAIN
 (1UL << 3)

	)

64 
	#GPIOHANDLE_REQUEST_OPEN_SOURCE
 (1UL << 4)

	)

88 
	sgpiohªdË_»que¡
 {

89 
__u32
 
	mlšeoff£ts
[
GPIOHANDLES_MAX
];

90 
__u32
 
	mæags
;

91 
__u8
 
	mdeçuÉ_v®ues
[
GPIOHANDLES_MAX
];

92 
	mcÚsum”_Ïb–
[32];

93 
__u32
 
	mlšes
;

94 
	mfd
;

103 
	sgpiohªdË_d©a
 {

104 
__u8
 
	mv®ues
[
GPIOHANDLES_MAX
];

107 
	#GPIOHANDLE_GET_LINE_VALUES_IOCTL
 
	`_IOWR
(0xB4, 0x08, 
gpiohªdË_d©a
)

	)

108 
	#GPIOHANDLE_SET_LINE_VALUES_IOCTL
 
	`_IOWR
(0xB4, 0x09, 
gpiohªdË_d©a
)

	)

111 
	#GPIOEVENT_REQUEST_RISING_EDGE
 (1UL << 0)

	)

112 
	#GPIOEVENT_REQUEST_FALLING_EDGE
 (1UL << 1)

	)

113 
	#GPIOEVENT_REQUEST_BOTH_EDGES
 ((1UL << 0è| (1UL << 1))

	)

129 
	sgpiÛv’t_»que¡
 {

130 
__u32
 
	mlšeoff£t
;

131 
__u32
 
	mhªdËæags
;

132 
__u32
 
	mev’tæags
;

133 
	mcÚsum”_Ïb–
[32];

134 
	mfd
;

140 
	#GPIOEVENT_EVENT_RISING_EDGE
 0x01

	)

141 
	#GPIOEVENT_EVENT_FALLING_EDGE
 0x02

	)

148 
	sgpiÛv’t_d©a
 {

149 
__u64
 
	mtime¡amp
;

150 
__u32
 
	mid
;

153 
	#GPIO_GET_CHIPINFO_IOCTL
 
	`_IOR
(0xB4, 0x01, 
gpioch_šfo
)

	)

154 
	#GPIO_GET_LINEINFO_IOCTL
 
	`_IOWR
(0xB4, 0x02, 
gpiŞše_šfo
)

	)

155 
	#GPIO_GET_LINEHANDLE_IOCTL
 
	`_IOWR
(0xB4, 0x03, 
gpiohªdË_»que¡
)

	)

156 
	#GPIO_GET_LINEEVENT_IOCTL
 
	`_IOWR
(0xB4, 0x04, 
gpiÛv’t_»que¡
)

	)

	@/usr/include/linux/i2c.h

28 #iâdeà
_LINUX_I2C_H


29 
	#_LINUX_I2C_H


	)

31 
	~<lšux/ty³s.h
>

69 
	si2c_msg
 {

70 
__u16
 
	maddr
;

71 
__u16
 
	mæags
;

72 
	#I2C_M_RD
 0x0001

	)

74 
	#I2C_M_TEN
 0x0010

	)

75 
	#I2C_M_DMA_SAFE
 0x0200

	)

78 
	#I2C_M_RECV_LEN
 0x0400

	)

79 
	#I2C_M_NO_RD_ACK
 0x0800

	)

80 
	#I2C_M_IGNORE_NAK
 0x1000

	)

81 
	#I2C_M_REV_DIR_ADDR
 0x2000

	)

82 
	#I2C_M_NOSTART
 0x4000

	)

83 
	#I2C_M_STOP
 0x8000

	)

84 
__u16
 
	mËn
;

85 
__u8
 *
	mbuf
;

90 
	#I2C_FUNC_I2C
 0x00000001

	)

91 
	#I2C_FUNC_10BIT_ADDR
 0x00000002

	)

92 
	#I2C_FUNC_PROTOCOL_MANGLING
 0x00000004

	)

93 
	#I2C_FUNC_SMBUS_PEC
 0x00000008

	)

94 
	#I2C_FUNC_NOSTART
 0x00000010

	)

95 
	#I2C_FUNC_SLAVE
 0x00000020

	)

96 
	#I2C_FUNC_SMBUS_BLOCK_PROC_CALL
 0x00008000

	)

97 
	#I2C_FUNC_SMBUS_QUICK
 0x00010000

	)

98 
	#I2C_FUNC_SMBUS_READ_BYTE
 0x00020000

	)

99 
	#I2C_FUNC_SMBUS_WRITE_BYTE
 0x00040000

	)

100 
	#I2C_FUNC_SMBUS_READ_BYTE_DATA
 0x00080000

	)

101 
	#I2C_FUNC_SMBUS_WRITE_BYTE_DATA
 0x00100000

	)

102 
	#I2C_FUNC_SMBUS_READ_WORD_DATA
 0x00200000

	)

103 
	#I2C_FUNC_SMBUS_WRITE_WORD_DATA
 0x00400000

	)

104 
	#I2C_FUNC_SMBUS_PROC_CALL
 0x00800000

	)

105 
	#I2C_FUNC_SMBUS_READ_BLOCK_DATA
 0x01000000

	)

106 
	#I2C_FUNC_SMBUS_WRITE_BLOCK_DATA
 0x02000000

	)

107 
	#I2C_FUNC_SMBUS_READ_I2C_BLOCK
 0x04000000

	)

108 
	#I2C_FUNC_SMBUS_WRITE_I2C_BLOCK
 0x08000000

	)

109 
	#I2C_FUNC_SMBUS_HOST_NOTIFY
 0x10000000

	)

111 
	#I2C_FUNC_SMBUS_BYTE
 (
I2C_FUNC_SMBUS_READ_BYTE
 | \

112 
I2C_FUNC_SMBUS_WRITE_BYTE
)

	)

113 
	#I2C_FUNC_SMBUS_BYTE_DATA
 (
I2C_FUNC_SMBUS_READ_BYTE_DATA
 | \

114 
I2C_FUNC_SMBUS_WRITE_BYTE_DATA
)

	)

115 
	#I2C_FUNC_SMBUS_WORD_DATA
 (
I2C_FUNC_SMBUS_READ_WORD_DATA
 | \

116 
I2C_FUNC_SMBUS_WRITE_WORD_DATA
)

	)

117 
	#I2C_FUNC_SMBUS_BLOCK_DATA
 (
I2C_FUNC_SMBUS_READ_BLOCK_DATA
 | \

118 
I2C_FUNC_SMBUS_WRITE_BLOCK_DATA
)

	)

119 
	#I2C_FUNC_SMBUS_I2C_BLOCK
 (
I2C_FUNC_SMBUS_READ_I2C_BLOCK
 | \

120 
I2C_FUNC_SMBUS_WRITE_I2C_BLOCK
)

	)

122 
	#I2C_FUNC_SMBUS_EMUL
 (
I2C_FUNC_SMBUS_QUICK
 | \

123 
I2C_FUNC_SMBUS_BYTE
 | \

124 
I2C_FUNC_SMBUS_BYTE_DATA
 | \

125 
I2C_FUNC_SMBUS_WORD_DATA
 | \

126 
I2C_FUNC_SMBUS_PROC_CALL
 | \

127 
I2C_FUNC_SMBUS_WRITE_BLOCK_DATA
 | \

128 
I2C_FUNC_SMBUS_I2C_BLOCK
 | \

129 
I2C_FUNC_SMBUS_PEC
)

	)

134 
	#I2C_SMBUS_BLOCK_MAX
 32

	)

135 
	ui2c_smbus_d©a
 {

136 
__u8
 
	mby‹
;

137 
__u16
 
	mwÜd
;

138 
__u8
 
	mblock
[
I2C_SMBUS_BLOCK_MAX
 + 2];

143 
	#I2C_SMBUS_READ
 1

	)

144 
	#I2C_SMBUS_WRITE
 0

	)

148 
	#I2C_SMBUS_QUICK
 0

	)

149 
	#I2C_SMBUS_BYTE
 1

	)

150 
	#I2C_SMBUS_BYTE_DATA
 2

	)

151 
	#I2C_SMBUS_WORD_DATA
 3

	)

152 
	#I2C_SMBUS_PROC_CALL
 4

	)

153 
	#I2C_SMBUS_BLOCK_DATA
 5

	)

154 
	#I2C_SMBUS_I2C_BLOCK_BROKEN
 6

	)

155 
	#I2C_SMBUS_BLOCK_PROC_CALL
 7

	)

156 
	#I2C_SMBUS_I2C_BLOCK_DATA
 8

	)

	@/usr/include/linux/input.h

9 #iâdeà
_INPUT_H


10 
	#_INPUT_H


	)

13 
	~<sys/time.h
>

14 
	~<sys/ioùl.h
>

15 
	~<sys/ty³s.h
>

16 
	~<lšux/ty³s.h
>

18 
	~"šput-ev’t-codes.h
"

26 
	sšput_ev’t
 {

27 #ià(
__BITS_PER_LONG
 !ğ32 || !
defšed
(
__USE_TIME_BITS64
)è&& !defšed(
__KERNEL__
)

28 
timev®
 
	mtime
;

29 
	#šput_ev’t_£c
 
time
.
tv_£c


	)

30 
	#šput_ev’t_u£c
 
time
.
tv_u£c


	)

32 
__k”Ãl_ulÚg_t
 
	m__£c
;

33 #ià
defšed
(
__¥¬c__
è&& defšed(
__¬ch64__
)

34 
	m__u£c
;

35 
	m__·d
;

37 
__k”Ãl_ulÚg_t
 
	m__u£c
;

39 
	#šput_ev’t_£c
 
__£c


	)

40 
	#šput_ev’t_u£c
 
__u£c


	)

42 
__u16
 
	mty³
;

43 
__u16
 
	mcode
;

44 
__s32
 
	mv®ue
;

51 
	#EV_VERSION
 0x010001

	)

57 
	sšput_id
 {

58 
__u16
 
	mbu¡y³
;

59 
__u16
 
	mv’dÜ
;

60 
__u16
 
	m´oduù
;

61 
__u16
 
	mv”siÚ
;

88 
	sšput_absšfo
 {

89 
__s32
 
	mv®ue
;

90 
__s32
 
	mmšimum
;

91 
__s32
 
	mmaximum
;

92 
__s32
 
	mfuzz
;

93 
__s32
 
	mæ©
;

94 
__s32
 
	m»sŞutiÚ
;

112 
	sšput_keym­_’Œy
 {

113 
	#INPUT_KEYMAP_BY_INDEX
 (1 << 0)

	)

114 
__u8
 
	mæags
;

115 
__u8
 
	mËn
;

116 
__u16
 
	mšdex
;

117 
__u32
 
	mkeycode
;

118 
__u8
 
	msÿncode
[32];

121 
	sšput_mask
 {

122 
__u32
 
	mty³
;

123 
__u32
 
	mcodes_size
;

124 
__u64
 
	mcodes_±r
;

127 
	#EVIOCGVERSION
 
	`_IOR
('E', 0x01, è

	)

128 
	#EVIOCGID
 
	`_IOR
('E', 0x02, 
šput_id
è

	)

129 
	#EVIOCGREP
 
	`_IOR
('E', 0x03, [2]è

	)

130 
	#EVIOCSREP
 
	`_IOW
('E', 0x03, [2]è

	)

132 
	#EVIOCGKEYCODE
 
	`_IOR
('E', 0x04, [2]è

	)

133 
	#EVIOCGKEYCODE_V2
 
	`_IOR
('E', 0x04, 
šput_keym­_’Œy
)

	)

134 
	#EVIOCSKEYCODE
 
	`_IOW
('E', 0x04, [2]è

	)

135 
	#EVIOCSKEYCODE_V2
 
	`_IOW
('E', 0x04, 
šput_keym­_’Œy
)

	)

137 
	#EVIOCGNAME
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x06,†’è

	)

138 
	#EVIOCGPHYS
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x07,†’è

	)

139 
	#EVIOCGUNIQ
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x08,†’è

	)

140 
	#EVIOCGPROP
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x09,†’è

	)

166 
	#EVIOCGMTSLOTS
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x0a,†’)

	)

168 
	#EVIOCGKEY
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x18,†’è

	)

169 
	#EVIOCGLED
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x19,†’è

	)

170 
	#EVIOCGSND
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x1a,†’è

	)

171 
	#EVIOCGSW
(
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x1b,†’è

	)

173 
	#EVIOCGBIT
(
ev
,
Ën
è
	`_IOC
(
_IOC_READ
, 'E', 0x20 + (ev),†’è

	)

174 
	#EVIOCGABS
(
abs
è
	`_IOR
('E', 0x40 + (abs), 
šput_absšfo
è

	)

175 
	#EVIOCSABS
(
abs
è
	`_IOW
('E', 0xc0 + (abs), 
šput_absšfo
è

	)

177 
	#EVIOCSFF
 
	`_IOW
('E', 0x80, 
ff_efãù
è

	)

178 
	#EVIOCRMFF
 
	`_IOW
('E', 0x81, è

	)

179 
	#EVIOCGEFFECTS
 
	`_IOR
('E', 0x84, è

	)

181 
	#EVIOCGRAB
 
	`_IOW
('E', 0x90, è

	)

182 
	#EVIOCREVOKE
 
	`_IOW
('E', 0x91, è

	)

213 
	#EVIOCGMASK
 
	`_IOR
('E', 0x92, 
šput_mask
è

	)

236 
	#EVIOCSMASK
 
	`_IOW
('E', 0x93, 
šput_mask
è

	)

238 
	#EVIOCSCLOCKID
 
	`_IOW
('E', 0xa0, è

	)

244 
	#ID_BUS
 0

	)

245 
	#ID_VENDOR
 1

	)

246 
	#ID_PRODUCT
 2

	)

247 
	#ID_VERSION
 3

	)

249 
	#BUS_PCI
 0x01

	)

250 
	#BUS_ISAPNP
 0x02

	)

251 
	#BUS_USB
 0x03

	)

252 
	#BUS_HIL
 0x04

	)

253 
	#BUS_BLUETOOTH
 0x05

	)

254 
	#BUS_VIRTUAL
 0x06

	)

256 
	#BUS_ISA
 0x10

	)

257 
	#BUS_I8042
 0x11

	)

258 
	#BUS_XTKBD
 0x12

	)

259 
	#BUS_RS232
 0x13

	)

260 
	#BUS_GAMEPORT
 0x14

	)

261 
	#BUS_PARPORT
 0x15

	)

262 
	#BUS_AMIGA
 0x16

	)

263 
	#BUS_ADB
 0x17

	)

264 
	#BUS_I2C
 0x18

	)

265 
	#BUS_HOST
 0x19

	)

266 
	#BUS_GSC
 0x1A

	)

267 
	#BUS_ATARI
 0x1B

	)

268 
	#BUS_SPI
 0x1C

	)

269 
	#BUS_RMI
 0x1D

	)

270 
	#BUS_CEC
 0x1E

	)

271 
	#BUS_INTEL_ISHTP
 0x1F

	)

276 
	#MT_TOOL_FINGER
 0x00

	)

277 
	#MT_TOOL_PEN
 0x01

	)

278 
	#MT_TOOL_PALM
 0x02

	)

279 
	#MT_TOOL_DIAL
 0x0a

	)

280 
	#MT_TOOL_MAX
 0x0f

	)

285 
	#FF_STATUS_STOPPED
 0x00

	)

286 
	#FF_STATUS_PLAYING
 0x01

	)

287 
	#FF_STATUS_MAX
 0x01

	)

304 
	sff_»¶ay
 {

305 
__u16
 
	mËngth
;

306 
__u16
 
	md–ay
;

314 
	sff_Œigg”
 {

315 
__u16
 
	mbu‰Ú
;

316 
__u16
 
	mš‹rv®
;

331 
	sff_’v–İe
 {

332 
__u16
 
	m©ck_Ëngth
;

333 
__u16
 
	m©ck_Ëv–
;

334 
__u16
 
	mçde_Ëngth
;

335 
__u16
 
	mçde_Ëv–
;

343 
	sff_cÚ¡ªt_efãù
 {

344 
__s16
 
	mËv–
;

345 
ff_’v–İe
 
	m’v–İe
;

354 
	sff_¿mp_efãù
 {

355 
__s16
 
	m¡¬t_Ëv–
;

356 
__s16
 
	m’d_Ëv–
;

357 
ff_’v–İe
 
	m’v–İe
;

370 
	sff_cÚd™iÚ_efãù
 {

371 
__u16
 
	mright_§tu¿tiÚ
;

372 
__u16
 
	mËá_§tu¿tiÚ
;

374 
__s16
 
	mright_cÛff
;

375 
__s16
 
	mËá_cÛff
;

377 
__u16
 
	md—dbªd
;

378 
__s16
 
	mûÁ”
;

399 
	sff_³riodic_efãù
 {

400 
__u16
 
	mwavefÜm
;

401 
__u16
 
	m³riod
;

402 
__s16
 
	mmagn™ude
;

403 
__s16
 
	moff£t
;

404 
__u16
 
	mpha£
;

406 
ff_’v–İe
 
	m’v–İe
;

408 
__u32
 
	mcu¡om_Ën
;

409 
__s16
 *
	mcu¡om_d©a
;

420 
	sff_rumbË_efãù
 {

421 
__u16
 
	m¡rÚg_magn™ude
;

422 
__u16
 
	mw—k_magn™ude
;

448 
	sff_efãù
 {

449 
__u16
 
	mty³
;

450 
__s16
 
	mid
;

451 
__u16
 
	mdœeùiÚ
;

452 
ff_Œigg”
 
	mŒigg”
;

453 
ff_»¶ay
 
	m»¶ay
;

456 
ff_cÚ¡ªt_efãù
 
	mcÚ¡ªt
;

457 
ff_¿mp_efãù
 
	m¿mp
;

458 
ff_³riodic_efãù
 
	m³riodic
;

459 
ff_cÚd™iÚ_efãù
 
	mcÚd™iÚ
[2];

460 
ff_rumbË_efãù
 
	mrumbË
;

461 } 
	mu
;

468 
	#FF_RUMBLE
 0x50

	)

469 
	#FF_PERIODIC
 0x51

	)

470 
	#FF_CONSTANT
 0x52

	)

471 
	#FF_SPRING
 0x53

	)

472 
	#FF_FRICTION
 0x54

	)

473 
	#FF_DAMPER
 0x55

	)

474 
	#FF_INERTIA
 0x56

	)

475 
	#FF_RAMP
 0x57

	)

477 
	#FF_EFFECT_MIN
 
FF_RUMBLE


	)

478 
	#FF_EFFECT_MAX
 
FF_RAMP


	)

484 
	#FF_SQUARE
 0x58

	)

485 
	#FF_TRIANGLE
 0x59

	)

486 
	#FF_SINE
 0x5a

	)

487 
	#FF_SAW_UP
 0x5b

	)

488 
	#FF_SAW_DOWN
 0x5c

	)

489 
	#FF_CUSTOM
 0x5d

	)

491 
	#FF_WAVEFORM_MIN
 
FF_SQUARE


	)

492 
	#FF_WAVEFORM_MAX
 
FF_CUSTOM


	)

498 
	#FF_GAIN
 0x60

	)

499 
	#FF_AUTOCENTER
 0x61

	)

507 
	#FF_MAX_EFFECTS
 
FF_GAIN


	)

509 
	#FF_MAX
 0x7f

	)

510 
	#FF_CNT
 (
FF_MAX
+1)

	)

	@/usr/include/linux/kernel.h

2 #iâdeà
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<lšux/sysšfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
è((Òè+ (dè- 1è/ (d))

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #iâdeà
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

11 
	#MS_RDONLY
 1

	)

12 
	#MS_NOSUID
 2

	)

13 
	#MS_NODEV
 4

	)

14 
	#MS_NOEXEC
 8

	)

15 
	#MS_SYNCHRONOUS
 16

	)

16 
	#MS_REMOUNT
 32

	)

17 
	#MS_MANDLOCK
 64

	)

18 
	#MS_DIRSYNC
 128

	)

19 
	#MS_NOATIME
 1024

	)

20 
	#MS_NODIRATIME
 2048

	)

21 
	#MS_BIND
 4096

	)

22 
	#MS_MOVE
 8192

	)

23 
	#MS_REC
 16384

	)

24 
	#MS_VERBOSE
 32768

	)

26 
	#MS_SILENT
 32768

	)

27 
	#MS_POSIXACL
 (1<<16è

	)

28 
	#MS_UNBINDABLE
 (1<<17è

	)

29 
	#MS_PRIVATE
 (1<<18è

	)

30 
	#MS_SLAVE
 (1<<19è

	)

31 
	#MS_SHARED
 (1<<20è

	)

32 
	#MS_RELATIME
 (1<<21è

	)

33 
	#MS_KERNMOUNT
 (1<<22è

	)

34 
	#MS_I_VERSION
 (1<<23è

	)

35 
	#MS_STRICTATIME
 (1<<24è

	)

36 
	#MS_LAZYTIME
 (1<<25è

	)

39 
	#MS_SUBMOUNT
 (1<<26)

	)

40 
	#MS_NOREMOTELOCK
 (1<<27)

	)

41 
	#MS_NOSEC
 (1<<28)

	)

42 
	#MS_BORN
 (1<<29)

	)

43 
	#MS_ACTIVE
 (1<<30)

	)

44 
	#MS_NOUSER
 (1<<31)

	)

49 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

50 
MS_LAZYTIME
)

	)

55 
	#MS_MGC_VAL
 0xC0ED0000

	)

56 
	#MS_MGC_MSK
 0xffff0000

	)

61 
	#OPEN_TREE_CLONE
 1

	)

62 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

67 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

68 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

69 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

70 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

71 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

72 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

73 
	#MOVE_MOUNT__MASK
 0x00000077

	)

78 
	#FSOPEN_CLOEXEC
 0x00000001

	)

83 
	#FSPICK_CLOEXEC
 0x00000001

	)

84 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

85 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

86 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

91 
	efscÚfig_commªd
 {

92 
	mFSCONFIG_SET_FLAG
 = 0,

93 
	mFSCONFIG_SET_STRING
 = 1,

94 
	mFSCONFIG_SET_BINARY
 = 2,

95 
	mFSCONFIG_SET_PATH
 = 3,

96 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

97 
	mFSCONFIG_SET_FD
 = 5,

98 
	mFSCONFIG_CMD_CREATE
 = 6,

99 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

105 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

110 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

111 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

112 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

113 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

114 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

115 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

116 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

117 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

118 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

	@/usr/include/linux/spi/spidev.h

23 #iâdeà
SPIDEV_H


24 
	#SPIDEV_H


	)

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/ioùl.h
>

33 
	#SPI_CPHA
 0x01

	)

34 
	#SPI_CPOL
 0x02

	)

36 
	#SPI_MODE_0
 (0|0)

	)

37 
	#SPI_MODE_1
 (0|
SPI_CPHA
)

	)

38 
	#SPI_MODE_2
 (
SPI_CPOL
|0)

	)

39 
	#SPI_MODE_3
 (
SPI_CPOL
|
SPI_CPHA
)

	)

41 
	#SPI_CS_HIGH
 0x04

	)

42 
	#SPI_LSB_FIRST
 0x08

	)

43 
	#SPI_3WIRE
 0x10

	)

44 
	#SPI_LOOP
 0x20

	)

45 
	#SPI_NO_CS
 0x40

	)

46 
	#SPI_READY
 0x80

	)

47 
	#SPI_TX_DUAL
 0x100

	)

48 
	#SPI_TX_QUAD
 0x200

	)

49 
	#SPI_RX_DUAL
 0x400

	)

50 
	#SPI_RX_QUAD
 0x800

	)

56 
	#SPI_IOC_MAGIC
 'k'

	)

94 
	s¥i_ioc_Œªsãr
 {

95 
__u64
 
	mtx_buf
;

96 
__u64
 
	mrx_buf
;

98 
__u32
 
	mËn
;

99 
__u32
 
	m¥“d_hz
;

101 
__u16
 
	md–ay_u£cs
;

102 
__u8
 
	mb™s_³r_wÜd
;

103 
__u8
 
	mcs_chªge
;

104 
__u8
 
	mtx_nb™s
;

105 
__u8
 
	mrx_nb™s
;

106 
__u8
 
	mwÜd_d–ay_u£cs
;

107 
__u8
 
	m·d
;

119 
	#SPI_MSGSIZE
(
N
) \

120 ((((
N
)*( (
¥i_ioc_Œªsãr
))è< (1 << 
_IOC_SIZEBITS
)) \

121 ? ((
N
)*( (
¥i_ioc_Œªsãr
))è: 0)

	)

122 
	#SPI_IOC_MESSAGE
(
N
è
	`_IOW
(
SPI_IOC_MAGIC
, 0, [
	`SPI_MSGSIZE
(N)])

	)

126 
	#SPI_IOC_RD_MODE
 
	`_IOR
(
SPI_IOC_MAGIC
, 1, 
__u8
)

	)

127 
	#SPI_IOC_WR_MODE
 
	`_IOW
(
SPI_IOC_MAGIC
, 1, 
__u8
)

	)

130 
	#SPI_IOC_RD_LSB_FIRST
 
	`_IOR
(
SPI_IOC_MAGIC
, 2, 
__u8
)

	)

131 
	#SPI_IOC_WR_LSB_FIRST
 
	`_IOW
(
SPI_IOC_MAGIC
, 2, 
__u8
)

	)

134 
	#SPI_IOC_RD_BITS_PER_WORD
 
	`_IOR
(
SPI_IOC_MAGIC
, 3, 
__u8
)

	)

135 
	#SPI_IOC_WR_BITS_PER_WORD
 
	`_IOW
(
SPI_IOC_MAGIC
, 3, 
__u8
)

	)

138 
	#SPI_IOC_RD_MAX_SPEED_HZ
 
	`_IOR
(
SPI_IOC_MAGIC
, 4, 
__u32
)

	)

139 
	#SPI_IOC_WR_MAX_SPEED_HZ
 
	`_IOW
(
SPI_IOC_MAGIC
, 4, 
__u32
)

	)

142 
	#SPI_IOC_RD_MODE32
 
	`_IOR
(
SPI_IOC_MAGIC
, 5, 
__u32
)

	)

143 
	#SPI_IOC_WR_MODE32
 
	`_IOW
(
SPI_IOC_MAGIC
, 5, 
__u32
)

	)

	@/usr/include/linux/string.h

2 #iâdeà
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<¡ršg.h
>

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	t__b™wi£
 
	t__pŞl_t
;

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 328748

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/linux/fscrypt.h

8 #iâdeà
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<lšux/ty³s.h
>

14 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

15 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

20 
	#FSCRYPT_POLICY_FLAGS_VALID
 0x07

	)

23 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

24 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

25 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

26 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

27 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

28 
	#__FSCRYPT_MODE_MAX
 9

	)

36 
	#FSCRYPT_POLICY_V1
 0

	)

37 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

38 
	sfsüy±_pŞicy_v1
 {

39 
__u8
 
	mv”siÚ
;

40 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

41 
__u8
 
	mf’ames_’üy±iÚ_mode
;

42 
__u8
 
	mæags
;

43 
__u8
 
	mma¡”_key_desütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

45 
	#fsüy±_pŞicy
 
fsüy±_pŞicy_v1


	)

51 
	#FSCRYPT_KEY_DESC_PREFIX
 "fsüy±:"

	)

52 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

53 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

54 
	sfsüy±_key
 {

55 
__u32
 
	mmode
;

56 
__u8
 
	m¿w
[
FSCRYPT_MAX_KEY_SIZE
];

57 
__u32
 
	msize
;

63 
	#FSCRYPT_POLICY_V2
 2

	)

64 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

65 
	sfsüy±_pŞicy_v2
 {

66 
__u8
 
	mv”siÚ
;

67 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

68 
__u8
 
	mf’ames_’üy±iÚ_mode
;

69 
__u8
 
	mæags
;

70 
__u8
 
	m__»£rved
[4];

71 
__u8
 
	mma¡”_key_id’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

75 
	sfsüy±_g‘_pŞicy_ex_¬g
 {

76 
__u64
 
	mpŞicy_size
;

78 
__u8
 
	mv”siÚ
;

79 
fsüy±_pŞicy_v1
 
	mv1
;

80 
fsüy±_pŞicy_v2
 
	mv2
;

81 } 
	mpŞicy
;

88 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

95 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

101 
	sfsüy±_key_¥ecif›r
 {

102 
__u32
 
	mty³
;

103 
__u32
 
	m__»£rved
;

105 
__u8
 
	m__»£rved
[32];

106 
__u8
 
	mdesütÜ
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

107 
__u8
 
	mid’tif›r
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

108 } 
	mu
;

112 
	sfsüy±_add_key_¬g
 {

113 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

114 
__u32
 
	m¿w_size
;

115 
__u32
 
	m__»£rved
[9];

116 
__u8
 
	m¿w
[];

120 
	sfsüy±_»move_key_¬g
 {

121 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

122 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

123 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

124 
__u32
 
	m»mov®_¡©us_æags
;

125 
__u32
 
	m__»£rved
[5];

129 
	sfsüy±_g‘_key_¡©us_¬g
 {

131 
fsüy±_key_¥ecif›r
 
	mkey_¥ec
;

132 
__u32
 
	m__»£rved
[6];

135 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

136 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

137 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

138 
__u32
 
	m¡©us
;

139 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

140 
__u32
 
	m¡©us_æags
;

141 
__u32
 
	mu£r_couÁ
;

142 
__u32
 
	m__out_»£rved
[13];

145 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

146 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

147 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

148 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]è

	)

149 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fsüy±_add_key_¬g
)

	)

150 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fsüy±_»move_key_¬g
)

	)

151 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fsüy±_»move_key_¬g
)

	)

152 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fsüy±_g‘_key_¡©us_¬g
)

	)

157 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

158 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

159 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

160 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

161 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

162 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

163 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

164 
	#FS_POLICY_FLAGS_VALID
 
FSCRYPT_POLICY_FLAGS_VALID


	)

165 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

166 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

167 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

168 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

169 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

170 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

171 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

172 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

173 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

174 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

175 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

176 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

177 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/sysinfo.h

2 #iâdeà
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<lšux/ty³s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysšfo
 {

9 
__k”Ãl_lÚg_t
 
	mu±ime
;

10 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

11 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

12 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

13 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

14 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

15 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

16 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

17 
__u16
 
	m´ocs
;

18 
__u16
 
	m·d
;

19 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

20 
__k”Ãl_ulÚg_t
 
	mä“high
;

21 
__u32
 
	mmem_un™
;

22 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_şªg_´”eq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

44 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

47 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

48 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

64 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

68 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


71 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

72 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

74 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

76 #ifdeà
__OPTIMIZE__


77 
__ex‹º_®ways_šlše
 *

78 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


80  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

83 
__ex‹º_®ways_šlše
 const *

84 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


86  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

89 
	}
}

91 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

92 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 #ifdeà
__USE_GNU


98 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


99 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

100 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

104 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

105 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

109 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


110 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

111 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

112 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

115 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

122 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

123 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

125 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

126 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

127 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

130 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

131 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

134 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

137 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

138 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

144 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

148 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

149 
__THROW
 
	`__nÚnuÎ
 ((2));

151 #ifdeà
__USE_XOPEN2K8


153 
	~<b™s/ty³s/loÿË_t.h
>

156 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

157 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

160 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

161 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

164 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

165 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| 
	$__GLIBC_USE
 (
ISOC2X
))

167 *
	$¡rdup
 (cÚ¡ *
__s
)

168 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

174 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
è|| __GLIBC_USE (
ISOC2X
)

175 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

176 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

179 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


181 
	#¡rdu·
(
s
) \

182 (
__ex‹nsiÚ__
 \

184 cÚ¡ *
__Şd
 = (
s
); \

185 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

186 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

187 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

188 
	}
}))

	)

191 
	#¡ºdu·
(
s
, 
n
) \

192 (
__ex‹nsiÚ__
 \

194 cÚ¡ *
__Şd
 = (
s
); \

195 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

196 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

197 
__Ãw
[
__Ën
] = '\0'; \

198 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

199 }))

	)

203 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


206 *
¡rchr
 (*
__s
, 
__c
)

207 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

208 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

209 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

211 #ifdeà
__OPTIMIZE__


212 
__ex‹º_®ways_šlše
 *

213 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


215  
__butš_¡rchr
 (
__s
, 
__c
);

218 
__ex‹º_®ways_šlše
 const *

219 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


221  
__butš_¡rchr
 (
__s
, 
__c
);

226 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

227 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

230 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


233 *
	`¡¼chr
 (*
__s
, 
__c
)

234 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

236 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

238 #ifdeà
__OPTIMIZE__


239 
__ex‹º_®ways_šlše
 *

240 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


242  
	`__butš_¡¼chr
 (
__s
, 
__c
);

245 
__ex‹º_®ways_šlše
 const *

246 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


248  
	`__butš_¡¼chr
 (
__s
, 
__c
);

251 
	}
}

253 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

254 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

257 #ifdeà
__USE_GNU


260 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


261 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

262 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

263 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

264 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

266 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

267 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

273 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

274 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

277 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

278 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

280 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


283 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

284 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

285 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

286 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

288 #ifdeà
__OPTIMIZE__


289 
__ex‹º_®ways_šlše
 *

290 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


292  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

295 
__ex‹º_®ways_šlše
 const *

296 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


298  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

301 
	}
}

303 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

304 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

307 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


310 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

311 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

312 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

313 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

315 #ifdeà
__OPTIMIZE__


316 
__ex‹º_®ways_šlše
 *

317 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


319  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

322 
__ex‹º_®ways_šlše
 const *

323 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


325  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

328 
	}
}

330 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

331 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

336 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

337 
__THROW
 
	`__nÚnuÎ
 ((2));

341 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

342 cÚ¡ *
__»¡riù
 
__d–im
,

343 **
__»¡riù
 
__§ve_±r
)

344 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

345 #ifdeà
__USE_POSIX


346 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

347 **
__»¡riù
 
__§ve_±r
)

348 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

351 #ifdeà
__USE_GNU


353 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


354 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

355 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

356 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

357 cÚ¡ *
__ÃedË
)

358 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

360 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

361 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

365 #ifdeà
__USE_GNU


369 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

370 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

371 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

375 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

376 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

377 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

378 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

379 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

380 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

385 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

386 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

388 #ifdef 
__USE_XOPEN2K8


391 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

392 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

397 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

398 #ifdeà
__USE_XOPEN2K


406 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


409 #ifdeà
__REDIRECT_NTH


410 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

411 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

412 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

414 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

415 
__THROW
 
	`__nÚnuÎ
 ((2));

416 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

421 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

422 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

426 #ifdeà
__USE_XOPEN2K8


428 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

431 #ifdeà
__USE_MISC


432 
	~<¡ršgs.h
>

436 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

440 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

441 cÚ¡ *
__»¡riù
 
__d–im
)

442 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

445 #ifdef 
__USE_XOPEN2K8


447 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

450 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

452 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

453 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

457 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

458 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

459 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

460 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

461 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

462 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

465 #ifdef 
__USE_GNU


467 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

468 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

471 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

474 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

476 #iâdeà
ba£Çme


481 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


482 "C++" *
	$ba£Çme
 (*
__f’ame
)

483 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

484 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

485 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

487 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

492 #ià
	`__GNUC_PREREQ
 (3,4)

493 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


495 
	~<b™s/¡ršg_fÜtif›d.h
>

499 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_MISC


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

120 #undeà
__USE_ISOC11


121 #undeà
__USE_ISOC99


122 #undeà
__USE_ISOC95


123 #undeà
__USE_ISOCXX11


124 #undeà
__USE_POSIX


125 #undeà
__USE_POSIX2


126 #undeà
__USE_POSIX199309


127 #undeà
__USE_POSIX199506


128 #undeà
__USE_XOPEN


129 #undeà
__USE_XOPEN_EXTENDED


130 #undeà
__USE_UNIX98


131 #undeà
__USE_XOPEN2K


132 #undeà
__USE_XOPEN2KXSI


133 #undeà
__USE_XOPEN2K8


134 #undeà
__USE_XOPEN2K8XSI


135 #undeà
__USE_LARGEFILE


136 #undeà
__USE_LARGEFILE64


137 #undeà
__USE_FILE_OFFSET64


138 #undeà
__USE_MISC


139 #undeà
__USE_ATFILE


140 #undeà
__USE_GNU


141 #undeà
__USE_FORTIFY_LEVEL


142 #undeà
__KERNEL_STRICT_NAMES


143 #undeà
__GLIBC_USE_ISOC2X


144 #undeà
__GLIBC_USE_DEPRECATED_GETS


145 #undeà
__GLIBC_USE_DEPRECATED_SCANF


149 #iâdeà
_LOOSE_KERNEL_NAMES


150 
	#__KERNEL_STRICT_NAMES


	)

160 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


161 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

162 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

164 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

171 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


172 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

173 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

175 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

179 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

185 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

186 && !
defšed
 
	g_DEFAULT_SOURCE


188 #undeà
_DEFAULT_SOURCE


189 
	#_DEFAULT_SOURCE
 1

	)

193 #ifdeà
_GNU_SOURCE


194 #undeà
_ISOC95_SOURCE


195 
	#_ISOC95_SOURCE
 1

	)

196 #undeà
_ISOC99_SOURCE


197 
	#_ISOC99_SOURCE
 1

	)

198 #undeà
_ISOC11_SOURCE


199 
	#_ISOC11_SOURCE
 1

	)

200 #undeà
_ISOC2X_SOURCE


201 
	#_ISOC2X_SOURCE
 1

	)

202 #undeà
_POSIX_SOURCE


203 
	#_POSIX_SOURCE
 1

	)

204 #undeà
_POSIX_C_SOURCE


205 
	#_POSIX_C_SOURCE
 200809L

	)

206 #undeà
_XOPEN_SOURCE


207 
	#_XOPEN_SOURCE
 700

	)

208 #undeà
_XOPEN_SOURCE_EXTENDED


209 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

210 #undeà
_LARGEFILE64_SOURCE


211 
	#_LARGEFILE64_SOURCE
 1

	)

212 #undeà
_DEFAULT_SOURCE


213 
	#_DEFAULT_SOURCE
 1

	)

214 #undeà
_ATFILE_SOURCE


215 
	#_ATFILE_SOURCE
 1

	)

220 #ià(
defšed
 
_DEFAULT_SOURCE
 \

221 || (!
defšed
 
	g__STRICT_ANSI__
 \

222 && !
defšed
 
	g_ISOC99_SOURCE
 && !defšed 
	g_ISOC11_SOURCE
 \

223 && !
defšed
 
	g_ISOC2X_SOURCE
 \

224 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

225 && !
defšed
 
	g_XOPEN_SOURCE
))

226 #undeà
_DEFAULT_SOURCE


227 
	#_DEFAULT_SOURCE
 1

	)

231 #ià(
defšed
 
_ISOC2X_SOURCE
 \

232 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

233 
	#__GLIBC_USE_ISOC2X
 1

	)

235 
	#__GLIBC_USE_ISOC2X
 0

	)

239 #ià(
defšed
 
_ISOC11_SOURCE
 || defšed 
_ISOC2X_SOURCE
 \

240 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

241 
	#__USE_ISOC11
 1

	)

245 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

246 || 
defšed
 
_ISOC2X_SOURCE
 \

247 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

248 
	#__USE_ISOC99
 1

	)

252 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

253 || 
defšed
 
_ISOC2X_SOURCE
 \

254 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

255 
	#__USE_ISOC95
 1

	)

258 #ifdeà
__ılu¥lus


260 #ià
__ılu¥lus
 >= 201703L

261 
	#__USE_ISOC11
 1

	)

265 #ià
__ılu¥lus
 >ğ201103L || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__


266 
	#__USE_ISOCXX11
 1

	)

267 
	#__USE_ISOC99
 1

	)

274 #ifdeà
_DEFAULT_SOURCE


275 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


276 
	#__USE_POSIX_IMPLICITLY
 1

	)

278 #undeà
_POSIX_SOURCE


279 
	#_POSIX_SOURCE
 1

	)

280 #undeà
_POSIX_C_SOURCE


281 
	#_POSIX_C_SOURCE
 200809L

	)

284 #ià((!
defšed
 
__STRICT_ANSI__
 \

285 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

286 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

287 
	#_POSIX_SOURCE
 1

	)

288 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

289 
	#_POSIX_C_SOURCE
 2

	)

290 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

291 
	#_POSIX_C_SOURCE
 199506L

	)

292 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

293 
	#_POSIX_C_SOURCE
 200112L

	)

295 
	#_POSIX_C_SOURCE
 200809L

	)

297 
	#__USE_POSIX_IMPLICITLY
 1

	)

306 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

307 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

308 
	#_POSIX_SOURCE
 1

	)

309 #undeà
_POSIX_C_SOURCE


310 
	#_POSIX_C_SOURCE
 199506L

	)

313 #ià(
defšed
 
_POSIX_SOURCE
 \

314 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

315 || 
defšed
 
_XOPEN_SOURCE
)

316 
	#__USE_POSIX
 1

	)

319 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


320 
	#__USE_POSIX2
 1

	)

323 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

324 
	#__USE_POSIX199309
 1

	)

327 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

328 
	#__USE_POSIX199506
 1

	)

331 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

332 
	#__USE_XOPEN2K
 1

	)

333 #undeà
__USE_ISOC95


334 
	#__USE_ISOC95
 1

	)

335 #undeà
__USE_ISOC99


336 
	#__USE_ISOC99
 1

	)

339 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

340 
	#__USE_XOPEN2K8
 1

	)

341 #undeà
_ATFILE_SOURCE


342 
	#_ATFILE_SOURCE
 1

	)

345 #ifdef 
_XOPEN_SOURCE


346 
	#__USE_XOPEN
 1

	)

347 #ià(
_XOPEN_SOURCE
 - 0) >= 500

348 
	#__USE_XOPEN_EXTENDED
 1

	)

349 
	#__USE_UNIX98
 1

	)

350 #undeà
_LARGEFILE_SOURCE


351 
	#_LARGEFILE_SOURCE
 1

	)

352 #ià(
_XOPEN_SOURCE
 - 0) >= 600

353 #ià(
_XOPEN_SOURCE
 - 0) >= 700

354 
	#__USE_XOPEN2K8
 1

	)

355 
	#__USE_XOPEN2K8XSI
 1

	)

357 
	#__USE_XOPEN2K
 1

	)

358 
	#__USE_XOPEN2KXSI
 1

	)

359 #undeà
__USE_ISOC95


360 
	#__USE_ISOC95
 1

	)

361 #undeà
__USE_ISOC99


362 
	#__USE_ISOC99
 1

	)

365 #ifdeà
_XOPEN_SOURCE_EXTENDED


366 
	#__USE_XOPEN_EXTENDED
 1

	)

371 #ifdeà
_LARGEFILE_SOURCE


372 
	#__USE_LARGEFILE
 1

	)

375 #ifdeà
_LARGEFILE64_SOURCE


376 
	#__USE_LARGEFILE64
 1

	)

379 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

380 
	#__USE_FILE_OFFSET64
 1

	)

383 #ià
defšed
 
_DEFAULT_SOURCE


384 
	#__USE_MISC
 1

	)

387 #ifdef 
_ATFILE_SOURCE


388 
	#__USE_ATFILE
 1

	)

391 #ifdef 
_GNU_SOURCE


392 
	#__USE_GNU
 1

	)

395 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

396 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

397 #ià
_FORTIFY_SOURCE
 > 1

398 
	#__USE_FORTIFY_LEVEL
 2

	)

400 
	#__USE_FORTIFY_LEVEL
 1

	)

403 
	#__USE_FORTIFY_LEVEL
 0

	)

410 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


411 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

413 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

428 #ià(
defšed
 
__USE_GNU
 \

429 && (
defšed
 
	g__ılu¥lus
 \

430 ? (
	g__ılu¥lus
 < 201103L && !
defšed
 
	g__GXX_EXPERIMENTAL_CXX0X__
) \

431 : (!
defšed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

432 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

434 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

439 
	~<¡dc-´edef.h
>

447 #undeà
__GNU_LIBRARY__


448 
	#__GNU_LIBRARY__
 6

	)

452 
	#__GLIBC__
 2

	)

453 
	#__GLIBC_MINOR__
 31

	)

455 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

456 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

459 #iâdeà
__ASSEMBLER__


460 #iâdeà
_SYS_CDEFS_H


461 
	~<sys/cdefs.h
>

466 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


467 
	#__USE_LARGEFILE
 1

	)

468 
	#__USE_LARGEFILE64
 1

	)

474 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

475 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

476 && 
defšed
 
	g__ex‹º_šlše


477 
	#__USE_EXTERN_INLINES
 1

	)

485 
	~<gnu/¡ubs.h
>

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
48
1011
cts_builtin_firmware.h
cts_charger_detect.c
cts_charger_detect.h
cts_config.h
cts_core.c
cts_core.h
cts_earjack_detect.c
cts_earjack_detect.h
cts_firmware.c
cts_firmware.h
cts_i2c_driver.c
cts_plat_qcom_config.h
cts_platform.c
cts_platform.h
cts_sfctrl.h
cts_sfctrlv2.c
cts_spi_flash.c
cts_spi_flash.h
cts_strerror.c
cts_strerror.h
cts_sysfs.c
cts_sysfs.h
cts_test.c
cts_test.h
cts_tool.c
/usr/include/linux/errno.h
/usr/include/linux/fb.h
/usr/include/linux/fs.h
/usr/include/linux/gpio.h
/usr/include/linux/i2c.h
/usr/include/linux/input.h
/usr/include/linux/kernel.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/spi/spidev.h
/usr/include/linux/string.h
/usr/include/linux/types.h
/usr/include/linux/version.h
/usr/include/linux/fscrypt.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
